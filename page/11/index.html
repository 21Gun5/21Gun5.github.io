<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 3.8.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"21guns.top","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="have a nice day">
<meta property="og:url" content="http://21guns.top/page/11/index.html">
<meta property="og:site_name" content="have a nice day">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="have a nice day">

<link rel="canonical" href="http://21guns.top/page/11/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>have a nice day</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">have a nice day</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" placeholder="搜索..." spellcheck="false" type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://21guns.top/2021/03/15/iot/小豚摄像头的安全分析/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="21Guns">
      <meta itemprop="description" content>
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="have a nice day">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/03/15/iot/小豚摄像头的安全分析/" class="post-title-link" itemprop="url">小豚摄像头的安全分析</a>
        </h2>

        <div class="post-meta">

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-03-15 09:23:44" itemprop="dateCreated datePublished" datetime="2021-03-15T09:23:44+08:00">2021-03-15</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-02-21 15:07:53" itemprop="dateModified" datetime="2022-02-21T15:07:53+08:00">2022-02-21</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/IOT安全/" itemprop="url" rel="index"><span itemprop="name">IOT安全</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>[TOC]</p>
<h1 id="小豚摄像头的安全分析"><a href="#小豚摄像头的安全分析" class="headerlink" title="小豚摄像头的安全分析"></a>小豚摄像头的安全分析</h1><h2 id="上"><a href="#上" class="headerlink" title="上"></a>上</h2><ul>
<li>PS：ppt见小米 aiot安全峰会，打开Iot设备分析的第一扇门.pdf</li>
<li><p>概要：通过uart获取shell，获取到shell很重要，能ps看状态、gdb调试，通过uart或telnet</p>
</li>
<li><p>外部分析</p>
<ul>
<li>抓包通信过程，前期coap协议配网，后期云端作为中转并加密通信</li>
<li>扫描端口</li>
</ul>
</li>
<li>硬件分析<ul>
<li>找cpu/soc、flash</li>
<li>依据型号找芯片手册、开发sdk，官网或淘宝</li>
<li>提取固件，flash+编程器，结合sdk进行固件分析</li>
</ul>
</li>
<li><p>串口分析，获取shell</p>
<ul>
<li>光有硬件层面上uart连接还不行，还需软件层面支持</li>
<li>支持1，kernel的引导参数：修改bootargs的console从null到ttyxxx</li>
<li>支持2，文件系统的启动脚本，可理解为那个rcS文件：将引脚从gpio功能改为uart功能</li>
</ul>
</li>
<li><p>soc（个人感性认识，不严谨）    </p>
<ul>
<li>可理解为cpu，网上：CPU = 运算器 + 控制器，现在几乎没有纯粹的CPU了，都是SoC</li>
<li>可理解为整块板子，文中：几个过孔即为SoC的UART接口</li>
<li>mcu可理解为cpu，即图中红框大芯片</li>
</ul>
</li>
<li>保护机制<ul>
<li>uboot对自身部分有保护，对其它部分并没有</li>
<li>但是其它部分有自己的，如crc校验，虽然不如前者的secure boot功能</li>
</ul>
</li>
<li>摄像头与云端TLS加密通信，摄像头对云端的TLS证书有校验，无法用简单的中间人攻击拿到通信内容</li>
</ul>
<h2 id="下"><a href="#下" class="headerlink" title="下"></a>下</h2><ul>
<li>概要：突破tls加密通信，实现中间人攻击，获取通信流量</li>
<li>配置sdk开发环境<ul>
<li>包含交叉编译环境及源码</li>
<li>编译busubox（支持telnet和tfpt）、gdbserver</li>
</ul>
</li>
<li>启用telnet<ul>
<li>若不支持，可重新编译busybox，修改config文件</li>
<li>启动脚本中挂载devpts设备文件，否则telnetd在建立第一个telnet连接后就会崩溃？（why？）</li>
<li>启动脚本中设置开机自启</li>
</ul>
</li>
<li>获取shell<ul>
<li>硬件即urat法获取shell不方便，最好telnet、反向shell等软件法</li>
<li>uart和telnet都固件重打包刷回flash，整个反向shell来作为预备，以免二者都失效而反复折腾硬件</li>
<li>本文的反向shell代码思路简单，可收藏待用（因为是新程序，故本地qemu测试后再上传）</li>
</ul>
</li>
<li>程序分析<ul>
<li>获取shell后，ps找关键进程</li>
<li>静态分析：patch程序，使其打印日志</li>
<li>动态调试：编译gdbserver</li>
<li>通信内容分析：通过中间人攻击获取未加密流量</li>
</ul>
</li>
<li>中间人攻击<ul>
<li>tld加密通信，并验证tls证书，不可中间人</li>
<li>将tls证书修改为自己的，就可进行中间人攻击，获取二者的通信内容</li>
</ul>
</li>
<li>其它<ul>
<li>Linux启动脚本不一定非是rcS，本文为big_run.sh和small_run.sh</li>
<li>打补丁脚本、中间人攻击脚本，都并未给出</li>
<li>tls是协议层面上的加密，程序中的加密是应用层面上的</li>
<li>缺少证书相关知识，为何修改tls证书就可中间人</li>
</ul>
</li>
</ul>
<blockquote>
<p>参考：</p>
<ul>
<li><a href="https://www.4hou.com/posts/XqYl" target="_blank" rel="noopener">https://www.4hou.com/posts/XqYl</a></li>
<li><a href="https://www.4hou.com/posts/22GP" target="_blank" rel="noopener">https://www.4hou.com/posts/22GP</a></li>
</ul>
</blockquote>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://21guns.top/2021/02/12/iot/iot设备固件解密及分析/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="21Guns">
      <meta itemprop="description" content>
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="have a nice day">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/02/12/iot/iot设备固件解密及分析/" class="post-title-link" itemprop="url">iot设备固件解密及分析</a>
        </h2>

        <div class="post-meta">

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-02-12 14:41:33" itemprop="dateCreated datePublished" datetime="2021-02-12T14:41:33+08:00">2021-02-12</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-02-21 16:07:16" itemprop="dateModified" datetime="2022-02-21T16:07:16+08:00">2022-02-21</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/IOT安全/" itemprop="url" rel="index"><span itemprop="name">IOT安全</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>[toc]</p>
<h1 id="iot设备固件解密及分析"><a href="#iot设备固件解密及分析" class="headerlink" title="iot设备固件解密及分析"></a>iot设备固件解密及分析</h1><h1 id="提取"><a href="#提取" class="headerlink" title="提取"></a>提取</h1><h2 id="binwalk"><a href="#binwalk" class="headerlink" title="binwalk"></a>binwalk</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 文件太多，直接-e或-Me耗时太多</span></span><br><span class="line"><span class="comment"># 先不加参数看偏移，再-o指定偏移来提取</span></span><br><span class="line">$ binwalk R7800-V1.0.2.82.img</span><br><span class="line">2228352       0x220080        Squashfs filesystem, little endian, version 4.0, compression:xz, size: 28795562 bytes, 3892 inodes, blocksize: 262144 bytes, created: 2021-02-05 11:54:07</span><br><span class="line"></span><br><span class="line">$ binwalk -o 0x220080 -e R7800-V1.0.2.82.img</span><br></pre></td></tr></table></figure>
<h1 id="解密"><a href="#解密" class="headerlink" title="解密"></a>解密</h1><h2 id="00"><a href="#00" class="headerlink" title="00"></a>00</h2><ul>
<li>jffs2</li>
</ul>
<p><a href="https://github.com/sviehb/jefferson" target="_blank" rel="noopener">https://github.com/sviehb/jefferson</a></p>
<ul>
<li>ubi</li>
</ul>
<p><a href="https://github.com/jrspruitt/ubi_reader" target="_blank" rel="noopener">https://github.com/jrspruitt/ubi_reader</a></p>
<h2 id="01-mercury-vxworks-unowfs"><a href="#01-mercury-vxworks-unowfs" class="headerlink" title="01-mercury-vxworks-unowfs"></a>01-mercury-vxworks-unowfs</h2><ul>
<li><a href="http://www.devttys0.com/2011/06/mystery-file-system/" target="_blank" rel="noopener">http://www.devttys0.com/2011/06/mystery-file-system/</a></li>
<li><a href="http://www.devttys0.com/wp-content/uploads/2011/06/unowfs.c" target="_blank" rel="noopener">http://www.devttys0.com/wp-content/uploads/2011/06/unowfs.c</a></li>
<li>unowfs.c<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Utility to extract files from OWFS file system images.</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * $ gcc -Wall unowfs.c -o unowfs</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Craig Heffner, 20 June 2011</span></span><br><span class="line"><span class="comment"> * http://www.devttys0.com</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAGIC <span class="meta-string">"owowowowowowowowowowowowowowowow"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAGIC_SIZE 32</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FILE_NAME_MAX_SIZE 40</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DEFAULT_DEST_DIR <span class="meta-string">"owfs-root"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DIRECTORY_TRAVERSAL <span class="meta-string">"../"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FILE_PREFIX <span class="meta-string">"./"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FILE_PREFIX_SIZE 2</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FILE_PATH_SIZE 43</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* OWFS structures */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> pack(1)</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">owfs_header</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="keyword">char</span> magic[MAGIC_SIZE];</span><br><span class="line">	<span class="keyword">uint32_t</span> version;</span><br><span class="line">	<span class="keyword">uint32_t</span> num_entries;</span><br><span class="line">	<span class="keyword">uint32_t</span> unknown;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">owfs_entry</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="keyword">char</span> name[FILE_NAME_MAX_SIZE];</span><br><span class="line">	<span class="keyword">uint32_t</span> size;</span><br><span class="line">	<span class="keyword">uint32_t</span> offset;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> pack()</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Function declarations */</span></span><br><span class="line"><span class="function"><span class="keyword">char</span> *<span class="title">file_read</span><span class="params">(<span class="keyword">char</span> *file, <span class="keyword">size_t</span> *fsize)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">file_write</span><span class="params">(<span class="keyword">char</span> *file, <span class="keyword">char</span> *data, <span class="keyword">size_t</span> size)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">unowfs</span><span class="params">(<span class="keyword">char</span> *data, <span class="keyword">size_t</span> size)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> file_count = <span class="number">0</span>, retval = EXIT_FAILURE;</span><br><span class="line">	<span class="keyword">char</span> *file = <span class="literal">NULL</span>, *dir = <span class="literal">NULL</span>, *owbuf = <span class="literal">NULL</span>;</span><br><span class="line">	<span class="keyword">size_t</span> file_size = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(argc &lt; <span class="number">2</span> || argv[<span class="number">1</span>][<span class="number">0</span>] == <span class="string">'-'</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"\nUsage: %s &lt;owfs image&gt; [destination directory]\n\n"</span>, argv[<span class="number">0</span>]);</span><br><span class="line">		<span class="keyword">goto</span> end;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	file = argv[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(argc == <span class="number">3</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		dir = argv[<span class="number">2</span>];</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		dir = DEFAULT_DEST_DIR;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	owbuf = file_read(file, &amp;file_size);</span><br><span class="line">	<span class="keyword">if</span>(!owbuf)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">goto</span> end;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(mkdir(dir, (S_IRWXU | S_IRWXG | S_IRWXO)) &lt; <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		perror(dir);</span><br><span class="line">		<span class="keyword">goto</span> end;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(chdir(dir) &lt; <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		perror(dir);</span><br><span class="line">		<span class="keyword">goto</span> end;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	file_count = unowfs(owbuf, file_size);</span><br><span class="line">	<span class="keyword">if</span>(file_count &gt; <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"\nExtracted %d files to ./%s/\n"</span>, file_count, dir);</span><br><span class="line">		retval = EXIT_SUCCESS;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">end:</span><br><span class="line">	<span class="keyword">if</span>(owbuf) <span class="built_in">free</span>(owbuf);</span><br><span class="line">	<span class="keyword">return</span> retval;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Parse and extract files from OWFS image */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">unowfs</span><span class="params">(<span class="keyword">char</span> *data, <span class="keyword">size_t</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> count = <span class="number">0</span>, i = <span class="number">0</span>, offset = <span class="number">0</span>;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">owfs_header</span> *<span class="title">header</span> = <span class="title">NULL</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">owfs_entry</span> * <span class="title">entry</span> = <span class="title">NULL</span>;</span></span><br><span class="line">	<span class="keyword">char</span> file_name[FILE_PATH_SIZE] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Validate image size */</span></span><br><span class="line">	<span class="keyword">if</span>(size &lt; <span class="keyword">sizeof</span>(struct owfs_header))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Invalid image: size too small\n"</span>);</span><br><span class="line">		<span class="keyword">goto</span> end;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	header = (struct owfs_header *) data;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Validate magic signature */</span></span><br><span class="line">	<span class="keyword">if</span>(<span class="built_in">memcmp</span>(header-&gt;magic, MAGIC, MAGIC_SIZE) != <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Invalid image: bad magic signature\n"</span>);</span><br><span class="line">		<span class="keyword">goto</span> end;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/* Values are in big endian format */</span></span><br><span class="line">	header-&gt;version = htonl(header-&gt;version);</span><br><span class="line">	header-&gt;num_entries = htonl(header-&gt;num_entries);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Extracting %d files from OWFS version %d image...\n\n"</span>, header-&gt;num_entries, header-&gt;version);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Loop through all file entries and write file data to disk */</span></span><br><span class="line">	<span class="keyword">for</span>(i=<span class="number">0</span>,offset=<span class="keyword">sizeof</span>(struct owfs_header); (i &lt; header-&gt;num_entries &amp;&amp; offset &lt; size); i++,offset+=<span class="keyword">sizeof</span>(struct owfs_entry))</span><br><span class="line">	&#123;</span><br><span class="line">		entry = (struct owfs_entry *) (data + offset);</span><br><span class="line"></span><br><span class="line">		entry-&gt;size = htonl(entry-&gt;size);	</span><br><span class="line">		entry-&gt;offset = htonl(entry-&gt;offset);</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* Make sure specially crafted file names don't write outside of the destination directory */</span></span><br><span class="line">		<span class="keyword">if</span>(<span class="built_in">strstr</span>(entry-&gt;name, DIRECTORY_TRAVERSAL))</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Refusing to extract potentially malicious file: %s\n"</span>, entry-&gt;name);</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* Prepend './' to the file name to ensure it get written to a relative path */</span></span><br><span class="line">		<span class="built_in">memset</span>((<span class="keyword">char</span> *) &amp;file_name, <span class="number">0</span>, FILE_PATH_SIZE);</span><br><span class="line">		<span class="built_in">strncpy</span>((<span class="keyword">char</span> *) &amp;file_name, FILE_PREFIX, FILE_PREFIX_SIZE);</span><br><span class="line">		<span class="built_in">strncat</span>((<span class="keyword">char</span> *) &amp;file_name, entry-&gt;name, (FILE_PATH_SIZE - FILE_PREFIX_SIZE));</span><br><span class="line"></span><br><span class="line">		<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"%s [%d]\n"</span>, entry-&gt;name, entry-&gt;size);</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* Write data to disk */</span></span><br><span class="line">		<span class="keyword">if</span>(file_write((<span class="keyword">char</span> *) &amp;file_name, (data + entry-&gt;offset), entry-&gt;size))</span><br><span class="line">		&#123;</span><br><span class="line">			count++;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Failed to write data to disk for file %s\n"</span>, entry-&gt;name);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">end:</span><br><span class="line">	<span class="keyword">return</span> count;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Read in file contents */</span></span><br><span class="line"><span class="function"><span class="keyword">char</span> *<span class="title">file_read</span><span class="params">(<span class="keyword">char</span> *file, <span class="keyword">size_t</span> *fsize)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        <span class="keyword">int</span> fd = <span class="number">0</span>;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">stat</span> _<span class="title">fstat</span> = &#123;</span> <span class="number">0</span> &#125;;</span><br><span class="line">        <span class="keyword">char</span> *buffer = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(stat(file,&amp;_fstat) == <span class="number">-1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">                <span class="keyword">goto</span> end;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(_fstat.st_size == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">                <span class="keyword">goto</span> end;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        fd = open(file,O_RDONLY);</span><br><span class="line">        <span class="keyword">if</span>(!fd)</span><br><span class="line">        &#123;</span><br><span class="line">                <span class="keyword">goto</span> end;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        buffer = <span class="built_in">malloc</span>(_fstat.st_size);</span><br><span class="line">        <span class="keyword">if</span>(!buffer)</span><br><span class="line">        &#123;</span><br><span class="line">                <span class="keyword">goto</span> end;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">memset</span>(buffer,<span class="number">0</span>,_fstat.st_size);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(read(fd,buffer,_fstat.st_size) != _fstat.st_size)</span><br><span class="line">        &#123;</span><br><span class="line">                <span class="keyword">if</span>(buffer) <span class="built_in">free</span>(buffer);</span><br><span class="line">                buffer = <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">                *fsize = _fstat.st_size;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">end:</span><br><span class="line">        <span class="keyword">if</span>(fd) close(fd);</span><br><span class="line">        <span class="keyword">return</span> buffer;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Write data to disk */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">file_write</span><span class="params">(<span class="keyword">char</span> *file, <span class="keyword">char</span> *data, <span class="keyword">size_t</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	FILE *fp = <span class="literal">NULL</span>;</span><br><span class="line">	<span class="keyword">int</span> retval = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	fp = fopen(file, <span class="string">"w"</span>);</span><br><span class="line">	<span class="keyword">if</span>(!fp)</span><br><span class="line">	&#123;</span><br><span class="line">		perror(file);</span><br><span class="line">		<span class="keyword">goto</span> end;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(fwrite(data, <span class="number">1</span>, size, fp) != size)</span><br><span class="line">	&#123;</span><br><span class="line">		perror(file);</span><br><span class="line">		<span class="keyword">goto</span> end;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	retval = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">end:</span><br><span class="line">	<span class="keyword">if</span>(fp) fclose(fp);</span><br><span class="line">	<span class="keyword">return</span> retval;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="02-uImage"><a href="#02-uImage" class="headerlink" title="02-uImage"></a>02-uImage</h2><ul>
<li><a href="https://www.pentestpartners.com/security-blog/using-hexdump-analysis-for-firmware-extraction-a-how-to/" target="_blank" rel="noopener">https://www.pentestpartners.com/security-blog/using-hexdump-analysis-for-firmware-extraction-a-how-to/</a></li>
<li>随便Google即可<a href="https://gist.github.com/adamvr/1079762" target="_blank" rel="noopener">https://gist.github.com/adamvr/1079762</a></li>
<li>extract_uimage.sh<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Copyright (C) 2010 Matthias Buecher (http://www.maddes.net/)</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># This program is free software; you can redistribute it and/or modify</span></span><br><span class="line"><span class="comment"># it under the terms of the GNU General Public License as published by</span></span><br><span class="line"><span class="comment"># the Free Software Foundation; either version 2 of the License, or</span></span><br><span class="line"><span class="comment"># (at your option) any later version.</span></span><br><span class="line"><span class="comment"># http://www.gnu.org/licenses/gpl-2.0.txt</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># This program is distributed in the hope that it will be useful,</span></span><br><span class="line"><span class="comment"># but WITHOUT ANY WARRANTY; without even the implied warranty of</span></span><br><span class="line"><span class="comment"># MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span></span><br><span class="line"><span class="comment"># GNU General Public License for more details.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># You should have received a copy of the GNU General Public License</span></span><br><span class="line"><span class="comment"># along with this program; if not, write to the Free Software</span></span><br><span class="line"><span class="comment"># Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"></span><br><span class="line">UIMAGE=<span class="variable">$1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># check for uImage magic word</span></span><br><span class="line"><span class="comment"># http://git.denx.de/cgi-bin/gitweb.cgi?p=u-boot.git;a=blob;f=include/image.h</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">'Checking for uImage magic word...'</span></span><br><span class="line">MAGIC=`dd <span class="keyword">if</span>=<span class="string">"<span class="variable">$&#123;UIMAGE&#125;</span>"</span> ibs=4 count=1 | hexdump -v -e <span class="string">'1/1 "%02X"'</span>`</span><br><span class="line">[ <span class="string">'27051956'</span> != <span class="string">"<span class="variable">$&#123;MAGIC&#125;</span>"</span> ]  &amp;&amp; &#123; <span class="built_in">echo</span> <span class="string">'Not an uImage.'</span> ; <span class="built_in">exit</span> 1 ; &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># extract data from uImage</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">'uImage recognized.'</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">'Extracting data...'</span></span><br><span class="line">DATAFILE=<span class="string">'uImage.data'</span></span><br><span class="line">dd <span class="keyword">if</span>=<span class="string">"<span class="variable">$&#123;UIMAGE&#125;</span>"</span> of=<span class="string">"<span class="variable">$&#123;DATAFILE&#125;</span>"</span> ibs=64 skip=1</span><br><span class="line"></span><br><span class="line"><span class="comment"># check for ARM mach type ( xx 1C A0 E3 xx 10 81 E3 )</span></span><br><span class="line"><span class="comment"># http://www.simtec.co.uk/products/SWLINUX/files/booting_article.html#d0e600</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">'Checking for ARM mach-type...'</span></span><br><span class="line">MAGIC=`dd <span class="keyword">if</span>=<span class="string">"<span class="variable">$&#123;DATAFILE&#125;</span>"</span> ibs=1 skip=1 count=3 | hexdump -v -e <span class="string">'1/1 "%02X"'</span>`</span><br><span class="line">[ <span class="string">'1CA0E3'</span> = <span class="string">"<span class="variable">$&#123;MAGIC&#125;</span>"</span> ] &amp;&amp; &#123;</span><br><span class="line">	MAGIC=`dd <span class="keyword">if</span>=<span class="string">"<span class="variable">$&#123;DATAFILE&#125;</span>"</span> ibs=1 skip=5 count=3 | hexdump -v -e <span class="string">'1/1 "%02X"'</span>`</span><br><span class="line">	[ <span class="string">'1081E3'</span> = <span class="string">"<span class="variable">$&#123;MAGIC&#125;</span>"</span> ] &amp;&amp; &#123;</span><br><span class="line">		<span class="built_in">echo</span> <span class="string">'ARM mach-type header recognized.'</span></span><br><span class="line">		<span class="built_in">echo</span> <span class="string">'Extracting mach-type header...'</span></span><br><span class="line">		dd <span class="keyword">if</span>=<span class="string">"<span class="variable">$&#123;DATAFILE&#125;</span>"</span> of=<span class="string">"uImage.mach-type"</span> ibs=8 count=1</span><br><span class="line"><span class="comment">#</span></span><br><span class="line">		ARCH=`hexdump -v -e <span class="string">'1/1 "%02X "'</span> uImage.mach-type`</span><br><span class="line">		<span class="built_in">echo</span> <span class="string">"The mach-type is: <span class="variable">$&#123;ARCH&#125;</span>"</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">		<span class="built_in">echo</span> <span class="string">'Stripping mach-type header...'</span></span><br><span class="line">		TMPFILE=<span class="string">'uImage.tmp'</span></span><br><span class="line">		dd <span class="keyword">if</span>=<span class="string">"<span class="variable">$&#123;DATAFILE&#125;</span>"</span> of=<span class="string">"<span class="variable">$&#123;TMPFILE&#125;</span>"</span> ibs=8 skip=1</span><br><span class="line">		rm -f <span class="string">"<span class="variable">$&#123;DATAFILE&#125;</span>"</span></span><br><span class="line">		mv <span class="string">"<span class="variable">$&#123;TMPFILE&#125;</span>"</span> <span class="string">"<span class="variable">$&#123;DATAFILE&#125;</span>"</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># check for zImage, otherwise assume Image</span></span><br><span class="line"><span class="comment"># http://www.simtec.co.uk/products/SWLINUX/files/booting_article.html#d0e309</span></span><br><span class="line">TMPFILE=<span class="string">'Image'</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">'Checking for zImage...'</span></span><br><span class="line">MAGIC=`dd <span class="keyword">if</span>=<span class="string">"<span class="variable">$&#123;DATAFILE&#125;</span>"</span> ibs=4 skip=9 count=1 | hexdump -v -e <span class="string">'1/1 "%02X"'</span>`</span><br><span class="line">[ <span class="string">'18286F01'</span> = <span class="string">"<span class="variable">$&#123;MAGIC&#125;</span>"</span> ] &amp;&amp; &#123;</span><br><span class="line">	START=`dd <span class="keyword">if</span>=<span class="string">"<span class="variable">$&#123;DATAFILE&#125;</span>"</span> ibs=4 skip=10 count=1 | hexdump -v -e <span class="string">'1/4 "%08X"'</span>`</span><br><span class="line">	END=`dd <span class="keyword">if</span>=<span class="string">"<span class="variable">$&#123;DATAFILE&#125;</span>"</span> ibs=4 skip=11 count=1 | hexdump -v -e <span class="string">'1/4 "%08X"'</span>`</span><br><span class="line"><span class="comment">#</span></span><br><span class="line">	SIZE=$(( 0x<span class="variable">$&#123;END&#125;</span> - 0x<span class="variable">$&#123;START&#125;</span> ))</span><br><span class="line"><span class="comment">#</span></span><br><span class="line">	<span class="built_in">echo</span> <span class="string">"zImage recognized with start 0x<span class="variable">$&#123;START&#125;</span>, end 0x<span class="variable">$&#123;END&#125;</span> and size <span class="variable">$&#123;SIZE&#125;</span>."</span></span><br><span class="line">	TMPFILE=<span class="string">'zImage'</span></span><br><span class="line">&#125;</span><br><span class="line">mv <span class="string">"<span class="variable">$&#123;DATAFILE&#125;</span>"</span> <span class="string">"<span class="variable">$&#123;TMPFILE&#125;</span>"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ToDo: extract Image from zImage</span></span><br><span class="line"><span class="comment"># http://openinkpot.org/wiki/Documentation/ZImageFormat</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"&gt;&gt;&gt; <span class="variable">$&#123;UIMAGE&#125;</span> extracted to <span class="variable">$&#123;TMPFILE&#125;</span>"</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="03-zyxel-zld-fsextract"><a href="#03-zyxel-zld-fsextract" class="headerlink" title="03-zyxel-zld_fsextract"></a>03-zyxel-zld_fsextract</h2><ul>
<li>只有2个可执行文件：unzip.mips、zld_fsextract.i386</li>
<li>readme.txt<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">./zld_fsextract.i386 438ABAQ0C0.bin ./unzip.mips -f compress.img -D compress.img</span><br><span class="line"></span><br><span class="line">1 Ubuntu下失败：因为默认用qemu-mips执行unzip.mips</span><br><span class="line"></span><br><span class="line">2 但实际上：$ file unzip.mips </span><br><span class="line">unzip.mips: ELF 32-bit MSB executable, MIPS, N32 MIPS64 rel2 version 1 (SYSV), statically linked, stripped</span><br><span class="line"></span><br><span class="line">3 故需要用：qemu-mipsn32 unzip.mips</span><br><span class="line"></span><br><span class="line">4 但上述./zld_fsextract.i386命令中，无法将qemu-mipsn32 unzip.mips作为一个命令，加双引号也不行</span><br><span class="line"></span><br><span class="line">5 kali下可以（xw的，用的最新qemu</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="04-dlink"><a href="#04-dlink" class="headerlink" title="04-dlink"></a>04-dlink</h2><ul>
<li><a href="https://0x434b.dev/breaking-the-d-link-dir3060-firmware-encryption-static-analysis-part-2/" target="_blank" rel="noopener">https://0x434b.dev/breaking-the-d-link-dir3060-firmware-encryption-static-analysis-part-2/</a></li>
<li><a href="https://github.com/0xricksanchez/dlink-decrypt" target="_blank" rel="noopener">https://github.com/0xricksanchez/dlink-decrypt</a></li>
<li>dlink-dec.py</li>
<li>用法:python3 dlink-dec.py -i DIR882A1_FW130B06.bin -o out -m dec，详细见见README.md</li>
<li>适用于： DIR3060、DIR882、<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"><span class="keyword">import</span> pathlib</span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> contextlib <span class="keyword">import</span> suppress</span><br><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"></span><br><span class="line">CIPHERTEXT_OFF = <span class="number">0x6DC</span></span><br><span class="line">SHA512_DEC_FW_W_KEY_OFF = <span class="number">0x1C</span></span><br><span class="line">SHA512_DEC_FW = <span class="number">0x5C</span></span><br><span class="line">SHA512_ENC_FW = <span class="number">0x9C</span></span><br><span class="line">IVEC_OFF = <span class="number">0xC</span></span><br><span class="line">DATA_LEN_DEC_FW_OFF = <span class="number">0x4</span></span><br><span class="line">DATALEN_DEC_FW_NO_PADDING_OFF = <span class="number">0x8</span></span><br><span class="line">IVEC_LEN = <span class="number">0x10</span></span><br><span class="line">DATA_LEN = <span class="number">0x4</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DcryptLink</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, inp, outp, mode)</span>:</span></span><br><span class="line">        self.inp = inp</span><br><span class="line">        self.outp = outp</span><br><span class="line">        self.key = <span class="keyword">None</span></span><br><span class="line">        self.data_len_dec_fw_no_padding = <span class="keyword">None</span></span><br><span class="line">        self.data_len_dec_fw = <span class="keyword">None</span></span><br><span class="line">        self.ivec = <span class="keyword">None</span></span><br><span class="line">        self.mode = mode</span><br><span class="line">        self.__setup__()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__setup__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.set_key()</span><br><span class="line">        self.set_datalen_variables()</span><br><span class="line">        self.set_ivec()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> self.mode == <span class="string">"dec"</span>:</span><br><span class="line">            self.decrypt()</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self.encrypt()</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_expected_sha512_from_fd_at_offset</span><span class="params">(file, offset, size=<span class="number">0x40</span>)</span>:</span></span><br><span class="line">        <span class="keyword">with</span> open(file, <span class="string">"rb"</span>) <span class="keyword">as</span> enc_fw:</span><br><span class="line">            enc_fw.seek(offset)</span><br><span class="line">            <span class="keyword">return</span> binascii.hexlify(enc_fw.read(size)).decode()</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">calc_sha512_from_fd_at_offset_of_len</span><span class="params">(file, offset_payload, len_payload, key=None)</span>:</span></span><br><span class="line">        <span class="keyword">with</span> open(file, <span class="string">"rb"</span>) <span class="keyword">as</span> enc_fw:</span><br><span class="line">            enc_fw.seek(offset_payload)</span><br><span class="line">            data = enc_fw.read(len_payload)</span><br><span class="line">            <span class="keyword">if</span> key:</span><br><span class="line">                data = data + key</span><br><span class="line">        <span class="keyword">return</span> hashlib.sha512(data).hexdigest()</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">verify</span><span class="params">(calculated, expected)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> expected != calculated:</span><br><span class="line">            print(<span class="string">"\t[!] Failed!"</span>)</span><br><span class="line">            <span class="keyword">raise</span> ValueError</span><br><span class="line">        print(<span class="string">"\t[+] OK!"</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">decrypt_aes128_cbc</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">with</span> open(self.inp, <span class="string">"rb"</span>) <span class="keyword">as</span> enc_fw:</span><br><span class="line">            enc_fw.seek(CIPHERTEXT_OFF)</span><br><span class="line">            ciphertext = enc_fw.read(self.data_len_dec_fw_no_padding)</span><br><span class="line">        cipher = AES.new(self.key, AES.MODE_CBC, self.ivec)</span><br><span class="line">        plaintext = cipher.decrypt(ciphertext)</span><br><span class="line">        pathlib.Path(self.outp).open(<span class="string">"wb"</span>).write(plaintext)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">verify_magic_bytes</span><span class="params">(self)</span>:</span></span><br><span class="line">        expected = <span class="string">b"SHRS"</span></span><br><span class="line">        actual = pathlib.Path(self.inp).open(<span class="string">"rb"</span>).read(<span class="number">4</span>)</span><br><span class="line">        print(<span class="string">"[*] Checking magic bytes..."</span>)</span><br><span class="line">        self.verify(actual, expected)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">set_datalen_variables</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">with</span> open(self.inp, <span class="string">"rb"</span>) <span class="keyword">as</span> enc_fw:</span><br><span class="line">            enc_fw.seek(DATA_LEN_DEC_FW_OFF)</span><br><span class="line">            self.data_len_dec_fw = int.from_bytes(enc_fw.read(DATA_LEN), byteorder=<span class="string">"big"</span>, signed=<span class="keyword">False</span>)</span><br><span class="line">            enc_fw.seek(DATALEN_DEC_FW_NO_PADDING_OFF)</span><br><span class="line">            self.data_len_dec_fw_no_padding = int.from_bytes(enc_fw.read(DATA_LEN), byteorder=<span class="string">"big"</span>, signed=<span class="keyword">False</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">set_ivec</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">with</span> open(self.inp, <span class="string">"rb"</span>) <span class="keyword">as</span> enc_fw:</span><br><span class="line">            enc_fw.seek(IVEC_OFF)</span><br><span class="line">            self.ivec = enc_fw.read(IVEC_LEN)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">set_key</span><span class="params">(self)</span>:</span></span><br><span class="line">        in_file = bytes.fromhex(<span class="string">"C8D32F409CACB347C8D26FDCB9090B3C"</span>)</span><br><span class="line">        user_key = bytes.fromhex(<span class="string">"358790034519F8C8235DB6492839A73F"</span>)</span><br><span class="line">        ivec = bytes.fromhex(<span class="string">"98C9D8F0133D0695E2A709C8B69682D4"</span>)</span><br><span class="line"></span><br><span class="line">        print(<span class="string">"[*] Calculating key..."</span>)</span><br><span class="line"></span><br><span class="line">        self.key = AES.new(user_key, AES.MODE_CBC, ivec).decrypt(in_file)</span><br><span class="line">        self.verify(self.key, bytes.fromhex(<span class="string">"C05FBF1936C99429CE2A0781F08D6AD8"</span>))</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">decrypt</span><span class="params">(self)</span>:</span></span><br><span class="line"></span><br><span class="line">        self.verify_magic_bytes()</span><br><span class="line"></span><br><span class="line">        print(<span class="string">"[*] Verifying SHA512 message digest of encrypted payload..."</span>)</span><br><span class="line">        md = self.calc_sha512_from_fd_at_offset_of_len(self.inp, CIPHERTEXT_OFF, self.data_len_dec_fw_no_padding)</span><br><span class="line">        expected_md = self.get_expected_sha512_from_fd_at_offset(self.inp, SHA512_ENC_FW)</span><br><span class="line">        self.verify(md, expected_md)</span><br><span class="line"></span><br><span class="line">        self.decrypt_aes128_cbc()</span><br><span class="line"></span><br><span class="line">        print(<span class="string">"[*] Verifying SHA512 message digests of decrypted payload..."</span>)</span><br><span class="line">        md = self.calc_sha512_from_fd_at_offset_of_len(self.outp, <span class="number">0</span>, self.data_len_dec_fw)</span><br><span class="line">        expected_md = self.get_expected_sha512_from_fd_at_offset(self.inp, SHA512_DEC_FW)</span><br><span class="line">        self.verify(md, expected_md)</span><br><span class="line"></span><br><span class="line">        md = self.calc_sha512_from_fd_at_offset_of_len(self.outp, <span class="number">0</span>, self.data_len_dec_fw, key=self.key)</span><br><span class="line">        expected_md = self.get_expected_sha512_from_fd_at_offset(self.inp, SHA512_DEC_FW_W_KEY_OFF)</span><br><span class="line">        self.verify(md, expected_md)</span><br><span class="line"></span><br><span class="line">        print(<span class="string">f'[+] Successfully decrypted "<span class="subst">&#123;pathlib.Path(self.inp).name&#125;</span>"!'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">encrypt</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="comment"># self.ivec can also be set to os.urandom(16) and encryption still works for arbitrary binaries.</span></span><br><span class="line">        <span class="comment"># 67..46 was chosen to handle original D-Link firmware files</span></span><br><span class="line">        self.ivec = bytes.fromhex(<span class="string">"67C6697351FF4AEC29CDBAABF2FBE346"</span>)</span><br><span class="line"></span><br><span class="line">        data = pathlib.Path(self.inp).read_bytes()</span><br><span class="line">        self.data_len_dec_fw_no_padding = len(data)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> self.data_len_dec_fw_no_padding % <span class="number">16</span> != <span class="number">0</span>:</span><br><span class="line">            data += data + <span class="string">b"\x00"</span> * (<span class="number">16</span> - self.data_len_dec_fw_no_padding % <span class="number">16</span>)</span><br><span class="line">            self.data_len_dec_fw = len(data)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self.data_len_dec_fw = self.data_len_dec_fw_no_padding</span><br><span class="line"></span><br><span class="line">        print(<span class="string">"[*] Calculating cipher..."</span>)</span><br><span class="line">        ciphert = AES.new(self.key, AES.MODE_CBC, self.ivec).encrypt(data)</span><br><span class="line"></span><br><span class="line">        print(<span class="string">"[*] Building essential security header..."</span>)</span><br><span class="line">        sec_header = <span class="string">b"SHRS"</span></span><br><span class="line">        sec_header += struct.pack(<span class="string">"&gt;I"</span>, self.data_len_dec_fw_no_padding)</span><br><span class="line">        sec_header += struct.pack(<span class="string">"&gt;I"</span>, self.data_len_dec_fw)</span><br><span class="line">        sec_header += self.ivec</span><br><span class="line">        sec_header += bytes.fromhex(</span><br><span class="line">            self.calc_sha512_from_fd_at_offset_of_len(self.inp, <span class="number">0</span>, self.data_len_dec_fw_no_padding, key=self.key)</span><br><span class="line">        )</span><br><span class="line">        sec_header += bytes.fromhex(self.calc_sha512_from_fd_at_offset_of_len(self.inp, <span class="number">0</span>, self.data_len_dec_fw_no_padding))</span><br><span class="line">        sec_header += bytes.fromhex(hashlib.sha512(ciphert).hexdigest())</span><br><span class="line">        sec_header += <span class="string">b"\x00"</span> * <span class="number">512</span></span><br><span class="line">        sec_header += os.urandom(<span class="number">512</span>)  <span class="comment"># fake signature1, and</span></span><br><span class="line">        sec_header += os.urandom(<span class="number">512</span>)  <span class="comment"># fake signature2 as they're not needed for decryption..</span></span><br><span class="line"></span><br><span class="line">        print(<span class="string">"[*] Writing encrypted firmware to file..."</span>)</span><br><span class="line">        pathlib.Path(self.outp).write_bytes(sec_header + ciphert)</span><br><span class="line">        print(<span class="string">"\t[+] Done!"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    arg_parser = argparse.ArgumentParser(</span><br><span class="line">        description=<span class="string">"D-Link SHRS decyption tool"</span>, formatter_class=argparse.ArgumentDefaultsHelpFormatter</span><br><span class="line">    )</span><br><span class="line">    arg_parser.add_argument(<span class="string">"-i"</span>, <span class="string">"--inp"</span>, type=str, help=<span class="string">"Path to the encrypted D-Link firmware image"</span>, required=<span class="keyword">True</span>)</span><br><span class="line">    arg_parser.add_argument(<span class="string">"-o"</span>, <span class="string">"--out"</span>, type=str, help=<span class="string">"Path to the decrypted firmware image"</span>, required=<span class="keyword">True</span>)</span><br><span class="line">    arg_parser.add_argument(</span><br><span class="line">        <span class="string">"-m"</span>, <span class="string">"--mode"</span>, type=str, default=<span class="string">"dec"</span>, choices=[<span class="string">"dec"</span>, <span class="string">"enc"</span>], help=<span class="string">"Choose whether to encrypt or decrypt"</span>,</span><br><span class="line">    )</span><br><span class="line">    cli_args = arg_parser.parse_args()</span><br><span class="line"></span><br><span class="line">    dlink = DcryptLink(cli_args.inp, cli_args.out, cli_args.mode)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        dlink.run()</span><br><span class="line">    <span class="keyword">except</span> ValueError:</span><br><span class="line">        <span class="keyword">with</span> suppress(FileNotFoundError):</span><br><span class="line">            pathlib.Path(dlink.outp).unlink()</span><br><span class="line">        print(<span class="string">"[!] Failed!"</span>)</span><br><span class="line">        sys.exit(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="05-ubi"><a href="#05-ubi" class="headerlink" title="05-ubi"></a>05-ubi</h2><ul>
<li>ubi提取方法</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- ubi是文件系统，可以直接mount（未实践</span><br><span class="line">- ubidump：https://github.com/nlitsme/ubidump（实测失败</span><br><span class="line">- ubi_reader：https://github.com/jrspruitt/ubi_reader（实测成功</span><br></pre></td></tr></table></figure>
<ul>
<li>ubi_reader成功<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 提取镜像</span></span><br><span class="line">ubireader_extract_images RBR750-V3.2.15.25_1.3.15-signed.chk</span><br><span class="line"></span><br><span class="line"><span class="comment"># 产生ubifs-root目录，最终提取到三个镜像</span></span><br><span class="line">-rw-r--r-- 1 lxl lxl  5586944 Oct 12 14:18 img-1542134531_vol-kernel.ubifs</span><br><span class="line">-rw-r--r-- 1 lxl lxl        0 Oct 12 14:19 img-1542134531_vol-rootfs_data.ubifs</span><br><span class="line">-rw-r--r-- 1 lxl lxl 38219776 Oct 12 14:19 img-1542134531_vol-ubi_rootfs.ubifs</span><br><span class="line"></span><br><span class="line"><span class="comment"># file查看</span></span><br><span class="line">img-1542134531_vol-kernel.ubifs:      data</span><br><span class="line">img-1542134531_vol-rootfs_data.ubifs: empty</span><br><span class="line">img-1542134531_vol-ubi_rootfs.ubifs:  Squashfs filesystem, little endian, version 4.0, 38197684 bytes, 4437 inodes, blocksize: 262144 bytes, created: Wed May  6 11:35:42 2020</span><br><span class="line"><span class="comment"># 提取</span></span><br><span class="line">binwalk -Me或者直接unsquashfs img-1542134531_vol-ubi_rootfs.ubifs即可</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="06-lua"><a href="#06-lua" class="headerlink" title="06-lua"></a>06-lua</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># unluac失败</span></span><br><span class="line"> ~/.Trash/unluac  <span class="built_in">cd</span> ~/Documents/Tools/unluac</span><br><span class="line"> ~/Documents/Tools/unluac  ls</span><br><span class="line">README.md     authors.txt   build.sh      documentation license.txt   src           <span class="built_in">test</span></span><br><span class="line"> ~/Documents/Tools/unluac  ./build.sh</span><br><span class="line"> ~/Documents/Tools/unluac  ls</span><br><span class="line">README.md     authors.txt   bin           build         build.sh      documentation license.txt   src           <span class="built_in">test</span></span><br><span class="line"> ~/Documents/Tools/unluac  <span class="built_in">cd</span> bin</span><br><span class="line"> ~/Documents/Tools/unluac/bin  ls</span><br><span class="line">unluac.jar</span><br><span class="line"> ~/Documents/Tools/unluac/bin  java -jar unluac.jar /Users/lxl/Desktop/tp-c5400/fs_1/usr/lib/lua/luci/controller/login.lua &gt; login1.lua</span><br><span class="line">Exception <span class="keyword">in</span> thread <span class="string">"main"</span> java.lang.IllegalStateException: The input chunk reports an invalid code <span class="keyword">for</span> lua number integrality: 4</span><br><span class="line">	at unluac.parse.LHeaderType.parse_number_integrality(LHeaderType.java:127)</span><br><span class="line">	at unluac.parse.LHeaderType51.parse_main(LHeaderType.java:196)</span><br><span class="line">	at unluac.parse.LHeaderType.parse(LHeaderType.java:45)</span><br><span class="line">	at unluac.parse.BHeader.&lt;init&gt;(BHeader.java:66)</span><br><span class="line">	at unluac.Main.file_to_function(Main.java:71)</span><br><span class="line">	at unluac.Main.main(Main.java:42)</span><br><span class="line"> ✘ ~/Documents/Tools/unluac/bin </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="comment"># luadec失败</span></span><br><span class="line"><span class="comment"># openwrt不同于默认的lua 字节码</span></span><br><span class="line">lxl@localhost  ~/Documents/Tools  git <span class="built_in">clone</span> https://github.com/viruscamp/luadec</span><br><span class="line"></span><br><span class="line">lxl@localhost  ~/Documents/Tools  <span class="built_in">cd</span> luadec</span><br><span class="line"></span><br><span class="line">lxl@localhost  ~/Documents/Tools/luadec   master  git submodule update --init lua-5.1</span><br><span class="line"></span><br><span class="line">lxl@ubuntu:/mnt/hgfs$ <span class="built_in">cd</span> luadec/lua-5.1/</span><br><span class="line"></span><br><span class="line">lxl@ubuntu:/mnt/hgfs/luadec/lua-5.1$ sudo apt install libreadline-dev</span><br><span class="line">lxl@ubuntu:/mnt/hgfs/luadec/lua-5.1$ make linux</span><br><span class="line">lxl@ubuntu:/mnt/hgfs/luadec/lua-5.1$ <span class="built_in">cd</span> ../luadec</span><br><span class="line">lxl@ubuntu:/mnt/hgfs/luadec/luadec$ make LUAVER=5.1</span><br><span class="line">lxl@ubuntu:/mnt/hgfs/luadec$ <span class="built_in">cd</span> luadec/</span><br><span class="line">lxl@ubuntu:/mnt/hgfs/luadec/luadec$ ./luadec </span><br><span class="line"></span><br><span class="line">./luadec /mnt/hgfs/mac/tp-c5400/fs_1/usr/lib/lua/luci/controller/login.lua </span><br><span class="line">./luadec: /mnt/hgfs/mac/tp-c5400/fs_1/usr/lib/lua/luci/controller/login.lua: bad code <span class="keyword">in</span> precompiled chunk</span><br><span class="line"></span><br><span class="line"><span class="comment"># luadec-tplink 成功,但没符号</span></span><br><span class="line"> lxl@localhost  ~/Documents/Tools/luadec-tplink-master/OSX-Compiled  ./luadec ~/Desktop/tp-c5400/fs_1/usr/lib/lua/luci/controller/login.lua</span><br></pre></td></tr></table></figure>
<h1 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h1><h2 id="加载基址"><a href="#加载基址" class="headerlink" title="加载基址"></a>加载基址</h2><h3 id="rbasefind"><a href="#rbasefind" class="headerlink" title="rbasefind"></a>rbasefind</h3><p><a href="https://github.com/sgayou/rbasefind" target="_blank" rel="noopener">https://github.com/sgayou/rbasefind</a><br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 编译:</span></span><br><span class="line">https://szpzs.oschina.io/2019/10/29/executable-program-in-rust/</span><br><span class="line"><span class="comment"># 1</span></span><br><span class="line">brew install rust</span><br><span class="line"><span class="comment"># 2</span></span><br><span class="line"><span class="built_in">cd</span> rbasefind-master</span><br><span class="line">cargo build --release</span><br><span class="line"><span class="comment"># 3</span></span><br><span class="line">ls target/release/rbasefind</span><br></pre></td></tr></table></figure></p>
<h3 id="ppc-rebase"><a href="#ppc-rebase" class="headerlink" title="ppc_rebase"></a>ppc_rebase</h3><ul>
<li>usage：python2 ppc_rebase.py firmware.bin</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://21guns.top/2021/02/08/iot/嵌入式设备web服务器-mini_httpd/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="21Guns">
      <meta itemprop="description" content>
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="have a nice day">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/02/08/iot/嵌入式设备web服务器-mini_httpd/" class="post-title-link" itemprop="url">嵌入式设备web服务器-mini_httpd</a>
        </h2>

        <div class="post-meta">

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-02-08 14:41:33" itemprop="dateCreated datePublished" datetime="2021-02-08T14:41:33+08:00">2021-02-08</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-02-17 16:10:14" itemprop="dateModified" datetime="2022-02-17T16:10:14+08:00">2022-02-17</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/IOT安全/" itemprop="url" rel="index"><span itemprop="name">IOT安全</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>[toc]</p>
<h1 id="version-1-30"><a href="#version-1-30" class="headerlink" title="version_1.30"></a>version_1.30</h1><h2 id="handle-request（main-call"><a href="#handle-request（main-call" class="headerlink" title="handle_request（main call"></a>handle_request（main call</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* This runs in a child process, and exits when done, so cleanup is</span></span><br><span class="line"><span class="comment">** not needed.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">handle_request</span><span class="params">( <span class="keyword">void</span> )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span>* method_str;<span class="comment">// 请求方法字符串</span></span><br><span class="line">    <span class="keyword">char</span>* line;</span><br><span class="line">    <span class="keyword">char</span>* cp;</span><br><span class="line">    <span class="keyword">int</span> r, file_len, i;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* index_names[] = &#123;</span><br><span class="line">	<span class="string">"index.html"</span>, <span class="string">"index.htm"</span>, <span class="string">"index.xhtml"</span>, <span class="string">"index.xht"</span>, <span class="string">"Default.htm"</span>,</span><br><span class="line">	<span class="string">"index.cgi"</span> &#125;;<span class="comment">// ????</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// 设置读取超时</span></span><br><span class="line">    <span class="comment">/* Set up the timeout for reading. */</span></span><br><span class="line">	<span class="meta">#<span class="meta-keyword">ifdef</span> HAVE_SIGSET</span></span><br><span class="line">    (<span class="keyword">void</span>) sigset( SIGALRM, handle_read_timeout );</span><br><span class="line">	<span class="meta">#<span class="meta-keyword">else</span> <span class="comment">/* HAVE_SIGSET */</span></span></span><br><span class="line">    (<span class="keyword">void</span>) signal( SIGALRM, handle_read_timeout );</span><br><span class="line">	<span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* HAVE_SIGSET */</span></span></span><br><span class="line">    (<span class="keyword">void</span>) alarm( READ_TIMEOUT );</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 初始化请求相关的变量</span></span><br><span class="line">    <span class="comment">/* Initialize the request variables. */</span></span><br><span class="line">    remoteuser = (<span class="keyword">char</span>*) <span class="number">0</span>;</span><br><span class="line">    method = METHOD_UNKNOWN;</span><br><span class="line">    path = (<span class="keyword">char</span>*) <span class="number">0</span>;</span><br><span class="line">    file = (<span class="keyword">char</span>*) <span class="number">0</span>;</span><br><span class="line">    pathinfo = (<span class="keyword">char</span>*) <span class="number">0</span>;</span><br><span class="line">    query = <span class="string">""</span>;</span><br><span class="line">    protocol = (<span class="keyword">char</span>*) <span class="number">0</span>;</span><br><span class="line">    status = <span class="number">0</span>;</span><br><span class="line">    bytes = <span class="number">-1</span>;</span><br><span class="line">    req_hostname = (<span class="keyword">char</span>*) <span class="number">0</span>;</span><br><span class="line">	<span class="comment">// 请求头对应的变量</span></span><br><span class="line">    authorization = (<span class="keyword">char</span>*) <span class="number">0</span>;</span><br><span class="line">    content_type = (<span class="keyword">char</span>*) <span class="number">0</span>;</span><br><span class="line">    content_length = <span class="number">-1</span>;</span><br><span class="line">    cookie = (<span class="keyword">char</span>*) <span class="number">0</span>;</span><br><span class="line">    host = (<span class="keyword">char</span>*) <span class="number">0</span>;</span><br><span class="line">    if_modified_since = (<span class="keyword">time_t</span>) <span class="number">-1</span>;</span><br><span class="line">    referrer = <span class="string">""</span>;</span><br><span class="line">    useragent = <span class="string">""</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 设置socket选项</span></span><br><span class="line">	<span class="meta">#<span class="meta-keyword">ifdef</span> TCP_NOPUSH</span></span><br><span class="line">    <span class="keyword">if</span> ( ! do_ssl )</span><br><span class="line">	&#123;</span><br><span class="line">	<span class="comment">/* Set the TCP_NOPUSH socket option, to try and avoid the 0.2 second</span></span><br><span class="line"><span class="comment">	** delay between sending the headers and sending the data.  A better</span></span><br><span class="line"><span class="comment">	** solution is writev() (as used in thttpd), or send the headers with</span></span><br><span class="line"><span class="comment">	** send(MSG_MORE) (only available in Linux so far).</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">	r = <span class="number">1</span>;</span><br><span class="line">	(<span class="keyword">void</span>) setsockopt(</span><br><span class="line">	    conn_fd, IPPROTO_TCP, TCP_NOPUSH, (<span class="keyword">void</span>*) &amp;r, <span class="keyword">sizeof</span>(r) );</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* TCP_NOPUSH */</span></span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// ssl相关</span></span><br><span class="line">	<span class="meta">#<span class="meta-keyword">ifdef</span> USE_SSL</span></span><br><span class="line">    <span class="keyword">if</span> ( do_ssl )</span><br><span class="line">	&#123;</span><br><span class="line">	ssl = SSL_new( ssl_ctx );</span><br><span class="line">	SSL_set_fd( ssl, conn_fd );</span><br><span class="line">	<span class="keyword">if</span> ( SSL_accept( ssl ) == <span class="number">0</span> )</span><br><span class="line">	    &#123;</span><br><span class="line">	    ERR_print_errors_fp( <span class="built_in">stderr</span> );</span><br><span class="line">	    finish_request( <span class="number">1</span> );</span><br><span class="line">	    &#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* USE_SSL */</span></span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Read in the request. */</span></span><br><span class="line">    start_request();<span class="comment">// request size和idx初始化为0</span></span><br><span class="line">    <span class="keyword">for</span> (;;)	</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">char</span> buf[<span class="number">50000</span>];</span><br><span class="line">		<span class="keyword">int</span> rr = my_read( buf, <span class="keyword">sizeof</span>(buf) - <span class="number">1</span> );<span class="comment">// 从socket中读取数据到buf</span></span><br><span class="line">		<span class="keyword">if</span> ( rr &lt; <span class="number">0</span> &amp;&amp; ( errno == EINTR || errno == EAGAIN ) )</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		<span class="keyword">if</span> ( rr &lt;= <span class="number">0</span> )</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		(<span class="keyword">void</span>) alarm( READ_TIMEOUT );</span><br><span class="line">		add_to_request( buf, rr );<span class="comment">// 调用add_data，将buf添加到全局变量request</span></span><br><span class="line">		<span class="keyword">if</span> ( <span class="built_in">strstr</span>( request, <span class="string">"\015\012\015\012"</span> ) != (<span class="keyword">char</span>*) <span class="number">0</span> ||<span class="built_in">strstr</span>( request, <span class="string">"\012\012"</span> ) != (<span class="keyword">char</span>*) <span class="number">0</span> )</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 解析请求的第一行：方法、路径、协议</span></span><br><span class="line">    <span class="comment">/* Parse the first line of the request. */</span></span><br><span class="line">    method_str = get_request_line();<span class="comment">// 第一次调用，获取请求行</span></span><br><span class="line">    <span class="keyword">if</span> ( method_str == (<span class="keyword">char</span>*) <span class="number">0</span> )</span><br><span class="line">		send_error( <span class="number">400</span>, <span class="string">"Bad Request"</span>, <span class="string">""</span>, <span class="string">"Can't parse request."</span> );</span><br><span class="line">    path = <span class="built_in">strpbrk</span>( method_str, <span class="string">" \t\012\015"</span> );<span class="comment">// 获取path</span></span><br><span class="line">    <span class="keyword">if</span> ( path == (<span class="keyword">char</span>*) <span class="number">0</span> )</span><br><span class="line">		send_error( <span class="number">400</span>, <span class="string">"Bad Request"</span>, <span class="string">""</span>, <span class="string">"Can't parse request."</span> );</span><br><span class="line">    *path++ = <span class="string">'\0'</span>;</span><br><span class="line">    path += <span class="built_in">strspn</span>( path, <span class="string">" \t\012\015"</span> );</span><br><span class="line">    protocol = <span class="built_in">strpbrk</span>( path, <span class="string">" \t\012\015"</span> );<span class="comment">// 获取协议，如HTTP/1.1</span></span><br><span class="line">    <span class="keyword">if</span> ( protocol == (<span class="keyword">char</span>*) <span class="number">0</span> )</span><br><span class="line">		send_error( <span class="number">400</span>, <span class="string">"Bad Request"</span>, <span class="string">""</span>, <span class="string">"Can't parse request."</span> );</span><br><span class="line">    *protocol++ = <span class="string">'\0'</span>;</span><br><span class="line">    protocol += <span class="built_in">strspn</span>( protocol, <span class="string">" \t\012\015"</span> );</span><br><span class="line">    query = <span class="built_in">strchr</span>( path, <span class="string">'?'</span> );<span class="comment">// 获取请求参数</span></span><br><span class="line">    <span class="keyword">if</span> ( query == (<span class="keyword">char</span>*) <span class="number">0</span> )</span><br><span class="line">		query = <span class="string">""</span>;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">		*query++ = <span class="string">'\0'</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 解析剩下的内容，即处理各种请求头，并赋值给相应的全局变量</span></span><br><span class="line">    <span class="comment">/* Parse the rest of the request headers. */</span></span><br><span class="line">    <span class="keyword">while</span> ( ( line = get_request_line() ) != (<span class="keyword">char</span>*) <span class="number">0</span> )</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> ( line[<span class="number">0</span>] == <span class="string">'\0'</span> )</span><br><span class="line">	    	<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> ( strncasecmp( line, <span class="string">"Authorization:"</span>, <span class="number">14</span> ) == <span class="number">0</span> )</span><br><span class="line">		&#123;</span><br><span class="line">			cp = &amp;line[<span class="number">14</span>];</span><br><span class="line">			cp += <span class="built_in">strspn</span>( cp, <span class="string">" \t"</span> );</span><br><span class="line">			authorization = cp;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> ( strncasecmp( line, <span class="string">"Content-Length:"</span>, <span class="number">15</span> ) == <span class="number">0</span> )</span><br><span class="line">		&#123;</span><br><span class="line">			cp = &amp;line[<span class="number">15</span>];</span><br><span class="line">			cp += <span class="built_in">strspn</span>( cp, <span class="string">" \t"</span> );</span><br><span class="line">			content_length = atol( cp );</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> ( strncasecmp( line, <span class="string">"Content-Type:"</span>, <span class="number">13</span> ) == <span class="number">0</span> )</span><br><span class="line">			&#123;</span><br><span class="line">			cp = &amp;line[<span class="number">13</span>];</span><br><span class="line">			cp += <span class="built_in">strspn</span>( cp, <span class="string">" \t"</span> );</span><br><span class="line">			content_type = cp;</span><br><span class="line">			&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> ( strncasecmp( line, <span class="string">"Cookie:"</span>, <span class="number">7</span> ) == <span class="number">0</span> )</span><br><span class="line">		&#123;</span><br><span class="line">			cp = &amp;line[<span class="number">7</span>];</span><br><span class="line">			cp += <span class="built_in">strspn</span>( cp, <span class="string">" \t"</span> );</span><br><span class="line">			cookie = cp;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> ( strncasecmp( line, <span class="string">"Host:"</span>, <span class="number">5</span> ) == <span class="number">0</span> )</span><br><span class="line">		&#123;</span><br><span class="line">			cp = &amp;line[<span class="number">5</span>];</span><br><span class="line">			cp += <span class="built_in">strspn</span>( cp, <span class="string">" \t"</span> );</span><br><span class="line">			host = cp;</span><br><span class="line">			<span class="keyword">if</span> ( host[<span class="number">0</span>] == <span class="string">'\0'</span> || host[<span class="number">0</span>] == <span class="string">'.'</span> ||<span class="built_in">strchr</span>( host, <span class="string">'/'</span> ) != (<span class="keyword">char</span>*) <span class="number">0</span> )</span><br><span class="line">				send_error( <span class="number">400</span>, <span class="string">"Bad Request"</span>, <span class="string">""</span>, <span class="string">"Can't parse request."</span> );</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> ( strncasecmp( line, <span class="string">"If-Modified-Since:"</span>, <span class="number">18</span> ) == <span class="number">0</span> )</span><br><span class="line">		&#123;</span><br><span class="line">			cp = &amp;line[<span class="number">18</span>];</span><br><span class="line">			cp += <span class="built_in">strspn</span>( cp, <span class="string">" \t"</span> );</span><br><span class="line">			if_modified_since = tdate_parse( cp );</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> ( strncasecmp( line, <span class="string">"Referer:"</span>, <span class="number">8</span> ) == <span class="number">0</span> )</span><br><span class="line">		&#123;</span><br><span class="line">			cp = &amp;line[<span class="number">8</span>];</span><br><span class="line">			cp += <span class="built_in">strspn</span>( cp, <span class="string">" \t"</span> );</span><br><span class="line">			referrer = cp;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> ( strncasecmp( line, <span class="string">"Referrer:"</span>, <span class="number">9</span> ) == <span class="number">0</span> )</span><br><span class="line">		&#123;</span><br><span class="line">			cp = &amp;line[<span class="number">9</span>];</span><br><span class="line">			cp += <span class="built_in">strspn</span>( cp, <span class="string">" \t"</span> );</span><br><span class="line">			referrer = cp;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> ( strncasecmp( line, <span class="string">"User-Agent:"</span>, <span class="number">11</span> ) == <span class="number">0</span> )</span><br><span class="line">		&#123;</span><br><span class="line">			cp = &amp;line[<span class="number">11</span>];</span><br><span class="line">			cp += <span class="built_in">strspn</span>( cp, <span class="string">" \t"</span> );</span><br><span class="line">			useragent = cp;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 判定method、一个数字对应一个请求方法</span></span><br><span class="line">    <span class="keyword">if</span> ( strcasecmp( method_str, get_method_str( METHOD_GET ) ) == <span class="number">0</span> )</span><br><span class="line">		method = METHOD_GET;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ( strcasecmp( method_str, get_method_str( METHOD_HEAD ) ) == <span class="number">0</span> )</span><br><span class="line">		method = METHOD_HEAD;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ( strcasecmp( method_str, get_method_str( METHOD_POST ) ) == <span class="number">0</span> )</span><br><span class="line">		method = METHOD_POST;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ( strcasecmp( method_str, get_method_str( METHOD_PUT ) ) == <span class="number">0</span> )</span><br><span class="line">		method = METHOD_PUT;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ( strcasecmp( method_str, get_method_str( METHOD_DELETE ) ) == <span class="number">0</span> )</span><br><span class="line">		method = METHOD_DELETE;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ( strcasecmp( method_str, get_method_str( METHOD_TRACE ) ) == <span class="number">0</span> )</span><br><span class="line">		method = METHOD_TRACE;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">		send_error( <span class="number">501</span>, <span class="string">"Not Implemented"</span>, <span class="string">""</span>, <span class="string">"That method is not implemented."</span> );</span><br><span class="line"></span><br><span class="line">    strdecode( path, path );<span class="comment">// 对path解码，调用了hexit，处理0-9、a-f、A-F</span></span><br><span class="line">    <span class="keyword">if</span> ( path[<span class="number">0</span>] != <span class="string">'/'</span> )</span><br><span class="line">		send_error( <span class="number">400</span>, <span class="string">"Bad Request"</span>, <span class="string">""</span>, <span class="string">"Bad filename."</span> );</span><br><span class="line">    file = &amp;(path[<span class="number">1</span>]);<span class="comment">// path+1即file，跳过第一个字符/</span></span><br><span class="line">    de_dotdot( file );<span class="comment">// 处理了// ../ /./等目录遍历的东西</span></span><br><span class="line">    <span class="keyword">if</span> ( file[<span class="number">0</span>] == <span class="string">'\0'</span> )</span><br><span class="line">		file = <span class="string">"./"</span>;</span><br><span class="line">    <span class="keyword">if</span> ( file[<span class="number">0</span>] == <span class="string">'/'</span> ||( file[<span class="number">0</span>] == <span class="string">'.'</span> &amp;&amp; file[<span class="number">1</span>] == <span class="string">'.'</span> &amp;&amp;( file[<span class="number">2</span>] == <span class="string">'\0'</span> || file[<span class="number">2</span>] == <span class="string">'/'</span> ) ) )</span><br><span class="line">		send_error( <span class="number">400</span>, <span class="string">"Bad Request"</span>, <span class="string">""</span>, <span class="string">"Illegal filename."</span> );</span><br><span class="line">    <span class="keyword">if</span> ( vhost )</span><br><span class="line">		file = virtual_file( file );<span class="comment">// 得到虚拟文件名，即带有host-ip的</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// 设置写入超时</span></span><br><span class="line">    <span class="comment">/* Set up the timeout for writing. */</span></span><br><span class="line">	<span class="meta">#<span class="meta-keyword">ifdef</span> HAVE_SIGSET</span></span><br><span class="line">    (<span class="keyword">void</span>) sigset( SIGALRM, handle_write_timeout );</span><br><span class="line">	<span class="meta">#<span class="meta-keyword">else</span> <span class="comment">/* HAVE_SIGSET */</span></span></span><br><span class="line">    (<span class="keyword">void</span>) signal( SIGALRM, handle_write_timeout );</span><br><span class="line">	<span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* HAVE_SIGSET */</span></span></span><br><span class="line">    (<span class="keyword">void</span>) alarm( WRITE_TIMEOUT );</span><br><span class="line"></span><br><span class="line">    r = stat( file, &amp;sb );<span class="comment">// 通过文件名filename获取文件信息，并保存在结构体stat中</span></span><br><span class="line">    <span class="keyword">if</span> ( r &lt; <span class="number">0</span> )</span><br><span class="line">		r = get_pathinfo();<span class="comment">// 获取路径信息，失败则-1</span></span><br><span class="line">    <span class="keyword">if</span> ( r &lt; <span class="number">0</span> )</span><br><span class="line">		send_error( <span class="number">404</span>, <span class="string">"Not Found"</span>, <span class="string">""</span>, <span class="string">"File not found."</span> );</span><br><span class="line">    file_len = <span class="built_in">strlen</span>( file );</span><br><span class="line">    <span class="comment">// 判断是否为目录，如果不是则 do_file</span></span><br><span class="line">    <span class="keyword">if</span> ( ! S_ISDIR( sb.st_mode ) )</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">/* Not a directory. */</span></span><br><span class="line">		<span class="keyword">while</span> ( file[file_len - <span class="number">1</span>] == <span class="string">'/'</span> )</span><br><span class="line">	    &#123;</span><br><span class="line">	    	file[file_len - <span class="number">1</span>] = <span class="string">'\0'</span>;</span><br><span class="line">	    	--file_len;</span><br><span class="line">	    &#125;</span><br><span class="line">		do_file();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">char</span> idx[<span class="number">10000</span>];</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 是目录，但是缺了最后的斜杠</span></span><br><span class="line">		<span class="comment">/* The filename is a directory.  Is it missing the trailing slash? */</span></span><br><span class="line">		<span class="keyword">if</span> ( file[file_len - <span class="number">1</span>] != <span class="string">'/'</span> &amp;&amp; pathinfo == (<span class="keyword">char</span>*) <span class="number">0</span> )</span><br><span class="line">	    &#123;</span><br><span class="line">	    	<span class="keyword">char</span> location[<span class="number">10000</span>];</span><br><span class="line">	    	<span class="keyword">if</span> ( query[<span class="number">0</span>] != <span class="string">'\0'</span> )</span><br><span class="line">				(<span class="keyword">void</span>) <span class="built_in">snprintf</span>(location, <span class="keyword">sizeof</span>(location), <span class="string">"Location: %s/?%s"</span>, path,query );</span><br><span class="line">	    	<span class="keyword">else</span></span><br><span class="line">				(<span class="keyword">void</span>) <span class="built_in">snprintf</span>(location, <span class="keyword">sizeof</span>(location), <span class="string">"Location: %s/"</span>, path );</span><br><span class="line">	    	send_error( <span class="number">302</span>, <span class="string">"Found"</span>, location, <span class="string">"Directories must end with a slash."</span> );</span><br><span class="line">	    &#125;</span><br><span class="line"></span><br><span class="line">	    <span class="comment">// 对index文件做do_file</span></span><br><span class="line">		<span class="comment">/* Check for an index file. */</span></span><br><span class="line">		<span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; <span class="keyword">sizeof</span>(index_names) / <span class="keyword">sizeof</span>(<span class="keyword">char</span>*); ++i )</span><br><span class="line">	    &#123;</span><br><span class="line">	    	(<span class="keyword">void</span>) <span class="built_in">snprintf</span>( idx, <span class="keyword">sizeof</span>(idx), <span class="string">"%s%s"</span>, file, index_names[i] );</span><br><span class="line">	    	<span class="keyword">if</span> ( stat( idx, &amp;sb ) &gt;= <span class="number">0</span> )</span><br><span class="line">			&#123;</span><br><span class="line">				file = idx;</span><br><span class="line">				do_file();</span><br><span class="line">				<span class="keyword">goto</span> got_one;</span><br><span class="line">			&#125;</span><br><span class="line">	    &#125;</span><br><span class="line"></span><br><span class="line">	    <span class="comment">// 是目录则do_dir</span></span><br><span class="line">		<span class="comment">/* Nope, no index file, so it's an actual directory request. */</span></span><br><span class="line">		do_dir();</span><br><span class="line"></span><br><span class="line">		got_one: ;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 请求结束前释放ssl</span></span><br><span class="line">	<span class="meta">#<span class="meta-keyword">ifdef</span> USE_SSL</span></span><br><span class="line">    SSL_free( ssl );</span><br><span class="line">	<span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* USE_SSL */</span></span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 结束请求，执行exit</span></span><br><span class="line">    finish_request( <span class="number">0</span> );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="do-file（handle-request-call"><a href="#do-file（handle-request-call" class="headerlink" title="do_file（handle_request call"></a>do_file（handle_request call</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">do_file</span><span class="params">( <span class="keyword">void</span> )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">10000</span>];<span class="comment">// 请求内容复制到此buf中操作</span></span><br><span class="line">    <span class="keyword">char</span> mime_encodings[<span class="number">500</span>];<span class="comment">// 获取mime时用到</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* mime_type;<span class="comment">// 文件mime类型</span></span><br><span class="line">    <span class="keyword">char</span> fixed_mime_type[<span class="number">500</span>];<span class="comment">// 处理后的mime</span></span><br><span class="line">    <span class="keyword">char</span>* cp;<span class="comment">// 处理字符串时，char point</span></span><br><span class="line">    <span class="keyword">int</span> fd;<span class="comment">// 文件描述符</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 检查本目录的认证情况</span></span><br><span class="line">    <span class="comment">/* Check authorization for this directory. */</span></span><br><span class="line">    (<span class="keyword">void</span>) <span class="built_in">strncpy</span>( buf, file, <span class="keyword">sizeof</span>(buf) );</span><br><span class="line">    cp = <span class="built_in">strrchr</span>( buf, <span class="string">'/'</span> );</span><br><span class="line">    <span class="keyword">if</span> ( cp == (<span class="keyword">char</span>*) <span class="number">0</span> )</span><br><span class="line">	(<span class="keyword">void</span>) <span class="built_in">strcpy</span>( buf, <span class="string">"."</span> );</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">	*cp = <span class="string">'\0'</span>;</span><br><span class="line">    auth_check( buf );<span class="comment">// 认证检查</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 检查请求的文件名是否为认证文件自身，即.htpasswd</span></span><br><span class="line">    <span class="comment">/* Check if the filename is the AUTH_FILE itself - that's verboten. */</span></span><br><span class="line">    <span class="keyword">if</span> ( <span class="built_in">strcmp</span>( file, AUTH_FILE ) == <span class="number">0</span> ||</span><br><span class="line">	 ( <span class="built_in">strcmp</span>( &amp;(file[<span class="built_in">strlen</span>(file) - <span class="keyword">sizeof</span>(AUTH_FILE) + <span class="number">1</span>]), AUTH_FILE ) == <span class="number">0</span> &amp;&amp;</span><br><span class="line">	   file[<span class="built_in">strlen</span>(file) - <span class="keyword">sizeof</span>(AUTH_FILE)] == <span class="string">'/'</span> ) )</span><br><span class="line">	&#123;</span><br><span class="line">		syslog(</span><br><span class="line">		    LOG_NOTICE, <span class="string">"%.80s URL \"%.80s\" tried to retrieve an auth file"</span>,</span><br><span class="line">		    ntoa( &amp;client_addr ), path );</span><br><span class="line">		send_error( <span class="number">403</span>, <span class="string">"Forbidden"</span>, <span class="string">""</span>, <span class="string">"File is protected."</span> );</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// referer请求头的检查</span></span><br><span class="line">    <span class="comment">/* Referrer check. */</span></span><br><span class="line">    check_referrer();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 若cgi开启，并且请求的是cgi，则</span></span><br><span class="line">    <span class="comment">/* Is it CGI? */</span></span><br><span class="line">    <span class="keyword">if</span> ( cgi_pattern != (<span class="keyword">char</span>*) <span class="number">0</span> &amp;&amp; match( cgi_pattern, file ) )</span><br><span class="line">	&#123;</span><br><span class="line">		do_cgi();<span class="comment">// 执行cgi</span></span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 若未获取到文件信息，则404</span></span><br><span class="line">    <span class="keyword">if</span> ( pathinfo != (<span class="keyword">char</span>*) <span class="number">0</span> )</span><br><span class="line">		send_error( <span class="number">404</span>, <span class="string">"Not Found"</span>, <span class="string">""</span>, <span class="string">"File not found."</span> );</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 只允许get和head请求</span></span><br><span class="line">    <span class="keyword">if</span> ( method != METHOD_GET &amp;&amp; method != METHOD_HEAD )</span><br><span class="line">		send_error( <span class="number">501</span>, <span class="string">"Not Implemented"</span>, <span class="string">""</span>, <span class="string">"That method is not implemented."</span> );</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 正常情况则打开，失败则403</span></span><br><span class="line">    fd = open( file, O_RDONLY );</span><br><span class="line">    <span class="keyword">if</span> ( fd &lt; <span class="number">0</span> )</span><br><span class="line">	&#123;</span><br><span class="line">		syslog(</span><br><span class="line">	    	LOG_INFO, <span class="string">"%.80s File \"%.80s\" is protected"</span>,</span><br><span class="line">	    	ntoa( &amp;client_addr ), path );</span><br><span class="line">		send_error( <span class="number">403</span>, <span class="string">"Forbidden"</span>, <span class="string">""</span>, <span class="string">"File is protected."</span> );</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 识别文件的mime</span></span><br><span class="line">    mime_type = figure_mime( file, mime_encodings, <span class="keyword">sizeof</span>(mime_encodings) );</span><br><span class="line">	<span class="comment">// 按照charset对mime处理</span></span><br><span class="line">    (<span class="keyword">void</span>) <span class="built_in">snprintf</span>(fixed_mime_type, <span class="keyword">sizeof</span>(fixed_mime_type), mime_type, charset );</span><br><span class="line">	<span class="comment">// 304未修改</span></span><br><span class="line">    <span class="keyword">if</span> ( if_modified_since != (<span class="keyword">time_t</span>) <span class="number">-1</span> &amp;&amp; if_modified_since &gt;= sb.st_mtime )</span><br><span class="line">	&#123;</span><br><span class="line">		add_headers(</span><br><span class="line">	    	<span class="number">304</span>, <span class="string">"Not Modified"</span>, <span class="string">""</span>, mime_encodings, fixed_mime_type,</span><br><span class="line">	    	(<span class="keyword">off_t</span>) <span class="number">-1</span>, sb.st_mtime );</span><br><span class="line">		send_response();</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 正常情况下200</span></span><br><span class="line">    add_headers(</span><br><span class="line">		<span class="number">200</span>, <span class="string">"Ok"</span>, <span class="string">""</span>, mime_encodings, fixed_mime_type, sb.st_size,</span><br><span class="line">		sb.st_mtime );</span><br><span class="line">    send_response();<span class="comment">// 向客户端发送响应信息</span></span><br><span class="line">    <span class="keyword">if</span> ( method == METHOD_HEAD )</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 忽略0长度的文件</span></span><br><span class="line">    <span class="keyword">if</span> ( sb.st_size &gt; <span class="number">0</span> )	<span class="comment">/* ignore zero-length files */</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="meta">#<span class="meta-keyword">ifdef</span> HAVE_SENDFILE</span></span><br><span class="line"></span><br><span class="line">		<span class="meta">#<span class="meta-keyword">ifndef</span> USE_SSL</span></span><br><span class="line">		send_via_sendfile( fd, conn_fd, sb.st_size );</span><br><span class="line">		<span class="meta">#<span class="meta-keyword">else</span> <span class="comment">/* USE_SSL */</span></span></span><br><span class="line">		<span class="keyword">if</span> ( do_ssl )</span><br><span class="line">	    	send_via_write( fd, sb.st_size );</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">	    	send_via_sendfile( fd, conn_fd, sb.st_size );</span><br><span class="line">		<span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* USE_SSL */</span></span></span><br><span class="line"></span><br><span class="line">		<span class="meta">#<span class="meta-keyword">else</span> <span class="comment">/* HAVE_SENDFILE */</span></span></span><br><span class="line">   		send_via_write( fd, sb.st_size );</span><br><span class="line"></span><br><span class="line">		<span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* HAVE_SENDFILE */</span></span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    (<span class="keyword">void</span>) close( fd );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="do-cgi（do-file-call"><a href="#do-cgi（do-file-call" class="headerlink" title="do_cgi（do_file call"></a>do_cgi（do_file call</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="auth-check（do-file-call"><a href="#auth-check（do-file-call" class="headerlink" title="auth_check（do_file call"></a>auth_check（do_file call</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">auth_check</span><span class="params">( <span class="keyword">char</span>* dirname )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> authpath[<span class="number">10000</span>];</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">stat</span> <span class="title">sb2</span>;</span><span class="comment">// 保存文件信息</span></span><br><span class="line">    <span class="keyword">char</span> authinfo[<span class="number">500</span>];</span><br><span class="line">    <span class="keyword">char</span>* authpass;</span><br><span class="line">    <span class="keyword">char</span>* colon;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">char</span> line[<span class="number">10000</span>];</span><br><span class="line">    <span class="keyword">int</span> l;</span><br><span class="line">    FILE* fp;</span><br><span class="line">    <span class="keyword">char</span>* cryp;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 构建认证文件的完整路径</span></span><br><span class="line">    <span class="comment">/* Construct auth filename. */</span></span><br><span class="line">    <span class="keyword">if</span> ( dirname[<span class="built_in">strlen</span>(dirname) - <span class="number">1</span>] == <span class="string">'/'</span> )</span><br><span class="line">		(<span class="keyword">void</span>) <span class="built_in">snprintf</span>( authpath, <span class="keyword">sizeof</span>(authpath), <span class="string">"%s%s"</span>, dirname, AUTH_FILE );</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">		(<span class="keyword">void</span>) <span class="built_in">snprintf</span>( authpath, <span class="keyword">sizeof</span>(authpath), <span class="string">"%s/%s"</span>, dirname, AUTH_FILE );</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 获取认证文件的文件信息，成功0，失败-1</span></span><br><span class="line">    <span class="comment">/* Does this directory have an auth file? */</span></span><br><span class="line">    <span class="keyword">if</span> ( stat( authpath, &amp;sb2 ) &lt; <span class="number">0</span> )</span><br><span class="line">	<span class="comment">/* Nope, let the request go through. */</span></span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 如果没有authorization请求头</span></span><br><span class="line">    <span class="comment">/* Does this request contain authorization info? */</span></span><br><span class="line">    <span class="keyword">if</span> ( authorization == (<span class="keyword">char</span>*) <span class="number">0</span> )</span><br><span class="line">	<span class="comment">/* Nope, return a 401 Unauthorized. */</span></span><br><span class="line">		send_authenticate( dirname );<span class="comment">// 发送401未认证错误</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// 如果authorization头中未发现Basic</span></span><br><span class="line">    <span class="comment">/* Basic authorization info? */</span></span><br><span class="line">    <span class="keyword">if</span> ( <span class="built_in">strncmp</span>( authorization, <span class="string">"Basic "</span>, <span class="number">6</span> ) != <span class="number">0</span> )</span><br><span class="line">		send_authenticate( dirname );</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 解码认证信息（最后补0</span></span><br><span class="line">    <span class="comment">/* Decode it. */</span></span><br><span class="line">    l = b64_decode(&amp;(authorization[<span class="number">6</span>]), (<span class="keyword">unsigned</span> <span class="keyword">char</span>*) authinfo, <span class="keyword">sizeof</span>(authinfo) - <span class="number">1</span> );</span><br><span class="line">    authinfo[l] = <span class="string">'\0'</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 从认证信息中获取pass</span></span><br><span class="line">    <span class="comment">/* Split into user and password. */</span></span><br><span class="line">    authpass = <span class="built_in">strchr</span>( authinfo, <span class="string">':'</span> );</span><br><span class="line">    <span class="keyword">if</span> ( authpass == (<span class="keyword">char</span>*) <span class="number">0</span> )</span><br><span class="line">		<span class="comment">/* No colon?  Bogus auth info. */</span></span><br><span class="line">		send_authenticate( dirname );</span><br><span class="line">	*authpass++ = <span class="string">'\0'</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 获取其他字段</span></span><br><span class="line">    <span class="comment">/* If there are more fields, cut them off. */</span></span><br><span class="line">    colon = <span class="built_in">strchr</span>( authpass, <span class="string">':'</span> );</span><br><span class="line">    <span class="keyword">if</span> ( colon != (<span class="keyword">char</span>*) <span class="number">0</span> )</span><br><span class="line">		*colon = <span class="string">'\0'</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 打开认证文件，失败403</span></span><br><span class="line">    <span class="comment">/* Open the password file. */</span></span><br><span class="line">    fp = fopen( authpath, <span class="string">"r"</span> );</span><br><span class="line">    <span class="keyword">if</span> ( fp == (FILE*) <span class="number">0</span> )</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">/* The file exists but we can't open it?  Disallow access. */</span></span><br><span class="line">		syslog(</span><br><span class="line">	    	LOG_ERR, <span class="string">"%.80s auth file %.80s could not be opened - %m"</span>,</span><br><span class="line">	    	ntoa( &amp;client_addr ), authpath );</span><br><span class="line">		send_error( <span class="number">403</span>, <span class="string">"Forbidden"</span>, <span class="string">""</span>, <span class="string">"File is protected."</span> );</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 一行行读取文件</span></span><br><span class="line">    <span class="comment">/* Read it. */</span></span><br><span class="line">    <span class="keyword">while</span> ( fgets( line, <span class="keyword">sizeof</span>(line), fp ) != (<span class="keyword">char</span>*) <span class="number">0</span> )</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">/* Nuke newline. */</span></span><br><span class="line">		l = <span class="built_in">strlen</span>( line );</span><br><span class="line">		<span class="keyword">if</span> ( line[l - <span class="number">1</span>] == <span class="string">'\n'</span> )</span><br><span class="line">	    	line[l - <span class="number">1</span>] = <span class="string">'\0'</span>;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 获取加密后的密码</span></span><br><span class="line">		<span class="comment">/* Split into user and encrypted password. */</span></span><br><span class="line">		cryp = <span class="built_in">strchr</span>( line, <span class="string">':'</span> );</span><br><span class="line">		<span class="keyword">if</span> ( cryp == (<span class="keyword">char</span>*) <span class="number">0</span> )</span><br><span class="line">	    	<span class="keyword">continue</span>;</span><br><span class="line">		*cryp++ = <span class="string">'\0'</span>;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 用户名匹配</span></span><br><span class="line">		<span class="comment">/* Is this the right user? */</span></span><br><span class="line">		<span class="keyword">if</span> ( <span class="built_in">strcmp</span>( line, authinfo ) == <span class="number">0</span> )</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">/* Yes. */</span></span><br><span class="line">			(<span class="keyword">void</span>) fclose( fp );</span><br><span class="line"></span><br><span class="line">			<span class="comment">// 密码也匹配</span></span><br><span class="line">			<span class="comment">/* So is the password right? */</span></span><br><span class="line">			<span class="keyword">if</span> ( <span class="built_in">strcmp</span>( crypt( authpass, cryp ), cryp ) == <span class="number">0</span> )</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="comment">/* Ok! */</span></span><br><span class="line">				remoteuser = line;</span><br><span class="line">				<span class="keyword">return</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="comment">// 密码不匹配</span></span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">				<span class="comment">/* No. */</span></span><br><span class="line">				send_authenticate( dirname );</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Didn't find that user.  Access denied. */</span></span><br><span class="line">    (<span class="keyword">void</span>) fclose( fp );</span><br><span class="line">    send_authenticate( dirname );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="main"><a href="#main" class="headerlink" title="main"></a>main</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">( <span class="keyword">int</span> argc, <span class="keyword">char</span>** argv )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> argn; <span class="comment">// 参数index，作下标</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">passwd</span>* <span class="title">pwd</span>;</span></span><br><span class="line">    <span class="keyword">uid_t</span> uid = <span class="number">32767</span>;</span><br><span class="line">    <span class="keyword">gid_t</span> gid = <span class="number">32767</span>;</span><br><span class="line">    usockaddr host_addr4;</span><br><span class="line">    usockaddr host_addr6;</span><br><span class="line">    <span class="keyword">int</span> gotv4, gotv6;</span><br><span class="line">    fd_set lfdset;</span><br><span class="line">    <span class="keyword">int</span> maxfd;</span><br><span class="line">    usockaddr usa;</span><br><span class="line">    <span class="keyword">socklen_t</span> sz;</span><br><span class="line">    <span class="keyword">int</span> r;</span><br><span class="line">    <span class="keyword">char</span>* cp;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 变量初始化，解析后再赋其它值</span></span><br><span class="line">    <span class="comment">/* Parse args. */</span></span><br><span class="line">    argv0 = argv[<span class="number">0</span>];</span><br><span class="line">    debug = <span class="number">0</span>;</span><br><span class="line">    port = <span class="number">0</span>;</span><br><span class="line">    dir = (<span class="keyword">char</span>*) <span class="number">0</span>;</span><br><span class="line">    data_dir = (<span class="keyword">char</span>*) <span class="number">0</span>;</span><br><span class="line">    do_chroot = <span class="number">0</span>;</span><br><span class="line">    vhost = <span class="number">0</span>;</span><br><span class="line">    cgi_pattern = (<span class="keyword">char</span>*) <span class="number">0</span>;</span><br><span class="line">    url_pattern = (<span class="keyword">char</span>*) <span class="number">0</span>;</span><br><span class="line">    no_empty_referrers = <span class="number">0</span>;</span><br><span class="line">    local_pattern = (<span class="keyword">char</span>*) <span class="number">0</span>;</span><br><span class="line">    charset = DEFAULT_CHARSET;</span><br><span class="line">    p3p = (<span class="keyword">char</span>*) <span class="number">0</span>;</span><br><span class="line">    max_age = <span class="number">-1</span>;</span><br><span class="line">    user = DEFAULT_USER;<span class="comment">// 启动此程序的用户，默认nobody</span></span><br><span class="line">    hostname = (<span class="keyword">char</span>*) <span class="number">0</span>;</span><br><span class="line">    logfile = (<span class="keyword">char</span>*) <span class="number">0</span>;</span><br><span class="line">    pidfile = (<span class="keyword">char</span>*) <span class="number">0</span>;</span><br><span class="line">    logfp = (FILE*) <span class="number">0</span>;</span><br><span class="line">    do_ssl = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果开启ssl，则设置证书和cipher</span></span><br><span class="line">	<span class="meta">#<span class="meta-keyword">ifdef</span> USE_SSL</span></span><br><span class="line">    certfile = DEFAULT_CERTFILE;</span><br><span class="line">    cipher = (<span class="keyword">char</span>*) <span class="number">0</span>;</span><br><span class="line">	<span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* USE_SSL */</span></span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 解析参数</span></span><br><span class="line">    argn = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">while</span> ( argn &lt; argc &amp;&amp; argv[argn][<span class="number">0</span>] == <span class="string">'-'</span> )</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// 版本信息</span></span><br><span class="line">		<span class="keyword">if</span> ( <span class="built_in">strcmp</span>( argv[argn], <span class="string">"-V"</span> ) == <span class="number">0</span> )</span><br><span class="line">		&#123;</span><br><span class="line">		    (<span class="keyword">void</span>) <span class="built_in">printf</span>( <span class="string">"%s\n"</span>, SERVER_SOFTWARE );<span class="comment">//"mini_httpd/1.30 26Oct2018"</span></span><br><span class="line">		    <span class="built_in">exit</span>( <span class="number">0</span> );</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// 读取配置</span></span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> ( <span class="built_in">strcmp</span>( argv[argn], <span class="string">"-C"</span> ) == <span class="number">0</span> &amp;&amp; argn + <span class="number">1</span> &lt; argc )</span><br><span class="line">		&#123;</span><br><span class="line">		    ++argn;</span><br><span class="line">		    read_config( argv[argn] );</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// 开启调试</span></span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> ( <span class="built_in">strcmp</span>( argv[argn], <span class="string">"-D"</span> ) == <span class="number">0</span> )</span><br><span class="line">		    debug = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 若开启ssl，则标志置1，并设置证书和密码</span></span><br><span class="line">		<span class="meta">#<span class="meta-keyword">ifdef</span> USE_SSL</span></span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> ( <span class="built_in">strcmp</span>( argv[argn], <span class="string">"-S"</span> ) == <span class="number">0</span> )</span><br><span class="line">		    do_ssl = <span class="number">1</span>;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> ( <span class="built_in">strcmp</span>( argv[argn], <span class="string">"-E"</span> ) == <span class="number">0</span> &amp;&amp; argn + <span class="number">1</span> &lt; argc )</span><br><span class="line">		&#123;</span><br><span class="line">		    ++argn;</span><br><span class="line">		    certfile = argv[argn];</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> ( <span class="built_in">strcmp</span>( argv[argn], <span class="string">"-Y"</span> ) == <span class="number">0</span> &amp;&amp; argn + <span class="number">1</span> &lt; argc )</span><br><span class="line">		&#123;</span><br><span class="line">		    ++argn;</span><br><span class="line">		    cipher = argv[argn];</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* USE_SSL */</span></span></span><br><span class="line"></span><br><span class="line">		<span class="comment">// 指定端口</span></span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> ( <span class="built_in">strcmp</span>( argv[argn], <span class="string">"-p"</span> ) == <span class="number">0</span> &amp;&amp; argn + <span class="number">1</span> &lt; argc )</span><br><span class="line">		&#123;</span><br><span class="line">		    ++argn;</span><br><span class="line">		    port = (<span class="keyword">unsigned</span> <span class="keyword">short</span>) atoi( argv[argn] );<span class="comment">// 字符串转数字</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// 指定路径</span></span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> ( <span class="built_in">strcmp</span>( argv[argn], <span class="string">"-d"</span> ) == <span class="number">0</span> &amp;&amp; argn + <span class="number">1</span> &lt; argc )</span><br><span class="line">		&#123;</span><br><span class="line">		    ++argn;</span><br><span class="line">		    dir = argv[argn];</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// 指定数据路径</span></span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> ( <span class="built_in">strcmp</span>( argv[argn], <span class="string">"-dd"</span> ) == <span class="number">0</span> &amp;&amp; argn + <span class="number">1</span> &lt; argc )</span><br><span class="line">		&#123;</span><br><span class="line">		    ++argn;</span><br><span class="line">		    data_dir = argv[argn];</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// 指定cgi模式</span></span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> ( <span class="built_in">strcmp</span>( argv[argn], <span class="string">"-c"</span> ) == <span class="number">0</span> &amp;&amp; argn + <span class="number">1</span> &lt; argc )</span><br><span class="line">		&#123;</span><br><span class="line">		    ++argn;</span><br><span class="line">		    cgi_pattern = argv[argn];</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// 指定用户</span></span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> ( <span class="built_in">strcmp</span>( argv[argn], <span class="string">"-u"</span> ) == <span class="number">0</span> &amp;&amp; argn + <span class="number">1</span> &lt; argc )</span><br><span class="line">		&#123;</span><br><span class="line">		    ++argn;</span><br><span class="line">		    user = argv[argn];</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// 指定主机名</span></span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> ( <span class="built_in">strcmp</span>( argv[argn], <span class="string">"-h"</span> ) == <span class="number">0</span> &amp;&amp; argn + <span class="number">1</span> &lt; argc )</span><br><span class="line">		&#123;</span><br><span class="line">		    ++argn;</span><br><span class="line">		    hostname = argv[argn];</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> ( <span class="built_in">strcmp</span>( argv[argn], <span class="string">"-r"</span> ) == <span class="number">0</span> )</span><br><span class="line">		    do_chroot = <span class="number">1</span>;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> ( <span class="built_in">strcmp</span>( argv[argn], <span class="string">"-v"</span> ) == <span class="number">0</span> )</span><br><span class="line">		    vhost = <span class="number">1</span>;</span><br><span class="line">		<span class="comment">// 指定日志文件</span></span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> ( <span class="built_in">strcmp</span>( argv[argn], <span class="string">"-l"</span> ) == <span class="number">0</span> &amp;&amp; argn + <span class="number">1</span> &lt; argc )</span><br><span class="line">		&#123;</span><br><span class="line">		    ++argn;</span><br><span class="line">		    logfile = argv[argn];</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// 指定pid文件</span></span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> ( <span class="built_in">strcmp</span>( argv[argn], <span class="string">"-i"</span> ) == <span class="number">0</span> &amp;&amp; argn + <span class="number">1</span> &lt; argc )</span><br><span class="line">		&#123;</span><br><span class="line">		    ++argn;</span><br><span class="line">		    pidfile = argv[argn];</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// 指定编码集</span></span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> ( <span class="built_in">strcmp</span>( argv[argn], <span class="string">"-T"</span> ) == <span class="number">0</span> &amp;&amp; argn + <span class="number">1</span> &lt; argc )</span><br><span class="line">		&#123;</span><br><span class="line">		    ++argn;</span><br><span class="line">		    charset = argv[argn];</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// here</span></span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> ( <span class="built_in">strcmp</span>( argv[argn], <span class="string">"-P"</span> ) == <span class="number">0</span> &amp;&amp; argn + <span class="number">1</span> &lt; argc )</span><br><span class="line">		&#123;</span><br><span class="line">		    ++argn;</span><br><span class="line">		    p3p = argv[argn];</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// here</span></span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> ( <span class="built_in">strcmp</span>( argv[argn], <span class="string">"-M"</span> ) == <span class="number">0</span> &amp;&amp; argn + <span class="number">1</span> &lt; argc )</span><br><span class="line">		&#123;</span><br><span class="line">		    ++argn;</span><br><span class="line">		    max_age = atoi( argv[argn] );</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// 无参数则打印帮助</span></span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		    usage();</span><br><span class="line">		++argn;</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="keyword">if</span> ( argn != argc )</span><br><span class="line">		usage();</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 守护进程日志相关</span></span><br><span class="line">	<span class="comment">// 获取程序名称</span></span><br><span class="line">    cp = <span class="built_in">strrchr</span>( argv0, <span class="string">'/'</span> );<span class="comment">// 返回 str 中最后一次出现字符 c 的位置，未找到返回空指针</span></span><br><span class="line">    <span class="keyword">if</span> ( cp != (<span class="keyword">char</span>*) <span class="number">0</span> )</span><br><span class="line">		++cp;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">		cp = argv0;</span><br><span class="line">	<span class="comment">// 为syslog作准备</span></span><br><span class="line">    openlog( cp, LOG_NDELAY|LOG_PID, LOG_DAEMON );<span class="comment">// C库函数，守护进程日志共三函数：openlog、syslog、closelog，前后两个非必须</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置web端口</span></span><br><span class="line">    <span class="keyword">if</span> ( port == <span class="number">0</span> )</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="meta">#<span class="meta-keyword">ifdef</span> USE_SSL</span></span><br><span class="line">		<span class="keyword">if</span> ( do_ssl )</span><br><span class="line">	    	port = DEFAULT_HTTPS_PORT;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">	    	port = DEFAULT_HTTP_PORT;</span><br><span class="line">		<span class="meta">#<span class="meta-keyword">else</span> <span class="comment">/* USE_SSL */</span></span></span><br><span class="line">			port = DEFAULT_HTTP_PORT;</span><br><span class="line">		<span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* USE_SSL */</span></span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* If we're root and we're going to become another user, get the uid/gid now.*/</span></span><br><span class="line">    <span class="keyword">if</span> ( getuid() == <span class="number">0</span> )<span class="comment">// 获取调用此进程的用户id，root的uid=0</span></span><br><span class="line">	&#123;</span><br><span class="line">		pwd = getpwnam( user );<span class="comment">// 获取当前用户的passwd结构（从/etc/passwd中获取记录</span></span><br><span class="line">		<span class="keyword">if</span> ( pwd == (struct passwd*) <span class="number">0</span> )<span class="comment">// 未找到此用户，则记录日志并报错</span></span><br><span class="line">	    &#123;</span><br><span class="line">	    	syslog( LOG_CRIT, <span class="string">"unknown user - '%s'"</span>, user );<span class="comment">// 写入/var/log/messages，这是syslogd守护进程的（系统级别），与本httpd的日志不同</span></span><br><span class="line">	    	(<span class="keyword">void</span>) <span class="built_in">fprintf</span>( <span class="built_in">stderr</span>, <span class="string">"%s: unknown user - '%s'\n"</span>, argv0, user );<span class="comment">// 报错到标准错误流，stderr和stdout默认都是打印到屏幕上</span></span><br><span class="line">	    	<span class="built_in">exit</span>( <span class="number">1</span> );</span><br><span class="line">	    &#125;</span><br><span class="line">	    <span class="comment">// 获取当前用户的uid和gid</span></span><br><span class="line">		uid = pwd-&gt;pw_uid;</span><br><span class="line">		gid = pwd-&gt;pw_gid;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 改变日志文件的所有者为指定的用户 </span></span><br><span class="line">    <span class="comment">/* Log file. */</span></span><br><span class="line">    <span class="keyword">if</span> ( logfile != (<span class="keyword">char</span>*) <span class="number">0</span> )</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">//打开指定的日志文件：若打开失败、若日志文件不是以绝对路径的方式</span></span><br><span class="line">		logfp = fopen( logfile, <span class="string">"a"</span> );</span><br><span class="line">		<span class="keyword">if</span> ( logfp == (FILE*) <span class="number">0</span> )</span><br><span class="line">		&#123;</span><br><span class="line">		    syslog( LOG_CRIT, <span class="string">"%s - %m"</span>, logfile );</span><br><span class="line">		    perror( logfile );<span class="comment">//将上一个函数发生错误的原因输出到标准错误(stderr).</span></span><br><span class="line">		    <span class="built_in">exit</span>( <span class="number">1</span> );</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> ( logfile[<span class="number">0</span>] != <span class="string">'/'</span> )</span><br><span class="line">		&#123;</span><br><span class="line">		    syslog( LOG_WARNING, <span class="string">"logfile is not an absolute path, you may not be able to re-open it"</span> );</span><br><span class="line">		    (<span class="keyword">void</span>) <span class="built_in">fprintf</span>( <span class="built_in">stderr</span>, <span class="string">"%s: logfile is not an absolute path, you may not be able to re-open it\n"</span>, argv0 );</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//日志文件打开正常</span></span><br><span class="line">		<span class="keyword">if</span> ( getuid() == <span class="number">0</span> )</span><br><span class="line">		&#123;</span><br><span class="line">		    <span class="comment">/* If we are root then we chown the log file to the user we'll be switching to.*/</span></span><br><span class="line">			<span class="keyword">if</span> ( fchown( fileno( logfp ), uid, gid ) &lt; <span class="number">0</span> )<span class="comment">// fd = fileno(fp)获取文件描述符、fchown改变文件的所有者</span></span><br><span class="line">			&#123;</span><br><span class="line">				syslog( LOG_WARNING, <span class="string">"fchown logfile - %m"</span> );</span><br><span class="line">				perror( <span class="string">"fchown logfile"</span> );</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// here</span></span><br><span class="line">    <span class="comment">/* Look up hostname. */</span></span><br><span class="line">    lookup_hostname(&amp;host_addr4, <span class="keyword">sizeof</span>(host_addr4), &amp;gotv4,&amp;host_addr6, <span class="keyword">sizeof</span>(host_addr6), &amp;gotv6 );</span><br><span class="line">    <span class="keyword">if</span> ( hostname == (<span class="keyword">char</span>*) <span class="number">0</span> )</span><br><span class="line">	&#123;</span><br><span class="line">		(<span class="keyword">void</span>) gethostname( hostname_buf, <span class="keyword">sizeof</span>(hostname_buf) );</span><br><span class="line">		hostname = hostname_buf;</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="keyword">if</span> ( ! ( gotv4 || gotv6 ) )</span><br><span class="line">	&#123;</span><br><span class="line">		syslog( LOG_CRIT, <span class="string">"can't find any valid address"</span> );</span><br><span class="line">		(<span class="keyword">void</span>) <span class="built_in">fprintf</span>( <span class="built_in">stderr</span>, <span class="string">"%s: can't find any valid address\n"</span>, argv0 );</span><br><span class="line">		<span class="built_in">exit</span>( <span class="number">1</span> );</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Initialize listen sockets.  Try v6 first because of a Linux peculiarity;</span></span><br><span class="line"><span class="comment">    ** like some other systems, it has magical v6 sockets that also listen for</span></span><br><span class="line"><span class="comment">    ** v4, but in Linux if you bind a v4 socket first then the v6 bind fails.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">if</span> ( gotv6 )</span><br><span class="line">	listen6_fd = initialize_listen_socket( &amp;host_addr6 );</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">	listen6_fd = <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">if</span> ( gotv4 )</span><br><span class="line">	listen4_fd = initialize_listen_socket( &amp;host_addr4 );</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">	listen4_fd = <span class="number">-1</span>;</span><br><span class="line">    <span class="comment">/* If we didn't get any valid sockets, fail. */</span></span><br><span class="line">    <span class="keyword">if</span> ( listen4_fd == <span class="number">-1</span> &amp;&amp; listen6_fd == <span class="number">-1</span> )</span><br><span class="line">	&#123;</span><br><span class="line">	syslog( LOG_CRIT, <span class="string">"can't bind to any address"</span> );</span><br><span class="line">	(<span class="keyword">void</span>) <span class="built_in">fprintf</span>( <span class="built_in">stderr</span>, <span class="string">"%s: can't bind to any address\n"</span>, argv0 );</span><br><span class="line">	<span class="built_in">exit</span>( <span class="number">1</span> );</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> USE_SSL</span></span><br><span class="line">    <span class="keyword">if</span> ( do_ssl )</span><br><span class="line">	&#123;</span><br><span class="line">	SSL_load_error_strings();</span><br><span class="line">	SSLeay_add_ssl_algorithms();</span><br><span class="line">	ssl_ctx = SSL_CTX_new( SSLv23_server_method() );</span><br><span class="line">	SSL_CTX_set_options( ssl_ctx, SSL_OP_NO_SSLv2|SSL_OP_NO_SSLv3 );</span><br><span class="line">	<span class="keyword">if</span> ( certfile[<span class="number">0</span>] != <span class="string">'\0'</span> )</span><br><span class="line">	    <span class="keyword">if</span> ( SSL_CTX_use_certificate_file( ssl_ctx, certfile, SSL_FILETYPE_PEM ) == <span class="number">0</span> ||</span><br><span class="line">		 SSL_CTX_use_certificate_chain_file( ssl_ctx, certfile ) == <span class="number">0</span> ||</span><br><span class="line">		 SSL_CTX_use_PrivateKey_file( ssl_ctx, certfile, SSL_FILETYPE_PEM ) == <span class="number">0</span> ||</span><br><span class="line">		 SSL_CTX_check_private_key( ssl_ctx ) == <span class="number">0</span> )</span><br><span class="line">		&#123;</span><br><span class="line">		ERR_print_errors_fp( <span class="built_in">stderr</span> );</span><br><span class="line">		<span class="built_in">exit</span>( <span class="number">1</span> );</span><br><span class="line">		&#125;</span><br><span class="line">	<span class="keyword">if</span> ( cipher != (<span class="keyword">char</span>*) <span class="number">0</span> )</span><br><span class="line">	    &#123;</span><br><span class="line">	    <span class="keyword">if</span> ( SSL_CTX_set_cipher_list( ssl_ctx, cipher ) == <span class="number">0</span> )</span><br><span class="line">		&#123;</span><br><span class="line">		ERR_print_errors_fp( <span class="built_in">stderr</span> );</span><br><span class="line">		<span class="built_in">exit</span>( <span class="number">1</span> );</span><br><span class="line">		&#125;</span><br><span class="line">	    &#125;</span><br><span class="line">	&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* USE_SSL */</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ( ! debug )</span><br><span class="line">	&#123;</span><br><span class="line">	<span class="comment">/* Make ourselves a daemon. */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> HAVE_DAEMON</span></span><br><span class="line">	<span class="keyword">if</span> ( daemon( <span class="number">1</span>, <span class="number">1</span> ) &lt; <span class="number">0</span> )</span><br><span class="line">	    &#123;</span><br><span class="line">	    syslog( LOG_CRIT, <span class="string">"daemon - %m"</span> );</span><br><span class="line">	    perror( <span class="string">"daemon"</span> );</span><br><span class="line">	    <span class="built_in">exit</span>( <span class="number">1</span> );</span><br><span class="line">	    &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">	<span class="keyword">switch</span> ( fork() )</span><br><span class="line">	    &#123;</span><br><span class="line">	    <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">	    <span class="keyword">break</span>;</span><br><span class="line">	    <span class="keyword">case</span> <span class="number">-1</span>:</span><br><span class="line">	    syslog( LOG_CRIT, <span class="string">"fork - %m"</span> );</span><br><span class="line">	    perror( <span class="string">"fork"</span> );</span><br><span class="line">	    <span class="built_in">exit</span>( <span class="number">1</span> );</span><br><span class="line">	    <span class="keyword">default</span>:</span><br><span class="line">	    <span class="built_in">exit</span>( <span class="number">0</span> );</span><br><span class="line">	    &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> HAVE_SETSID</span></span><br><span class="line">	(<span class="keyword">void</span>) setsid();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	&#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">	<span class="comment">/* Even if we don't daemonize, we still want to disown our parent</span></span><br><span class="line"><span class="comment">	** process.</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">#ifdef HAVE_SETSID</span><br><span class="line">	(<span class="keyword">void</span>) setsid();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* HAVE_SETSID */</span></span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ( pidfile != (<span class="keyword">char</span>*) <span class="number">0</span> )</span><br><span class="line">        &#123;</span><br><span class="line">	<span class="comment">/* Write the PID file. */</span></span><br><span class="line">	FILE* pidfp = fopen( pidfile, <span class="string">"w"</span> );</span><br><span class="line">        <span class="keyword">if</span> ( pidfp == (FILE*) <span class="number">0</span> )</span><br><span class="line">            &#123;</span><br><span class="line">	    syslog( LOG_CRIT, <span class="string">"%s - %m"</span>, pidfile );</span><br><span class="line">	    perror( pidfile );</span><br><span class="line">            <span class="built_in">exit</span>( <span class="number">1</span> );</span><br><span class="line">            &#125;</span><br><span class="line">        (<span class="keyword">void</span>) <span class="built_in">fprintf</span>( pidfp, <span class="string">"%d\n"</span>, (<span class="keyword">int</span>) getpid() );</span><br><span class="line">        (<span class="keyword">void</span>) fclose( pidfp );</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Read zone info now, in case we chroot(). */</span></span><br><span class="line">    tzset();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* If we're root, start becoming someone else. */</span></span><br><span class="line">    <span class="keyword">if</span> ( getuid() == <span class="number">0</span> )</span><br><span class="line">	&#123;</span><br><span class="line">	<span class="comment">/* Set aux groups to null. */</span></span><br><span class="line">	<span class="keyword">if</span> ( setgroups( <span class="number">0</span>, (<span class="keyword">gid_t</span>*) <span class="number">0</span> ) &lt; <span class="number">0</span> )</span><br><span class="line">	    &#123;</span><br><span class="line">	    syslog( LOG_CRIT, <span class="string">"setgroups - %m"</span> );</span><br><span class="line">	    perror( <span class="string">"setgroups"</span> );</span><br><span class="line">	    <span class="built_in">exit</span>( <span class="number">1</span> );</span><br><span class="line">	    &#125;</span><br><span class="line">	<span class="comment">/* Set primary group. */</span></span><br><span class="line">	<span class="keyword">if</span> ( setgid( gid ) &lt; <span class="number">0</span> )</span><br><span class="line">	    &#123;</span><br><span class="line">	    syslog( LOG_CRIT, <span class="string">"setgid - %m"</span> );</span><br><span class="line">	    perror( <span class="string">"setgid"</span> );</span><br><span class="line">	    <span class="built_in">exit</span>( <span class="number">1</span> );</span><br><span class="line">	    &#125;</span><br><span class="line">	<span class="comment">/* Try setting aux groups correctly - not critical if this fails. */</span></span><br><span class="line">	<span class="keyword">if</span> ( initgroups( user, gid ) &lt; <span class="number">0</span> )</span><br><span class="line">	    &#123;</span><br><span class="line">	    syslog( LOG_ERR, <span class="string">"initgroups - %m"</span> );</span><br><span class="line">	    perror( <span class="string">"initgroups"</span> );</span><br><span class="line">	    &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> HAVE_SETLOGIN</span></span><br><span class="line">	<span class="comment">/* Set login name. */</span></span><br><span class="line">	(<span class="keyword">void</span>) setlogin( user );</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* HAVE_SETLOGIN */</span></span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Switch directories if requested. */</span></span><br><span class="line">    <span class="keyword">if</span> ( dir != (<span class="keyword">char</span>*) <span class="number">0</span> )</span><br><span class="line">	&#123;</span><br><span class="line">	<span class="keyword">if</span> ( chdir( dir ) &lt; <span class="number">0</span> )</span><br><span class="line">	    &#123;</span><br><span class="line">	    syslog( LOG_CRIT, <span class="string">"chdir - %m"</span> );</span><br><span class="line">	    perror( <span class="string">"chdir"</span> );</span><br><span class="line">	    <span class="built_in">exit</span>( <span class="number">1</span> );</span><br><span class="line">	    &#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Get current directory. */</span></span><br><span class="line">    (<span class="keyword">void</span>) getcwd( cwd, <span class="keyword">sizeof</span>(cwd) - <span class="number">1</span> );</span><br><span class="line">    <span class="keyword">if</span> ( cwd[<span class="built_in">strlen</span>( cwd ) - <span class="number">1</span>] != <span class="string">'/'</span> )</span><br><span class="line">	(<span class="keyword">void</span>) <span class="built_in">strcat</span>( cwd, <span class="string">"/"</span> );</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Chroot if requested. */</span></span><br><span class="line">    <span class="keyword">if</span> ( do_chroot )</span><br><span class="line">	&#123;</span><br><span class="line">	<span class="keyword">if</span> ( chroot( cwd ) &lt; <span class="number">0</span> )</span><br><span class="line">	    &#123;</span><br><span class="line">	    syslog( LOG_CRIT, <span class="string">"chroot - %m"</span> );</span><br><span class="line">	    perror( <span class="string">"chroot"</span> );</span><br><span class="line">	    <span class="built_in">exit</span>( <span class="number">1</span> );</span><br><span class="line">	    &#125;</span><br><span class="line">	<span class="comment">/* If we're logging and the logfile's pathname begins with the</span></span><br><span class="line"><span class="comment">	** chroot tree's pathname, then elide the chroot pathname so</span></span><br><span class="line"><span class="comment">	** that the logfile pathname still works from inside the chroot</span></span><br><span class="line"><span class="comment">	** tree.</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">	<span class="keyword">if</span> ( logfile != (<span class="keyword">char</span>*) <span class="number">0</span> )</span><br><span class="line">	    &#123;</span><br><span class="line">	    <span class="keyword">if</span> ( <span class="built_in">strncmp</span>( logfile, cwd, <span class="built_in">strlen</span>( cwd ) ) == <span class="number">0</span> )</span><br><span class="line">		&#123;</span><br><span class="line">		(<span class="keyword">void</span>) ol_strcpy( logfile, &amp;logfile[<span class="built_in">strlen</span>( cwd ) - <span class="number">1</span>] );</span><br><span class="line">		<span class="comment">/* (We already guaranteed that cwd ends with a slash, so leaving</span></span><br><span class="line"><span class="comment">		** that slash in logfile makes it an absolute pathname within</span></span><br><span class="line"><span class="comment">		** the chroot tree.)</span></span><br><span class="line"><span class="comment">		*/</span></span><br><span class="line">		&#125;</span><br><span class="line">	    <span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">		syslog( LOG_WARNING, <span class="string">"logfile is not within the chroot tree, you will not be able to re-open it"</span> );</span><br><span class="line">		(<span class="keyword">void</span>) <span class="built_in">fprintf</span>( <span class="built_in">stderr</span>, <span class="string">"%s: logfile is not within the chroot tree, you will not be able to re-open it\n"</span>, argv0 );</span><br><span class="line">		&#125;</span><br><span class="line">	    &#125;</span><br><span class="line">	(<span class="keyword">void</span>) <span class="built_in">strcpy</span>( cwd, <span class="string">"/"</span> );</span><br><span class="line">	<span class="comment">/* Always chdir to / after a chroot. */</span></span><br><span class="line">	<span class="keyword">if</span> ( chdir( cwd ) &lt; <span class="number">0</span> )</span><br><span class="line">	    &#123;</span><br><span class="line">	    syslog( LOG_CRIT, <span class="string">"chroot chdir - %m"</span> );</span><br><span class="line">	    perror( <span class="string">"chroot chdir"</span> );</span><br><span class="line">	    <span class="built_in">exit</span>( <span class="number">1</span> );</span><br><span class="line">	    &#125;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Switch directories again if requested. */</span></span><br><span class="line">    <span class="keyword">if</span> ( data_dir != (<span class="keyword">char</span>*) <span class="number">0</span> )</span><br><span class="line">	&#123;</span><br><span class="line">	<span class="keyword">if</span> ( chdir( data_dir ) &lt; <span class="number">0</span> )</span><br><span class="line">	    &#123;</span><br><span class="line">	    syslog( LOG_CRIT, <span class="string">"data_dir chdir - %m"</span> );</span><br><span class="line">	    perror( <span class="string">"data_dir chdir"</span> );</span><br><span class="line">	    <span class="built_in">exit</span>( <span class="number">1</span> );</span><br><span class="line">	    &#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* If we're root, become someone else. */</span></span><br><span class="line">    <span class="keyword">if</span> ( getuid() == <span class="number">0</span> )</span><br><span class="line">	&#123;</span><br><span class="line">	<span class="comment">/* Set uid. */</span></span><br><span class="line">	<span class="keyword">if</span> ( setuid( uid ) &lt; <span class="number">0</span> )</span><br><span class="line">	    &#123;</span><br><span class="line">	    syslog( LOG_CRIT, <span class="string">"setuid - %m"</span> );</span><br><span class="line">	    perror( <span class="string">"setuid"</span> );</span><br><span class="line">	    <span class="built_in">exit</span>( <span class="number">1</span> );</span><br><span class="line">	    &#125;</span><br><span class="line">	<span class="comment">/* Check for unnecessary security exposure. */</span></span><br><span class="line">	<span class="keyword">if</span> ( ! do_chroot )</span><br><span class="line">	    &#123;</span><br><span class="line">	    syslog( LOG_WARNING,</span><br><span class="line">		<span class="string">"started as root without requesting chroot(), warning only"</span> );</span><br><span class="line">	    (<span class="keyword">void</span>) <span class="built_in">fprintf</span>( <span class="built_in">stderr</span>,</span><br><span class="line">		<span class="string">"%s: started as root without requesting chroot(), warning only\n"</span>, argv0 );</span><br><span class="line">	    &#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Catch various signals. */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> HAVE_SIGSET</span></span><br><span class="line">    (<span class="keyword">void</span>) sigset( SIGTERM, handle_sigterm );</span><br><span class="line">    (<span class="keyword">void</span>) sigset( SIGINT, handle_sigterm );</span><br><span class="line">    (<span class="keyword">void</span>) sigset( SIGUSR1, handle_sigterm );</span><br><span class="line">    (<span class="keyword">void</span>) sigset( SIGHUP, handle_sighup );</span><br><span class="line">    (<span class="keyword">void</span>) sigset( SIGCHLD, handle_sigchld );</span><br><span class="line">    (<span class="keyword">void</span>) sigset( SIGPIPE, SIG_IGN );</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span> <span class="comment">/* HAVE_SIGSET */</span></span></span><br><span class="line">    (<span class="keyword">void</span>) signal( SIGTERM, handle_sigterm );</span><br><span class="line">    (<span class="keyword">void</span>) signal( SIGINT, handle_sigterm );</span><br><span class="line">    (<span class="keyword">void</span>) signal( SIGUSR1, handle_sigterm );</span><br><span class="line">    (<span class="keyword">void</span>) signal( SIGHUP, handle_sighup );</span><br><span class="line">    (<span class="keyword">void</span>) signal( SIGCHLD, handle_sigchld );</span><br><span class="line">    (<span class="keyword">void</span>) signal( SIGPIPE, SIG_IGN );</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* HAVE_SIGSET */</span></span></span><br><span class="line">    got_hup = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    init_mime();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ( hostname == (<span class="keyword">char</span>*) <span class="number">0</span> )</span><br><span class="line">	syslog(</span><br><span class="line">	    LOG_NOTICE, <span class="string">"%.80s starting on port %d"</span>, SERVER_SOFTWARE,</span><br><span class="line">	    (<span class="keyword">int</span>) port );</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">	syslog(</span><br><span class="line">	    LOG_NOTICE, <span class="string">"%.80s starting on %.80s, port %d"</span>, SERVER_SOFTWARE,</span><br><span class="line">	    hostname, (<span class="keyword">int</span>) port );</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Main loop. */</span></span><br><span class="line">    <span class="keyword">for</span> (;;)</span><br><span class="line">	&#123;</span><br><span class="line">	<span class="comment">/* Do we need to re-open the log file? */</span></span><br><span class="line">	<span class="keyword">if</span> ( got_hup )</span><br><span class="line">	    &#123;</span><br><span class="line">	    re_open_logfile();</span><br><span class="line">	    got_hup = <span class="number">0</span>;</span><br><span class="line">	    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Do a select() on at least one and possibly two listen fds.</span></span><br><span class="line"><span class="comment">	** If there's only one listen fd then we could skip the select</span></span><br><span class="line"><span class="comment">	** and just do the (blocking) accept(), saving one system call;</span></span><br><span class="line"><span class="comment">	** that's what happened up through version 1.18.  However there</span></span><br><span class="line"><span class="comment">	** is one slight drawback to that method: the blocking accept()</span></span><br><span class="line"><span class="comment">	** is not interrupted by a signal call.  Since we definitely want</span></span><br><span class="line"><span class="comment">	** signals to interrupt a waiting server, we use select() even</span></span><br><span class="line"><span class="comment">	** if there's only one fd.</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">	FD_ZERO( &amp;lfdset );</span><br><span class="line">	maxfd = <span class="number">-1</span>;</span><br><span class="line">	<span class="keyword">if</span> ( listen4_fd != <span class="number">-1</span> )</span><br><span class="line">	    &#123;</span><br><span class="line">	    FD_SET( listen4_fd, &amp;lfdset );</span><br><span class="line">	    <span class="keyword">if</span> ( listen4_fd &gt; maxfd )</span><br><span class="line">		maxfd = listen4_fd;</span><br><span class="line">	    &#125;</span><br><span class="line">	<span class="keyword">if</span> ( listen6_fd != <span class="number">-1</span> )</span><br><span class="line">	    &#123;</span><br><span class="line">	    FD_SET( listen6_fd, &amp;lfdset );</span><br><span class="line">	    <span class="keyword">if</span> ( listen6_fd &gt; maxfd )</span><br><span class="line">		maxfd = listen6_fd;</span><br><span class="line">	    &#125;</span><br><span class="line">	<span class="keyword">if</span> ( select( maxfd + <span class="number">1</span>, &amp;lfdset, (fd_set*) <span class="number">0</span>, (fd_set*) <span class="number">0</span>, (struct timeval*) <span class="number">0</span> ) &lt; <span class="number">0</span> )</span><br><span class="line">	    &#123;</span><br><span class="line">	    <span class="keyword">if</span> ( errno == EINTR || errno == EAGAIN )</span><br><span class="line">		<span class="keyword">continue</span>;	<span class="comment">/* try again */</span></span><br><span class="line">	    syslog( LOG_CRIT, <span class="string">"select - %m"</span> );</span><br><span class="line">	    perror( <span class="string">"select"</span> );</span><br><span class="line">	    <span class="built_in">exit</span>( <span class="number">1</span> );</span><br><span class="line">	    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Accept the new connection. */</span></span><br><span class="line">	sz = <span class="keyword">sizeof</span>(usa);</span><br><span class="line">	<span class="keyword">if</span> ( listen4_fd != <span class="number">-1</span> &amp;&amp; FD_ISSET( listen4_fd, &amp;lfdset ) )</span><br><span class="line">	    conn_fd = accept( listen4_fd, &amp;usa.sa, &amp;sz );</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> ( listen6_fd != <span class="number">-1</span> &amp;&amp; FD_ISSET( listen6_fd, &amp;lfdset ) )</span><br><span class="line">	    conn_fd = accept( listen6_fd, &amp;usa.sa, &amp;sz );</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	    &#123;</span><br><span class="line">	    syslog( LOG_CRIT, <span class="string">"select failure"</span> );</span><br><span class="line">	    (<span class="keyword">void</span>) <span class="built_in">fprintf</span>( <span class="built_in">stderr</span>, <span class="string">"%s: select failure\n"</span>, argv0 );</span><br><span class="line">	    <span class="built_in">exit</span>( <span class="number">1</span> );</span><br><span class="line">	    &#125;</span><br><span class="line">	<span class="keyword">if</span> ( conn_fd &lt; <span class="number">0</span> )</span><br><span class="line">	    &#123;</span><br><span class="line">	    <span class="keyword">if</span> ( errno == EINTR || errno == EAGAIN || errno == ECONNABORTED )</span><br><span class="line">		<span class="keyword">continue</span>;	<span class="comment">/* try again */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> EPROTO</span></span><br><span class="line">	    <span class="keyword">if</span> ( errno == EPROTO )</span><br><span class="line">		<span class="keyword">continue</span>;	<span class="comment">/* try again */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* EPROTO */</span></span></span><br><span class="line">	    syslog( LOG_CRIT, <span class="string">"accept - %m"</span> );</span><br><span class="line">	    perror( <span class="string">"accept"</span> );</span><br><span class="line">	    <span class="built_in">exit</span>( <span class="number">1</span> );</span><br><span class="line">	    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Fork a sub-process to handle the connection. */</span></span><br><span class="line">	r = fork();</span><br><span class="line">	<span class="keyword">if</span> ( r &lt; <span class="number">0</span> )</span><br><span class="line">	    &#123;</span><br><span class="line">	    syslog( LOG_CRIT, <span class="string">"fork - %m"</span> );</span><br><span class="line">	    perror( <span class="string">"fork"</span> );</span><br><span class="line">	    <span class="built_in">exit</span>( <span class="number">1</span> );</span><br><span class="line">	    &#125;</span><br><span class="line">	<span class="keyword">if</span> ( r == <span class="number">0</span> )</span><br><span class="line">	    &#123;</span><br><span class="line">	    <span class="comment">/* Child process. */</span></span><br><span class="line">	    client_addr = usa;</span><br><span class="line">	    <span class="keyword">if</span> ( listen4_fd != <span class="number">-1</span> )</span><br><span class="line">		(<span class="keyword">void</span>) close( listen4_fd );</span><br><span class="line">	    <span class="keyword">if</span> ( listen6_fd != <span class="number">-1</span> )</span><br><span class="line">		(<span class="keyword">void</span>) close( listen6_fd );</span><br><span class="line">	    handle_request();</span><br><span class="line">	    &#125;</span><br><span class="line">	(<span class="keyword">void</span>) close( conn_fd );</span><br><span class="line">	&#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h2 id="read-config（main-call"><a href="#read-config（main-call" class="headerlink" title="read_config（main call"></a>read_config（main call</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">read_config</span><span class="params">( <span class="keyword">char</span>* filename )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    FILE* fp;</span><br><span class="line">    <span class="keyword">char</span> line[<span class="number">10000</span>];</span><br><span class="line">    <span class="keyword">char</span>* cp;</span><br><span class="line">    <span class="keyword">char</span>* cp2;</span><br><span class="line">    <span class="keyword">char</span>* name;</span><br><span class="line">    <span class="keyword">char</span>* value;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 打开指定的配置文件（命令行中</span></span><br><span class="line">    fp = fopen( filename, <span class="string">"r"</span> );</span><br><span class="line">    <span class="keyword">if</span> ( fp == (FILE*) <span class="number">0</span> )</span><br><span class="line">	&#123;</span><br><span class="line">		syslog( LOG_CRIT, <span class="string">"%s - %m"</span>, filename );</span><br><span class="line">		perror( filename );</span><br><span class="line">		<span class="built_in">exit</span>( <span class="number">1</span> );</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> ( fgets( line, <span class="keyword">sizeof</span>(line), fp ) != (<span class="keyword">char</span>*) <span class="number">0</span> )<span class="comment">// 读取一行</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">/* Trim comments. */</span></span><br><span class="line">		<span class="keyword">if</span> ( ( cp = <span class="built_in">strchr</span>( line, <span class="string">'#'</span> ) ) != (<span class="keyword">char</span>*) <span class="number">0</span> )<span class="comment">// 处理注释行</span></span><br><span class="line">	    	*cp = <span class="string">'\0'</span>;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* Skip leading whitespace. */</span></span><br><span class="line">		cp = line;</span><br><span class="line">		cp += <span class="built_in">strspn</span>( cp, <span class="string">" \t\012\015"</span> );<span class="comment">// 处理换行，" \t\n\r"</span></span><br><span class="line"></span><br><span class="line">		<span class="comment">/* Split line into words. */</span></span><br><span class="line">		<span class="keyword">while</span> ( *cp != <span class="string">'\0'</span> )</span><br><span class="line">	    &#123;</span><br><span class="line">	    	<span class="comment">/* Find next whitespace. */</span></span><br><span class="line">	    	cp2 = cp + <span class="built_in">strcspn</span>( cp, <span class="string">" \t\012\015"</span> );</span><br><span class="line">	    	<span class="comment">/* Insert EOS and advance next-word pointer. */</span></span><br><span class="line">	    	while ( *cp2 == ' ' || *cp2 == '\t' || *cp2 == '\012' || *cp2 == '\015' )</span><br><span class="line">				*cp2++ = <span class="string">'\0'</span>;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// 获取行中的键值对</span></span><br><span class="line">	    	<span class="comment">/* Split into name and value. */</span></span><br><span class="line">	    	name = cp;</span><br><span class="line">	    	value = <span class="built_in">strchr</span>( name, <span class="string">'='</span> );</span><br><span class="line">	    	<span class="keyword">if</span> ( value != (<span class="keyword">char</span>*) <span class="number">0</span> )</span><br><span class="line">				*value++ = <span class="string">'\0'</span>;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// 分别处理，对相应的name赋值（全局变量</span></span><br><span class="line">	    	<span class="comment">/* Interpret. */</span></span><br><span class="line">	    	<span class="keyword">if</span> ( strcasecmp( name, <span class="string">"debug"</span> ) == <span class="number">0</span> )</span><br><span class="line">			&#123;</span><br><span class="line">				no_value_required( name, value );</span><br><span class="line">				debug = <span class="number">1</span>;<span class="comment">// 只取0/1，则no_</span></span><br><span class="line">			&#125;</span><br><span class="line">	    	<span class="keyword">else</span> <span class="keyword">if</span> ( strcasecmp( name, <span class="string">"port"</span> ) == <span class="number">0</span> )</span><br><span class="line">			&#123;</span><br><span class="line">				value_required( name, value );</span><br><span class="line">				port = (<span class="keyword">unsigned</span> <span class="keyword">short</span>) atoi( value );<span class="comment">// 取具体的值，则没有no_</span></span><br><span class="line">			&#125;</span><br><span class="line">	    	<span class="keyword">else</span> <span class="keyword">if</span> ( strcasecmp( name, <span class="string">"dir"</span> ) == <span class="number">0</span> )</span><br><span class="line">			&#123;</span><br><span class="line">				value_required( name, value );</span><br><span class="line">				dir = e_strdup( value );<span class="comment">//  数字则atoi，字符串则strdup</span></span><br><span class="line">			&#125;</span><br><span class="line">	    	<span class="keyword">else</span> <span class="keyword">if</span> ( strcasecmp( name, <span class="string">"data_dir"</span> ) == <span class="number">0</span> )</span><br><span class="line">			&#123;</span><br><span class="line">				value_required( name, value );</span><br><span class="line">				data_dir = e_strdup( value );</span><br><span class="line">			&#125;</span><br><span class="line">	    	<span class="keyword">else</span> <span class="keyword">if</span> ( strcasecmp( name, <span class="string">"chroot"</span> ) == <span class="number">0</span> )</span><br><span class="line">			&#123;</span><br><span class="line">				no_value_required( name, value );</span><br><span class="line">				do_chroot = <span class="number">1</span>;</span><br><span class="line">			&#125;</span><br><span class="line">	    	<span class="keyword">else</span> <span class="keyword">if</span> ( strcasecmp( name, <span class="string">"nochroot"</span> ) == <span class="number">0</span> )</span><br><span class="line">			&#123;</span><br><span class="line">				no_value_required( name, value );</span><br><span class="line">				do_chroot = <span class="number">0</span>;</span><br><span class="line">			&#125;</span><br><span class="line">	    	<span class="keyword">else</span> <span class="keyword">if</span> ( strcasecmp( name, <span class="string">"user"</span> ) == <span class="number">0</span> )</span><br><span class="line">			&#123;</span><br><span class="line">				value_required( name, value );</span><br><span class="line">				user = e_strdup( value );</span><br><span class="line">			&#125;</span><br><span class="line">	    	<span class="keyword">else</span> <span class="keyword">if</span> ( strcasecmp( name, <span class="string">"cgipat"</span> ) == <span class="number">0</span> )</span><br><span class="line">			&#123;</span><br><span class="line">				value_required( name, value );</span><br><span class="line">				cgi_pattern = e_strdup( value );</span><br><span class="line">			&#125;</span><br><span class="line">	    	<span class="keyword">else</span> <span class="keyword">if</span> ( strcasecmp( name, <span class="string">"urlpat"</span> ) == <span class="number">0</span> )</span><br><span class="line">			&#123;</span><br><span class="line">				value_required( name, value );</span><br><span class="line">				url_pattern = e_strdup( value );</span><br><span class="line">			&#125;</span><br><span class="line">	    	<span class="keyword">else</span> <span class="keyword">if</span> ( strcasecmp( name, <span class="string">"noemptyreferers"</span> ) == <span class="number">0</span> ||strcasecmp( name, <span class="string">"noemptyreferrers"</span> ) == <span class="number">0</span> )</span><br><span class="line">			&#123;</span><br><span class="line">				value_required( name, value );</span><br><span class="line">				no_empty_referrers = <span class="number">1</span>;</span><br><span class="line">			&#125;</span><br><span class="line">	    	<span class="keyword">else</span> <span class="keyword">if</span> ( strcasecmp( name, <span class="string">"localpat"</span> ) == <span class="number">0</span> )</span><br><span class="line">			&#123;</span><br><span class="line">				value_required( name, value );</span><br><span class="line">				local_pattern = e_strdup( value );</span><br><span class="line">			&#125;</span><br><span class="line">	    	<span class="keyword">else</span> <span class="keyword">if</span> ( strcasecmp( name, <span class="string">"host"</span> ) == <span class="number">0</span> )</span><br><span class="line">			&#123;</span><br><span class="line">				value_required( name, value );</span><br><span class="line">				hostname = e_strdup( value );</span><br><span class="line">			&#125;</span><br><span class="line">	    	<span class="keyword">else</span> <span class="keyword">if</span> ( strcasecmp( name, <span class="string">"logfile"</span> ) == <span class="number">0</span> )</span><br><span class="line">			&#123;</span><br><span class="line">				value_required( name, value );</span><br><span class="line">				logfile = e_strdup( value );</span><br><span class="line">			&#125;</span><br><span class="line">	    	<span class="keyword">else</span> <span class="keyword">if</span> ( strcasecmp( name, <span class="string">"vhost"</span> ) == <span class="number">0</span> )</span><br><span class="line">			&#123;</span><br><span class="line">				no_value_required( name, value );</span><br><span class="line">				vhost = <span class="number">1</span>;</span><br><span class="line">			&#125;</span><br><span class="line">	    	<span class="keyword">else</span> <span class="keyword">if</span> ( strcasecmp( name, <span class="string">"pidfile"</span> ) == <span class="number">0</span> )</span><br><span class="line">			&#123;</span><br><span class="line">				value_required( name, value );</span><br><span class="line">				pidfile = e_strdup( value );</span><br><span class="line">			&#125;</span><br><span class="line">	    	<span class="keyword">else</span> <span class="keyword">if</span> ( strcasecmp( name, <span class="string">"charset"</span> ) == <span class="number">0</span> )</span><br><span class="line">			&#123;</span><br><span class="line">				value_required( name, value );</span><br><span class="line">				charset = e_strdup( value );</span><br><span class="line">			&#125;</span><br><span class="line">	    	<span class="keyword">else</span> <span class="keyword">if</span> ( strcasecmp( name, <span class="string">"p3p"</span> ) == <span class="number">0</span> )</span><br><span class="line">			&#123;</span><br><span class="line">				value_required( name, value );</span><br><span class="line">				p3p = e_strdup( value );</span><br><span class="line">			&#125;</span><br><span class="line">	    	<span class="keyword">else</span> <span class="keyword">if</span> ( strcasecmp( name, <span class="string">"max_age"</span> ) == <span class="number">0</span> )</span><br><span class="line">			&#123;</span><br><span class="line">				value_required( name, value );</span><br><span class="line">				max_age = atoi( value );</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="comment">// ssl相关</span></span><br><span class="line">			<span class="meta">#<span class="meta-keyword">ifdef</span> USE_SSL</span></span><br><span class="line">	    	<span class="keyword">else</span> <span class="keyword">if</span> ( strcasecmp( name, <span class="string">"ssl"</span> ) == <span class="number">0</span> )</span><br><span class="line">			&#123;</span><br><span class="line">				no_value_required( name, value );</span><br><span class="line">				do_ssl = <span class="number">1</span>;</span><br><span class="line">			&#125;</span><br><span class="line">	    	<span class="keyword">else</span> <span class="keyword">if</span> ( strcasecmp( name, <span class="string">"certfile"</span> ) == <span class="number">0</span> )</span><br><span class="line">			&#123;</span><br><span class="line">				value_required( name, value );</span><br><span class="line">				certfile = e_strdup( value );</span><br><span class="line">			&#125;</span><br><span class="line">	    	<span class="keyword">else</span> <span class="keyword">if</span> ( strcasecmp( name, <span class="string">"cipher"</span> ) == <span class="number">0</span> )</span><br><span class="line">			&#123;</span><br><span class="line">				value_required( name, value );</span><br><span class="line">				cipher = e_strdup( value );</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* USE_SSL */</span></span></span><br><span class="line">	    	<span class="keyword">else</span></span><br><span class="line">			&#123;</span><br><span class="line">				(<span class="keyword">void</span>) <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"%s: unknown config option '%s'\n"</span>, argv0, name );</span><br><span class="line">				<span class="built_in">exit</span>( <span class="number">1</span> );</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">	    	<span class="comment">/* Advance to next word. */</span></span><br><span class="line">	    	cp = cp2;</span><br><span class="line">	    	cp += <span class="built_in">strspn</span>( cp, <span class="string">" \t\012\015"</span> );</span><br><span class="line">	    &#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    (<span class="keyword">void</span>) fclose( fp );<span class="comment">// 关闭配置文件</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://21guns.top/2021/01/13/iot/Netgear R6220 认证绕过漏洞分析/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="21Guns">
      <meta itemprop="description" content>
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="have a nice day">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/01/13/iot/Netgear R6220 认证绕过漏洞分析/" class="post-title-link" itemprop="url">Netgear R6220 认证绕过漏洞分析</a>
        </h2>

        <div class="post-meta">

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-01-13 15:23:48" itemprop="dateCreated datePublished" datetime="2021-01-13T15:23:48+08:00">2021-01-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-02-21 16:03:01" itemprop="dateModified" datetime="2022-02-21T16:03:01+08:00">2022-02-21</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/IOT安全/" itemprop="url" rel="index"><span itemprop="name">IOT安全</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>[toc]</p>
<h1 id="Netgear-R6220-认证绕过漏洞分析"><a href="#Netgear-R6220-认证绕过漏洞分析" class="headerlink" title="Netgear R6220 认证绕过漏洞分析"></a>Netgear R6220 认证绕过漏洞分析</h1><h2 id="00-前言"><a href="#00-前言" class="headerlink" title="00-前言"></a>00-前言</h2><p>依据cve/zdi等平台发布的漏洞信息，借助补丁对比技术，对Netgear r6220认证绕过漏洞进行研究，涉及漏洞的发现过程、成因分析、POC编写</p>
<h2 id="01-简介"><a href="#01-简介" class="headerlink" title="01-简介"></a>01-简介</h2><ol>
<li><p>漏洞描述：<a href="https://www.zerodayinitiative.com/advisories/ZDI-19-866/" target="_blank" rel="noopener">https://www.zerodayinitiative.com/advisories/ZDI-19-866/</a>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2021/01/13/iot/Netgear R6220 认证绕过漏洞分析/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </p></li></ol></div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://21guns.top/2021/01/10/iot/硬件法提取固件概述/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="21Guns">
      <meta itemprop="description" content>
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="have a nice day">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/01/10/iot/硬件法提取固件概述/" class="post-title-link" itemprop="url">硬件法提取固件概述</a>
        </h2>

        <div class="post-meta">

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-01-10 09:23:44" itemprop="dateCreated datePublished" datetime="2021-01-10T09:23:44+08:00">2021-01-10</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-02-21 17:48:46" itemprop="dateModified" datetime="2022-02-21T17:48:46+08:00">2022-02-21</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/IOT安全/" itemprop="url" rel="index"><span itemprop="name">IOT安全</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>[toc]</p>
<h2 id="硬件法提取固件概述"><a href="#硬件法提取固件概述" class="headerlink" title="硬件法提取固件概述"></a>硬件法提取固件概述</h2><ul>
<li>概要：芯片封装、引脚定义、芯片夹、flashroom、openocd、芯片手册、提取固件（falsh外置/mcu内置）</li>
<li>为何免拆提取<ul>
<li>拆卸+焊接，麻烦且考验动手能力</li>
<li>电烙铁、热吹风等工具的限制</li>
<li>客户不允许拆</li>
</ul>
</li>
<li>固件存储位置：flash外置存储、mcu内置存储</li>
<li>芯片封装与引脚定义<ul>
<li>SOP、QFP、QFN、BGA</li>
<li>SOP、QFP针脚外露，可用芯片夹子实现免拆提取</li>
<li>后两者不可，如BGA封装在下面（文中没写QFN）</li>
</ul>
</li>
<li>SOP<ul>
<li>针脚外露，有8根或16根，即SOP8/16</li>
<li>SOP8/16 封装的 Flash 在路由器、摄像头等 IOT 设备厂较为常见</li>
<li>一个角上有小圆点，为第一针脚，其余逆时针排布</li>
<li>型号代码一般是24或25开头（型号代码是啥？）//here</li>
</ul>
</li>
<li>QFP<ul>
<li>针脚外露，针脚数一般都在64以上</li>
<li>针脚数不固定，没有统一标准，由厂商自行定义</li>
<li>在小型IOT设备中可作为主控或协处理器（sop为flash，此为cpu）</li>
<li>针脚定义见具体厂商的芯片手册、示例图见文中</li>
</ul>
</li>
<li>BGA<ul>
<li>I/O 端子在封装下方，提取固件则需要使用BGA返修台拆卸下来读取，不能实现免拆提取</li>
<li>一般用于 CPU 和大容量存储</li>
<li>同FFP，针脚定义见具体厂商的芯片手册、示例图见文中</li>
</ul>
</li>
<li>芯片夹：SOP8/16脚测夹、芯片通用测试夹测试钩子、ECU 探针</li>
<li>SOP8/16脚测夹<ul>
<li>常用于 SPI 闪存的固件提取</li>
<li>SOP8 以及 SOP16 封装的芯片</li>
<li>示例图见文</li>
</ul>
</li>
<li>芯片通用测试夹测试钩子<ul>
<li>常用于SOP QFP 封装芯片的固件提取或协议分析</li>
<li>第一种：适用针脚较少的芯片（如 SOP8 封装的）、勾式扁式分别对应单钩双钩、价格相对便宜</li>
<li>第二种：夹子更细、用在有更多更细的针脚芯片上（如 QFP 封装的）、价格贵</li>
<li>示例图见文</li>
<li>第二种：夹子比较小，夹连续的针脚时有一定的困难，需要反复尝试</li>
<li>第二种：由于没有支撑，可能刚夹上就被弹开，所以需要ECU 探针</li>
</ul>
</li>
<li>ECU 探针<ul>
<li>多用于汽车 ECU 固件提取，也可用于其它</li>
<li>带有支架，只需要把探针搭在对应的芯片针脚上，搭而非夹</li>
<li>如芯片通用测试夹测试钩子，第二种，刚夹上就被弹开的情况</li>
<li>使用 ECU 探针读取固件方式与使用芯片通用测试夹测试钩子类似。唯一的差异是探针是搭在针脚上，而不是夹在针脚上</li>
<li>示例图见文</li>
</ul>
</li>
<li>从flash提取<ul>
<li>读取 SOP8 封装的 SPI Flash较多</li>
<li>软件：flashroom</li>
<li>硬件：测试夹（即sop8/16）、编程器（CH341A较慢，用树莓派）</li>
<li>步骤1，apt 安装flashroom</li>
<li>步骤2，配置树莓派：启用其spi接口并加载spi模块</li>
<li>步骤3，接线：找树莓派的引脚定义、找flash的引脚定义、flashroom给出二者如何连接（rpi header与spi flash的表）</li>
<li>步骤4，提取：flashrom p linux_spi:dev=/dev/spidev0.0,spispeed=1000 r w25q_rasp.bin（p指定设备类型/读写速度、r保存路径、若写回flash则用w）</li>
<li>接线时，用到了一块中介板子，怎么连的？//here</li>
</ul>
</li>
<li>从mcu提取<ul>
<li>固件位于mcu内置flash，通过调试接口（SWD/JTAG等）提取</li>
<li>FT232H作为pc与mcu的中转，usb插电脑，怎么连接mcu？图没看懂//here）</li>
</ul>
</li>
<li>硬件<ul>
<li>测试夹：芯片通用测试夹测试钩子</li>
<li>调试器：FT232H（提供USB到多种转接，如JTAG/SWD/UART），也可用 JLink、STLink 等调试器</li>
</ul>
</li>
<li>软件：OpenOCD<ul>
<li>Open OnChip Debugger，开源的片上调试器</li>
<li>可以与 GDB 配合进行动态调试（具体步骤未提及//here）</li>
<li>运行需两个配置文件：调试器和目标芯片的配置文件，openocd/scripts# openocd f interface/ft232hmoduleswd.cfg  f target/stm32f0x.cfg </li>
<li>运行之后，使用 telnet 连接本地的 4444 端口与芯片进行交互</li>
<li>help 查看支持命令、提取固件使用 dump_image</li>
</ul>
</li>
<li>芯片手册<ul>
<li>根据芯片丝印 STM32f030 RCT6，找手册</li>
<li>采用 SWD进行调试：目录3.16Serial wire debug port (SWDP)：An Arm SWDP interface is provided to allow a serial wire debugging tool to be connected to the MCU.</li>
<li>引脚定义：目录4Pinouts and pin descriptions：依据STM32f030，找到Table 11. STM32F030x4/6/8/C pin definitions，依据QFP64的封装方式，找到pin number为LQFP64那一列</li>
</ul>
</li>
<li>内存映射：目录5 Memory mapping<ul>
<li>CODE：广义上固件</li>
<li>Flash memory：内置的 Flash（硬盘）</li>
<li>System memory：预置了一段 BootLoader、为了从串口下载程序（ROM）</li>
<li>SRAW：内置 SRAM、一般用于程序调试（内存）</li>
<li>狭义上固件：Flash Memory 中，起始地址为 0x8000000 ，大小为 x40000</li>
</ul>
</li>
<li>找调试接口<ul>
<li>调试方式：读手册，swd，Serial Wire Debug，与JTAG的20个引脚相比，SWD只需要4个（或者5个）引脚</li>
<li>封装方式：由图可见，采用QFP64封装，4x16=64</li>
<li>芯片型号：看芯片丝印，STM32f030 RCT6</li>
<li>确定调试接口：SWDIO（输入输出）、SWCLK（时钟）、VSS（电源）、RESET（重置）</li>
</ul>
</li>
<li>步骤<ul>
<li>openocd安装：apt、源码（厂商定制化的）</li>
<li>接线：根据芯片丝印下载手册、手册中找调试接口</li>
<li>固件位置及大小：手册</li>
<li>启动openocd</li>
<li>telnet 连接 locahsot:4444 端口：halt 中断代码执行、dump_image导出固件</li>
<li>dump_image 格式： 文件名 起始地址 导出的数据长度，dump_image flash.bin 0x8000000 0x40000</li>
</ul>
</li>
<li>代码读取保护<ul>
<li>芯片开启代码读取保护（CRP/RDP），防止固件被提取</li>
<li>此法（即openocd提取固件），可应用在 IOT 安全测试中，验证 CRP 是否开启</li>
</ul>
</li>
</ul>
<blockquote>
<p>参考：<a href="https://www.anquanke.com/post/id/227285" target="_blank" rel="noopener">https://www.anquanke.com/post/id/227285</a></p>
</blockquote>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://21guns.top/2021/01/09/iot/v380摄像头固件重打包getshell/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="21Guns">
      <meta itemprop="description" content>
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="have a nice day">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/01/09/iot/v380摄像头固件重打包getshell/" class="post-title-link" itemprop="url">v380摄像头固件重打包getshell</a>
        </h2>

        <div class="post-meta">

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-01-09 09:23:44" itemprop="dateCreated datePublished" datetime="2021-01-09T09:23:44+08:00">2021-01-09</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-02-21 17:11:06" itemprop="dateModified" datetime="2022-02-21T17:11:06+08:00">2022-02-21</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/IOT安全/" itemprop="url" rel="index"><span itemprop="name">IOT安全</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>[toc]</p>
<h1 id="v380摄像头固件重打包getshell"><a href="#v380摄像头固件重打包getshell" class="headerlink" title="v380摄像头固件重打包getshell"></a>v380摄像头固件重打包getshell</h1><ul>
<li>RTSP：实时流协议 (Real Time Streaming Protocol)</li>
<li>patchV380：<a href="https://github.com/bcaller/v380-ipcam-firmware-patch/" target="_blank" rel="noopener">https://github.com/bcaller/v380-ipcam-firmware-patch/</a></li>
<li>更新流程<ol>
<li>检查md5、hwname</li>
<li>从固件中提取文件到/tmp/hu_files_tmpdir/</li>
<li>执行exshell_bfu.sh，before update</li>
<li>复制通用文件和音乐文件到/mnt/mtd/和/mnt/mtd/mvsound/</li>
<li>/sbin/updater刷入kernel和mtd</li>
<li>执行exshell_afu.sh，after update</li>
</ol>
</li>
<li>Linux set命令用于设置shell。-x：执行指令后，会先显示该指令及所下的参数。</li>
<li>passwd记录</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># root:$5$EvgtGUo1zRnZRW$Ge399ZNp3EYQP1NJt7MF1fbYjfnhtloG5m1N2KCp9l0:10933:0:99999:7:::</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 举例：$1$abcdefg$Qp6zr7K0tHxV79N9cCLSc1</span></span><br><span class="line">密码部分由三个部分组成，由<span class="string">'$'</span>分割。 </span><br><span class="line">按照<span class="string">'$'</span>分割后分别是加密方式（1），salt值（abcdefg），加密后的密码串（Qp6zr7K0tHxV79N9cCLSc1）。 </span><br><span class="line">目前加密方式有6种，最常见的只有3种： </span><br><span class="line">	1:MD5加密，密文长度22 </span><br><span class="line">	5:SHA-256加密，密文长度43 </span><br><span class="line">	6:SHA-512加密，密文长度86</span><br></pre></td></tr></table></figure>
<ul>
<li>mkpasswd工具</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 非Linux，自行下载</span></span><br><span class="line"><span class="comment"># method、salt、明文</span></span><br><span class="line">$ mkpasswd --method=sha256crypt --salt=EvgtGUo1zRnZRW Hello.123</span><br><span class="line"><span class="variable">$5</span><span class="variable">$EvgtGUo1zRnZRW</span><span class="variable">$2A2sE5yjjsR2K6QJH0Te2rKOUGaCRXiEIgdr9e5KlO0</span></span><br></pre></td></tr></table></figure>
<ul>
<li>/sbin/updater刷入kernel和mtd，用到ioctl函数，比如erase mtd</li>
<li>cat提取mtd内容<ul>
<li>：<code>cat /dev/mtd4ro &gt; /mnt/sdcard/mtd4</code> （插入内存卡）</li>
<li>/dev/mtd?是字符设备，允许字节流的方式访问</li>
</ul>
</li>
<li>固件重打包获取shell<ul>
<li>提取出shadow文件所在的mtd，cat /dev/mtd</li>
<li>提取文件系统，unsquashfs</li>
<li>修改shadow文件，mkpasswd生成密文</li>
<li>重新打包mtd，mksquashfs</li>
<li>将新mtd添加至固件，patchv380</li>
<li>更新固件，存放至内存卡</li>
</ul>
</li>
</ul>
<blockquote>
<p>参考：<a href="https://blog.caller.xyz/v380-ipcam-firmware-patching/" target="_blank" rel="noopener">https://blog.caller.xyz/v380-ipcam-firmware-patching/</a></p>
</blockquote>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/10/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/10/">10</a><span class="page-number current">11</span><a class="page-number" href="/page/12/">12</a><span class="space">&hellip;</span><a class="page-number" href="/page/28/">28</a><a class="extend next" rel="next" href="/page/12/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="21Guns" src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">21Guns</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">164</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">7</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">71</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="vx:lxllxllx1" title="Wechat → vx:lxllxllx1" rel="noopener" target="_blank"><i class="fab fa-weixin fa-fw"></i>Wechat</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://github.com/21Gun5" title="GitHub → https://github.com/21Gun5" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>
  <div class="cc-license motion-element" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2016 – 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">21Guns</span>
</div>

        








      </div>
    </footer>
  </div>

  
  <script size="300" alpha="0.5" zindex="0" src="/lib/canvas-ribbon/canvas-ribbon.js"></script>
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script>
<script src="/js/schemes/pisces.js"></script>
<script src="/js/next-boot.js"></script>



  




  <script src="/js/local-search.js"></script>












  

  

</body>
</html>
