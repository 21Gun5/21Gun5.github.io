<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 3.8.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"21guns.top","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="have a nice day">
<meta property="og:url" content="http://21guns.top/page/3/index.html">
<meta property="og:site_name" content="have a nice day">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="have a nice day">

<link rel="canonical" href="http://21guns.top/page/3/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>have a nice day</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">have a nice day</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" placeholder="搜索..." spellcheck="false" type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://21guns.top/2021/12/17/iov/汽车中OTA升级及安全/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="21Guns">
      <meta itemprop="description" content>
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="have a nice day">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/12/17/iov/汽车中OTA升级及安全/" class="post-title-link" itemprop="url">汽车中OTA升级及安全性</a>
        </h2>

        <div class="post-meta">

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-12-17 11:25:18" itemprop="dateCreated datePublished" datetime="2021-12-17T11:25:18+08:00">2021-12-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-03-05 21:04:08" itemprop="dateModified" datetime="2022-03-05T21:04:08+08:00">2022-03-05</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/IOV安全/" itemprop="url" rel="index"><span itemprop="name">IOV安全</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="汽车中OTA升级及安全性"><a href="#汽车中OTA升级及安全性" class="headerlink" title="汽车中OTA升级及安全性"></a>汽车中OTA升级及安全性</h1><h2 id="OTA升级机制"><a href="#OTA升级机制" class="headerlink" title="OTA升级机制"></a>OTA升级机制</h2><ul>
<li>漏洞修复/升级的方式<ul>
<li>插入固件升级的U盘，车主自行升级</li>
<li>前往服务中心，工作人员帮助升级</li>
<li>利用OTA升级机制，远程推送补丁，自动升级修复漏洞</li>
</ul>
</li>
<li><p>OTA升级
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2021/12/17/iov/汽车中OTA升级及安全/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </p></li></ul></div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://21guns.top/2021/12/13/iov/汽车安全的攻击面/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="21Guns">
      <meta itemprop="description" content>
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="have a nice day">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/12/13/iov/汽车安全的攻击面/" class="post-title-link" itemprop="url">汽车安全的攻击面</a>
        </h2>

        <div class="post-meta">

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-12-13 11:25:18" itemprop="dateCreated datePublished" datetime="2021-12-13T11:25:18+08:00">2021-12-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-03-05 21:04:08" itemprop="dateModified" datetime="2022-03-05T21:04:08+08:00">2022-03-05</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/IOV安全/" itemprop="url" rel="index"><span itemprop="name">IOV安全</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="汽车安全的攻击面"><a href="#汽车安全的攻击面" class="headerlink" title="汽车安全的攻击面"></a>汽车安全的攻击面</h1><ul>
<li>安全是一个体系，从系统角度考虑，木桶理论</li>
<li>从两个角度分析攻击向量<ul>
<li>技术能力：攻击者有能力对目标汽车进行恶意利用</li>
<li>可操作性：恶意利用时需要克服的条件限制</li>
</ul>
</li>
<li>限制条件可分三类：间接物理攻击、短距离无线访问、远距离无线访问
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2021/12/13/iov/汽车安全的攻击面/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </li></ul></div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://21guns.top/2021/12/02/iov/宝马汽车实验安全评估-总结报告/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="21Guns">
      <meta itemprop="description" content>
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="have a nice day">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/12/02/iov/宝马汽车实验安全评估-总结报告/" class="post-title-link" itemprop="url">宝马汽车实验安全评估-总结报告</a>
        </h2>

        <div class="post-meta">

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-12-02 11:25:48" itemprop="dateCreated datePublished" datetime="2021-12-02T11:25:48+08:00">2021-12-02</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-03-05 21:04:10" itemprop="dateModified" datetime="2022-03-05T21:04:10+08:00">2022-03-05</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/IOV安全/" itemprop="url" rel="index"><span itemprop="name">IOV安全</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>[toc]</p>
<h1 id="宝马汽车实验安全评估-总结报告"><a href="#宝马汽车实验安全评估-总结报告" class="headerlink" title="宝马汽车实验安全评估-总结报告"></a>宝马汽车实验安全评估-总结报告</h1><h1 id="1-介绍"><a href="#1-介绍" class="headerlink" title="1. 介绍"></a>1. 介绍</h1><ul>
<li><p>近年来，越来越多的BMW汽车配备了新一代的“互联网连接”信息娱乐系统（如HU_NBT/HU_ENTRYNAV），也称为主机单元和远程通信控制单元（如TCB）。虽然这些组件明显提高了用户体验的便利性和性能，但它们也带来了新的被攻击机会。</p>
</li>
<li><p>在我们的工作中，我们系统地对多辆BMW汽车的Head Unit、TCU和中央网关模块的软硬件进行了深入和全面的分析。重点关注这些部件的外部攻击面后，我们发现，通过一组远程攻击面（包括GSM通信、BMW远程服务、BMW ConnectedDrive服务、UDS远程诊断、NGTP协议以及蓝牙协议），在广泛的区域内，对多辆连接互联网的BMW汽车进行远程的定点攻击是可行的。因此，对于攻击者而言，通过利用复杂攻击链（由不同汽车组件中的漏洞组成），可以很容易的获取对汽车CAN总线的远程控制。除此之外，即便车辆不可以联网，也可以通过物理访问方式（比如USB、以太网以及ODB-II接口）来威胁到Head Unit主机单元。我们根据测试可以确认，所有的漏洞将会影响到各种现代宝马车型。
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2021/12/02/iov/宝马汽车实验安全评估-总结报告/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </p></li></ul></div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://21guns.top/2021/11/28/iov/车机分析及固件提取/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="21Guns">
      <meta itemprop="description" content>
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="have a nice day">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/11/28/iov/车机分析及固件提取/" class="post-title-link" itemprop="url">车机分析及固件提取</a>
        </h2>

        <div class="post-meta">

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-11-28 09:23:44" itemprop="dateCreated datePublished" datetime="2021-11-28T09:23:44+08:00">2021-11-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-03-05 21:04:08" itemprop="dateModified" datetime="2022-03-05T21:04:08+08:00">2022-03-05</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/IOV安全/" itemprop="url" rel="index"><span itemprop="name">IOV安全</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="车机分析及固件提取"><a href="#车机分析及固件提取" class="headerlink" title="车机分析及固件提取"></a>车机分析及固件提取</h2><ul>
<li>概要：车联网系统架构、UART、获取shell提取固件</li>
<li>获取车机端固件<ol>
<li>官网提供升级固件</li>
<li>硬件调试接口JTAG获取固件</li>
<li>读取Flash芯片获取固件</li>
<li>通过串口获取车机系统Shell权限，进而对固件进行打包</li>
<li>利用车机固件更新API，从云端获取更新固件</li>
<li>云端信息泄露，如FTP弱口令或未授权接口获取车机固件</li>
</ol>
</li>
<li>不同厂商的车联网架构不同，但总体可分为4部分：<ol>
<li>信息娱乐系统(IVI)</li>
<li>车载网关(TBOX)</li>
<li>手机端车联网应用(APP)：此类APP功能如车主服务，应用商城，远程控车</li>
<li>车联网云平台服务(TSP)：以云的形式向用户侧/车辆侧提供用户信息维护、车辆定位、状态监控等服务</li>
</ol>
</li>
<li>IVI：车载信息娱乐系统(In-Vehicle Infotainment)。<ul>
<li>早期CD机的音频播放，车联网功能后，可通过蜂窝网络接入互联网</li>
<li>常见功能：实时导航，网页浏览，视频播放，手机投屏，语音控车</li>
<li>具备一定CAN总线能力，因此其”功能外溢”现象产生的攻击面，可能会导致控车漏洞</li>
</ul>
</li>
<li>T-BOX：车载网关(Telematics BOX)。<ul>
<li>负责车机内部的以太网通信，同时提供联网能力，实现车端与云平台(TSP)的远程长连接</li>
<li>具备一定CAN总线能力，也是数字钥匙(手机控车)的实现载体</li>
<li>通过数字钥匙，可通过手机对车辆进行远程操控(云钥匙)、近场操控(蓝牙/NFC钥匙)</li>
</ul>
</li>
<li>Uart<ul>
<li>通用异步收发传输器，一种串行异步收发协议</li>
<li>原理：将数据的二进制位一位一位的进行传输，信号线上的状态位，高电平代表’1’低电平代表’0’</li>
</ul>
</li>
<li>波特率<ul>
<li>当两个设备使用UART串口通讯时，必须先约定好传输速率，即波特率</li>
<li>典型的波特率：300，1200，2400，9600，19200，38400，115200</li>
<li>试过每一个波特率还是无法接收到可见字符，说明：找错了串口、本身传输的数据是不可见字符</li>
</ul>
</li>
<li>Uart三根线<ul>
<li>TX：发送数据端，要接对面设备的RX</li>
<li>RX：接收数据端，要接对面设备的TX</li>
<li>GND：保证两设备共地，有统一的参考平面</li>
</ul>
</li>
<li>uart的数据包：起始位、数据位、停止位</li>
<li>配件：液晶显示屏、车机、二者的连接线</li>
<li>分析前需要先通电，车机上会标注出一些信息，7号BAT接正极，8号GND接负极，4号ACC_IN接正极</li>
<li>车联网厂商：有的将车载网关(T-Box)与信息娱乐系统(IVI)集成到同一Linux中，有的会将二者分开</li>
<li>一般单片机的MCU都没有shell，故不必关注mcu的串口</li>
<li>找串口：直接标出<code>rx tx</code>、需要根据经验猜测、万用表找</li>
<li>提取固件，根据硬件功能来分析<ul>
<li>车机有wifi功能，通过工程模式开启wifi热点，<code>WiFi→FTP/TFTP→PC</code></li>
<li>通过串口文件传输协议，直接提取固件，<code>Uart→Xmodem/Ymodem/Zmodem→PC</code></li>
</ul>
</li>
<li>三种协议<ul>
<li>Xmodem：异步文件传输协议，需要对每个块都进行认可，导致性能下降</li>
<li>Ymodem：Xmodem改良版，协议控制符、传输流程与Xmodem相同，差别在数据帧</li>
<li>Zmodem：串流传输方式，速度最快</li>
<li>工具：minicom、SecureCRT</li>
</ul>
</li>
<li>使用SecureCRT可直接下载/上传文件，如果芯片系统里存在lrzsz，可以直接用Zmodem，命令 sz filename即可下载</li>
</ul>
<blockquote>
<p>参考：<a href="https://mp.weixin.qq.com/s/IIqg3ePO6MNY-pxcpGYv1w" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/IIqg3ePO6MNY-pxcpGYv1w</a></p>
</blockquote>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://21guns.top/2021/11/26/iot/D-Link DIR3060固件加解密算法分析/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="21Guns">
      <meta itemprop="description" content>
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="have a nice day">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/11/26/iot/D-Link DIR3060固件加解密算法分析/" class="post-title-link" itemprop="url">D-Link DIR3060固件加解密算法分析</a>
        </h2>

        <div class="post-meta">

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-11-26 12:31:13" itemprop="dateCreated datePublished" datetime="2021-11-26T12:31:13+08:00">2021-11-26</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-02-21 16:04:13" itemprop="dateModified" datetime="2022-02-21T16:04:13+08:00">2022-02-21</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/IOT安全/" itemprop="url" rel="index"><span itemprop="name">IOT安全</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>[toc]</p>
<h2 id="00-简介"><a href="#00-简介" class="headerlink" title="00-简介"></a>00-简介</h2><ul>
<li>文章概要：D-Link DIR3060加解密算法以及固件结构的分析</li>
<li><p>PS：手头没啥现成的文章，找了一篇自己的学习笔记，当时初入iot大坑，记录的比较详细，按照自己的理解，对原文做了一定补充和总结，算是半翻译半原创，希望可以帮助到新人，还望大家不吝指教。</p>
</li>
<li><p>结合原文食用更佳：</p>
<ul>
<li><a href="https://0x434b.dev/breaking-the-d-link-dir3060-firmware-encryption-recon-part-1/" target="_blank" rel="noopener">Breaking the D-Link DIR3060 Firmware Encryption - Recon - Part 1</a></li>
<li><a href="https://0x434b.dev/breaking-the-d-link-dir3060-firmware-encryption-static-analysis-of-the-decryption-routine-part-2-1/" target="_blank" rel="noopener">Breaking the D-Link DIR3060 Firmware Encryption - Static analysis of the decryption routine - Part 2.1</a></li>
<li><a href="https://0x434b.dev/breaking-the-d-link-dir3060-firmware-encryption-static-analysis-part-2/" target="_blank" rel="noopener">Breaking the D-Link DIR3060 Firmware Encryption - Static analysis of the decryption routine - Part 2.2</a></li>
</ul>
</li>
</ul>
<h2 id="01-逆向分析"><a href="#01-逆向分析" class="headerlink" title="01-逆向分析"></a>01-逆向分析</h2><ul>
<li><p>lwl, lwr：未对齐内存的访问</p>
</li>
<li><p>大小端问题</p>
  <figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$v0:</span><br><span class="line">          ↓</span><br><span class="line"><span class="number">00000000</span>: <span class="number">5348</span> <span class="number">5253</span> <span class="number">00</span>d1 d9a6 <span class="number">00</span>d1 d9b0 <span class="number">67</span>c6 <span class="number">6973</span>  SHRS........g.is</span><br><span class="line"><span class="number">00000010</span>: <span class="number">51f</span>f <span class="number">4</span>aec <span class="number">29</span>cd baab f2fb e346 fda7 <span class="number">4</span>d06  Q.J.)......F..M.</span><br><span class="line">[...]</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line">lwl $v1 <span class="number">11</span>($v0):</span><br><span class="line">                                      ↓</span><br><span class="line"><span class="number">00000000</span>: <span class="number">5348</span> <span class="number">5253</span> <span class="number">00</span>d1 d9a6 <span class="number">00</span>d1 d9b0 <span class="number">67</span>c6 <span class="number">6973</span>  SHRS........g.is</span><br><span class="line"><span class="number">00000010</span>: <span class="number">51f</span>f <span class="number">4</span>aec <span class="number">29</span>cd baab f2fb e346 fda7 <span class="number">4</span>d06  Q.J.)......F..M.</span><br><span class="line">[...]</span><br><span class="line">--&gt; $v1 = b0d9</span><br></pre></td></tr></table></figure>
</li>
<li><p>python实现字节转整数</p>
  <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1</span></span><br><span class="line">int.from_bytes(<span class="string">b'\xb0\xd9\xd1\x00'</span>, byteorder=<span class="string">'little'</span>, signed=<span class="keyword">False</span>)</span><br><span class="line"><span class="number">13752752</span></span><br><span class="line"><span class="comment"># 2</span></span><br><span class="line"><span class="keyword">from</span> socket <span class="keyword">import</span> htonl</span><br><span class="line">htonl(<span class="number">0xb0d9d100</span>)</span><br><span class="line"><span class="number">13752752</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>wc -c DIR_882_FW120B06.BIN：-c, –bytes</p>
</li>
<li><p>xargs命令的作用，是将标准输入转为命令行参数</p>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;</span><span class="bash"> wc -c DIR_882_FW120B06.BIN | cut -d<span class="string">' '</span> -f1 | xargs <span class="built_in">printf</span> <span class="string">'0x%x\n'</span>     </span></span><br><span class="line">0xd1f247</span><br></pre></td></tr></table></figure>
</li>
<li><p>SHA512_Init, SHA512_Update, SHA512_Final，计算hash值的一组函数，最终 return a pointer to the hash value</p>
</li>
<li><p>hexdump</p>
  <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&gt; hd DIR_882_FW120B06.BIN -s 0x9c -n 64</span><br><span class="line">0000009c  68 bf e5 30 a0 49 b9 e8  5d a0 bb 81 71 87 05 <span class="built_in">cd</span>  |h..0.I..]...q...|</span><br><span class="line">000000ac  70 25 18 f2 8f af d6 21  35 05 31 7e fd af 60 56  |p%.....!5.1~..`V|</span><br><span class="line">000000bc  d8 ed e7 71 6c 39 d1 68  0d a7 13 f4 04 41 87 58  |...ql9.h.....A.X|</span><br><span class="line">000000cc  e9 97 36 73 99 78 8b 01  10 ee 12 d6 b6 3b 69 ec  |..6s.x.......;i.|</span><br><span class="line">000000dc</span><br><span class="line"></span><br><span class="line">&gt; hd DIR_882_FW120B06.BIN -s 0x9c -n 64 -e <span class="string">'156/1 "%x" "\n"'</span> | cut -d$<span class="string">'\n'</span> -f2</span><br><span class="line">68bfe530a049b9e85da0bb8171875cd702518f28fafd621355317efdaf6056d8ede7716c39d168da713f44418758e997367399788b110ee12d6b63b69ec</span><br><span class="line"><span class="comment"># -s，skip</span></span><br><span class="line"><span class="comment"># -n，length</span></span><br><span class="line"><span class="comment"># -e，format</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li><p>mips函数调用：多于四个参数，其他参数保存在栈中，看对a0操作的前面有没有sw保存到栈的操作，一般就是多出的</p>
</li>
<li><p>AES</p>
<ul>
<li>高级加密标准、对称加密算法</li>
<li>只有一个密钥，这个密钥既用来加密，也用于解密</li>
<li>加密方式有五种：<strong>ECB</strong>, <strong>CBC</strong>, CTR, CFB, OFB（从安全性角度推荐CBC加密方法</li>
<li>CBC加密需要一个十六位的key(密钥)和一个十六位iv(偏移量)、ECB加密不需要iv</li>
<li>Google：python 利用Crypto进行AES解密&amp;加密文件</li>
</ul>
</li>
<li><p>AES_cbc_encrypt</p>
<ul>
<li>(const unsigned char <em>in, unsigned char </em>out, size_t length, const AES_KEY <em>key, unsigned char </em>ivec, const int enc);</li>
<li>If enc is non-zero, AES_cbc_encrypt() encrypts len bytes at in to out using the 128 bit key and the 128 bit initialization vector ivec in CBC mode. </li>
<li>If enc is 0, AES_cbc_encrypt() performs the corresponding decryption.</li>
</ul>
</li>
<li><p>一般情况下：解密、获取解密文件hash、hash对比来判断正确与否</p>
</li>
<li><p>两个差不多大的数值，一个是真正长度，另一个是为对齐而增加后的长度</p>
<ul>
<li>（AES为了安全考虑，每个块是16字节</li>
<li>文中关于datalen_1和2的分析还是有些乱</li>
</ul>
</li>
<li><p>hexdump中出现*号，表示一堆0</p>
</li>
<li><p>RSA_verify</p>
<ul>
<li>(int type, const unsigned char <em>m, unsigned int m_len, unsigned char </em>sigbuf, unsigned int siglen, RSA *rsa);</li>
<li>verifies that the signature <strong>sigbuf</strong> of size <strong>siglen</strong> matches a given message digest <strong>m</strong> of size <strong>m_len</strong>. </li>
<li><strong>type</strong> denotes the message digest algorithm that was used to generate the signature. </li>
<li><strong>rsa</strong> is the signer’s public key.</li>
<li>returns 1 on successful verification, 0 otherwise.</li>
</ul>
</li>
<li><p>RSA_verify，type=0x2A2=674，openssl/obj_mac.h中，#define NID_SHA512 674，说明是sha512，是一种hash算法</p>
</li>
<li><p>AES+RSA常结合使用：前者对称，后者非对称</p>
</li>
<li><p>unlink</p>
<ul>
<li>(const char* pathname);</li>
<li>删除一个名字（某些情况下删除这个名字所指向的文件）</li>
<li>从文件系统中中删除一个名字，若这个名字是指向这个文件的最后一个链接，并且没有进程处于打开这个文件的状态，则删除这个文件，释放这个文件占用的空间</li>
<li>如果这个名字是指向这个文件的最后一个链接，但有某个进程处于打开这个文件的状态，则暂时不删除这个文件，要等到打开这个文件的进程关闭这个文件的文件描述符后才删除这个文件</li>
</ul>
</li>
</ul>
<h2 id="02-流程梳理"><a href="#02-流程梳理" class="headerlink" title="02-流程梳理"></a>02-流程梳理</h2><h3 id="1-main"><a href="#1-main" class="headerlink" title="1-main"></a>1-main</h3><ol>
<li>是否有“decrypt”字符串？</li>
<li>加密or解密</li>
</ol>
<h3 id="2-decrypt-firmware"><a href="#2-decrypt-firmware" class="headerlink" title="2-decrypt_firmware"></a>2-decrypt_firmware</h3><ol>
<li>参数个数<ol>
<li>小于2（1），打印帮助信息</li>
<li>大于2（3），pem为指定的文件</li>
<li>等于2，pem为默认的”/tmp/public.pem”</li>
</ol>
</li>
<li>check_cert获取密钥，用于后面数字签名的验证，pem文件中存储着rsa的密钥（公/私）<ol>
<li>OPENSSL_add_all_algorithms_noconf、RSA_new、PEM_read_RSAPublicKey、RSA_free</li>
<li>fopen/fclose打开/关闭pem文件</li>
<li>（目前遇到rsa两种情况：RSA解密aes的密钥、RSA解密用于验证数字签名</li>
</ol>
</li>
<li>call_aes_cbc_encrypt调用aes_cbc_encrypt：aes-cbc解密得到key，后面真正解密固件时用到<ol>
<li>AES_set_decrypt_key (userKey, bits, key)：通过userkey进一步获取key，可以理解为用户提供的密钥userkey不能直接用于解密，需要做进一步处理</li>
<li>AES_cbc_encrypt(in, out, length, key, ivec, enc)：加/解密通过enc指定、cbc是aes的一种模式，cbc需要ivec而ebc不需要</li>
<li>in、key、ivec都是硬编码在二进制程序中的，in输入为加密的aes密钥，解密后用于后面aes解密固件</li>
</ol>
</li>
<li>打印上面解密出来的key：<ol>
<li>有两次aes解密，第一次解密aes密钥（用于第二次），第二次解密固件</li>
<li>第一次解密的密钥来自硬编码，第二次解密的密钥来自第一次的解密结果</li>
</ol>
</li>
<li>actual_decryption：真正的解密固件的函数，前面都是准备工作<ol>
<li>选择pem文件：自己指定还是用默认的</li>
<li>从pem中获取rsa密钥：用于后面验证数字签名</li>
<li>aes解密：获取后面aes解密的密钥</li>
</ol>
</li>
</ol>
<h3 id="3-actual-decryption"><a href="#3-actual-decryption" class="headerlink" title="3-actual_decryption"></a>3-actual_decryption</h3><ol start="0">
<li>传参：待解密的固件、 临时文件”/tmp/.firmware.orig”、前面解密获得的key</li>
<li>映射到内存等准备工作<ol>
<li>memset准备两块内存空间（0填充</li>
<li>stat获取加密固件的文件状态，成功则open打开，再成功则mmap映射到内存</li>
<li>打开tmp下的临时文件，成功则lseek将文件指针移动到最后，并添加1个0，随后close关闭文件，来保存修改、</li>
<li>open再次打开tmp下临时文件，并mmap映射到内存</li>
</ol>
</li>
<li>检查标记：将加密固件传入check_magic来检查标记，其memcmp查看是否以“SHRS”开头</li>
<li>小端转大端：从文件偏移4、8处取出数据，htonl将主机字节序转为网络字节序，得到两个值：v1和v2<ol>
<li>htonl：host、network、unsigned long </li>
<li>主机序一般为小端，网络为大端，htonl也就是将小端转为大端</li>
<li>小端符合人思维（倒序），大端直观（正序），也就是将内存中倒着的数据正过来，好计算</li>
</ol>
</li>
<li>calc_SHA512_digest第一次验证完整性<ol>
<li>传入：加密固件、值v2，</li>
<li>其SHA512_Init、SHA512_Update、SHA512_Final，一看就是计算hash，</li>
<li>memcmp比较文件偏移0x9c处和hash值</li>
</ol>
</li>
<li>aes_cbc_encrypt解密固件：<ol>
<li>in输入：加密的固件，从偏移6dc处开始而非文件开头</li>
<li>out输出：tmp下的临时文件，可见这个文件的作用就是接收解密后的固件，为其提供空间（类似字符数组存放返回结果，在此只不过换成了文件</li>
<li>len长度：前面htonl获取的值v2</li>
<li>key密钥：第一次aes解密后的结果</li>
<li>ivec初始化向量：硬编码在加密固件中（第一次的iv硬编码在二进制程序中</li>
</ol>
</li>
<li>calc_SHA512_digest第二次验证完整性<ol>
<li>传入：解密后的固件、值v1</li>
<li>memcmp比较文件偏移0x5c处和hash值</li>
</ol>
</li>
<li>calc_SHA512_digest第三次验证完整性<ol>
<li>传入：解密后的固件、值v1、第一次aes解密获取到的aes_key</li>
<li>同上2次没本质区别，只不过hash的对象为固件+key，SHA512_Update多调用一次即可</li>
<li>memcmp比较文件偏移0x1c处和hash值</li>
</ol>
</li>
<li>SHA512_checker调用RSA_verify验证数字签名：<ol>
<li>RSA_verify(type, m, m_len, sigbuf, siglen,rsa)</li>
<li>type摘要算法类型：指定生成签名的hash算法，0x2a2表示SHA512</li>
<li>rsa密钥：前面从pem文件中获取到的</li>
<li>m消息，sigbuf签名：用rsa解密sigbuf，type计算m的散列值，对比二者来验证签名</li>
<li>前后调用两次：第一次（m=0x5c，sigbuf=0x2dc），第二次（m=0x9c，sigbuf=0x4dc）</li>
</ol>
</li>
<li>扫尾：munmap、close、解密成功返回0</li>
</ol>
<h3 id="4-扫尾"><a href="#4-扫尾" class="headerlink" title="4-扫尾"></a>4-扫尾</h3><ol>
<li>unlink删除加密的固件</li>
<li>rename将tmp下的临时文件重命名为加密固件的名字，此时临时文件就是解密后的固件</li>
<li>RSA_free释放rsa结构体，结束</li>
</ol>
<h2 id="03-代码编写"><a href="#03-代码编写" class="headerlink" title="03-代码编写"></a>03-代码编写</h2><ul>
<li>通过汇编写C</li>
<li><p>通过C写python</p>
</li>
<li><p><a href="https://github.com/0xricksanchez/dlink-decrypt（暂不自己动手了，有类似需求时当做参考" target="_blank" rel="noopener">https://github.com/0xricksanchez/dlink-decrypt（暂不自己动手了，有类似需求时当做参考</a></p>
</li>
</ul>
<h2 id="04-固件结构"><a href="#04-固件结构" class="headerlink" title="04-固件结构"></a>04-固件结构</h2><p><img src="https://note-1252764528.cos.ap-chengdu.myqcloud.com/2020-09-18-085343.jpg" alt="image-20200918161124445"></p>
<h3 id="0-3"><a href="#0-3" class="headerlink" title="0-3"></a>0-3</h3><ul>
<li>4字节：53 48 52 53</li>
<li>SHRS，加密固件的标记</li>
</ul>
<h3 id="4-7、8-B"><a href="#4-7、8-B" class="headerlink" title="4-7、8-B"></a>4-7、8-B</h3><ul>
<li>各4字节：00 D1 D9 A6/00 D1 D9 B0</li>
<li>处理<ul>
<li>汇编中通过lwr/lwl逆序取出：0xA6D9D100</li>
<li>通过htonl：将主机字节序转为网络字节序，也就是再倒一次变成0x00D1D9A6，十进制为13752742</li>
<li>（不知为何这样，可能汇编中只能倒着取出，所以逼不得已再倒一次变正常</li>
<li>得到两个数：13752742/13752752（可见二者仅差了10</li>
<li>加密固件大小：0xD1F247=13759047（并非二者，但都是1375</li>
</ul>
</li>
<li>分析value2<ul>
<li>value2=13752752，传入了calc_SHA512_digest第一次验证完整性和aes_cbc_encrypt第二次解密，一同传入的还有加密固件的0x6DC偏移，0xD1F247-0x6DC=13757291，也不对</li>
<li>value1=13752742，传入了calc_SHA512_digest第二次和第三次验证完整性，注意此时一同传入的是解密后的固件了，获取解密后固件（已经有解密脚本了）的大小为D1D9B0=13752752，正是value2的值（注意而不是value1</li>
<li>因此：value2为解密后固件大小</li>
</ul>
</li>
<li>分析value1<ul>
<li>由上分析1是与解密后的固件相关的，1仅比2小了10，即解密固件大小比1多了10，多的10是什么？</li>
<li>查看解密后固件最后10字节，发现全是0，大胆猜想：莫非是填充？</li>
<li>value1=13752742 % 16 = 6，value2=13752745 % 16 = 0，1取余为6，填充16-6=10正好凑16整数</li>
<li>填充到16整数也是由aes决定的，参考<a href="https://tools.ietf.org/html/rfc3602#section-2.4（Block" target="_blank" rel="noopener">https://tools.ietf.org/html/rfc3602#section-2.4（Block</a> Size and Padding</li>
<li>因此：value1为原始固件大小</li>
</ul>
</li>
<li>综上：1原始解密后固件大小，2在1基础上填充后的</li>
</ul>
<h3 id="C-1B"><a href="#C-1B" class="headerlink" title="C-1B"></a>C-1B</h3><ul>
<li>16字节：67 C6 69 73 51 FF 4A EC 29 CD BA AB F2 FB E3 46</li>
<li>第二次aes解密（解密固件）的ivec向量</li>
</ul>
<h3 id="1C-5B"><a href="#1C-5B" class="headerlink" title="1C-5B"></a>1C-5B</h3><ul>
<li>64字节：FD A7 4D 06 A4 66 E6 AD BF C4 9D 13 F3 F7 D1 12 98 6B 2A 35 1D 0E 90 85 B7 83 F7 4D 3A 2A 25 5A B8 13 0C FB 2A 17 7A B2 99 04 60 66 EB C2 58 98 82 74 08 E3 54 1E E2 51 44 42 E8 D6 8E 46 6E 2C</li>
<li>第三次calc_SHA512_digest验证完整性时（传入解密后固件+解密后的aes_key），64字节的消息摘要</li>
</ul>
<h3 id="5C-9B"><a href="#5C-9B" class="headerlink" title="5C-9B"></a>5C-9B</h3><ul>
<li>64字节：16 57 D3 0B 07 D7 7C 9E 11 EC 72 1D FB 87 A2 5B 18 EC 53 82 85 B9 84 39 B6 B4 DD 85 DE F0 28 3D 36 0E BE AA D0 9D 71 B0 BA 3E 26 40 E8 C5 4C 0E 0B 32 EB 00 E8 F7 21 D7 3A AA 0D 14 D5 F7 E8 72</li>
<li>第二次calc_SHA512_digest验证完整性时（仅传入解密后固件），64字节的消息摘要</li>
</ul>
<h3 id="9C-DB"><a href="#9C-DB" class="headerlink" title="9C-DB"></a>9C-DB</h3><ul>
<li>65字节：68 BF E5 30 A0 49 B9 E8 5D A0 BB 81 71 87 05 CD 70 25 18 F2 8F AF D6 21 35 05 31 7E FD AF 60 56 D8 ED E7 71 6C 39 D1 68 0D A7 13 F4 04 41 87 58 E9 97 36 73 99 78 8B 01 10 EE 12 D6 B6 3B 69 EC</li>
<li>第一次calc_SHA512_digest验证完整性时（仅传入加密固件），64字节的消息摘要</li>
</ul>
<h3 id="DC-2DB"><a href="#DC-2DB" class="headerlink" title="DC-2DB"></a>DC-2DB</h3><ul>
<li>512个0字节</li>
<li>填充用的？还是用来保存后续产生的数据？</li>
</ul>
<h3 id="2DC-4DB、4DC-6DB"><a href="#2DC-4DB、4DC-6DB" class="headerlink" title="2DC-4DB、4DC-6DB"></a>2DC-4DB、4DC-6DB</h3><ul>
<li>各512个字节</li>
<li>两次RSA_verify验证所用的签名</li>
</ul>
<h3 id="6DC"><a href="#6DC" class="headerlink" title="6DC-"></a>6DC-</h3><ul>
<li>第二次aes解密（解密固件），传入加密固件的6dc偏移</li>
<li>真正的加密数据</li>
</ul>
<h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><ul>
<li>0-6DB：头部，总大小1756，提供附加数据<ul>
<li>0-DB：meta checks元数据，用于解密或验证</li>
<li>DC-2DB：512空字节，填充？保留空间？</li>
<li>2DC-4DB、4DC-6DB：各512字节，两次RSA_verify验证所用的签名</li>
<li>6DC-：真正的加密数据</li>
</ul>
</li>
</ul>
<p>首发于iotsec-zone：<a href="https://www.iotsec-zone.com/article?id=17" target="_blank" rel="noopener">https://www.iotsec-zone.com/article?id=17</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://21guns.top/2021/11/10/iot/天府杯-asus路由器漏洞分析/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="21Guns">
      <meta itemprop="description" content>
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="have a nice day">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/11/10/iot/天府杯-asus路由器漏洞分析/" class="post-title-link" itemprop="url">天府杯-asus路由器漏洞分析</a>
        </h2>

        <div class="post-meta">

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-11-10 09:23:44" itemprop="dateCreated datePublished" datetime="2021-11-10T09:23:44+08:00">2021-11-10</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-02-21 17:09:52" itemprop="dateModified" datetime="2022-02-21T17:09:52+08:00">2022-02-21</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/IOT安全/" itemprop="url" rel="index"><span itemprop="name">IOT安全</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>[toc]</p>
<h2 id="天府杯-asus路由器漏洞分析"><a href="#天府杯-asus路由器漏洞分析" class="headerlink" title="天府杯-asus路由器漏洞分析"></a>天府杯-asus路由器漏洞分析</h2><ul>
<li>概要：envrams暴露、current_lang信息泄漏、整数溢出及堆溢出</li>
<li>查看端口以便选择目标程序<ul>
<li>筛出：envrams、wanduck、cfg_server、httpd、infosvr</li>
<li>排除：三方开源程序、仅监听本地端口的程序</li>
<li>三方：维护者众多，发现漏洞较难</li>
<li>监听本地端口：即便有漏洞也无法直接利用（若有进程通信则可能间接利用）</li>
</ul>
</li>
<li>其它<ul>
<li>固件获取：web页面中设置后，可telnet登陆设备，将二进制程序取回本地</li>
<li>固件遵守GPL协议，故可找相关代码作为参考，如梅林固件</li>
<li>httpd程序中找到路由表：结构体数组，并非网络概念，而是uri路由</li>
<li>当多个华硕路由器通过AiMesh组网之后，会出现cfg_client和cfg_server之间的通信</li>
<li>路由表广义上来讲就是结构体数组，不管是uri还是端口的</li>
</ul>
</li>
<li>nvram_xxx函数<ul>
<li>与配置相关，set保存/更新配置、get获取配置</li>
<li>最终会执行到和内核通信的socket：提高了配置访问速度、解决配置更新不同步的问题</li>
</ul>
</li>
<li>envrams暴露问题<ul>
<li>envrams：获取和更新配置的接口、监听tcp5152端口、支持show/get/set等指令、可获取/更新nvram.nvm文件中配置</li>
<li>nvram.nvm文件：保存其它进程的配置，重启后，配置会加载到内核中，但是加载时机较晚，故会覆盖已有配置</li>
<li>比如envrams将x_Setting的值设置为0，设备误认为自己被恢复出厂设置，故web不需要用户名/密码即可登陆</li>
<li>修复简单粗暴：iptables增加一条规则，限制了5152端口的访问</li>
</ul>
</li>
<li>结构体的六个成员<ul>
<li>1：访问的uri</li>
<li>2：页面类型</li>
<li>3：cache-control头</li>
<li>4：某函数</li>
<li>5：uri的处理函数，比如do_ej是页面解析器</li>
<li>6：是否需要登陆</li>
</ul>
</li>
<li>信息泄露问题<ul>
<li>do_ej也能处理post请求，而且接收current_lang参数，用于控制页面的显示语言</li>
<li>snprintf限制长度为0x10，若输入长度超过0x10，原本的“%s.dict”就会被顶出去（//here，format参数怎么被顶？）</li>
<li>current_lang=/////etc/shadow，shadow内容将会通过http直接回显出来（//here，current_lang字段看来是内嵌在html页面上的，那么文件内容怎么解析出来的？）</li>
<li>修复：限制a1参数的长度和内容</li>
</ul>
</li>
<li>cfg_server程序<ul>
<li>类似httpd，可以在cfg_server程序中找到多个路由表，关于端口的</li>
<li>TLV（Type-Length-Value）格式：T即路由表中的编号、V是aes加密数据内容及其crc32值、L为不合理的值会怎样（即漏洞点）</li>
</ul>
</li>
<li>整数溢出、堆溢出//here<ul>
<li>构造恶意数据：第0x28号请求、长度为0xFFFFFFF4、crc32值为0（绕过crc32校验)</li>
<li>在AES解密过程中，会触发整数溢出，导致malloc错误的内存大小</li>
<li>R11值为0xFFFFFFF4，而malloc长度仅仅为0x4，声明的内存长度小于实际长度，造成堆溢出，导致AES解密数据写入后续溢出的堆内存中</li>
<li>利用：待学习</li>
</ul>
</li>
</ul>
<blockquote>
<p>参考：<a href="https://mp.weixin.qq.com/s/5dJ74cAATmPg7sjYHZR4wQ" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/5dJ74cAATmPg7sjYHZR4wQ</a></p>
</blockquote>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/2/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><span class="space">&hellip;</span><a class="page-number" href="/page/28/">28</a><a class="extend next" rel="next" href="/page/4/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="21Guns" src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">21Guns</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">164</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">7</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">71</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="vx:lxllxllx1" title="Wechat → vx:lxllxllx1" rel="noopener" target="_blank"><i class="fab fa-weixin fa-fw"></i>Wechat</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://github.com/21Gun5" title="GitHub → https://github.com/21Gun5" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>
  <div class="cc-license motion-element" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2016 – 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">21Guns</span>
</div>

        








      </div>
    </footer>
  </div>

  
  <script size="300" alpha="0.5" zindex="0" src="/lib/canvas-ribbon/canvas-ribbon.js"></script>
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script>
<script src="/js/schemes/pisces.js"></script>
<script src="/js/next-boot.js"></script>



  




  <script src="/js/local-search.js"></script>












  

  

</body>
</html>
